<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>RAG | All wisdom begins with memory.</title><meta name="author" content="李俊泽"><meta name="copyright" content="李俊泽"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="P01_RAG系统项目介绍1 背景介绍【了解】 业务：IT教育的答疑项目 技术：RAG【知识库+LLM】  2 RAG相关介绍【掌握】2.1 RAG概念通⽤的基础⼤模型存在一些问题：  幻觉问题，LLM有时会在回答中⽣成看似合理但实际上是错误的信息 LLM的知识不是实时的，模型训练好后不具备自动更新"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liamjohnson-w.github.io/2025/10/21/RAG/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RAG',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-21 22:05:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"> <script src="/live2d-widget/autoload.js"></script><script src="/live2d-widget/autoload.js"> </script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/tx.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">239</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">58</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-gamepad"></i><span> Games</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/mikutap/"><i class="fa-fw fa fa-music"></i><span> MikuTap 初音未来</span></a></li><li><a class="site-page child" href="/starbattle/"><i class="fa-fw fa fa-space-shuttle"></i><span> StartBattle 星际大战</span></a></li><li><a class="site-page child" href="/2048/"><i class="fa-fw fa fa-flag"></i><span> 2048 经典游戏</span></a></li><li><a class="site-page child" href="/battlecity/"><i class="fa-fw fa fa-arrow-circle-left"></i><span> BattleCity 坦克大战</span></a></li><li><a class="site-page child" href="/pacman/"><i class="fa-fw fa fa-bolt"></i><span> PacMan  吃豆人</span></a></li><li><a class="site-page child" href="/tetris/"><i class="fa-fw fa fa-arrows-alt"></i><span> Tetris 俄罗斯方块</span></a></li><li><a class="site-page child" href="/smallcat/"><i class="fa-fw fa fa-paw"></i><span> CatchCat 困住小猫</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-leaf"></i><span> Moments</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/diary/"><i class="fa-fw fas fa-bookmark"></i><span> Diary</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-hourglass-half"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-podcast"></i><span> More</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags标签</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About关于</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-bookmark"></i><span> Messageboard留言板</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/%E8%83%8C%E6%99%AF%20(2).png')"><nav id="nav"><span id="blog-info"><a href="/" title="All wisdom begins with memory."><span class="site-name">All wisdom begins with memory.</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-gamepad"></i><span> Games</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/mikutap/"><i class="fa-fw fa fa-music"></i><span> MikuTap 初音未来</span></a></li><li><a class="site-page child" href="/starbattle/"><i class="fa-fw fa fa-space-shuttle"></i><span> StartBattle 星际大战</span></a></li><li><a class="site-page child" href="/2048/"><i class="fa-fw fa fa-flag"></i><span> 2048 经典游戏</span></a></li><li><a class="site-page child" href="/battlecity/"><i class="fa-fw fa fa-arrow-circle-left"></i><span> BattleCity 坦克大战</span></a></li><li><a class="site-page child" href="/pacman/"><i class="fa-fw fa fa-bolt"></i><span> PacMan  吃豆人</span></a></li><li><a class="site-page child" href="/tetris/"><i class="fa-fw fa fa-arrows-alt"></i><span> Tetris 俄罗斯方块</span></a></li><li><a class="site-page child" href="/smallcat/"><i class="fa-fw fa fa-paw"></i><span> CatchCat 困住小猫</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-leaf"></i><span> Moments</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/diary/"><i class="fa-fw fas fa-bookmark"></i><span> Diary</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-hourglass-half"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-podcast"></i><span> More</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags标签</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About关于</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-bookmark"></i><span> Messageboard留言板</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RAG</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-10-20T16:00:00.000Z" title="Created 2025-10-21 00:00:00">2025-10-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-10-21T14:05:38.397Z" title="Updated 2025-10-21 22:05:38">2025-10-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RAG"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="P01-RAG系统项目介绍"><a href="#P01-RAG系统项目介绍" class="headerlink" title="P01_RAG系统项目介绍"></a>P01_RAG系统项目介绍</h1><h2 id="1-背景介绍【了解】"><a href="#1-背景介绍【了解】" class="headerlink" title="1 背景介绍【了解】"></a>1 背景介绍【了解】</h2><ul>
<li>业务：IT教育的答疑项目</li>
<li>技术：RAG【知识库+LLM】</li>
</ul>
<h2 id="2-RAG相关介绍【掌握】"><a href="#2-RAG相关介绍【掌握】" class="headerlink" title="2 RAG相关介绍【掌握】"></a>2 RAG相关介绍【掌握】</h2><h3 id="2-1-RAG概念"><a href="#2-1-RAG概念" class="headerlink" title="2.1 RAG概念"></a>2.1 RAG概念</h3><p>通⽤的基础⼤模型存在一些问题：</p>
<ul>
<li>幻觉问题，LLM有时会在回答中⽣成看似合理但实际上是错误的信息</li>
<li>LLM的知识不是实时的，模型训练好后不具备自动更新知识的能力，会导致部分信息滞后</li>
<li>LLM领域知识是缺乏的，大模型的知识来源于训练数据，这些数据主要来自公开的互联网和开源数据集，无法覆盖特定领域或高度专业化的内部知识</li>
</ul>
<p><strong>RAG是一种将大规模语言模型（LLM）与外部知识源的检索相结合，以改进问答能力的工程框架。</strong> 它使用来自私有或专有数据源的信息来辅助文本生成，从而弥补LLM的局限性，特别是在解决幻觉问题和提升时效性方面。</p>
<h3 id="2-2-RAG作用"><a href="#2-2-RAG作用" class="headerlink" title="2.2 RAG作用"></a>2.2 RAG作用</h3><blockquote>
<p><strong>缓解LLM“幻觉”问题</strong> ： LLM在生成文本时有时会“一本正经地胡说八道”，即生成听起来合理但实际上不准确或捏造的信息，这被称为“幻觉”。RAG通过提供外部事实依据，显著减少了这种幻觉现象，让LLM的输出更具 <strong>事实性</strong> 和 <strong>可靠性</strong> 。</p>
<p><strong>获取最新信息</strong> ：LLM的训练数据通常是静态的，这意味着它们无法获取到训练截止日期之后发生的事件或更新的信息。RAG允许LLM连接到实时或定期更新的外部数据源（如新闻、数据库、内部文档等），从而提供 <strong>最新、最及时</strong> 的答案。</p>
<p><strong>领域特定知识增强</strong> ：对于特定行业或企业内部的知识，LLM的通用训练数据往往不足。RAG能够将LLM与企业内部的知识库文档或特定领域的数据连接起来，使LLM能够回答高度专业化的问题，并提供 <strong>更符合上下文的答案</strong> 。</p>
<p><strong>降低模型微调成本</strong> ：传统上，为了让LLM适应特定任务或数据，需要进行昂贵的 <strong>微调（Fine-tuning）</strong>  。RAG提供了一种更<strong>经济高效</strong>的替代方案，它无需修改LLM的底层参数，只需更新外部知识库即可，大大降低了维护和更新模型的成本。</p>
<p><strong>提高答案的可解释性和溯源性</strong> ：RAG可以引用其获取信息的来源，这意味着用户可以查看LLM答案所依据的原始文档或数据，增强了答案的 <strong>透明度</strong> 和 <strong>用户信任度</strong> 。</p>
</blockquote>
<p>RAG通过将检索和生成相结合，既保留了传统检索问答的可靠性，又获得了LLM的灵活性和自然表达能力。<strong>它能让AI始终基于最新的、可信的知识来回答问题，同时保持对话的流畅自然。</strong></p>
<h3 id="2-3-RAG-的工作原理"><a href="#2-3-RAG-的工作原理" class="headerlink" title="2.3 RAG 的工作原理"></a>2.3 RAG 的工作原理</h3><h4 id="2-3-1-工作流程图解"><a href="#2-3-1-工作流程图解" class="headerlink" title="2.3.1 工作流程图解"></a>2.3.1 工作流程图解</h4><p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/ea6cd96e0248471ab6eed3232008b124.png" alt="img"></p>
<h4 id="2-3-2-RAG标准流程"><a href="#2-3-2-RAG标准流程" class="headerlink" title="2.3.2 RAG标准流程"></a>2.3.2 RAG标准流程</h4><p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/9aaecadf38c84ebc997c41f427280706.png" alt="img"></p>
<p>RAG 标准流程由索引（Indexing）、检索（Retriever）和生成（Generation）三个核心阶段组成。</p>
<ul>
<li><p>索引阶段，通过处理多种来源多种格式的文档提取其中文本，将其切分为标准长度的文本块（chunk），并进行嵌入向量化（embedding），向量存储在向量数据库（vector database）中。</p>
<ul>
<li><p>加载文件</p>
</li>
<li><p>内容提取</p>
</li>
<li><p>文本分割 ，形成chunk</p>
</li>
<li><p>文本向量化</p>
</li>
<li><p>将向量存储到向量数据库</p>
</li>
</ul>
</li>
<li><p>检索阶段，用户输入的查询（query）被转化为向量表示，通过相似度匹配从向量数据库中检索出最相关的文本块。</p>
<ul>
<li>query向量化</li>
<li>在文本向量中匹配出与问句向量相似的top_k个</li>
</ul>
</li>
<li><p>生成阶段，检索到的相关文本与原始查询共同构成提示词（Prompt），输入大语言模型（LLM），生成精确且具备上下文关联的回答。</p>
<ul>
<li>匹配出的文本作为上下文和问题一起添加到prompt中</li>
<li>提交给LLM生成答案</li>
</ul>
</li>
</ul>
<h2 id="3-项目流程【掌握】"><a href="#3-项目流程【掌握】" class="headerlink" title="3 项目流程【掌握】"></a>3 项目流程【掌握】</h2><p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009102949722.png" alt="image-20251009102949722"></p>
<p>（AI）学科在线答疑系统RAG主要步骤：</p>
<ul>
<li>第一步：将现有后台搜集的FQA数据集存储到Mysql数据库中</li>
<li>第二步：基于query实现Mysql数据库检索：将query和现有问题匹配（做相似度计算），如果阈值&gt;&#x3D;0.85，就认为问题比较明确，直接返回对应的答案；否则，进入RAG检索系统</li>
<li>第三步：搭建本地知识库：对本地文档加载读取；进行文档分割；文档向量化；存储向量数据库（Milvus）</li>
<li>第四步：基于query实现Milvus数据库检索：将query进行向量表示，并从Milvus数据库中检索出相似的top-k个文本段</li>
<li>第五步：将query和检索出的top-k文本段拼接，送入大模型，实现预测</li>
</ul>
<h2 id="4-项目结构【实现】"><a href="#4-项目结构【实现】" class="headerlink" title="4 项目结构【实现】"></a>4 项目结构【实现】</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">integrated_qa_system/</span><br><span class="line">├── config.ini                     # 配置文件，包含所有模块的配置</span><br><span class="line">├── base/</span><br><span class="line">│   ├── config.py              # 配置管理，加载 config.ini</span><br><span class="line">│   ├── logger.py              # 日志设置</span><br><span class="line">├── rag_qa/</span><br><span class="line">│   ├── core/</span><br><span class="line">│   │   ├── prompts.py         # RAG 提示模板</span><br><span class="line">│   │   ├── query_classifier.py # 查询分类器</span><br><span class="line">│   │   ├── strategy_selector.py # 检索策略选择器</span><br><span class="line">│   │   ├── vector_store.py    # 向量存储与检索</span><br><span class="line">│   │   ├── rag_system.py      # RAG 系统核心逻辑</span><br><span class="line">│   ├── main.py                # RAG 系统独立入口，支持存储和查询</span><br><span class="line">├── mysql_qa/</span><br><span class="line">│   ├── db/</span><br><span class="line">│   │   ├── mysql_client.py    # MySQL 数据库操作</span><br><span class="line">│   ├── cache/</span><br><span class="line">│   │   ├── redis_client.py    # Redis 缓存操作</span><br><span class="line">│   ├── retrieval/</span><br><span class="line">│   │   ├── bm25_search.py     # BM25 搜索</span><br><span class="line">│   ├── utils/</span><br><span class="line">│   │   ├── preprocess.py      # 文本预处理</span><br><span class="line">│   ├── main.py                # MySQL 系统独立入口，支持查询</span><br><span class="line">├── main.py                    # 集成系统入口，结合 RAG 和 MySQL</span><br><span class="line">├── requirements.txt           # 依赖文件</span><br><span class="line">└── logs/</span><br><span class="line">    └── app.log                # 日志文件</span><br></pre></td></tr></table></figure>



<h2 id="5-环境配置【实现】"><a href="#5-环境配置【实现】" class="headerlink" title="5 环境配置【实现】"></a>5 环境配置【实现】</h2><h3 id="5-1-python环境"><a href="#5-1-python环境" class="headerlink" title="5.1 python环境"></a>5.1 python环境</h3><ul>
<li>虚拟环境</li>
</ul>
<p>为了不影响之前的python环境，也为了新项目中不会出现环境问题，需要新安装一个新的python环境。</p>
<p>如果之前虚拟环境是安装在C盘，C盘空间不足了，可以按下面的文档设置，安装到新的盘。<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_64878779/article/details/143457384?spm=1001.2014.3001.5506">https://blog.csdn.net/weixin_64878779/article/details/143457384?spm=1001.2014.3001.5506</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开conda终端后，设置镜像</span></span><br><span class="line">pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装虚拟环境</span></span><br><span class="line">conda create -n edu_rag python`3.10.18</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">激活虚拟环境</span></span><br><span class="line">conda activate edu_rag</span><br></pre></td></tr></table></figure>

<ul>
<li>安装全部依赖</li>
</ul>
<p>先在终端执行位置创建一个文件 requirements.txt，里边的内容如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ollama`0.4.4</span></span><br><span class="line"><span class="attr">requests`2.32.3</span></span><br><span class="line"><span class="attr">langchain`0.3.10</span></span><br><span class="line"><span class="attr">langchain_community`0.3.27</span></span><br><span class="line"><span class="attr">langchain-ollama`0.3.6</span></span><br><span class="line"><span class="attr">numexpr`2.11.0</span></span><br><span class="line"><span class="attr">unstructured`0.11.0</span></span><br><span class="line"><span class="attr">nltk`3.9.1</span></span><br><span class="line"><span class="attr">chromadb`1.0.15</span></span><br><span class="line"><span class="attr">faiss-cpu`1.12.0</span></span><br><span class="line"><span class="attr">pymilvus`2.5.4</span></span><br><span class="line"><span class="attr">pandas`2.3.1</span></span><br><span class="line"><span class="attr">jieba</span></span><br><span class="line"><span class="attr">rank_bm25`0.2.2</span></span><br><span class="line"><span class="attr">redis`5.3.1</span></span><br><span class="line"><span class="attr">pymysql`1.1.1</span></span><br><span class="line"><span class="attr">opencv-python`4.10.0.84</span></span><br><span class="line"><span class="attr">PyMuPDF`1.23.16</span></span><br><span class="line"><span class="attr">python-docx`1.1.2</span></span><br><span class="line"><span class="attr">pillow`11.1.0</span></span><br><span class="line"><span class="attr">rapidocr-onnxruntime`1.4.4</span></span><br><span class="line"><span class="attr">python-pptx`0.6.23</span></span><br><span class="line"><span class="attr">transformers`4.45.0</span></span><br><span class="line"><span class="attr">modelscope`1.23.0</span></span><br><span class="line"><span class="attr">addict`2.4.0</span></span><br><span class="line"><span class="attr">datasets`3.3.1</span></span><br><span class="line"><span class="attr">simplejson`3.19.2</span></span><br><span class="line"><span class="attr">sortedcontainers`2.4.0</span></span><br><span class="line"><span class="attr">markdown`3.6</span></span><br><span class="line"><span class="attr">sentence-transformers`3.0.1</span></span><br><span class="line"><span class="attr">milvus-model`0.2.5</span></span><br><span class="line"><span class="attr">tiktoken`0.7.0</span></span><br><span class="line"><span class="attr">sentencepiece`0.2.0</span></span><br><span class="line"><span class="attr">ragas`0.2.6</span></span><br><span class="line"><span class="attr">starlette`0.46.2</span></span><br><span class="line"><span class="attr">fastapi`0.115.12</span></span><br></pre></td></tr></table></figure>

<p>然后执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>如果电脑支持GPU，可以按照之前讲过的方法安装不高于CUDA版本的torch等三方包，比如（cu121为cuda的版本）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121</span><br></pre></td></tr></table></figure>



<h3 id="5-2-相关工具介绍"><a href="#5-2-相关工具介绍" class="headerlink" title="5.2 相关工具介绍"></a>5.2 相关工具介绍</h3><p>Ollama：一个开源的大型语言模型服务工具，用于快速在本地运行大模型。</p>
<p>LangChain：为各种LLMs实现通用的接口，把LLMs相关的组件“链接”在一起，简化LLMs应用的开发难度，方便开发者快速地开发复杂的LLMs应用。</p>
<p>Milvus：一个开源向量数据库，用于实现向量数据的存储和检索。</p>
<p>MySQL&#x2F;Redis：分别为关系型数据库和内存数据库，用于实现缓存高频问答对，加快回复效率。</p>
<h1 id="LangChain"><a href="#LangChain" class="headerlink" title="LangChain"></a>LangChain</h1><h2 id="1-简述【理解】"><a href="#1-简述【理解】" class="headerlink" title="1 简述【理解】"></a>1 简述【理解】</h2><h3 id="1-1-什么是LangChain"><a href="#1-1-什么是LangChain" class="headerlink" title="1.1 什么是LangChain"></a>1.1 什么是LangChain</h3><p>LangChain是一个框架，来帮助开发者快速开发智能应用。</p>
<p>参考官网介绍：</p>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/introduction/">https://python.langchain.com/docs/introduction/</a></p>
<p>LangChain 简化了 LLM 应用程序生命周期的每个阶段：</p>
<ul>
<li>开发：使用 LangChain 的开源组件和第三方集成构建应用程序。使用 LangGraph 构建具有一流流式和人机交互支持的状态智能体。</li>
<li>生产化：使用 LangSmith 检查、监控和评估应用程序，方便持续优化和部署。</li>
<li>部署：使用 LangGraph平台 将应用程序转变为可用于生产的 API 和助手。</li>
</ul>
<h3 id="1-2-主要组件"><a href="#1-2-主要组件" class="headerlink" title="1.2 主要组件"></a>1.2 主要组件</h3><p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250703152303288.png" alt="image-20250703152303288"></p>
<ul>
<li>Models：模型，各种类型的模型和模型集成，比如GPT-4</li>
<li>Prompts：提示，包括提示管理、提示优化和提示序列化</li>
<li>Memory：记忆，用来保存和模型交互时的上下文状态</li>
<li>Indexes：索引，用来结构化文档，以便和模型交互</li>
<li>Chains：链，一系列对各种组件的调用</li>
<li>Agents：代理，决定模型采取哪些行动，执行并且观察流程，直到完成为止</li>
</ul>
<h3 id="1-3-LangChain核心包"><a href="#1-3-LangChain核心包" class="headerlink" title="1.3 LangChain核心包"></a>1.3 LangChain核心包</h3><p>langchain-core：聊天模型和其他组件的基础抽象。</p>
<p>集成包（例如 langchain-openai、langchain-anthropic 等）：重要的集成被拆分为轻量级的独立包，由 LangChain 团队和集成方共同维护。</p>
<p>langchain：包含链（chains）、智能体（agents）和检索策略，这些构成了应用的认知架构。</p>
<p>langchain-community：由社区维护的第三方集成。</p>
<p>langgraph：一个编排框架，用于将 LangChain 组件组合成可用于生产的应用，支持持久化、流式处理及其他关键特性。</p>
<h2 id="2-Models【熟悉】"><a href="#2-Models【熟悉】" class="headerlink" title="2 Models【熟悉】"></a>2 Models【熟悉】</h2><h3 id="2-1-LLMs-大语言模型"><a href="#2-1-LLMs-大语言模型" class="headerlink" title="2.1 LLMs (大语言模型)"></a>2.1 LLMs (大语言模型)</h3><p>LLMs使用场景最多，常用大模型的下载库：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://huggingface.co/models">https://huggingface.co/models</a></p>
<p><a target="_blank" rel="noopener" href="https://modelscope.cn/models">https://modelscope.cn/models</a></p>
</blockquote>
<p>下面Qwen为例进行讲解。</p>
<hr>
<p>模型调用有2种方式：</p>
<ul>
<li>通过ChatOpenAI进行调用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">import</span>  os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个ChatOpenAI对象</span></span><br><span class="line">llm = ChatOpenAI(base_url=os.environ.get(<span class="string">&#x27;DASHSCOPE_BASE_URL&#x27;</span>),</span><br><span class="line">                 model=os.environ.get(<span class="string">&#x27;DASHSCOPE_MODEL_NAME&#x27;</span>),</span><br><span class="line">                 api_key=os.environ.get(<span class="string">&#x27;DASHSCOPE_API_KEY&#x27;</span>),</span><br><span class="line">                 temperature=<span class="number">0.7</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用模型</span></span><br><span class="line">result = llm.invoke(<span class="string">&quot;帮我讲个笑话吧&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result.content)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>通过ChatTongyi进行调用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line"><span class="comment"># base_url和api_key可以不用显示设置，它们会自动从环境变量中获取</span></span><br><span class="line">llm = ChatTongyi(model=os.environ.get(<span class="string">&#x27;DASHSCOPE_MODEL_NAME&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用模型</span></span><br><span class="line">result = llm.invoke(<span class="string">&quot;帮我讲个笑话吧&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result.content)</span><br></pre></td></tr></table></figure>



<h3 id="2-2-Chat-Models-聊天模型"><a href="#2-2-Chat-Models-聊天模型" class="headerlink" title="2.2 Chat Models (聊天模型)"></a>2.2 Chat Models (聊天模型)</h3><p>聊天消息包含下面几种类型，使用时需要按照约定传入合适的值：</p>
<ul>
<li><p>AIMessage: 就是 AI 输出的消息，可以是针对问题的回答.</p>
</li>
<li><p>HumanMessage: 人类消息就是用户信息，由人给出的信息发送给LLMs的提示信息，比如“实现一个快速排序方法”.</p>
</li>
<li><p>SystemMessage: 可以用于指定模型具体所处的环境和背景，如角色扮演等。你可以在这里给出具体的指示，比如“作为一个代码专家”，或者“返回json格式”.</p>
</li>
<li><p>ChatMessage: Chat 消息可以接受任意角色的参数，但是在大多数时间，我们应该使用上面的三种类型.</p>
</li>
</ul>
<p>LangChain支持大量的chat 模型,可以通过官网查询：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/chat/">https://python.langchain.com/docs/integrations/chat/</a></p>
</blockquote>
<ul>
<li>SystemMessage+HumanMessage+AIMessage</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> SystemMessage,HumanMessage,AIMessage</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">chat = ChatTongyi()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义message</span></span><br><span class="line"><span class="comment"># 1)只有HumanMessage</span></span><br><span class="line"><span class="comment"># message = [HumanMessage(content=&quot;给我写一首唐诗&quot;)]</span></span><br><span class="line"><span class="comment"># print(f&#x27;message--&gt;&#123;message&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2)SystemMessage+HumanMessage</span></span><br><span class="line"><span class="comment"># message = [SystemMessage(content=&quot;你是一个田园诗人&quot;),HumanMessage(content=&quot;给我写一首唐诗，请尊重版权，不要抄袭&quot;)]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3)SystemMessage+HumanMessage+AIMessage</span></span><br><span class="line">message = [SystemMessage(content=<span class="string">&quot;你是一个田园诗人&quot;</span>),</span><br><span class="line">           HumanMessage(content=<span class="string">&quot;给我写一首唐诗，请尊重版权，不要抄袭&quot;</span>),</span><br><span class="line">           AIMessage(content=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">           闲步柴门外，斜阳照野田。  </span></span><br><span class="line"><span class="string">风轻花影动，水静月光圆。  </span></span><br><span class="line"><span class="string">老树鸣蝉歇，新荷映日鲜。  </span></span><br><span class="line"><span class="string">心随云去远，不问世间缘。</span></span><br><span class="line"><span class="string">           &quot;&quot;&quot;</span>),</span><br><span class="line">           HumanMessage(content=<span class="string">&quot;请继续写诗&quot;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用模型</span></span><br><span class="line">response = chat.invoke(message)</span><br><span class="line"><span class="built_in">print</span>(response.content)</span><br></pre></td></tr></table></figure>



<h3 id="2-3-Embeddings-Models-嵌入模型）"><a href="#2-3-Embeddings-Models-嵌入模型）" class="headerlink" title="2.3 Embeddings Models(嵌入模型）"></a>2.3 Embeddings Models(嵌入模型）</h3><p>Embedding的作用就是将数据进行文本向量化</p>
<p>不同的Embedding模型对多语言支持和文本类型有不同的特点：</p>
<ul>
<li><strong>多语言支持</strong>：<ul>
<li><code>text-embedding-ada-002</code>：支持多种语言，但对中文等亚洲语言的支持相对较弱</li>
<li><code>bge-large-zh</code>：对中文有很好的支持</li>
<li><code>multilingual-e5-large</code>：对多语言都有较好的支持</li>
</ul>
</li>
<li><strong>文本类型适用性</strong>：<ul>
<li>代码文本：建议使用专门的代码Embedding模型，如 <code>CodeBERT</code></li>
<li>通用文本：可以使用<code>text-embedding-ada-002</code>或 <code>bge-large-zh</code></li>
<li>专业领域文本：建议使用该领域的专门模型</li>
</ul>
</li>
</ul>
<p>可以参考MTEB（大规模文本嵌入基准）排行榜以获取最新模型效果：<a target="_blank" rel="noopener" href="https://huggingface.co/spaces/mteb/leaderboard">https://huggingface.co/spaces/mteb/leaderboard</a></p>
<p>接下来以一个文本嵌入模型的例子进行说明：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">embed = DashScopeEmbeddings()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单个文档嵌入</span></span><br><span class="line">doc_embedding = embed.embed_query(<span class="string">&quot;Embeddings Models可以为文本创建向量映射，这样就能在向量空间里去考虑文本，执行诸如语义搜索之类的操作，比如说寻找相似的文本片段。&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(doc_embedding)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(doc_embedding))  <span class="comment"># 1536</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个文档嵌入</span></span><br><span class="line">doc_embeddings = embed.embed_documents([<span class="string">&quot;Embeddings Models特点：将字符串作为输入，返回一个浮动数的列表。&quot;</span>, <span class="string">&quot;在NLP中，Embedding的作用就是将数据进行文本向量化。&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(doc_embeddings)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(doc_embeddings))  <span class="comment"># 2</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009153337258.png" alt="image-20251009153337258"></p>
<h2 id="3-Prompts【掌握】"><a href="#3-Prompts【掌握】" class="headerlink" title="3 Prompts【掌握】"></a>3 Prompts【掌握】</h2><h3 id="3-1-通用prompt"><a href="#3-1-通用prompt" class="headerlink" title="3.1 通用prompt"></a>3.1 通用prompt</h3><p>Prompt是指当用户输入信息给模型时加入的提示，这个提示的形式可以是zero-shot或者few-shot等方式，目的是让模型理解更为复杂的业务场景以便更好的解决问题。</p>
<p>提示模板：如果你有了一个起作用的提示，你可能想把它作为一个模板用于解决其他问题，LangChain就提供了PromptTemplates组件，它可以帮助你更方便的构建提示。</p>
<ul>
<li><strong>zero-shot提示方式</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义提示词模版，并进行变量替换</span></span><br><span class="line">template = <span class="string">&quot;我的邻居姓&#123;lastname&#125;，他生了个儿子，给他儿子起个名字&quot;</span></span><br><span class="line">prompt_template = PromptTemplate(template=template, input_variables=[<span class="string">&quot;lastname&quot;</span>])</span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line">prompt = prompt_template.<span class="built_in">format</span>(lastname=<span class="string">&quot;王&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># prompt = prompt_template.format(lastname=&quot;王&quot;)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;prompt--&gt;<span class="subst">&#123;prompt&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型调用</span></span><br><span class="line">result = model.invoke(prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result.content&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009154834640.png" alt="image-20251009154834640"></p>
<ul>
<li><strong>few-shot提示方式</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate, FewShotPromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = Tongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">examples = [</span><br><span class="line">    &#123;<span class="string">&quot;word&quot;</span>: <span class="string">&quot;开心&quot;</span>, <span class="string">&quot;antonym&quot;</span>: <span class="string">&quot;难过&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;word&quot;</span>: <span class="string">&quot;高&quot;</span>, <span class="string">&quot;antonym&quot;</span>: <span class="string">&quot;矮&quot;</span>&#125;,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 示例提示词字符串</span></span><br><span class="line">example_template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">单词: &#123;word&#125;</span></span><br><span class="line"><span class="string">反义词: &#123;antonym&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建示例提示词模版</span></span><br><span class="line">example_prompt = PromptTemplate(template=example_template, input_variables=[<span class="string">&quot;word&quot;</span>, <span class="string">&quot;antonym&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建few_shot_prompt模版</span></span><br><span class="line">few_shot_prompt = FewShotPromptTemplate(example_prompt=example_prompt,</span><br><span class="line">                                        examples=examples,</span><br><span class="line">                                        example_separator=<span class="string">&quot;&quot;</span>,</span><br><span class="line">                                        prefix=<span class="string">&quot;请给出单词的反义词，以下是一些示例：&quot;</span>,</span><br><span class="line">                                        suffix=<span class="string">&quot;\n单词：&#123;input&#125;\n反义词:&quot;</span>,</span><br><span class="line">                                        input_variables=[<span class="string">&quot;input&quot;</span>]</span><br><span class="line">                                        )</span><br><span class="line">prompt = few_shot_prompt.<span class="built_in">format</span>(<span class="built_in">input</span>=<span class="string">&quot;富有&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;prompt--&gt;<span class="subst">&#123;prompt&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型预测</span></span><br><span class="line">result = model.invoke(prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009160049585.png" alt="image-20251009160049585" style="zoom:50%;" />



<h3 id="3-2-chatprompts"><a href="#3-2-chatprompts" class="headerlink" title="3.2 chatprompts"></a>3.2 chatprompts</h3><p> 适合交互式对话应用，如聊天机器人、智能客服等，这些应用需要处理用户和LLM之间的多轮对话。</p>
<blockquote>
<p>ChatPromptTemplate</p>
<p>SystemMessagePromptTemplate</p>
<p>HumanMessagePromptTemplate</p>
<p>history&#x3D;[(“system”,”……”),(‘human’,”……”),(“ai”,”……”)]</p>
</blockquote>
<ul>
<li><strong>直接提问</strong></li>
</ul>
<p>提示模板就是把一些常见的提示整理成模板，用户只需要修改模板中特定的词语，就能快速准确地告诉模型自己的需求。我们看个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义提示词模版，并进行变量替换</span></span><br><span class="line">template = <span class="string">&quot;我的邻居姓&#123;lastname&#125;，他生了个儿子，给他儿子起个名字&quot;</span></span><br><span class="line">prompt_template = ChatPromptTemplate.from_template(template)</span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line">prompt = prompt_template.format_messages(lastname=<span class="string">&quot;王&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;prompt--&gt;<span class="subst">&#123;prompt&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型调用</span></span><br><span class="line">result = model.invoke(prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result.content&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009162440497.png" alt="image-20251009162440497"></p>
<ul>
<li><strong>zero-shot提示方式</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> SystemMessage</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, HumanMessagePromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统消息</span></span><br><span class="line">system_prompt = SystemMessage(<span class="string">&quot;你是一个取名专家&quot;</span>)</span><br><span class="line"><span class="comment"># 定义提示词模版，并进行变量替换</span></span><br><span class="line">template = <span class="string">&quot;我的邻居姓&#123;lastname&#125;，他生了个儿子，给他儿子起个名字&quot;</span></span><br><span class="line">prompt_template = HumanMessagePromptTemplate.from_template(template)</span><br><span class="line"><span class="comment"># 将系统消息和用户的提示词模版组装</span></span><br><span class="line">chat_template = ChatPromptTemplate.from_messages([system_prompt, prompt_template])</span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line">prompt = chat_template.format_messages(lastname=<span class="string">&quot;王&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;prompt--&gt;<span class="subst">&#123;prompt&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型调用</span></span><br><span class="line">result = model.invoke(prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result.content&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009163147122.png" alt="image-20251009163147122"></p>
<ul>
<li><strong>few-shot提示方式</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage, AIMessage</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, MessagesPlaceholder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建提示词模版</span></span><br><span class="line">prompt_template = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;给出每个单词的反义词&quot;</span>),</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;history&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>)</span><br><span class="line">])</span><br><span class="line"><span class="comment"># 创建history</span></span><br><span class="line"><span class="comment"># history = [HumanMessage(content=&quot;开心&quot;),</span></span><br><span class="line"><span class="comment">#            AIMessage(content=&quot;难过&quot;),</span></span><br><span class="line"><span class="comment">#            HumanMessage(content=&quot;高&quot;),</span></span><br><span class="line"><span class="comment">#            AIMessage(content=&quot;矮&quot;)]</span></span><br><span class="line"><span class="comment"># 简写的方式    &#x27;human&#x27;, &#x27;user&#x27;, &#x27;ai&#x27;, &#x27;assistant&#x27;, &#x27;function&#x27;, &#x27;tool&#x27;, &#x27;system&#x27;, or &#x27;developer&#x27;</span></span><br><span class="line">history = [(<span class="string">&quot;human&quot;</span>, <span class="string">&quot;开心&quot;</span>), (<span class="string">&quot;ai&quot;</span>, <span class="string">&quot;难过&quot;</span>), (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;高&quot;</span>), (<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;矮&quot;</span>)]</span><br><span class="line">prompt = prompt_template.format_messages(history=history, <span class="built_in">input</span>=<span class="string">&#x27;富有&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;prompt--&gt;<span class="subst">&#123;prompt&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型调用</span></span><br><span class="line">response = model.invoke(prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;response--&gt;<span class="subst">&#123;response.content&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009164121143.png" alt="image-20251009164121143"></p>
<h2 id="4-Chains【掌握】"><a href="#4-Chains【掌握】" class="headerlink" title="4 Chains【掌握】"></a>4 Chains【掌握】</h2><h3 id="4-1-chain"><a href="#4-1-chain" class="headerlink" title="4.1 chain"></a>4.1 chain</h3><p>在LangChain中，Chains描述了将LLM与其他组件结合起来完成一个应用程序的过程。<br>针对上一小节的提示模版例子，zero-shot里面，我们可以用链来连接提示模版组件和模型，进而可以实现代码的更改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.llm <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义提示词模版，并进行变量替换</span></span><br><span class="line">template = <span class="string">&quot;我的邻居姓&#123;lastname&#125;，他生了个儿子，给他儿子起个名字&quot;</span></span><br><span class="line">prompt_template = PromptTemplate(template=template, input_variables=[<span class="string">&quot;lastname&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># # 替换</span></span><br><span class="line"><span class="comment"># prompt = prompt_template.format(lastname=&quot;王&quot;)</span></span><br><span class="line"><span class="comment"># print(f&#x27;prompt--&gt;&#123;prompt&#125;&#x27;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># # 模型调用</span></span><br><span class="line"><span class="comment"># result = model.invoke(prompt)</span></span><br><span class="line"><span class="comment"># print(f&#x27;result--&gt;&#123;result.content&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组装链</span></span><br><span class="line">chain = LLMChain(llm=model, prompt=prompt_template)</span><br><span class="line"><span class="comment"># 模型调用</span></span><br><span class="line">result = chain.invoke(<span class="built_in">input</span>=&#123;<span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;王&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>如果你想将第一个模型输出的结果，直接作为第二个模型的输入，还可以使用LangChain的SimpleSequentialChain, 代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.llm <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.sequential <span class="keyword">import</span> SimpleSequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建第一条链</span></span><br><span class="line">template1 = <span class="string">&quot;我的邻居姓&#123;lastname&#125;，他生了个儿子，给他儿子起个名字&quot;</span></span><br><span class="line">prompt_template1 = PromptTemplate(template=template1, input_variables=[<span class="string">&quot;lastname&quot;</span>])</span><br><span class="line">chain1 = LLMChain(llm=model, prompt=prompt_template1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建第二条链</span></span><br><span class="line">template2 = <span class="string">&quot;邻居的儿子名字叫&#123;child_name&#125;，给他起一个小名&quot;</span></span><br><span class="line">prompt_template2 = PromptTemplate(template=template2, input_variables=[<span class="string">&quot;child_name&quot;</span>])</span><br><span class="line">chain2 = LLMChain(llm=model, prompt=prompt_template2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将两条链连接起来</span></span><br><span class="line"><span class="comment"># verbose=True 表示输出推理过程</span></span><br><span class="line">final_chain = SimpleSequentialChain(chains=[chain1, chain2], verbose=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;final_chain--&gt;<span class="subst">&#123;final_chain&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链调用，只需要传入第一个链的输入参数</span></span><br><span class="line">result = final_chain.invoke(<span class="string">&quot;王&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009172755215.png" alt="image-20251009172755215"></p>
<p>思考过程：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009172929068.png" alt="image-20251009172929068"></p>
<p>最终结果:</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009172942290.png" alt="image-20251009172942290"></p>
<h3 id="4-2-LCEL"><a href="#4-2-LCEL" class="headerlink" title="4.2 LCEL"></a>4.2 LCEL</h3><p>LCEL（Lang Chain Expression Language） 是一种声明式的方法，用于轻松组合链条。</p>
<p>LCEL的基本语法规则是使用<code>|</code>符号将不同的组件连接起来，形成一个链式结构。<code>|</code>符号类似于Unix的管道操作符，它将一个组件的输出作为下一个组件的输入，从而实现数据的传递和处理。</p>
<p>上一个组件的输出作为下一个组件的输入，输出和输入的类型必须保持一致，否则不能连接。</p>
<p>我们改造一下前面2个chain：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.llm <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义提示词模版，并进行变量替换</span></span><br><span class="line">template = <span class="string">&quot;我的邻居姓&#123;lastname&#125;，他生了个儿子，给他儿子起个名字&quot;</span></span><br><span class="line">prompt_template = PromptTemplate(template=template, input_variables=[<span class="string">&quot;lastname&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 组装链</span></span><br><span class="line"><span class="comment"># chain = LLMChain(llm=model, prompt=prompt_template)</span></span><br><span class="line">chain = prompt_template | model</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型调用</span></span><br><span class="line">result = chain.invoke(<span class="built_in">input</span>=&#123;<span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;王&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.llm <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.sequential <span class="keyword">import</span> SimpleSequentialChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建第一条链</span></span><br><span class="line">template1 = <span class="string">&quot;我的邻居姓&#123;lastname&#125;，他生了个儿子，给他儿子起个名字&quot;</span></span><br><span class="line">prompt_template1 = PromptTemplate(template=template1, input_variables=[<span class="string">&quot;lastname&quot;</span>])</span><br><span class="line"><span class="comment"># chain1 = LLMChain(llm=model, prompt=prompt_template1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建第二条链</span></span><br><span class="line">template2 = <span class="string">&quot;邻居的儿子名字叫&#123;child_name&#125;，给他起一个小名&quot;</span></span><br><span class="line">prompt_template2 = PromptTemplate(template=template2, input_variables=[<span class="string">&quot;child_name&quot;</span>])</span><br><span class="line"><span class="comment"># chain2 = LLMChain(llm=model, prompt=prompt_template2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 将两条链连接起来</span></span><br><span class="line"><span class="comment"># # verbose=True 表示输出推理过程</span></span><br><span class="line"><span class="comment"># final_chain = SimpleSequentialChain(chains=[chain1, chain2], verbose=True)</span></span><br><span class="line"><span class="comment"># print(f&#x27;final_chain--&gt;&#123;final_chain&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建chain</span></span><br><span class="line">final_chain = prompt_template1 | model | prompt_template2 | model</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链调用，只需要传入第一个链的输入参数</span></span><br><span class="line">result = final_chain.invoke(<span class="string">&quot;王&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251009173901308.png" alt="image-20251009173901308"></p>
<h2 id="5-Output-parsers【了解】"><a href="#5-Output-parsers【了解】" class="headerlink" title="5 Output parsers【了解】"></a>5 Output parsers【了解】</h2><p> LLM 的输出是自然语言文本，但在应用开发中，我们经常需要将这些文本转换为结构化的数据格式，如列表、字典或对象。LangChain 输出解析器负责获取 LLM 的输出并将其转换为更合适的格式。</p>
<p>部分解析器如下：</p>
<table>
<thead>
<tr>
<th>解析器名称</th>
<th>核心功能</th>
<th>输出的 Python 类型</th>
<th>工业级应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>StrOutputParser</td>
<td>默认解析器。将 LLM 的输出直接解析为字符串。</td>
<td>str</td>
<td>只需要原始回答时（如问答任务、对话场景）</td>
</tr>
<tr>
<td>CommaSeparatedListParser</td>
<td>将 LLM 输出的、用逗号分隔的文本解析为列表。</td>
<td>list[str]</td>
<td>列表&#x2F;枚举型输出</td>
</tr>
<tr>
<td>JsonOutputParser</td>
<td>极其常用。将 LLM 输出的 JSON 字符串解析为 Python 字典。</td>
<td>dict</td>
<td>结构化 JSON 输出</td>
</tr>
<tr>
<td>PydanticOutputParser</td>
<td>极其常用。将 LLM 输出解析为预先定义的 Pydantic 对象，提供类型安全和数据验证。</td>
<td>自定义的 pydantic.BaseModel 对象</td>
<td>输出需要严格结构化（JSON-like）数据时</td>
</tr>
<tr>
<td>DatetimeOutputParser</td>
<td>从文本中智能地解析出日期和时间信息。</td>
<td>datetime.datetime</td>
<td>需要时间格式时</td>
</tr>
</tbody></table>
<h2 id="6-Memory【理解】"><a href="#6-Memory【理解】" class="headerlink" title="6 Memory【理解】"></a>6 Memory【理解】</h2><p>大模型本身不具备上下文的概念，它并不保存上次交互的内容，ChatGPT之所以能够和人正常沟通对话，因为它进行了一层封装，将历史记录回传给了模型。</p>
<p>因此 LangChain 也提供了Memory组件, Memory分为两种类型： <strong>短期记忆和长期记忆</strong> 。短期记忆一般指单一会话时传递数据，长期记忆则是处理多个会话时获取和更新信息。</p>
<ul>
<li>方法一：使用 <strong>ChatMessageHistory</strong> 手动添加上下文</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_message_histories <span class="keyword">import</span> ChatMessageHistory</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> messages_to_dict, messages_from_dict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.创建一个ChatMessageHistory对象，用来存储对话信息</span></span><br><span class="line">history = ChatMessageHistory()</span><br><span class="line">history.add_user_message(<span class="string">&quot;你好&quot;</span>)  <span class="comment"># 添加用户消息</span></span><br><span class="line">history.add_ai_message(<span class="string">&quot;您好&quot;</span>)  <span class="comment"># 添加AI消息</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;history--&gt;<span class="subst">&#123;history&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;history.messages--&gt;<span class="subst">&#123;history.messages&#125;</span>&#x27;</span>)  <span class="comment"># 内部的存储方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 2.可以将history.messages中的信息保存到字典中，然后保存到数据库或者文件中，方便后续读取</span></span><br><span class="line"><span class="comment"># # 2.1 messages_to_dict()方法将history.messages保存成字典</span></span><br><span class="line"><span class="comment"># dict_data = messages_to_dict(history.messages)</span></span><br><span class="line"><span class="comment"># print(f&#x27;dict_data--&gt;&#123;dict_data&#125;&#x27;)</span></span><br><span class="line"><span class="comment"># # 2.2 将字典保存到文件中</span></span><br><span class="line"><span class="comment"># with open(&#x27;history.json&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) as f:</span></span><br><span class="line"><span class="comment">#     f.write(json.dumps(dict_data, ensure_ascii=False, indent=4))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.从文件中读取出字典，然后将字典转换成消息</span></span><br><span class="line"><span class="comment"># 3.1 从文件中读取字典</span></span><br><span class="line">message_dict = json.load(<span class="built_in">open</span>(<span class="string">&#x27;history.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;message_dict--&gt;<span class="subst">&#123;message_dict&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># 3.2 将字典转换成消息</span></span><br><span class="line">messages = messages_from_dict(message_dict)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;messages--&gt;<span class="subst">&#123;messages&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010090731599.png" alt="image-20251010090731599"></p>
<hr>
<ul>
<li>方法二：使用 <strong>ConversationChain</strong> 自动保存用户和AI的历史交互内容，作为后续回复的上下文</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.conversation.base <span class="keyword">import</span> ConversationChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"><span class="comment"># 实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>, temperature=<span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化会话链，需要将模型传入</span></span><br><span class="line">conversation = ConversationChain(llm=model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用会话链</span></span><br><span class="line">result1 = conversation.predict(<span class="built_in">input</span>=<span class="string">&quot;小明有1只猫&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result1--&gt;<span class="subst">&#123;result1&#125;</span>&#x27;</span>)</span><br><span class="line">result2 = conversation.predict(<span class="built_in">input</span>=<span class="string">&quot;小明有2只狗&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result2--&gt;<span class="subst">&#123;result2&#125;</span>&#x27;</span>)</span><br><span class="line">result3 = conversation.predict(<span class="built_in">input</span>=<span class="string">&quot;小明家一共有几只宠物&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result3--&gt;<span class="subst">&#123;result3&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取会话历史</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;*&#x27;</span>*<span class="number">50</span>)</span><br><span class="line"><span class="built_in">print</span>(conversation.memory.buffer)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010092910969.png" alt="image-20251010092910969"></p>
<h2 id="7-Indexes【掌握】"><a href="#7-Indexes【掌握】" class="headerlink" title="7 Indexes【掌握】"></a>7 Indexes【掌握】</h2><p>Indexes组件的目的是让LangChain具备处理文档处理的能力，包括：文档加载、检索等。注意，这里的文档不局限于txt、pdf等文本类内容，还涵盖email、区块链、视频等内容。</p>
<p>Indexes组件主要包含类型：</p>
<ul>
<li>文档加载器</li>
<li>文本分割器</li>
<li>VectorStores</li>
<li>检索器</li>
</ul>
<h3 id="7-1-文档加载器"><a href="#7-1-文档加载器" class="headerlink" title="7.1 文档加载器"></a>7.1 文档加载器</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/v0.2/docs/introduction/">https://python.langchain.com/v0.2/docs/introduction/</a></p>
</blockquote>
<p>文档加载器主要基于<code>Unstructured</code> 包，<code>Unstructured</code> 是一个python包，可以把各种类型的文件转换成文本。文档加载器使用起来很简单，只需要引入相应的loader工具。</p>
<p>LangChain支持的文档加载器 (部分)：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250705100227413.png" alt="image-20250705100227413"></p>
<p>示例代码：</p>
<blockquote>
<p> 需要安装的包：</p>
<p> pip install unstructured</p>
<p> pip install langchain-unstructured</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_unstructured <span class="keyword">import</span> UnstructuredLoader</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 UnstructuredLoader 对象</span></span><br><span class="line">loader = UnstructuredLoader(<span class="string">&#x27;./langchain_data/衣服属性.txt&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="comment"># 加载</span></span><br><span class="line">docs = loader.load()  <span class="comment"># 默认将每行数据存储为 Document 对象</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;docs--&gt;<span class="subst">&#123;docs&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;docs--&gt;<span class="subst">&#123;<span class="built_in">len</span>(docs)&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># 第一行数据</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;docs[0].page_content--&gt;<span class="subst">&#123;docs[<span class="number">0</span>].page_content&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;*&#x27;</span>*<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> TextLoader</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 TextLoader 对象</span></span><br><span class="line">loader = TextLoader(<span class="string">&#x27;./langchain_data/衣服属性.txt&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="comment"># 加载</span></span><br><span class="line">docs = loader.load()  <span class="comment"># 默认将 每个文件数据存储为 Document 对象</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;docs--&gt;<span class="subst">&#123;docs&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;docs--&gt;<span class="subst">&#123;<span class="built_in">len</span>(docs)&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># # 第一行数据</span></span><br><span class="line"><span class="built_in">print</span>(docs[<span class="number">0</span>].page_content.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010095456457.png" alt="image-20251010095456457"></p>
<h3 id="7-2-文档分割器"><a href="#7-2-文档分割器" class="headerlink" title="7.2 文档分割器"></a>7.2 文档分割器</h3><p>由于模型对输入的字符长度有限制，我们在碰到很长的文本时，需要把文本分割成多个小的文本片段。</p>
<p>文本分割最简单的方式是按照字符长度进行分割，但是这会带来很多问题，比如说如果文本是一段代码，一个函数被分割到两段之后就成了没有意义的字符，所以整体的原则是把语义相关的文本片段放在一起。</p>
<p>LangChain中最基本的文本分割器是<code>CharacterTextSplitter</code> ，它按照指定的分隔符（默认“\n\n”）进行分割，并且考虑文本片段的最大长度。我们看个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> CharacterTextSplitter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建分词器 separator参数指的是分割的分隔符，chunk_size指的是分割出来的每个块的大小，chunk_overlap指的是每个块之间重叠的大小</span></span><br><span class="line">text_splitter = CharacterTextSplitter(separator=<span class="string">&quot; &quot;</span>, chunk_size=<span class="number">5</span>, chunk_overlap=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一句话分割【重叠时，需要考虑2个条件：一是前边的块是拼接得到的，二是 重叠字符个数能够被分出来】</span></span><br><span class="line">result1 = text_splitter.split_text(<span class="string">&quot;a b cd d e f&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result1--&gt;<span class="subst">&#123;result1&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多句话分割</span></span><br><span class="line">result2 = text_splitter.create_documents([<span class="string">&quot;a b c d e f&quot;</span>, <span class="string">&quot;e f g h&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result2---&gt;<span class="subst">&#123;result2&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多句话分割</span></span><br><span class="line">result3 = text_splitter.split_documents([Document(page_content=<span class="string">&quot;a b c d e f&quot;</span>, metadata=&#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;)])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result3---&gt;<span class="subst">&#123;result3&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010101233749.png" alt="image-20251010101233749"></p>
<hr>
<p>在跑上述代码时，可能会报错，报错如下：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010111723752.png" alt="image-20251010111723752"></p>
<p>解决方式：</p>
<ul>
<li>先安装nltk</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install nltk</span><br></pre></td></tr></table></figure>

<ul>
<li>然后下载nltk_data【不建议执行】</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nltk</span><br><span class="line">nltk.download(<span class="string">&#x27;punkt_tab&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>因为下载速度较慢，所以强烈建议大家，直接将同步文件夹中的nltk_data放到报错提示的Searched in中的任意一个文件夹下。</strong></p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010112144104.png" alt="image-20251010112144104"></p>
<p>比如放到 C:\Users\14091 文件夹下。</p>
<hr>
<p>除了CharacterTextSplitter分割器，LangChain还支持其他文档分割器 (部分)：</p>
<table>
<thead>
<tr>
<th>分割器名称</th>
<th>功能描述</th>
<th>类型</th>
<th>工业场景应用</th>
</tr>
</thead>
<tbody><tr>
<td>CharacterTextSplitter</td>
<td>简单按指定分隔符（如换行、逗号）直接分割。</td>
<td>基础字符解析</td>
<td>简单字符串或 CSV 数据处理，如传感器数据日志。</td>
</tr>
<tr>
<td>RecursiveCharacterTextSplitter</td>
<td>递归按字符分割，先尝试自然边界（如段落、句子），太大则继续细分。</td>
<td>通用字符解析</td>
<td>通用文本处理，如日志、报告、PDF 文档分割，便于 RAG 检索。</td>
</tr>
<tr>
<td>TokenTextSplitter</td>
<td>按 token（词元）分割，支持 LLM token 计数。</td>
<td>Token 基于解析</td>
<td>LLM 输入优化，如处理 API 响应或长查询，控制 token 限制。</td>
</tr>
<tr>
<td>SentenceTextSplitter</td>
<td>按句子边界分割，使用 NLP 识别句子（包括标点）。</td>
<td>语义解析</td>
<td>自然语言文本，如文章或对话分析，保持句子完整。</td>
</tr>
<tr>
<td>SpacyTextSplitter</td>
<td>使用 SpaCy NLP 库按句子或实体分割（需安装 SpaCy）。</td>
<td>语义解析</td>
<td>高级 NLP 场景，如实体提取或生物医学文本。</td>
</tr>
<tr>
<td>NLTKTextSplitter</td>
<td>使用 NLTK 库按句子或词分割（需安装 NLTK）。</td>
<td>语义解析</td>
<td>文本研究或分析，如时间序列数据描述。</td>
</tr>
<tr>
<td>MarkdownHeaderTextSplitter</td>
<td>按 Markdown 结构（如标题、列表）智能分割。</td>
<td>结构化解析</td>
<td>Markdown 文档分割，保留语义结构，用于知识库构建。</td>
</tr>
<tr>
<td>HTMLSplitter</td>
<td>按 HTML 标签（如 、）分割网页内容。</td>
<td>结构化解析</td>
<td>网页数据爬取，如在线技术文档或新闻提取。</td>
</tr>
<tr>
<td>LatexTextSplitter</td>
<td>按 LaTeX 结构（如章节、公式）分割。</td>
<td>结构化解析</td>
<td>学术论文或数学文档处理。</td>
</tr>
<tr>
<td>PythonCodeTextSplitter</td>
<td>按 Python 代码结构（如函数、类）分割。</td>
<td>代码解析</td>
<td>源代码文件分析，如脚本调试或代码库管理。</td>
</tr>
</tbody></table>
<p>下面就几个重要的分割器进行讲解。</p>
<ul>
<li>递归字符文本分割器（RecursiveCharacterTextSplitter）</li>
</ul>
<blockquote>
<p>递归字符文本分割器是一种更智能的分割方法，它尝试在特定分隔符处分割文本，以保持更好的语义完整性。 特点：</p>
<ul>
<li>尝试在自然断点处分割文本</li>
<li>比简单的字符分割更能保持语义完整性</li>
<li>适用于结构化程度较高的文本，如 Markdown、HTML 等</li>
</ul>
<p>运行流程：</p>
<ul>
<li>首先尝试使用第一个分隔符（如 “\n\n”）分割文本</li>
<li>如果分割后的块仍然过大，则使用下一个分隔符继续分割</li>
<li>重复此过程，直到达到指定的 chunk_size 或用完所有分隔符</li>
</ul>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter(</span><br><span class="line">    chunk_size=<span class="number">100</span>,  <span class="comment"># 每个块最多 100 个字符</span></span><br><span class="line">    chunk_overlap=<span class="number">20</span>,  <span class="comment"># 相邻分块会共享 20 个字符</span></span><br><span class="line">    length_function=<span class="built_in">len</span>,  <span class="comment"># 用字符数来衡量长度</span></span><br><span class="line">    separators=[<span class="string">&quot;\n\n&quot;</span>, <span class="string">&quot;\n&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>]  <span class="comment"># 会优先尝试按 \n\n 分段，如果太长，再按 \n → 空格 → 逐字符切分。</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">人工智能正在快速发展，尤其是大语言模型的应用，正在改变人类的工作方式。</span></span><br><span class="line"><span class="string">它们可以帮助人们进行写作、代码生成、甚至是科研探索。</span></span><br><span class="line"><span class="string">相比之下，新能源的发展同样重要。</span></span><br><span class="line"><span class="string">电动车和太阳能正在逐渐替代传统能源，减少碳排放，对全球环境保护至关重要。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">docs = text_splitter.split_text(text)</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003095555611.png" alt="image-20251003095555611"></p>
</blockquote>
<ul>
<li>语义文档分割器（SemanticChunker）</li>
</ul>
<blockquote>
<p>语义文档分割器使用语义理解来分割文本，这是一种更高级的分割方法。 特点：</p>
<ul>
<li>基于语义相似性分割文本</li>
<li>能够更好地保持语义完整性</li>
<li>计算成本较高，处理大量文本时可能效率较低</li>
<li>适用于需要高度语义理解的场景</li>
</ul>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_experimental.text_splitter <span class="keyword">import</span> SemanticChunker</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">embed = DashScopeEmbeddings()</span><br><span class="line"></span><br><span class="line">text_splitter = SemanticChunker(</span><br><span class="line">    embeddings=embed,</span><br><span class="line">    breakpoint_threshold_type=<span class="string">&#x27;percentile&#x27;</span>,</span><br><span class="line">    <span class="comment"># 更低的百分位会更“积极”地切分（数值越小 =&gt; 切得越多）</span></span><br><span class="line">    breakpoint_threshold_amount=<span class="number">70.0</span>,</span><br><span class="line">    <span class="comment"># 句子拆分正则为同时识别中/英文终结符</span></span><br><span class="line">    sentence_split_regex=<span class="string">r&#x27;(?&lt;=[。！？.!?])\s*&#x27;</span>,</span><br><span class="line">    <span class="comment"># 每个切分后片段（chunk）至少要有多少个字符</span></span><br><span class="line">    min_chunk_size=<span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">人工智能正在快速发展，尤其是大语言模型的应用，正在改变人类的工作方式。</span></span><br><span class="line"><span class="string">它们可以帮助人们进行写作、代码生成、甚至是科研探索。</span></span><br><span class="line"><span class="string">相比之下，新能源的发展同样重要。</span></span><br><span class="line"><span class="string">电动车和太阳能正在逐渐替代传统能源，减少碳排放，对全球环境保护至关重要。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">docs = text_splitter.split_text(text)</span><br><span class="line"><span class="keyword">for</span> i, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(docs):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;------ Chunk <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> ------&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(d.strip())</span><br><span class="line">    <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003095433705.png" alt="image-20251003095433705"></p>
</blockquote>
<ul>
<li>MarkdownHeaderTextSplitter（Markdown文档切割器）</li>
</ul>
<blockquote>
<p>适用于Markdown文档，按照标题进行拆分</p>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> MarkdownHeaderTextSplitter</span><br><span class="line"></span><br><span class="line">&gt;headers_to_split_on = [</span><br><span class="line">&gt;(<span class="string">&quot;#&quot;</span>, <span class="string">&quot;Header 1&quot;</span>),</span><br><span class="line">&gt;(<span class="string">&quot;##&quot;</span>, <span class="string">&quot;Header 2&quot;</span>),</span><br><span class="line">&gt;(<span class="string">&quot;###&quot;</span>, <span class="string">&quot;Header 3&quot;</span>),</span><br><span class="line">&gt;]</span><br><span class="line"></span><br><span class="line">&gt;markdown_splitter = MarkdownHeaderTextSplitter(headers_to_split_on=headers_to_split_on)</span><br><span class="line"></span><br><span class="line">&gt;markdown_text = <span class="string">&quot;# Header 1\nSome text\n## Header 2\nMore text\n### Header 3\nEven more text&quot;</span></span><br><span class="line">&gt;docs = markdown_splitter.split_text(markdown_text)</span><br><span class="line">&gt;<span class="built_in">print</span>(docs)</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003100510115.png" alt="image-20251003100510115"></p>
</blockquote>
<p>其他拓展知识可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_28540861/article/details/149161419">https://blog.csdn.net/qq_28540861/article/details/149161419</a></p>
<h3 id="7-3-VectorStores"><a href="#7-3-VectorStores" class="headerlink" title="7.3 VectorStores"></a>7.3 VectorStores</h3><p>VectorStores是一种特殊类型的数据库，它的作用是存储由嵌入创建的向量，提供相似查询等功能。</p>
<p>LangChain支持的VectorStore有<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/vectorstores/%EF%BC%8C%E5%B8%B8%E8%A7%81%E7%9A%84%E5%A6%82%E4%B8%8B%EF%BC%9A">https://python.langchain.com/docs/integrations/vectorstores/，常见的如下：</a></p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250705114738060.png" alt="image-20250705114738060"></p>
<blockquote>
<p> 我们使用其中一个<code>Chroma</code> 组件作为例子：</p>
<p> pip install chromadb</p>
<p> pip install langchain-chroma</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> CharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> TextLoader</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.加载文档</span></span><br><span class="line"><span class="comment"># 创建 TextLoader 对象</span></span><br><span class="line">loader = TextLoader(<span class="string">&#x27;langchain_data/pku.txt&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="comment"># 加载文档</span></span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="comment"># print(f&#x27;docs--&gt;&#123;docs&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.将文档进行分块</span></span><br><span class="line"><span class="comment"># 创建 CharacterTextSplitter 对象</span></span><br><span class="line">text_splitter = CharacterTextSplitter(separator=<span class="string">&quot;\n\n&quot;</span>, chunk_size=<span class="number">200</span>, chunk_overlap=<span class="number">30</span>)</span><br><span class="line"><span class="comment"># 分块</span></span><br><span class="line">split_docs = text_splitter.split_documents(docs)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;split_docs--&gt;<span class="subst">&#123;split_docs&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.创建向量数据库，并将切分后的文档保存到向量数据库中</span></span><br><span class="line">embedding_model = DashScopeEmbeddings()</span><br><span class="line"><span class="comment"># chromadb = Chroma.from_documents(documents=split_docs,</span></span><br><span class="line"><span class="comment">#                                  embedding=embedding_model,</span></span><br><span class="line"><span class="comment">#                                  persist_directory=&quot;./chroma_db&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果存在向量数据库，则加载向量数据库</span></span><br><span class="line">chromadb = Chroma(persist_directory=<span class="string">&quot;./chroma_db&quot;</span>, embedding_function=embedding_model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.使用向量数据库进行查询</span></span><br><span class="line">query = <span class="string">&quot;1937年北京大学发生了什么？&quot;</span></span><br><span class="line"><span class="comment"># k=2 表示返回最相似的2个文档</span></span><br><span class="line">result = chromadb.similarity_search(query, k=<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010114824818.png" alt="image-20251010114824818"></p>
<h3 id="7-4-检索器"><a href="#7-4-检索器" class="headerlink" title="7.4 检索器"></a>7.4 检索器</h3><h4 id="7-4-1-LangChain中的检索器定义"><a href="#7-4-1-LangChain中的检索器定义" class="headerlink" title="7.4.1 LangChain中的检索器定义"></a>7.4.1 LangChain中的检索器定义</h4><p>检索器是 LangChain 中负责信息检索的模块，通常与 索引（Indexes） 模块（如向量存储、嵌入模型）结合使用。它的核心功能是：</p>
<ul>
<li>输入：接收用户查询（通常是文本）。</li>
<li>处理：根据查询从数据源中检索相关内容。</li>
<li>输出：返回一组相关文档或文本片段（通常是 Document 对象列表）。</li>
</ul>
<h4 id="7-4-2-检索器的工作原理"><a href="#7-4-2-检索器的工作原理" class="headerlink" title="7.4.2 检索器的工作原理"></a>7.4.2 检索器的工作原理</h4><p>检索器通常与 向量存储（Vector Stores） 配合，通过嵌入模型（Embedding Models）将查询和文档转为向量，基于相似性进行检索。工作流程可以分为以下步骤：</p>
<ul>
<li>查询嵌入：将用户查询通过嵌入模型（如 OpenAIEmbeddings）转为向量表示</li>
<li>相似性搜索：在向量存储中查找与查询向量最相似的文档向量。</li>
<li>文档返回：返回匹配的文档（包含内容、元数据等）。</li>
<li>后处理（可选）：对检索结果进行排序、过滤或重新排名。</li>
</ul>
<p>检索器的核心依赖：</p>
<ul>
<li>嵌入模型：将文本转为向量（如 OpenAIEmbeddings, HuggingFaceEmbeddings）。</li>
<li>向量存储：存储文档向量（如 Chroma、FAISS、Pinecone）。</li>
<li>相似性度量：如余弦相似度、欧几里得距离</li>
</ul>
<h4 id="7-4-3-检索器类型"><a href="#7-4-3-检索器类型" class="headerlink" title="7.4.3 检索器类型"></a>7.4.3 检索器类型</h4><p>langchain支持很多检索器<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/retrievers/%EF%BC%8C%E9%83%A8%E5%88%86%E5%A6%82%E4%B8%8B%EF%BC%9A">https://python.langchain.com/docs/integrations/retrievers/，部分如下：</a></p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250705114709874-17594578225791.png" alt="image-20250705114709874"></p>
<p>此处我们讲解VectorStoreRetriever。</p>
<p>在 LangChain 中，as_retriever() 方法的 search_type 参数决定了向量检索的具体算法和行为。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">retriever = vector_store.as_retriever(</span><br><span class="line">    search_type=<span class="string">&quot;similarity&quot;</span>,  <span class="comment"># 可选 &quot;similarity&quot;|&quot;mmr&quot;|&quot;similarity_score_threshold&quot;</span></span><br><span class="line">    search_kwargs=&#123;</span><br><span class="line">        <span class="string">&quot;k&quot;</span>: <span class="number">5</span>,  <span class="comment"># 返回结果数量</span></span><br><span class="line">        <span class="string">&quot;score_threshold&quot;</span>: <span class="number">0.7</span>,  <span class="comment"># 仅当search_type=&quot;similarity_score_threshold&quot;时有效,低于阈值的都丢弃。</span></span><br><span class="line">        <span class="string">&quot;filter&quot;</span>: &#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;重要文档.pdf&quot;</span>&#125;,  <span class="comment"># 元数据过滤，只会检索满足条件的文档。</span></span><br><span class="line">        <span class="string">&quot;lambda_mult&quot;</span>: <span class="number">0.25</span>  <span class="comment"># 仅MMR搜索有效(控制多样性)：接近 0 则更强调和查询的相关性；接近 1 则更强调结果之间的差异性</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>以下是三种搜索类型的对比：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250714160215042-17594581318012.png" alt="image-20250714160215042"></p>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> CharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.创建向量数据库，并将切分后的文档保存到向量数据库中</span></span><br><span class="line">embedding_model = DashScopeEmbeddings()</span><br><span class="line"><span class="comment"># 如果存在向量数据库，则加载向量数据库</span></span><br><span class="line">chromadb = Chroma(persist_directory=<span class="string">&quot;./chroma_db&quot;</span>, embedding_function=embedding_model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.使用向量数据库进行查询</span></span><br><span class="line">query = <span class="string">&quot;1937年北京大学发生了什么？&quot;</span></span><br><span class="line"><span class="comment"># k=2 表示返回最相似的2个文档</span></span><br><span class="line"><span class="comment"># result = chromadb.similarity_search(query, k=2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将向量数据库转换为检索器</span></span><br><span class="line">retriever = chromadb.as_retriever(search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">3</span>&#125;)</span><br><span class="line"><span class="comment"># 使用检索器进行查询</span></span><br><span class="line">result = retriever.invoke(query)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result--&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010145001168.png" alt="image-20251010145001168"></p>
<p> <strong>拓展：</strong></p>
<p><code>vectordb.as_retriever()</code> 和 <code>vectordb.similarity_search()</code> 都是用于从向量数据库中检索相关文档的方法，它们有什么异同：</p>
<ul>
<li><p>相同</p>
<ul>
<li>核心功能：两者都基于向量相似度（如余弦相似度）从向量数据库中检索与查询最相关的文档。</li>
<li>底层技术：通常使用相同的嵌入模型和相似度计算方式（如 FAISS、Chroma、Pinecone 等）。</li>
</ul>
</li>
<li><p>不同</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250705114109276.png" alt="image-20250705114109276"></p>
</li>
</ul>
<h4 id="7-4-4-拓展"><a href="#7-4-4-拓展" class="headerlink" title="7.4.4 拓展"></a>7.4.4 拓展</h4><p>其他几种常用的检索器介绍如下。</p>
<ul>
<li>TFIDFRetriever</li>
</ul>
<blockquote>
<p>功能：基于 TF-IDF（词频-逆文档频率）的检索器。 </p>
<p>特点：</p>
<ul>
<li>使用 TF-IDF 向量表示文档和查询。</li>
<li>适合快速构建原型。</li>
<li>不支持语义搜索。</li>
</ul>
<p>适用场景：</p>
<ul>
<li>文本搜索</li>
<li>关键词提取</li>
</ul>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.retrievers <span class="keyword">import</span> TFIDFRetriever</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"></span><br><span class="line">docs = [</span><br><span class="line">    Document(page_content=<span class="string">&quot;量子计算是一种基于量子力学的计算范式。&quot;</span>),</span><br><span class="line">    Document(page_content=<span class="string">&quot;人工智能是模拟人类智能的技术。&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">retriever = TFIDFRetriever.from_documents(docs)</span><br><span class="line">retriever.k = <span class="number">1</span>  <span class="comment"># 返回 1 个结果</span></span><br><span class="line">results = retriever.invoke(<span class="string">&quot;量子计算&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(results)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003104151768.png" alt="image-20251003104151768" style="zoom:80%;" /></blockquote>
<ul>
<li>BM25Retriever</li>
</ul>
<blockquote>
<p>BM25算法：BM25 是对 TF-IDF 的改进版本，在 TF-IDF 基础上做了归一化（防止长文档优势）与饱和控制（防止词频无限增长）。</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003105157106.png" alt="image-20251003105157106" style="zoom: 60%;" />

<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251006090343544.png" alt="image-20251006090343544" style="zoom:67%;" />

<p>功能：基于 BM25 算法的关键词检索器，适合基于词频的搜索。</p>
<p>特点：</p>
<ul>
<li>不依赖嵌入模型，使用词频和逆文档频率（TF-IDF）计算相关性。</li>
<li>适合关键词匹配场景，计算成本低。</li>
<li>不支持语义搜索，效果依赖文本的字面匹配。</li>
</ul>
<p>适用场景：</p>
<ul>
<li>传统搜索场景。</li>
<li>关键词驱动的问答。</li>
</ul>
<p>环境依赖：</p>
<p>pip install rank_bm25</p>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.retrievers <span class="keyword">import</span> BM25Retriever</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"></span><br><span class="line">docs = [</span><br><span class="line">    Document(page_content=<span class="string">&quot;量子计算是一种基于量子力学的计算范式。&quot;</span>),</span><br><span class="line">    Document(page_content=<span class="string">&quot;人工智能是模拟人类智能的技术。&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">retriever = BM25Retriever.from_documents(docs)</span><br><span class="line">retriever.k = <span class="number">1</span>  <span class="comment"># 返回 1 个结果</span></span><br><span class="line">results = retriever.invoke(<span class="string">&quot;量子计算&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(results)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003104151768.png" alt="image-20251003104151768" style="zoom:80%;" /></blockquote>
<ul>
<li>MultiQueryRetriever</li>
</ul>
<blockquote>
<p>功能：它借助 LLM 自动生成多个语义等价的改写查询，把用户的问题扩展成多个角度，然后对每个改写进行检索，最后合并结果，以提高召回率。 </p>
<p>特点：</p>
<ul>
<li>使用语言模型生成查询的多种表达方式</li>
<li>从向量存储中检索所有变体的结果并合并</li>
<li>提高召回率，适合复杂查询</li>
</ul>
<p>适用场景：</p>
<ul>
<li>查询表达不明确或需要覆盖多种语义</li>
<li>提高检索的全面性</li>
</ul>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.retrievers.multi_query <span class="keyword">import</span> MultiQueryRetriever</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line">load_dotenv()</span><br><span class="line">docs = [</span><br><span class="line">    Document(page_content=<span class="string">&quot;量子计算基于量子力学。&quot;</span>),</span><br><span class="line">    Document(page_content=<span class="string">&quot;人工智能模拟人类智能。&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">embeddings = DashScopeEmbeddings()</span><br><span class="line">vectorstore = Chroma.from_documents(docs, embeddings)</span><br><span class="line">llm = ChatTongyi()</span><br><span class="line"></span><br><span class="line">retriever = MultiQueryRetriever.from_llm(</span><br><span class="line">    retriever=vectorstore.as_retriever(),</span><br><span class="line">    llm=llm</span><br><span class="line">)</span><br><span class="line">results = retriever.invoke(<span class="string">&quot;量子计算是什么？&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(results)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003145128180.png" alt="image-20251003145128180"></p>
</blockquote>
<ul>
<li>EnsembleRetriever</li>
</ul>
<blockquote>
<p>功能：结合多种检索器（如 BM25 和向量存储），融合结果。</p>
<p>特点：</p>
<ul>
<li>结合关键词搜索和语义搜索的优点</li>
<li>支持加权融合，调整不同检索器的权重</li>
<li>提高召回率和精准度</li>
</ul>
<p>适用场景：</p>
<ul>
<li>需要综合关键词和语义的搜索</li>
<li>复杂查询场景</li>
</ul>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain.retrievers <span class="keyword">import</span> EnsembleRetriever</span><br><span class="line"><span class="keyword">from</span> langchain_community.retrievers <span class="keyword">import</span> BM25Retriever</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line">docs = [</span><br><span class="line">    Document(page_content=<span class="string">&quot;量子计算基于量子力学。&quot;</span>),</span><br><span class="line">    Document(page_content=<span class="string">&quot;人工智能模拟人类智能。&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">bm25_retriever = BM25Retriever.from_documents(docs)</span><br><span class="line">bm25_retriever.k = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">embeddings = DashScopeEmbeddings()</span><br><span class="line">vectorstore = Chroma.from_documents(docs, embeddings)</span><br><span class="line">vector_retriever = vectorstore.as_retriever(search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line">ensemble_retriever = EnsembleRetriever(</span><br><span class="line">    retrievers=[bm25_retriever, vector_retriever],</span><br><span class="line">    weights=[<span class="number">0.5</span>, <span class="number">0.5</span>]</span><br><span class="line">)</span><br><span class="line">results = ensemble_retriever.invoke(<span class="string">&quot;量子计算&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(results)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003145923240.png" alt="image-20251003145923240"></p>
</blockquote>
<ul>
<li>ContextualCompressionRetriever</li>
</ul>
<blockquote>
<p>功能：对检索结果进行压缩，提取最相关的内容 </p>
<p>特点：</p>
<ul>
<li>使用语言模型对检索到的文档进行重新排序或精炼</li>
<li>减少无关内容，提高结果质量</li>
<li>增加计算开销，但提升精准度</li>
</ul>
<p>适用场景：</p>
<ul>
<li>文档内容冗长，需要提取关键信息</li>
<li>提高问答系统的答案质量</li>
</ul>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">from</span> langchain.retrievers <span class="keyword">import</span> ContextualCompressionRetriever</span><br><span class="line">&gt;<span class="keyword">from</span> langchain.retrievers.document_compressors <span class="keyword">import</span> LLMChainExtractor</span><br><span class="line">&gt;<span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line">&gt;<span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line">&gt;<span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line">&gt;<span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line">&gt;<span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">&gt;load_dotenv()</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># 原始文档：内容很长，包含很多和问题无关的细节</span></span><br><span class="line">&gt;docs = [</span><br><span class="line"> Document(page_content=<span class="string">&quot;&quot;&quot;量子计算是一种基于量子力学的计算范式。</span></span><br><span class="line"><span class="string">&gt;它利用量子比特（qubit）进行运算，能够表示叠加态和纠缠态。</span></span><br><span class="line"><span class="string">&gt;这种计算方式在某些特定问题上（比如大数分解、搜索问题）可能远远快于经典计算机。</span></span><br><span class="line"><span class="string">&gt;量子计算机的核心是量子比特和量子门操作，它们共同决定了计算的能力。</span></span><br><span class="line"><span class="string">&gt;除此之外，量子计算的研究还涉及量子误差纠正、量子通信、量子算法的设计等多个方向。&quot;&quot;&quot;</span>),</span><br><span class="line"></span><br><span class="line"> Document(page_content=<span class="string">&quot;&quot;&quot;人工智能是一门研究如何使机器表现出类似人类智能的学科。</span></span><br><span class="line"><span class="string">&gt;它的主要技术包括机器学习、深度学习、自然语言处理、计算机视觉等。</span></span><br><span class="line"><span class="string">&gt;人工智能的应用非常广泛，比如自动驾驶、智能推荐、医疗辅助诊断等。</span></span><br><span class="line"><span class="string">&gt;在哲学上，人们也讨论人工智能是否可能拥有意识和思维。&quot;&quot;&quot;</span>)</span><br><span class="line">&gt;]</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># 构建向量数据库</span></span><br><span class="line">&gt;embeddings = DashScopeEmbeddings()</span><br><span class="line">&gt;vectorstore = Chroma.from_documents(docs, embeddings)</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># 初始化大模型</span></span><br><span class="line">&gt;llm = ChatTongyi(model=<span class="string">&quot;qwen-max&quot;</span>)</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># 构建压缩器</span></span><br><span class="line">&gt;compressor = LLMChainExtractor.from_llm(llm)</span><br><span class="line">&gt;<span class="comment"># 构建压缩检索器</span></span><br><span class="line">&gt;retriever = ContextualCompressionRetriever(</span><br><span class="line"> base_compressor=compressor,</span><br><span class="line"> base_retriever=vectorstore.as_retriever()</span><br><span class="line">&gt;)</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># 问一个具体问题</span></span><br><span class="line">&gt;results = retriever.invoke(<span class="string">&quot;量子计算的核心组成部分是什么？&quot;</span>)</span><br><span class="line"></span><br><span class="line">&gt;<span class="built_in">print</span>(<span class="string">&quot;---- 原始检索结果 ----&quot;</span>)</span><br><span class="line">&gt;raw_results = vectorstore.as_retriever().invoke(<span class="string">&quot;量子计算的核心组成部分是什么？&quot;</span>)</span><br><span class="line">&gt;<span class="keyword">for</span> r <span class="keyword">in</span> raw_results:</span><br><span class="line"> <span class="built_in">print</span>(r.page_content)</span><br><span class="line"></span><br><span class="line">&gt;<span class="built_in">print</span>(<span class="string">&quot;\n---- 压缩后的结果 ----&quot;</span>)</span><br><span class="line">&gt;<span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line"> <span class="built_in">print</span>(r.page_content)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003150444442.png" alt="image-20251003150444442" style="zoom:67%;" /></blockquote>
<ul>
<li>Custom Retriever</li>
</ul>
<blockquote>
<p>功能：开发者可以自定义检索逻辑，适配特定数据源或算法 </p>
<p>特点：</p>
<ul>
<li>继承 BaseRetriever 类，实现 get_relevant_documents 方法</li>
<li>支持任意数据源（如数据库、API）</li>
</ul>
<p>适用场景：</p>
<ul>
<li>特定领域的数据源（如内部数据库）</li>
<li>自定义检索算法</li>
</ul>
<p>示例代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.retrievers <span class="keyword">import</span> BaseRetriever</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomRetriever</span>(<span class="title class_ inherited__">BaseRetriever</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_relevant_documents</span>(<span class="params">self, query: <span class="built_in">str</span>, **kwargs</span>):</span><br><span class="line">        <span class="comment"># 自定义逻辑（如查询数据库）</span></span><br><span class="line">        <span class="keyword">return</span> [Document(page_content=<span class="string">f&quot;自定义结果 for <span class="subst">&#123;query&#125;</span>&quot;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">retriever = CustomRetriever()</span><br><span class="line">results = retriever.invoke(<span class="string">&quot;量子计算&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(results)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003150756134.png" alt="image-20251003150756134" style="zoom:67%;" /></blockquote>
<h2 id="8-Agents【理解】"><a href="#8-Agents【理解】" class="headerlink" title="8 Agents【理解】"></a>8 Agents【理解】</h2><h3 id="8-1-Agent-概念"><a href="#8-1-Agent-概念" class="headerlink" title="8.1 Agent 概念"></a>8.1 Agent 概念</h3><p>Agent（智能体）是一种能够感知环境、进行决策和执行动作的智能实体。不同于传统的人工智能，Agent 具备通过主动思考、调用工具去逐步完成给定目标的能力。</p>
<p>从大模型的角度来看，<strong>Agent其实就是基于大模型的语义理解和推理能力，让大模型拥有解决复杂问题时的任务规划能力，并调用外部工具来执行各种任务，并且能够保留“记忆”的一个智能体</strong>。</p>
<blockquote>
<p>Agent &#x3D; 大模型 + 任务规划（Planning） + 使用外部工具执行任务（Tools&amp;Action） + 记忆（Memory）</p>
</blockquote>
<hr>
<p><strong>工作流程概述：</strong></p>
<ul>
<li>用户提出任务。</li>
<li>Agent 启动： 将用户输入与预设的“提示词模板”结合，并结合当前的“上下文”和“变量”，形成一个完整的输入发送给大模型。</li>
<li>大模型思考与决策 (循环)：<ul>
<li>大模型接收输入后，根据其内置的逻辑和提示词的指导，进行“思考”。</li>
<li>它会判断完成当前任务是需要继续使用工具来获取更多信息&#x2F;执行操作，还是已经可以直接生成最终答案。</li>
<li>如果需要工具： 大模型会根据任务需求和对工具的描述，选择合适的工具，并生成执行该工具所需的输入参数。这些参数通常会从上下文或变量中提取。</li>
<li>工具执行： 选定的工具被调用，执行其功能。</li>
<li>结果反馈： 工具执行的结果会返回给 Agent，并被用来更新“上下文”和“变量”。</li>
<li>循环： Agent 将更新后的“上下文”、“变量”以及工具执行结果再次反馈给大模型，大模型继续进行新一轮的“思考-行动”循环，直到任务完成。</li>
<li>如果直接回答： 当大模型判断任务已完成，或无需额外工具即可回答时，它会生成最终的答案。</li>
</ul>
</li>
<li>用户输出： 最终答案被呈现给用户。</li>
</ul>
<h3 id="8-2-Agent关键组成部分"><a href="#8-2-Agent关键组成部分" class="headerlink" title="8.2 Agent关键组成部分"></a>8.2 Agent关键组成部分</h3><p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250705115745718.png" alt="image-20250705115745718"></p>
<ul>
<li><p>任务规划（Planning）</p>
<p>Agent需要提前将一项复杂任务拆解为多个更小、更易于处理的子任务，从而实现对复杂任务的高效处理</p>
</li>
<li><p>长短期记忆（Memory）</p>
<p>聊天上下文，长期保留和回忆信息</p>
</li>
<li><p>工具&amp;执行（Tools&amp;Action）</p>
<p>根据拆分好的子任务，调用外部提供好的专业API解决专业问题，完成一个个具体的子任务，并把处理结果返回给大模型</p>
</li>
</ul>
<h3 id="8-3-langchain实现Agent"><a href="#8-3-langchain实现Agent" class="headerlink" title="8.3 langchain实现Agent"></a>8.3 langchain实现Agent</h3><p>LangChain 提供了不同类型的代理（主要罗列一下三种）:</p>
<ul>
<li><p><strong>Zero-shot ReAct Description</strong></p>
<ul>
<li><p>基于 <strong>ReAct 框架</strong>（推理 + 行动），仅依赖工具的 <strong>描述</strong> 来决定调用哪个工具。</p>
</li>
<li><p>特点：无需额外示例（zero-shot），但 <strong>不具备记忆能力</strong>，每次推理都独立进行。</p>
</li>
<li><p>使用场景：简单任务，工具选择完全靠工具描述即可。</p>
</li>
</ul>
</li>
<li><p><strong>Structured Chat Zero-shot ReAct Description</strong></p>
<ul>
<li><p>同样基于 <strong>ReAct 框架</strong>，但可以处理 <strong>结构化输入</strong>，即支持带多个参数的工具（类似函数调用）。</p>
</li>
<li><p>特点：不仅能像第一种代理那样根据描述选择工具，还能正确组织并传递复杂参数。</p>
</li>
<li><p>使用场景：调用接口类工具、需要多参数输入的任务。</p>
</li>
</ul>
</li>
<li><p><strong>Conversational ReAct Description</strong></p>
<ul>
<li><p>在 ReAct 框架基础上，增强了 <strong>对话记忆能力</strong>。</p>
</li>
<li><p>特点：能根据上下文对话历史来做出工具选择和回应，更适合持续性对话场景。</p>
</li>
<li><p>使用场景：多轮对话，用户可能引用之前的内容或需要长期上下文跟踪。</p>
</li>
</ul>
</li>
</ul>
<hr>
<p>LangChain 中集成了很多工具，可以通过下面的方式进行查询：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits.load_tools <span class="keyword">import</span> get_all_tool_names</span><br><span class="line">results = get_all_tool_names()</span><br><span class="line"><span class="built_in">print</span>(results)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;sleep&#x27;, &#x27;wolfram-alpha&#x27;, &#x27;google-search&#x27;, &#x27;google-search-results-json&#x27;, &#x27;searx-search-results-json&#x27;, &#x27;bing-search&#x27;, &#x27;metaphor-search&#x27;, &#x27;ddg-search&#x27;, &#x27;google-books&#x27;, &#x27;google-lens&#x27;, &#x27;google-serper&#x27;, &#x27;google-scholar&#x27;, &#x27;google-finance&#x27;, &#x27;google-trends&#x27;, &#x27;google-jobs&#x27;, &#x27;google-serper-results-json&#x27;, &#x27;searchapi&#x27;, &#x27;searchapi-results-json&#x27;, &#x27;serpapi&#x27;, &#x27;dalle-image-generator&#x27;, &#x27;twilio&#x27;, &#x27;searx-search&#x27;, &#x27;merriam-webster&#x27;, &#x27;wikipedia&#x27;, &#x27;arxiv&#x27;, &#x27;golden-query&#x27;, &#x27;pubmed&#x27;, &#x27;human&#x27;, &#x27;awslambda&#x27;, &#x27;stackexchange&#x27;, &#x27;sceneXplain&#x27;, &#x27;graphql&#x27;, &#x27;openweathermap-api&#x27;, &#x27;dataforseo-api-search&#x27;, &#x27;dataforseo-api-search-json&#x27;, &#x27;eleven_labs_text2speech&#x27;, &#x27;google_cloud_texttospeech&#x27;, &#x27;read_file&#x27;, &#x27;reddit_search&#x27;, &#x27;news-api&#x27;, &#x27;tmdb-api&#x27;, &#x27;podcast-api&#x27;, &#x27;memorize&#x27;, &#x27;llm-math&#x27;, &#x27;open-meteo-api&#x27;, &#x27;requests&#x27;, &#x27;requests_get&#x27;, &#x27;requests_post&#x27;, &#x27;requests_patch&#x27;, &#x27;requests_put&#x27;, &#x27;requests_delete&#x27;, &#x27;terminal&#x27;]</span><br></pre></td></tr></table></figure>

<hr>
<p>接下来，通过一个示例来学习Agent的基本使用。</p>
<ul>
<li>问题1：计算一下300的25%是多少？</li>
<li>问题2：请帮我介绍一下故宫</li>
</ul>
<p>示例代码：</p>
<blockquote>
<p>需要提前安装 wikipedia</p>
<p>pip install wikipedia</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> initialize_agent, AgentType</span><br><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits.load_tools <span class="keyword">import</span> load_tools, get_all_tool_names</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">tool_names = get_all_tool_names()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;tool_names--&gt;<span class="subst">&#123;tool_names&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"><span class="comment"># 1.实例化模型</span></span><br><span class="line">model = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.设置工具</span></span><br><span class="line">tools = load_tools([<span class="string">&#x27;wikipedia&#x27;</span>, <span class="string">&#x27;llm-math&#x27;</span>], llm=model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.创建agent</span></span><br><span class="line"><span class="comment"># verbose=True 表示输出推理过程</span></span><br><span class="line">agent = initialize_agent(tools, model, AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.设置提示词并调用agent</span></span><br><span class="line"><span class="comment"># prompt = &quot;计算一下300的25%是多少？&quot;</span></span><br><span class="line">prompt = <span class="string">&quot;请帮我介绍一下故宫&quot;</span></span><br><span class="line"></span><br><span class="line">result = agent.invoke(prompt)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;result---&gt;<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010170213307.png" alt="image-20251010170213307"></p>
<h3 id="8-4-langchain自定义工具"><a href="#8-4-langchain自定义工具" class="headerlink" title="8.4 langchain自定义工具"></a>8.4 langchain自定义工具</h3><blockquote>
<p>参考官网 <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/how_to/custom_tools/">https://python.langchain.com/docs/how_to/custom_tools/</a></p>
</blockquote>
<p>自定义工具除了调用的实际函数外，还需要几个组件：</p>
<ul>
<li><code>name</code> (str)是必需的，并且在提供给代理的一组工具中必须是唯一的</li>
<li><code>description</code> (str)是可选的，但建议使用，因为代理使用它来确定工具的使用情况</li>
<li><code>return_direct</code> (bool), 默认关闭，打开时tool会返回执行结果</li>
<li><code>args_schema</code> (Pydantic BaseModel), 可选，但推荐使用，可用于提供更多信息(例如，少量示例)或验证预期参数。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits.load_tools <span class="keyword">import</span> load_tools</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> initialize_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentType</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models.tongyi <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line"><span class="comment"># 1.实例化模型</span></span><br><span class="line">llm = ChatTongyi(model=<span class="string">&#x27;qwen-max&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.定义工具</span></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">time</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;返回今天的日期。用于任何与获取今天日期相关的问题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    该函数的输入应始终为空字符串，且它始终返回今天的日期。</span></span><br><span class="line"><span class="string">    任何与日期相关的计算应在此函数之外完成。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(date.today())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.设置工具</span></span><br><span class="line"><span class="comment"># 加载常用工具，例如数学计算和维基百科</span></span><br><span class="line">tools = load_tools([<span class="string">&quot;llm-math&quot;</span>, <span class="string">&quot;wikipedia&quot;</span>], llm=llm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.创建代理</span></span><br><span class="line">agent = initialize_agent(tools+[time], llm, agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.设置提示词并进行agent推理</span></span><br><span class="line">prompt = <span class="string">&quot;今天是什么日期？&quot;</span></span><br><span class="line"></span><br><span class="line">result = agent.invoke(prompt)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&#x27;output&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251010170949928.png" alt="image-20251010170949928" style="zoom:67%;" />



<h2 id="9-LangChain使用场景【理解】"><a href="#9-LangChain使用场景【理解】" class="headerlink" title="9 LangChain使用场景【理解】"></a>9 LangChain使用场景【理解】</h2><ul>
<li>个人助手</li>
<li>基于文档的问答系统</li>
<li>聊天机器人</li>
<li>Tabular数据查询</li>
<li>API交互</li>
<li>信息提取</li>
<li>文档总结</li>
</ul>
<h1 id="Milvus向量数据库"><a href="#Milvus向量数据库" class="headerlink" title="Milvus向量数据库"></a>Milvus向量数据库</h1><h2 id="1-什么是-Milvus-向量数据库？【理解】"><a href="#1-什么是-Milvus-向量数据库？【理解】" class="headerlink" title="1 什么是 Milvus 向量数据库？【理解】"></a>1 什么是 Milvus 向量数据库？【理解】</h2><p>Milvus 是一款开源的向量数据库（2019年提出），其唯一目标是存储、索引和管理由深度神经网络和其他机器学习（ML）模型生成的大规模嵌入向量。</p>
<p>两大作用：存储、检索</p>
<h2 id="2-关键概念【理解】"><a href="#2-关键概念【理解】" class="headerlink" title="2 关键概念【理解】"></a>2 关键概念【理解】</h2><h3 id="2-1-非结构化数据"><a href="#2-1-非结构化数据" class="headerlink" title="2.1 非结构化数据"></a>2.1 非结构化数据</h3><p>非结构化数据包括图像、视频、音频和自然语言等信息，这些信息不遵循预定义的模型或组织方式，占据了世界数据的约 80%。非结构化数据可以通过各种模型转化为向量数据后进行处理。</p>
<h3 id="2-2-嵌入向量"><a href="#2-2-嵌入向量" class="headerlink" title="2.2 嵌入向量"></a>2.2 嵌入向量</h3><p>嵌入向量是对非结构化数据（如电子邮件、物联网传感器数据、Instagram 照片、蛋白质结构等）的特征抽象。数学上，嵌入向量是一个浮点数或二进制数的数组。</p>
<p>通过现代的向量转化技术，比如各种机器学习模型或者深度学习模型，可以将非结构化数据抽象为 n 维特征向量空间的向量。</p>
<h3 id="2-3-向量相似度搜索"><a href="#2-3-向量相似度搜索" class="headerlink" title="2.3 向量相似度搜索"></a>2.3 向量相似度搜索</h3><p>向量相似度搜索是将向量与数据库进行比较，以找到与查询向量最相似的向量的过程。近似最近邻搜索（ANN）算法能够计算向量之间的距离，从而提升向量相似度检索的速度。如果两条向量十分相似，这就意味着它们所代表的源数据也十分相似。</p>
<h3 id="2-4-Collection-和-Field"><a href="#2-4-Collection-和-Field" class="headerlink" title="2.4 Collection 和 Field"></a>2.4 Collection 和 Field</h3><p>与传统数据库引擎类似，用户也可以在 Milvus 中创建数据库，并为某些用户分配权限来管理它们。一个 Milvus 集群最多支持 64 个数据库。</p>
<p>在Milvus数据库中，有Collection和Field的概念，可以和关系数据库中表和字段进行对应：</p>
<table>
<thead>
<tr>
<th>Milvus</th>
<th>关系数据库</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Collection</td>
<td>表</td>
<td>集合相当于关系数据库中的表，用于组织数据</td>
</tr>
<tr>
<td>Field</td>
<td>字段</td>
<td>字段Schema相当于表中的列</td>
</tr>
<tr>
<td>Entity</td>
<td>行</td>
<td>实体就是一条完整的数据记录，包含一个或多个字段</td>
</tr>
<tr>
<td>Index</td>
<td>索引</td>
<td>从原始数据衍生出来的重组数据结构，可以大大加快向量相似性搜索的过程</td>
</tr>
<tr>
<td>Partition</td>
<td>分区</td>
<td>在物理存储上将 Collections 数据分成多个部分，即分区</td>
</tr>
</tbody></table>
<blockquote>
<p>注意：1个collection最多支持4个向量Field</p>
</blockquote>
<h2 id="3-为什么选择-Milvus？【掌握】"><a href="#3-为什么选择-Milvus？【掌握】" class="headerlink" title="3 为什么选择 Milvus？【掌握】"></a>3 为什么选择 Milvus？【掌握】</h2><ul>
<li>高性能：性能卓越，可对海量数据集进行向量相似度检索。</li>
<li>高可用、高可靠：Milvus 支持在云上扩展，其容灾能力能够保证服务高可用。</li>
<li>混合查询：Milvus 支持在向量相似度检索过程中进行标量字段过滤，实现混合查询。</li>
<li>开发者友好：支持多语言、多工具的 Milvus 生态系统。</li>
</ul>
<h2 id="4-支持哪些索引和度量？【理解】"><a href="#4-支持哪些索引和度量？【理解】" class="headerlink" title="4 支持哪些索引和度量？【理解】"></a>4 支持哪些索引和度量？【理解】</h2><p>索引是数据的组织单位。在搜索或查询插入的实体之前，必须声明索引类型和相似度度量。<strong>如果您未指定索引类型，则 Milvus 将默认使用暴力搜索。</strong></p>
<h3 id="4-1-索引类型"><a href="#4-1-索引类型" class="headerlink" title="4.1 索引类型"></a>4.1 索引类型</h3><table>
<thead>
<tr>
<th align="left">特性&#x2F;索引类型</th>
<th align="left">FLAT (Flat)</th>
<th align="left">IVF_FLAT</th>
<th align="left">IVF_SQ8</th>
<th align="left">IVF_PQ</th>
<th align="left">HNSW</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>全称</strong></td>
<td align="left">平面扫描</td>
<td align="left">倒排文件 - 平面</td>
<td align="left">倒排文件 - 标量量化8位</td>
<td align="left">倒排文件 - 乘积量化</td>
<td align="left">层级可导航小世界图</td>
</tr>
<tr>
<td align="left"><strong>核心原理</strong></td>
<td align="left">暴力计算所有向量与查询向量的距离</td>
<td align="left">先聚类划分簇，再在目标簇内暴力搜索</td>
<td align="left">类似 IVF_FLAT，但向量被压缩存储（8位整数）</td>
<td align="left">将向量空间划分为子空间并分别量化编码</td>
<td align="left">构建多层导航图进行快速近邻搜索</td>
</tr>
<tr>
<td align="left"><strong>精度 (Recall)</strong></td>
<td align="left"><strong>最高</strong> (100%，精确搜索)</td>
<td align="left">高</td>
<td align="left">中高</td>
<td align="left">中</td>
<td align="left">非常高</td>
</tr>
<tr>
<td align="left"><strong>查询速度</strong></td>
<td align="left"><strong>最慢</strong> (O(n))</td>
<td align="left">快</td>
<td align="left">较快</td>
<td align="left"><strong>最快</strong></td>
<td align="left">非常快</td>
</tr>
<tr>
<td align="left"><strong>内存使用</strong></td>
<td align="left">高 (存储原始浮点向量)</td>
<td align="left">高 (存储原始向量)</td>
<td align="left">中等 (量化后节省空间)</td>
<td align="left"><strong>最低</strong> (高度压缩)</td>
<td align="left">高 (存储原始向量和图结构)</td>
</tr>
<tr>
<td align="left"><strong>构建时间</strong></td>
<td align="left">无 (无需构建)</td>
<td align="left">中等</td>
<td align="left">中等</td>
<td align="left">较快</td>
<td align="left">较长</td>
</tr>
<tr>
<td align="left"><strong>是否支持动态数据</strong></td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left">是</td>
<td align="left"><strong>是</strong></td>
</tr>
<tr>
<td align="left"><strong>适用场景</strong></td>
<td align="left">数据量小 (&lt; 百万)，要求绝对精确</td>
<td align="left">数据量中等，追求高召回率</td>
<td align="left">数据量大，平衡速度、精度和内存</td>
<td align="left">超大规模数据，极致追求查询速度和低内存</td>
<td align="left">数据量大，要求高精度和较快查询，支持动态增删</td>
</tr>
<tr>
<td align="left"><strong>主要优势</strong></td>
<td align="left">精确、简单、无需训练</td>
<td align="left">高召回、实现成熟</td>
<td align="left">内存占用适中，性能良好</td>
<td align="left">查询极快，内存占用极低</td>
<td align="left">支持动态数据，精度高，查询快</td>
</tr>
<tr>
<td align="left"><strong>主要劣势</strong></td>
<td align="left">速度慢，不适用于大数据</td>
<td align="left">内存占用高，构建需聚类</td>
<td align="left">精度因量化略有损失</td>
<td align="left">精度损失相对较大，配置复杂</td>
<td align="left">构建时间较长，内存占用高</td>
</tr>
</tbody></table>
<p><strong>使用建议</strong></p>
<ul>
<li><p><strong>追求绝对精度且数据量小：</strong> 选择 <code>FLAT</code>。</p>
</li>
<li><p><strong>通用场景，平衡各方面：</strong> <code>IVF_SQ8</code> 或 <code>HNSW</code> 是很好的选择。<code>HNSW</code> 在支持动态更新方面更具优势。</p>
</li>
<li><p><strong>超大规模数据，追求极致性能：</strong> 优先考虑 <code>IVF_PQ</code>。</p>
</li>
<li><p><strong>数据频繁增删改：</strong> 选择 <code>HNSW</code> (Milvus 推荐用于动态数据)。</p>
</li>
</ul>
<h3 id="4-2-相似度度量"><a href="#4-2-相似度度量" class="headerlink" title="4.2 相似度度量"></a>4.2 相似度度量</h3><p>对于浮点向量，通常使用以下指标：</p>
<ul>
<li>L2（欧几里得距离）：计算向量间的直线距离，值越小越相似，常用于图像处理等领域。</li>
<li>IP（内积）：计算两个向量的点积，值越大越相似。当向量经过归一化时，其结果等价于余弦相似度，常用于NLP文本向量搜索。</li>
<li>COSINE（余弦相似度）：衡量两个向量方向的夹角余弦值，值越大（越接近1）表示方向越一致，对向量的幅度不敏感，非常适合文本和语义相似性搜索。</li>
</ul>
<p>对于稀疏向量，通常使用以下指标：</p>
<ul>
<li>IP（内积）：主要用于衡量稀疏向量的相似性。</li>
<li>BM25：一种常用于信息检索的评分函数，也支持用于稀疏向量的搜索。</li>
</ul>
<hr>
<h2 id="5-Milvus数据库操作【熟悉】"><a href="#5-Milvus数据库操作【熟悉】" class="headerlink" title="5 Milvus数据库操作【熟悉】"></a>5 Milvus数据库操作【熟悉】</h2><p>开始之前，请确保本地环境中有 Python 3.8+ 可用。安装<code>pymilvus</code> ，其中包含 python 客户端库和 Milvus Lite：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pymilvus</span><br></pre></td></tr></table></figure>

<p>在操作Milvus数据库之前，需要先启动服务。</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251012103305562.png" alt="image-20251012103305562"></p>
<p>可视化页面：</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:30000/">http://127.0.0.1:30000</a></p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251012103410963.png" alt="image-20251012103410963"></p>
<p>查询ip的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig</span><br></pre></td></tr></table></figure>



<h3 id="5-1-设置向量数据库"><a href="#5-1-设置向量数据库" class="headerlink" title="5.1 设置向量数据库"></a>5.1 设置向量数据库</h3><p>连接Milvus向量数据库，并创建一个名称为milvus_demo的数据库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymilvus <span class="keyword">import</span> MilvusClient, DataType, RRFRanker, AnnSearchRequest</span><br><span class="line"></span><br><span class="line"><span class="comment"># todo: 1.创建数据库</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate_db</span>():</span><br><span class="line">    <span class="comment"># 创建一个客户端</span></span><br><span class="line">    client = MilvusClient(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">19530</span>)</span><br><span class="line">    <span class="comment"># client = MilvusClient(uri=&quot;http://localhost:19530&quot;)</span></span><br><span class="line">    <span class="comment"># print(client)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 列举数据库</span></span><br><span class="line">    databases = client.list_databases()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Databases--&gt;<span class="subst">&#123;databases&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建数据库</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;milvus_demo&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> databases:</span><br><span class="line">        client.create_database(<span class="string">&#x27;milvus_demo&#x27;</span>)</span><br><span class="line">    <span class="comment"># 使用</span></span><br><span class="line">    client.using_database(<span class="string">&#x27;milvus_demo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> client</span><br></pre></td></tr></table></figure>



<h3 id="5-2-Collections操作"><a href="#5-2-Collections操作" class="headerlink" title="5.2 Collections操作"></a>5.2 Collections操作</h3><p>在 Milvus 中，我们需要一个 Collections 来存储向量及其相关元数据。你可以把它想象成传统 SQL 数据库中的表格。创建 Collections 时，可以定义 Schema 和索引参数来配置向量规格，如维度、索引类型和远距离度量。此外，还有一些复杂的概念来优化索引以提高向量搜索性能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># todo: 2.collection集合的操作</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate_table</span>(<span class="params">client</span>):</span><br><span class="line">    <span class="comment"># 1）定义schema</span></span><br><span class="line">    <span class="comment">## 注意：在定义集合 Schema 时，enable_dynamic_field=True 使得后续可以插入未定义的字段。一般动态字段以 JSON 格式存储，通常命名为 $meta。在插入数据时，所有未定义的字段及其值将被保存为键值对。</span></span><br><span class="line">    <span class="comment">## 在定义集合 Schema 时，auto_id=True 可以对主键自动增长id。</span></span><br><span class="line">    schema = client.create_schema(auto_id=<span class="literal">False</span>, enable_dynamic_field=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2）添加字段</span></span><br><span class="line">    schema.add_field(field_name=<span class="string">&#x27;id&#x27;</span>, datatype=DataType.INT64, is_primary=<span class="literal">True</span>, description=<span class="string">&quot;主键&quot;</span>)</span><br><span class="line">    schema.add_field(field_name=<span class="string">&#x27;vector&#x27;</span>, datatype=DataType.FLOAT_VECTOR, dim=<span class="number">8</span>, description=<span class="string">&quot;向量字段&quot;</span>)  <span class="comment"># dim 表示向量的维度</span></span><br><span class="line">    schema.add_field(field_name=<span class="string">&#x27;scalar&#x27;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">256</span>, description=<span class="string">&quot;标量字段&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3）创建集合</span></span><br><span class="line">    client.create_collection(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>, schema=schema)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4）创建索引</span></span><br><span class="line">    <span class="comment"># 创建索引参数</span></span><br><span class="line">    index_params = client.prepare_index_params()</span><br><span class="line">    <span class="comment"># 设置索引参数：在向量字段上创建索引</span></span><br><span class="line">    index_params.add_index(field_name=<span class="string">&#x27;vector&#x27;</span>, index_type=<span class="string">&#x27;IVF_FLAT&#x27;</span>, metric_type=<span class="string">&#x27;COSINE&#x27;</span>, index_name=<span class="string">&#x27;vector_index&#x27;</span>, nlist=<span class="number">1024</span>)  <span class="comment"># nlist=1024 表示索引的聚类数量</span></span><br><span class="line">    <span class="comment"># 设置索引参数：在标量字段上创建索引,常用的索引类型就是INVERTED(倒排索引) index_type=&#x27;&#x27;代表使用默认索引</span></span><br><span class="line">    index_params.add_index(field_name=<span class="string">&#x27;scalar&#x27;</span>, index_type=<span class="string">&#x27;&#x27;</span>, index_name=<span class="string">&#x27;scalar_index&#x27;</span>)</span><br><span class="line">    <span class="comment"># 创建索引</span></span><br><span class="line">    client.create_index(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>, index_params=index_params)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5）查看索引信息</span></span><br><span class="line">    res = client.list_indexes(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;索引信息--&gt;<span class="subst">&#123;res&#125;</span>&#x27;</span>)</span><br><span class="line">    res = client.describe_index(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>, index_name=<span class="string">&#x27;vector_index&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;指定索引详细信息--&gt;<span class="subst">&#123;res&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6）查看collection状态</span></span><br><span class="line">    <span class="built_in">print</span>(client.get_load_state(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>))  <span class="comment"># &#123;&#x27;state&#x27;: &lt;LoadState: NotLoad&gt;&#125; 表示数据未加载</span></span><br><span class="line">    client.load_collection(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(client.get_load_state(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>))  <span class="comment"># &#123;&#x27;state&#x27;: &lt;LoadState: Loaded&gt;&#125; 表示数据已加载，可以进行向量搜索</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7）删除索引</span></span><br><span class="line">    <span class="comment"># 如果collection已加载，则需要先释放collection才能删除索引</span></span><br><span class="line">    client.release_collection(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>)</span><br><span class="line">    client.drop_index(collection_name=<span class="string">&#x27;demo_v1&#x27;</span>, index_name=<span class="string">&#x27;vector_index&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-3-Entity实体数据操作"><a href="#5-3-Entity实体数据操作" class="headerlink" title="5.3 Entity实体数据操作"></a>5.3 Entity实体数据操作</h3><p>在 Milvus 中，<strong>实体</strong>指的是<strong>Collections</strong>中共享相同<strong>Schema</strong> 的数据记录，行中每个字段的数据构成一个实体。因此，同一 Collections 中的实体具有相同的属性（如字段名称、数据类型和其他约束）。</p>
<h4 id="5-3-1-数据的增、删、改"><a href="#5-3-1-数据的增、删、改" class="headerlink" title="5.3.1 数据的增、删、改"></a>5.3.1 数据的增、删、改</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">operate_entity</span>(<span class="params">client</span>):</span><br><span class="line">    <span class="comment"># todo: 1.创建集合collection</span></span><br><span class="line">    <span class="comment"># 这种方式: collection 只包括两个字段. id 作为主键， vector 作为向量字段，以及自动设置 auto_id、enable_dynamic_field 为 True</span></span><br><span class="line">    <span class="comment"># auto_id 启用此设置可确保主键自动递增。在数据插入期间无需手动提供主键。</span></span><br><span class="line">    <span class="comment"># enable_dynamic_field 启用后，要插入的数据中除 id 和 vector 之外的所有字段都将被视为动态字段。</span></span><br><span class="line">    <span class="comment"># 这些附加字段作为键值对保存在名为 $meta 的特殊字段中。此功能允许在数据插入期间包含额外的字段。</span></span><br><span class="line">    client.create_collection(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>, dimension=<span class="number">5</span>, metric_type=<span class="string">&#x27;IP&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # todo: 2.插入数据</span></span><br><span class="line">    data = [</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">0</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.3580376395471989</span>, -<span class="number">0.6023495712049978</span>, <span class="number">0.18414012509913835</span>, -<span class="number">0.26286205330961354</span>,</span><br><span class="line">                             <span class="number">0.9029438446296592</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;pink_8682&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.19886812562848388</span>, <span class="number">0.06023560599112088</span>, <span class="number">0.6976963061752597</span>, <span class="number">0.2614474506242501</span>,</span><br><span class="line">                             <span class="number">0.838729485096104</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;red_7025&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.43742130801983836</span>, -<span class="number">0.5597502546264526</span>, <span class="number">0.6457887650909682</span>, <span class="number">0.7894058910881185</span>,</span><br><span class="line">                             <span class="number">0.20785793220625592</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;orange_6781&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.3172005263489739</span>, <span class="number">0.9719044792798428</span>, -<span class="number">0.36981146090600725</span>, -<span class="number">0.4860894583077995</span>,</span><br><span class="line">                             <span class="number">0.95791889146345</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;pink_9298&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.4452349528804562</span>, -<span class="number">0.8757026943054742</span>, <span class="number">0.8220779437047674</span>, <span class="number">0.46406290649483184</span>,</span><br><span class="line">                             <span class="number">0.30337481143159106</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;red_4794&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.985825131989184</span>, -<span class="number">0.8144651566660419</span>, <span class="number">0.6299267002202009</span>, <span class="number">0.1206906911183383</span>,</span><br><span class="line">                             -<span class="number">0.1446277761879955</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;yellow_4222&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">6</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.8371977790571115</span>, -<span class="number">0.015764369584852833</span>, -<span class="number">0.31062937026679327</span>, -<span class="number">0.562666951622192</span>,</span><br><span class="line">                             -<span class="number">0.8984947637863987</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;red_9392&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">7</span>, <span class="string">&quot;vector&quot;</span>: [-<span class="number">0.33445148015177995</span>, -<span class="number">0.2567135004164067</span>, <span class="number">0.8987539745369246</span>, <span class="number">0.9402995886420709</span>,</span><br><span class="line">                             <span class="number">0.5378064918413052</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;grey_8510&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">8</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.39524717779832685</span>, <span class="number">0.4000257286739164</span>, -<span class="number">0.5890507376891594</span>, -<span class="number">0.8650502298996872</span>,</span><br><span class="line">                             -<span class="number">0.6140360785406336</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;white_9381&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">9</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.5718280481994695</span>, <span class="number">0.24070317428066512</span>, -<span class="number">0.3737913482606834</span>, -<span class="number">0.06726932177492717</span>,</span><br><span class="line">                             -<span class="number">0.6980531615588608</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;purple_4976&quot;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># 插入数据</span></span><br><span class="line">    result1 = client.insert(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>, data=data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;插入数据结果--&gt;<span class="subst">&#123;result1&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # todo: 3.向分区中插入数据</span></span><br><span class="line">    <span class="comment"># data = [</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 10, &quot;vector&quot;: [-0.5570353903748935, -0.8997887893201304, -0.7123782431855732, -0.6298990746450119,</span></span><br><span class="line">    <span class="comment">#                           0.6699215060604258], &quot;color&quot;: &quot;red_1202&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 11, &quot;vector&quot;: [0.6319019033373907, 0.6821488267878275, 0.8552303045704168, 0.36929791364943054,</span></span><br><span class="line">    <span class="comment">#                           -0.14152860714878068], &quot;color&quot;: &quot;blue_4150&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 12, &quot;vector&quot;: [0.9483947484855766, -0.32294203351925344, 0.9759290319978025, 0.8262982148666174,</span></span><br><span class="line">    <span class="comment">#                           -0.8351194181285713], &quot;color&quot;: &quot;orange_4590&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 13, &quot;vector&quot;: [-0.5449109892498731, 0.043511240563786524, -0.25105249484790804, -0.012030655265886425,</span></span><br><span class="line">    <span class="comment">#                           -0.0010987671273892108], &quot;color&quot;: &quot;pink_9619&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 14, &quot;vector&quot;: [0.6603339372951424, -0.10866551787442225, -0.9435597754324891, 0.8230244263466688,</span></span><br><span class="line">    <span class="comment">#                           -0.7986720938400362], &quot;color&quot;: &quot;orange_4863&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 15, &quot;vector&quot;: [-0.8825129181091456, -0.9204557711667729, -0.935350065513425, 0.5484069690287079,</span></span><br><span class="line">    <span class="comment">#                           0.24448151140671204], &quot;color&quot;: &quot;orange_7984&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 16, &quot;vector&quot;: [0.6285586391568163, 0.5389064528263487, -0.3163366239905099, 0.22036279378888013,</span></span><br><span class="line">    <span class="comment">#                           0.15077052220816167], &quot;color&quot;: &quot;blue_9010&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 17, &quot;vector&quot;: [-0.20151825016059233, -0.905239387635804, 0.6749305353372479, -0.7324272081377843,</span></span><br><span class="line">    <span class="comment">#                           -0.33007998971889263], &quot;color&quot;: &quot;blue_4521&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 18, &quot;vector&quot;: [0.2432286610792349, 0.01785636564206139, -0.651356982731391, -0.35848148851027895,</span></span><br><span class="line">    <span class="comment">#                           -0.7387383128324057], &quot;color&quot;: &quot;orange_2529&quot;&#125;,</span></span><br><span class="line">    <span class="comment">#     &#123;&quot;id&quot;: 19, &quot;vector&quot;: [0.055512329053363674, 0.7100266349039421, 0.4956956543575197, 0.24541352586717702,</span></span><br><span class="line">    <span class="comment">#                           0.4209030729923515], &quot;color&quot;: &quot;red_9437&quot;&#125;</span></span><br><span class="line">    <span class="comment"># ]</span></span><br><span class="line">    <span class="comment"># # 创建分区</span></span><br><span class="line">    <span class="comment"># client.create_partition(collection_name=&#x27;demo_v2&#x27;, partition_name=&#x27;partition1&#x27;)</span></span><br><span class="line">    <span class="comment"># # 插入数据</span></span><br><span class="line">    <span class="comment"># result2 = client.insert(collection_name=&#x27;demo_v2&#x27;, data=data, partition_name=&#x27;partition1&#x27;)</span></span><br><span class="line">    <span class="comment"># print(f&#x27;插入数据结果--&gt;&#123;result2&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 4.更新插入</span></span><br><span class="line">    <span class="comment"># 在 Milvus 中，upsert 操作执行数据级操作，根据集合中是否已存在主键来插入或更新实体。具体来说：</span></span><br><span class="line">    <span class="comment"># 如果集合中已存在该实体的主键，则现有实体将被覆盖。</span></span><br><span class="line">    <span class="comment"># 如果集合中不存在主键，则将插入一个新实体。</span></span><br><span class="line">    data = [</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">0</span>, <span class="string">&quot;vector&quot;</span>: [-<span class="number">0.619954382375778</span>, <span class="number">0.4479436794798608</span>, -<span class="number">0.17493894838751745</span>, -<span class="number">0.4248030059917294</span>,</span><br><span class="line">                             -<span class="number">0.8648452746018911</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;black_9898&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.4762662251462588</span>, -<span class="number">0.6942502138717026</span>, -<span class="number">0.4490002642657902</span>, -<span class="number">0.628696575798281</span>,</span><br><span class="line">                             <span class="number">0.9660395877041965</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;red_7319&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;vector&quot;</span>: [-<span class="number">0.8864122635045097</span>, <span class="number">0.9260170474445351</span>, <span class="number">0.801326976181461</span>, <span class="number">0.6383943392381306</span>,</span><br><span class="line">                             <span class="number">0.7563037341572827</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;white_6465&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.14594326235891586</span>, -<span class="number">0.3775407299900644</span>, -<span class="number">0.3765479013078812</span>, <span class="number">0.20612075380355122</span>,</span><br><span class="line">                             <span class="number">0.4902678929632145</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;orange_7580&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.4548498669607359</span>, -<span class="number">0.887610217681605</span>, <span class="number">0.5655081329910452</span>, <span class="number">0.19220509387904117</span>,</span><br><span class="line">                             <span class="number">0.016513983433433577</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;red_3314&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.11755001847051827</span>, -<span class="number">0.7295149788999611</span>, <span class="number">0.2608115847524266</span>, -<span class="number">0.1719167007897875</span>,</span><br><span class="line">                             <span class="number">0.7417611743754855</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;black_9955&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">6</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.9363032158314308</span>, <span class="number">0.030699901477745373</span>, <span class="number">0.8365910312319647</span>, <span class="number">0.7823840208444011</span>,</span><br><span class="line">                             <span class="number">0.2625222076909237</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;yellow_2461&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">7</span>, <span class="string">&quot;vector&quot;</span>: [<span class="number">0.0754823906014721</span>, -<span class="number">0.6390658668265143</span>, <span class="number">0.5610517334334937</span>, -<span class="number">0.8986261118798251</span>,</span><br><span class="line">                             <span class="number">0.9372056764266794</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;white_5015&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">8</span>, <span class="string">&quot;vector&quot;</span>: [-<span class="number">0.3038434006935904</span>, <span class="number">0.1279149203380523</span>, <span class="number">0.503958664270957</span>, -<span class="number">0.2622661156746988</span>,</span><br><span class="line">                             <span class="number">0.7407627307791929</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;purple_6414&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">9</span>, <span class="string">&quot;vector&quot;</span>: [-<span class="number">0.7125086947677588</span>, -<span class="number">0.8050968321012257</span>, -<span class="number">0.32608864121785786</span>, <span class="number">0.3255654958645424</span>,</span><br><span class="line">                             <span class="number">0.26227968923834233</span>], <span class="string">&quot;color&quot;</span>: <span class="string">&quot;brown_7231&quot;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    result3 = client.upsert(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>, data=data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;更新数据结果--&gt;<span class="subst">&#123;result3&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 5.删除数据</span></span><br><span class="line">    result4 = client.delete(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>, <span class="built_in">filter</span>=<span class="string">&quot;id in [0, 1, 2, 3]&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;删除数据结果--&gt;<span class="subst">&#123;result4&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="comment"># 按照id进行删除；指定分区删除数据</span></span><br><span class="line">    <span class="comment"># res = client.delete(collection_name=&#x27;demo_v2&#x27;, ids=[1, 2, 3, 4], partition_name=&#x27;partitionA&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br></pre></td></tr></table></figure>



<h4 id="5-3-2-数据的查询"><a href="#5-3-2-数据的查询" class="headerlink" title="5.3.2 数据的查询"></a>5.3.2 数据的查询</h4><p>简单查询：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">query_operation</span>(<span class="params">client</span>):</span><br><span class="line">    <span class="comment"># todo: 1.单向量搜索</span></span><br><span class="line">    res = client.search(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>,</span><br><span class="line">                        data=[[<span class="number">0.19886812562848388</span>, <span class="number">0.06023560599112088</span>, <span class="number">0.6976963061752597</span>, <span class="number">0.2614474506242501</span>,</span><br><span class="line">                               <span class="number">0.838729485096104</span>]],</span><br><span class="line">                        limit=<span class="number">2</span>,  <span class="comment"># 返回的个数</span></span><br><span class="line">                        search_params=&#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>&#125;,  <span class="comment"># 查询的参数-指定相似度度量的方式</span></span><br><span class="line">                        output_fields=[<span class="string">&quot;id&quot;</span>, <span class="string">&#x27;vector&#x27;</span>])  <span class="comment"># search_params是在查询时执行距离计算方式，如果定义索引的时候，已经制定了方式可以不写</span></span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 2.多向量搜索</span></span><br><span class="line">    res = client.search(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>,</span><br><span class="line">                        data=[[<span class="number">0.19886812562848388</span>, <span class="number">0.06023560599112088</span>, <span class="number">0.6976963061752597</span>, <span class="number">0.2614474506242501</span>, <span class="number">0.838729485096104</span>],</span><br><span class="line">                              [<span class="number">0.3172005263489739</span>, <span class="number">0.9719044792798428</span>, -<span class="number">0.36981146090600725</span>, -<span class="number">0.4860894583077995</span>, <span class="number">0.95791889146345</span>]],</span><br><span class="line">                        limit=<span class="number">2</span>,  <span class="comment"># 返回的个数</span></span><br><span class="line">                        search_params=&#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>&#125;,  <span class="comment"># 查询的参数-指定相似度度量的方式</span></span><br><span class="line">                        output_fields=[<span class="string">&quot;id&quot;</span>, <span class="string">&#x27;vector&#x27;</span>])  <span class="comment"># search_params是在查询时执行距离计算方式，如果定义索引的时候，已经制定了方式可以不写</span></span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 3.分区搜索</span></span><br><span class="line">    res = client.search(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>,</span><br><span class="line">                        data=[[<span class="number">0.19886812562848388</span>, <span class="number">0.06023560599112088</span>, <span class="number">0.6976963061752597</span>, <span class="number">0.2614474506242501</span>,</span><br><span class="line">                               <span class="number">0.838729485096104</span>]],</span><br><span class="line">                        limit=<span class="number">2</span>,  <span class="comment"># 返回的个数</span></span><br><span class="line">                        search_params=&#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>&#125;,  <span class="comment"># 查询的参数-指定相似度度量的方式</span></span><br><span class="line">                        output_fields=[<span class="string">&quot;id&quot;</span>, <span class="string">&#x27;vector&#x27;</span>],  <span class="comment"># search_params是在查询时执行距离计算方式，如果定义索引的时候，已经制定了方式可以不写</span></span><br><span class="line">                        partition_names=[<span class="string">&#x27;partition1&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 4.过滤搜索</span></span><br><span class="line">    res = client.search(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>,</span><br><span class="line">                        data=[[<span class="number">0.19886812562848388</span>, <span class="number">0.06023560599112088</span>, <span class="number">0.6976963061752597</span>, <span class="number">0.2614474506242501</span>,</span><br><span class="line">                               <span class="number">0.838729485096104</span>]],</span><br><span class="line">                        limit=<span class="number">2</span>,  <span class="comment"># 返回的个数</span></span><br><span class="line">                        search_params=&#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>&#125;,  <span class="comment"># 查询的参数-指定相似度度量的方式</span></span><br><span class="line">                        output_fields=[<span class="string">&quot;id&quot;</span>, <span class="string">&#x27;vector&#x27;</span>],  <span class="comment"># search_params是在查询时执行距离计算方式，如果定义索引的时候，已经制定了方式可以不写</span></span><br><span class="line">                        <span class="built_in">filter</span>=<span class="string">&quot;color like &#x27;red%&#x27;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 5.范围搜索</span></span><br><span class="line">    res = client.search(collection_name=<span class="string">&#x27;demo_v2&#x27;</span>,</span><br><span class="line">                        data=[[<span class="number">0.19886812562848388</span>, <span class="number">0.06023560599112088</span>, <span class="number">0.6976963061752597</span>, <span class="number">0.2614474506242501</span>,</span><br><span class="line">                               <span class="number">0.838729485096104</span>]],</span><br><span class="line">                        limit=<span class="number">2</span>,  <span class="comment"># 返回的个数</span></span><br><span class="line">                        search_params=&#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>, <span class="string">&quot;params&quot;</span>:&#123;<span class="string">&quot;radius&quot;</span>: <span class="number">0.8</span>, <span class="string">&quot;range_filter&quot;</span>: <span class="number">1</span>&#125;&#125;,  <span class="comment"># 查询的参数-指定相似度度量的方式</span></span><br><span class="line">                        output_fields=[<span class="string">&quot;id&quot;</span>, <span class="string">&#x27;vector&#x27;</span>])  <span class="comment"># search_params是在查询时执行距离计算方式，如果定义索引的时候，已经制定了方式可以不写</span></span><br><span class="line">    <span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<hr>
<p>复杂查询：</p>
<ul>
<li><p><strong>混合检索</strong>：要对两组 ANN 搜索结果进行合并和重新排序，有必要选择适当的重新排序策略。支持两种重排策略：<strong>加权排名策略（WeightedRanker</strong>）和<strong>重排序</strong>策略（<strong>RRFRanker</strong>）。在选择重排策略时，需要考虑的一个问题是，在向量场中是否需要强调一个或多个基本 ANN 搜索。</p>
</li>
<li><p><strong>加权排名</strong>：如果用户要求结果强调特定的向量场，建议使用该策略。通过 WeightedRanker，用户可以为某些向量场分配更高的权重，从而更加强调这些向量场。例如，在多模态搜索中，图片的文字描述可能比图片的颜色更重要。</p>
<ul>
<li>使用 WeightedRanker 策略时，需要在<code>WeightedRanker</code> 函数中输入权重值。混合搜索中的基本 ANN 搜索次数与需要输入的值的次数相对应。输入值的范围应为 [0,1]，数值越接近 1 表示重要性越高。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymilvus <span class="keyword">import</span> WeightedRanker</span><br><span class="line">rerank= WeightedRanker(<span class="number">0.8</span>, <span class="number">0.3</span>) </span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>RRFRanker（倒数排序融合）</strong>：在没有特定重点的情况下，建议采用这种策略。RRF 可以有效平衡每个向量场的重要性</p>
<ul>
<li>RRFRanker的核心思想是根据每个结果在其检索列表中的排名位置来计算分数。具体而言，算法使用以下公式为每个结果分配分数：</li>
</ul>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251011010328302.png" alt="image-20251011010328302"></p>
<ul>
<li><blockquote>
<p>d：表示文档。</p>
<p>N：表示不同检索路径的数量。</p>
<p>ranki(d)：表示文档 <em>d</em> 在第 <em>i</em> 个检索器中的排名位置，从0开始计数。</p>
<p>k：是一个平滑参数，用于控制随着排名增加分数的降低速度。默认值通常设置为60。</p>
</blockquote>
</li>
<li><p>使用 RRFRanker 策略时，需要将参数值<code>k</code> 输入 RRFRanker。<code>k</code> 的默认值为 60。该参数有助于确定如何组合来自不同 ANN 搜索的排名，目的是平衡和混合所有搜索的重要性。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymilvus <span class="keyword">import</span> RRFRanker</span><br><span class="line"></span><br><span class="line">ranker = RRFRanker(<span class="number">100</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">complex_query</span>(<span class="params">client</span>):</span><br><span class="line">    <span class="comment"># 定义集合的 Schema（关闭动态字段，显式定义字段结构）</span></span><br><span class="line">    schema = client.create_schema(enable_dynamic_field=<span class="literal">False</span>)</span><br><span class="line">    schema.add_field(field_name=<span class="string">&#x27;film_id&#x27;</span>, datatype=DataType.INT64, is_primary=<span class="literal">True</span>)  <span class="comment"># 主键字段</span></span><br><span class="line">    schema.add_field(field_name=<span class="string">&#x27;filmVector&#x27;</span>, datatype=DataType.FLOAT_VECTOR, dim=<span class="number">5</span>)  <span class="comment"># 电影特征向量</span></span><br><span class="line">    schema.add_field(field_name=<span class="string">&#x27;posterVector&#x27;</span>, datatype=DataType.FLOAT_VECTOR, dim=<span class="number">5</span>)  <span class="comment"># 海报特征向量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义索引配置（为不同向量字段建立独立索引）</span></span><br><span class="line">    index_params = client.prepare_index_params()</span><br><span class="line">    index_params.add_index(field_name=<span class="string">&#x27;filmVector&#x27;</span>, index_type=<span class="string">&quot;IVF_FLAT&quot;</span>,</span><br><span class="line">                           metric_type=<span class="string">&quot;L2&quot;</span>, params=&#123;<span class="string">&quot;nlist&quot;</span>: <span class="number">128</span>&#125;)  <span class="comment"># 使用 L2 距离的倒排索引</span></span><br><span class="line">    index_params.add_index(field_name=<span class="string">&#x27;posterVector&#x27;</span>, index_type=<span class="string">&quot;&quot;</span>,</span><br><span class="line">                           metric_type=<span class="string">&quot;COSINE&quot;</span>)  <span class="comment"># 使用余弦相似度，无额外索引结构</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建集合</span></span><br><span class="line">    client.create_collection(collection_name=<span class="string">&#x27;demo_v3&#x27;</span>, schema=schema, index_params=index_params)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成并插入样本数据</span></span><br><span class="line">    entities = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        film_id = random.randint(<span class="number">1</span>, <span class="number">10000</span>)</span><br><span class="line">        film_vector = [random.random() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">        poster_vector = [random.random() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">        entities.append(&#123;<span class="string">&quot;film_id&quot;</span>: film_id, <span class="string">&quot;filmVector&quot;</span>: film_vector, <span class="string">&quot;posterVector&quot;</span>: poster_vector&#125;)</span><br><span class="line"></span><br><span class="line">    client.insert(collection_name=<span class="string">&#x27;demo_v3&#x27;</span>, data=entities)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------------------</span></span><br><span class="line">    <span class="comment"># 多向量混合搜索（Hybrid Search）示例</span></span><br><span class="line">    <span class="comment"># ----------------------------</span></span><br><span class="line">    <span class="comment"># hybrid_search() 可在一次请求中同时对多个向量字段执行独立的 ANN（近似最近邻）搜索，</span></span><br><span class="line">    <span class="comment"># 每个 AnnSearchRequest 代表一个字段上的查询。</span></span><br><span class="line">    <span class="comment"># 搜索结果将通过 ranker（如 RRFRanker）进行融合排序。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1)检索路径1：搜索电影向量，使用 L2 距离 进行相似度评估</span></span><br><span class="line">    <span class="comment"># 定义针对 filmVector 的搜索请求</span></span><br><span class="line">    query_filmVector = [[<span class="number">0.8896863042430693</span>, <span class="number">0.370613100114602</span>, <span class="number">0.23779315077113428</span>,</span><br><span class="line">                         <span class="number">0.38227915951132996</span>, <span class="number">0.5997064603128835</span>]]</span><br><span class="line">    dense_search_params = &#123;</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: query_filmVector,</span><br><span class="line">        <span class="string">&quot;anns_field&quot;</span>: <span class="string">&quot;filmVector&quot;</span>,  <span class="comment"># 与 schema 中定义的字段名一致</span></span><br><span class="line">        <span class="string">&quot;param&quot;</span>: &#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;L2&quot;</span>, <span class="string">&quot;nprobe&quot;</span>: <span class="number">10</span>&#125;,  <span class="comment"># nprobe 控制搜索的簇数量</span></span><br><span class="line">        <span class="string">&quot;limit&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    request_1 = AnnSearchRequest(**dense_search_params)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Request 1--&gt;<span class="subst">&#123;request_1&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2)检索路径2：搜索导演向量，使用 COSINE 进行相似度评估</span></span><br><span class="line">    <span class="comment"># 定义针对 posterVector 的搜索请求</span></span><br><span class="line">    query_posterVector = [[<span class="number">0.02550758562349764</span>, <span class="number">0.006085637357292062</span>,</span><br><span class="line">                           <span class="number">0.5325251250159071</span>, <span class="number">0.7676432650114147</span>, <span class="number">0.5521074424751443</span>]]</span><br><span class="line">    sparse_search_params = &#123;</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: query_posterVector,</span><br><span class="line">        <span class="string">&quot;anns_field&quot;</span>: <span class="string">&quot;posterVector&quot;</span>,</span><br><span class="line">        <span class="string">&quot;param&quot;</span>: &#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;COSINE&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;limit&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    request_2 = AnnSearchRequest(**sparse_search_params)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Request 2--&gt;<span class="subst">&#123;request_2&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3)结果进行聚合</span></span><br><span class="line">    <span class="comment"># 第一种融合方式：加权排名策略</span></span><br><span class="line">    rerank = WeightedRanker(<span class="number">0.8</span>, <span class="number">0.3</span>)</span><br><span class="line">    <span class="comment"># 使用hybrid_search来实现混合搜索</span></span><br><span class="line">    final_result = client.hybrid_search(collection_name=<span class="string">&#x27;demo_v3&#x27;</span>,</span><br><span class="line">                                        reqs=[request_1, request_2],</span><br><span class="line">                                        ranker=rerank,</span><br><span class="line">                                        output_fields=[<span class="string">&quot;film_id&quot;</span>, <span class="string">&quot;filmVector&quot;</span>, <span class="string">&quot;posterVector&quot;</span>],</span><br><span class="line">                                        limit=<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;final_result--&gt;<span class="subst">&#123;final_result&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 第二种融合方式：倒数排序融合</span></span><br><span class="line">    ranker = RRFRanker(k=<span class="number">100</span>)  <span class="comment"># k值默认为60，指的是平滑系数</span></span><br><span class="line">    <span class="comment"># 使用hybrid_search来实现混合搜索</span></span><br><span class="line">    final_result = client.hybrid_search(collection_name=<span class="string">&#x27;demo_v3&#x27;</span>,</span><br><span class="line">                                        reqs=[request_1, request_2],</span><br><span class="line">                                        ranker=ranker,</span><br><span class="line">                                        output_fields=[<span class="string">&quot;film_id&quot;</span>, <span class="string">&quot;filmVector&quot;</span>, <span class="string">&quot;posterVector&quot;</span>],</span><br><span class="line">                                        limit=<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;final_result--&gt;<span class="subst">&#123;final_result&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="5-4-删除-Collections"><a href="#5-4-删除-Collections" class="headerlink" title="5.4 删除 Collections"></a>5.4 删除 Collections</h3><p>如果想删除某个 Collections 中的所有数据，可以通过以下方法丢弃该 Collections</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Drop collection</span></span><br><span class="line">client.drop_collection(collection_name=<span class="string">&quot;demo_collection&quot;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="一、Python日志介绍与应用"><a href="#一、Python日志介绍与应用" class="headerlink" title="一、Python日志介绍与应用"></a>一、Python日志介绍与应用</h1><hr>
<h2 id="1-日志记录概述【掌握】"><a href="#1-日志记录概述【掌握】" class="headerlink" title="1 日志记录概述【掌握】"></a>1 日志记录概述【掌握】</h2><p>日志（Logging）是程序运行时记录关键信息的一种方式，例如操作成功、错误发生或调试信息。它在开发和维护中非常重要，因为：</p>
<ul>
<li><strong>调试</strong>：帮助找到代码中的问题。</li>
<li><strong>监控</strong>：记录程序的运行状态。</li>
<li><strong>审计</strong>：追踪用户或系统的行为。</li>
</ul>
<p>Python的<code>logging</code>模块是一个内置工具，提供灵活的日志记录功能，比简单的<code>print</code>语句更强大。</p>
<hr>
<p><strong>核心概念：</strong></p>
<p>（1）<strong>日志级别</strong>：表示日志的重要性，常见级别从低到高：</p>
<ul>
<li><code>DEBUG</code>：调试信息（最低）。</li>
<li><code>INFO</code>：一般信息。</li>
<li><code>WARNING</code>：警告，可能有问题。</li>
<li><code>ERROR</code>：错误，已影响程序。</li>
<li><code>CRITICAL</code>：严重错误（最高）。</li>
</ul>
<p>（2）<strong>日志处理器（Handler）</strong>：决定日志输出到哪里（如控制台或文件）。</p>
<p>（3）<strong>日志格式（Formatter）</strong>：定义日志的显示样式（如时间、级别、消息）。</p>
<hr>
<h2 id="2-示例1：基础日志记录【实现】"><a href="#2-示例1：基础日志记录【实现】" class="headerlink" title="2 示例1：基础日志记录【实现】"></a>2 示例1：基础日志记录【实现】</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置基本的日志设置</span></span><br><span class="line">logging.basicConfig(level=logging.WARNING)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取日志记录器</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;Example1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录不同级别的日志</span></span><br><span class="line">logger.debug(<span class="string">&quot;这是调试信息，通常用于开发&quot;</span>)</span><br><span class="line">logger.info(<span class="string">&quot;程序运行正常&quot;</span>)</span><br><span class="line">logger.warning(<span class="string">&quot;注意，可能有小问题&quot;</span>)</span><br><span class="line">logger.error(<span class="string">&quot;发生错误&quot;</span>)</span><br><span class="line">logger.critical(<span class="string">&quot;严重错误，程序可能崩溃&quot;</span>)</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="3-示例2：自定义日志格式【实现】"><a href="#3-示例2：自定义日志格式【实现】" class="headerlink" title="3 示例2：自定义日志格式【实现】"></a>3 示例2：自定义日志格式【实现】</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(name)s - %(asctime)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取日志记录器</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;Example2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录日志</span></span><br><span class="line">logger.debug(<span class="string">&quot;调试模式已开启&quot;</span>)</span><br><span class="line">logger.info(<span class="string">&quot;正在处理数据&quot;</span>)</span><br><span class="line">logger.error(<span class="string">&quot;数据处理失败&quot;</span>)</span><br></pre></td></tr></table></figure>




<p>常见的 format 占位符说明表：</p>
<table>
<thead>
<tr>
<th>占位符</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>%(asctime)s</code></td>
<td>日志事件发生的时间（格式默认为 <code>YYYY-MM-DD HH:MM:SS,mmm</code>）</td>
<td><code>2025-10-11 11:12:23,456</code></td>
</tr>
<tr>
<td><code>%(levelname)s</code></td>
<td>日志级别名称</td>
<td><code>DEBUG</code>、<code>INFO</code>、<code>WARNING</code>、<code>ERROR</code>、<code>CRITICAL</code></td>
</tr>
<tr>
<td><code>%(message)s</code></td>
<td>实际的日志消息内容</td>
<td><code>This is a log message</code></td>
</tr>
<tr>
<td><code>%(name)s</code></td>
<td>日志记录器的名称（logger 名称）</td>
<td><code>root</code> 或自定义名称</td>
</tr>
<tr>
<td><code>%(filename)s</code></td>
<td>当前执行的文件名（不含路径）</td>
<td><code>main.py</code></td>
</tr>
<tr>
<td><code>%(pathname)s</code></td>
<td>当前执行的文件完整路径</td>
<td><code>/home/user/project/main.py</code></td>
</tr>
<tr>
<td><code>%(lineno)d</code></td>
<td>日志语句所在的行号</td>
<td><code>42</code></td>
</tr>
<tr>
<td><code>%(funcName)s</code></td>
<td>调用日志的函数名</td>
<td><code>process_data</code></td>
</tr>
<tr>
<td><code>%(module)s</code></td>
<td>模块名（去掉 <code>.py</code> 的文件名）</td>
<td><code>main</code></td>
</tr>
<tr>
<td><code>%(thread)d</code></td>
<td>线程 ID（整数）</td>
<td><code>139635528570624</code></td>
</tr>
<tr>
<td><code>%(threadName)s</code></td>
<td>线程名称</td>
<td><code>MainThread</code></td>
</tr>
<tr>
<td><code>%(process)d</code></td>
<td>进程 ID</td>
<td><code>12345</code></td>
</tr>
<tr>
<td><code>%(processName)s</code></td>
<td>进程名称</td>
<td><code>MainProcess</code></td>
</tr>
<tr>
<td><code>%(levelno)s</code></td>
<td>日志级别的数字值（DEBUG&#x3D;10, INFO&#x3D;20, 等）</td>
<td><code>10</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="4-示例3：将日志存储到文件【实现】"><a href="#4-示例3：将日志存储到文件【实现】" class="headerlink" title="4 示例3：将日志存储到文件【实现】"></a>4 示例3：将日志存储到文件【实现】</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志格式</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(name)s - %(asctime)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">    filename=<span class="string">&#x27;C03_base_use.log&#x27;</span>,</span><br><span class="line">    filemode=<span class="string">&#x27;w&#x27;</span>,  <span class="comment"># a 追加； w 覆盖</span></span><br><span class="line">    encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取日志记录器</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;Example3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录日志</span></span><br><span class="line">logger.debug(<span class="string">&quot;调试模式已开启&quot;</span>)</span><br><span class="line">logger.info(<span class="string">&quot;正在处理数据&quot;</span>)</span><br><span class="line">logger.error(<span class="string">&quot;数据处理失败&quot;</span>)</span><br></pre></td></tr></table></figure>




<hr>
<h2 id="5-示例4：同时输出到控制台和文件【实现】"><a href="#5-示例4：同时输出到控制台和文件【实现】" class="headerlink" title="5 示例4：同时输出到控制台和文件【实现】"></a>5 示例4：同时输出到控制台和文件【实现】</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取日志记录器</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;Example4&quot;</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义日志格式</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">&#x27;%(name)s - %(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建控制台处理器</span></span><br><span class="line">console_handler = logging.StreamHandler()</span><br><span class="line">console_handler.setFormatter(formatter)</span><br><span class="line">console_handler.setLevel(logging.WARNING)  <span class="comment"># 每个日志处理器可以单独设置日志级别，但是这个日志级别必须高于或等于处理器级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建文件处理器</span></span><br><span class="line">file_handler = logging.FileHandler(filename=<span class="string">&quot;C04_base_use.log&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, mode=<span class="string">&quot;a&quot;</span>)</span><br><span class="line">file_handler.setFormatter(formatter)</span><br><span class="line">file_handler.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将处理器添加到日志记录器中</span></span><br><span class="line">logger.addHandler(console_handler)</span><br><span class="line">logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录日志</span></span><br><span class="line">logger.debug(<span class="string">&quot;调试模式已开启&quot;</span>)</span><br><span class="line">logger.info(<span class="string">&quot;正在处理数据&quot;</span>)</span><br><span class="line">logger.error(<span class="string">&quot;数据处理失败&quot;</span>)</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="6-代码实现【理解】"><a href="#6-代码实现【理解】" class="headerlink" title="6 代码实现【理解】"></a>6 代码实现【理解】</h2><h3 id="6-1-整体结构"><a href="#6-1-整体结构" class="headerlink" title="6.1 整体结构"></a>6.1 整体结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">logging_lesson/</span><br><span class="line">├── logs/</span><br><span class="line">│   └── app.log      # 日志文件</span><br><span class="line">├── utils/</span><br><span class="line">│   └── logger.py    # 日志配置模块</span><br><span class="line">├── main.py          # 主程序入口</span><br></pre></td></tr></table></figure>

<h3 id="6-2-日志配置模块"><a href="#6-2-日志配置模块" class="headerlink" title="6.2 日志配置模块"></a>6.2 日志配置模块</h3><p>位置：logging_lesson&#x2F;utils&#x2F;logger.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logger</span>(<span class="params">name, log_file=<span class="string">&#x27;logs/app.log&#x27;</span></span>):</span><br><span class="line">    <span class="comment"># 创建日志文件夹</span></span><br><span class="line">    os.makedirs(os.path.dirname(log_file), exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取日志记录器</span></span><br><span class="line">    logger = logging.getLogger(name)</span><br><span class="line">    logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义日志格式</span></span><br><span class="line">    formatter = logging.Formatter(<span class="string">&#x27;%(name)s - %(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建控制台处理器</span></span><br><span class="line">    console_handler = logging.StreamHandler()</span><br><span class="line">    console_handler.setFormatter(formatter)</span><br><span class="line">    console_handler.setLevel(logging.INFO)  <span class="comment"># 每个日志处理器可以单独设置日志级别，但是这个日志级别必须高于或等于处理器级别</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建文件处理器</span></span><br><span class="line">    file_handler = logging.FileHandler(filename=log_file, encoding=<span class="string">&quot;utf-8&quot;</span>, mode=<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    file_handler.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将处理器添加到日志记录器中</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logger.handlers:  <span class="comment"># 先进行判断，再进行添加。避免重复添加处理器</span></span><br><span class="line">        logger.addHandler(console_handler)</span><br><span class="line">        logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    setup_logger(<span class="string">&#x27;demo&#x27;</span>, <span class="string">r&#x27;D:\workspace\python\llm_sy1\P02_tools\logging_lesson\logs\app.log&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="6-2-主程序"><a href="#6-2-主程序" class="headerlink" title="6.2 主程序"></a>6.2 主程序</h3><p>位置：logging_lesson&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> P02_tools.logging_lesson.utils.logger <span class="keyword">import</span> setup_logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入之前配置好的logger对象</span></span><br><span class="line">logger = setup_logger(<span class="string">&#x27;MainApp&#x27;</span>, <span class="string">r&#x27;D:\workspace\python\llm_sy1\P02_tools\logging_lesson\logs\app.log&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_data</span>(<span class="params">data</span>):</span><br><span class="line">    logger.debug(<span class="string">f&quot;开始处理数据: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        logger.error(<span class="string">&quot;数据为空，无法处理&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    logger.info(<span class="string">&quot;数据处理完成&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> data.upper()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    logger.info(<span class="string">&quot;程序启动&quot;</span>)</span><br><span class="line">    result = process_data(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        logger.info(<span class="string">f&quot;处理结果: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">&quot;处理失败&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">&quot;程序结束&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h1 id="二、BM25算法简介与应用"><a href="#二、BM25算法简介与应用" class="headerlink" title="二、BM25算法简介与应用"></a>二、BM25算法简介与应用</h1><hr>
<h2 id="1-BM25算法概述【掌握】"><a href="#1-BM25算法概述【掌握】" class="headerlink" title="1 BM25算法概述【掌握】"></a>1 BM25算法概述【掌握】</h2><p>BM25（Best Matching 25）是一种信息检索领域的排名算法，用于计算查询（Query）与文档（Document）之间的相关性得分。它改进了传统的TF-IDF算法，使检索结果更准确。</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251003105157106.png" alt="img"></p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251006090343544.png" alt="img"></p>
<h2 id="2-简单示例【理解】"><a href="#2-简单示例【理解】" class="headerlink" title="2 简单示例【理解】"></a>2 简单示例【理解】</h2><p>假设我们有以下文档集合：</p>
<ul>
<li>文档1：”我喜欢编程”</li>
<li>文档2：”编程很有趣”</li>
</ul>
<p>需要查询 “他喜欢编程” 最相关的文档</p>
<p><strong>步骤</strong>：</p>
<ol>
<li>分词：将文档和查询拆分为词。<ul>
<li>文档1：[“我”, “喜欢”, “编程”]</li>
<li>文档2：[“编程”, “很”, “有趣”]</li>
<li>查询：[“他”, “喜欢”, “编程”]</li>
</ul>
</li>
<li>计算BM25得分：使用<code>rank_bm25</code>库计算每个文档与查询的相关性。</li>
</ol>
<hr>
<h2 id="3-代码实现【掌握】"><a href="#3-代码实现【掌握】" class="headerlink" title="3 代码实现【掌握】"></a>3 代码实现【掌握】</h2><h3 id="3-1-整体结构"><a href="#3-1-整体结构" class="headerlink" title="3.1 整体结构"></a>3.1 整体结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bm25_lesson/</span><br><span class="line">├── retrieval/</span><br><span class="line">│   └── bm25_search.py  # BM25检索模块</span><br><span class="line">├── main.py             # 主程序入口</span><br></pre></td></tr></table></figure>

<h3 id="3-2-检索模块"><a href="#3-2-检索模块" class="headerlink" title="3.2 检索模块"></a>3.2 检索模块</h3><p>位置：bm25_lesson&#x2F;retrieval&#x2F;bm25_search.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">from</span> rank_bm25 <span class="keyword">import</span> BM25L</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志格式</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.DEBUG,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># 获取日志记录器</span></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"><span class="comment"># print(__name__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BM25Search</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, docs</span>):</span><br><span class="line">        self.docs = docs</span><br><span class="line">        <span class="comment"># 将文档进行分词</span></span><br><span class="line">        self.tokenized_docs = [jieba.lcut(doc) <span class="keyword">for</span> doc <span class="keyword">in</span> self.docs]</span><br><span class="line">        <span class="comment"># print(f&#x27;tokenized_docs--&gt;&#123;self.tokenized_docs&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 将分词后的文档送入BM25模型，获得BM25模型的对象</span></span><br><span class="line">        self.bm25 = BM25L(self.tokenized_docs)</span><br><span class="line">        logger.info(<span class="string">f&#x27;BM25模型对象创建成功&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="comment"># 将查询语句进行分词</span></span><br><span class="line">        tokenized_query = jieba.lcut(query)</span><br><span class="line">        <span class="comment"># print(f&#x27;tokenized_query--&gt;&#123;tokenized_query&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 获取BM25模型对象，并调用get_scores方法，传入查询语句，获取查询语句的BM25得分</span></span><br><span class="line">        scores = self.bm25.get_scores(tokenized_query)</span><br><span class="line">        <span class="comment"># print(f&#x27;scores--&gt;&#123;scores&#125;&#x27;)  # [1.09433592 0.22790195]</span></span><br><span class="line">        <span class="comment"># 获取最高分数对应的索引</span></span><br><span class="line">        best_index = scores.argmax()</span><br><span class="line">        <span class="comment"># print(f&#x27;best_index--&gt;&#123;best_index&#125;&#x27;)</span></span><br><span class="line">        best_score = scores[best_index]</span><br><span class="line">        best_doc = self.docs[best_index]</span><br><span class="line">        logger.info(<span class="string">f&#x27;查询语句：<span class="subst">&#123;query&#125;</span>，最匹配的文档：<span class="subst">&#123;best_doc&#125;</span>，BM25得分：<span class="subst">&#123;best_score&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> best_doc, best_score</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 示例文档集合</span></span><br><span class="line">    documents = [<span class="string">&quot;我喜欢编程&quot;</span>, <span class="string">&quot;编程很有趣&quot;</span>]</span><br><span class="line">    obj = BM25Search(documents)</span><br><span class="line">    query = <span class="string">&quot;他喜欢编程&quot;</span></span><br><span class="line">    best_doc, best_score = obj.search(query)</span><br></pre></td></tr></table></figure>

<p><strong>拓展：</strong></p>
<table>
<thead>
<tr>
<th>模型</th>
<th>核心改进</th>
<th>优势</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>BM25Okapi</strong></td>
<td>标准版本</td>
<td>理论基础扎实，参数直观</td>
<td>通用文本检索任务</td>
</tr>
<tr>
<td><strong>BM25L</strong></td>
<td>对低词频项加平滑（+δ）</td>
<td>改善低频词、短文本表现</td>
<td>新闻、微博、短文本检索</td>
</tr>
<tr>
<td><strong>BM25Plus</strong></td>
<td>对整体加平滑（+Δ）</td>
<td>综合性能更稳健，长度惩罚更合理</td>
<td>通用任务、长短文混合场景</td>
</tr>
</tbody></table>
<h3 id="3-3-主程序"><a href="#3-3-主程序" class="headerlink" title="3.3 主程序"></a>3.3 主程序</h3><p>位置：bm25_lesson&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> retrieval.bm25_search <span class="keyword">import</span> BM25Search</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 示例文档集合</span></span><br><span class="line">    documents = [<span class="string">&quot;我喜欢编程&quot;</span>, <span class="string">&quot;编程很有趣&quot;</span>]</span><br><span class="line">    obj = BM25Search(documents)</span><br><span class="line">    query = <span class="string">&quot;他喜欢编程&quot;</span></span><br><span class="line">    best_doc, best_score = obj.search(query)</span><br><span class="line">    <span class="keyword">if</span> best_doc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;查询语句：<span class="subst">&#123;query&#125;</span>，最匹配的文档：<span class="subst">&#123;best_doc&#125;</span>，BM25得分：<span class="subst">&#123;best_score&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">f&quot;未找到匹配的文档！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h1 id="三、Redis数据库简介与使用"><a href="#三、Redis数据库简介与使用" class="headerlink" title="三、Redis数据库简介与使用"></a>三、Redis数据库简介与使用</h1><hr>
<h2 id="1-Redis-数据库概述【理解】"><a href="#1-Redis-数据库概述【理解】" class="headerlink" title="1 Redis 数据库概述【理解】"></a>1 Redis 数据库概述【理解】</h2><p>Redis（Remote Dictionary Server）是一个高性能的键值对数据库，常用于缓存、会话管理等场景。它支持多种数据结构（如字符串、哈希、列表等），并提供快速的内存操作。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io/</a></p>
<p><strong>Redis 的核心特性：</strong></p>
<ul>
<li><strong>高性能</strong>：数据存储在内存中，读写速度极快。</li>
<li><strong>持久化</strong>：支持 RDB（快照式） 和 AOF（日志式） 两种持久化方式。</li>
<li><strong>灵活性</strong>：支持多种数据类型和丰富命令。</li>
<li><strong>简单易用</strong>：提供直观的 API，易于集成。</li>
</ul>
<p><strong>应用场景：</strong></p>
<ul>
<li>缓存查询结果以减少数据库压力。</li>
<li>存储用户会话信息。</li>
<li>实现排行榜或计数器功能。</li>
</ul>
<p><code>Redis在本项目中的作用：</code></p>
<p>去缓存极高频的问答对，如果用户的问题到达后，会直接检索Redis中有没有<code>相同</code>的问题，如果有则直接返回答案！如果没有，则去MySQL有没有<code>相似</code>的问题，如果有则返回问题答案；如果没有则进行RAG搜索。</p>
<h2 id="2-代码实现【实现】"><a href="#2-代码实现【实现】" class="headerlink" title="2 代码实现【实现】"></a>2 代码实现【实现】</h2><h3 id="2-1-整体结构"><a href="#2-1-整体结构" class="headerlink" title="2.1 整体结构"></a>2.1 整体结构</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis<span class="built_in">_</span>lesson/</span><br><span class="line">├── base.py             <span class="params">#</span> 配置文件和日志模块</span><br><span class="line">├── redis<span class="built_in">_</span>client.py      <span class="params">#</span> Redis 客户端模块</span><br><span class="line">├── main.py             <span class="params">#</span> 主程序入口</span><br></pre></td></tr></table></figure>

<p>操作Redis之前，需要先启动Docker中的Redis。</p>
<h3 id="2-2-配置文件"><a href="#2-2-配置文件" class="headerlink" title="2.2 配置文件"></a>2.2 配置文件</h3><p>位置：redis_lesson&#x2F;base.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    REDIS_HOST = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    REDIS_PORT = <span class="number">6379</span></span><br><span class="line">    REDIS_PASSWORD = <span class="number">1234</span></span><br><span class="line">    REDIS_DB = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-Redis-客户端模块"><a href="#2-3-Redis-客户端模块" class="headerlink" title="2.3 Redis 客户端模块"></a>2.3 Redis 客户端模块</h3><p>位置：redis_lesson&#x2F;redis_client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> base <span class="keyword">import</span> Config, logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.logger = logger</span><br><span class="line">        self.conf = Config()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client = redis.StrictRedis(host=self.conf.REDIS_HOST,</span><br><span class="line">                                            port=self.conf.REDIS_PORT,</span><br><span class="line">                                            password=self.conf.REDIS_PASSWORD,</span><br><span class="line">                                            db=self.conf.REDIS_DB,</span><br><span class="line">                                            decode_responses=<span class="literal">True</span>)  <span class="comment"># 将响应解码为字符串</span></span><br><span class="line">            self.logger.info(<span class="string">&quot;RedisClient成功启动!&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;Redis 连接失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_data</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client.<span class="built_in">set</span>(key, json.dumps(value))</span><br><span class="line">            self.logger.info(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 存储成功&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 存储失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据key获取数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_data</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = self.client.get(key)</span><br><span class="line">            <span class="comment"># print(f&#x27;value--&gt;&#123;type(value), value&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">return</span> json.loads(value) <span class="keyword">if</span> value <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 获取失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据问题获取答案</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_answer</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = self.client.get(<span class="string">f&quot;answer:<span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># print(f&#x27;value--&gt;&#123;type(value), value&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                self.logger.info(<span class="string">f&quot;从 Redis 中获取 &#x27;<span class="subst">&#123;query&#125;</span>&#x27; 的答案成功&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> json.loads(value)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;问题 <span class="subst">&#123;query&#125;</span> 获取失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据key删除数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_data</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client.delete(key)</span><br><span class="line">            self.logger.info(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 删除成功&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 删除失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    redis_client = RedisClient()</span><br></pre></td></tr></table></figure>



<h3 id="2-4-主程序"><a href="#2-4-主程序" class="headerlink" title="2.4 主程序"></a>2.4 主程序</h3><p>位置：redis_lesson&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis_client <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> base <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建Redis客户端</span></span><br><span class="line">    redis_client = RedisClient()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 示例数据</span></span><br><span class="line">    key = <span class="string">&quot;user1&quot;</span></span><br><span class="line">    value = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>&#125;</span><br><span class="line">    <span class="comment"># 存储数据</span></span><br><span class="line">    redis_client.set_data(key, value)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据</span></span><br><span class="line">    data = redis_client.get_data(key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;获取的数据为：<span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 存储问答对</span></span><br><span class="line">    query = <span class="string">&quot;什么是AI&quot;</span></span><br><span class="line">    key = <span class="string">&quot;answer:&quot;</span> + query</span><br><span class="line">    value = <span class="string">&quot;人工智能&quot;</span></span><br><span class="line">    redis_client.set_data(key, value)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据</span></span><br><span class="line">    <span class="comment"># data = redis_client.get_data(key)</span></span><br><span class="line">    <span class="comment"># print(f&quot;获取的答案为：&#123;data&#125;&quot;)</span></span><br><span class="line">    answer = redis_client.get_answer(query)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;获取的答案为：<span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除数据</span></span><br><span class="line">    redis_client.delete_data(key)</span><br><span class="line">    answer = redis_client.get_answer(query)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;获取的答案为：<span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>运行结果：<br><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251013112347907.png" alt="image-20251013112347907"></p>
<h1 id="四、基于MySQL的FQA问答系统实现"><a href="#四、基于MySQL的FQA问答系统实现" class="headerlink" title="四、基于MySQL的FQA问答系统实现"></a>四、基于MySQL的FQA问答系统实现</h1><hr>
<h2 id="1-FQA系统概述"><a href="#1-FQA系统概述" class="headerlink" title="1 FQA系统概述"></a>1 FQA系统概述</h2><p>本系统从MySQL数据库检索问答对，使用BM25算法计算相似度，并通过Softmax归一化将得分转换为概率值，阈值0.85判断答案可靠性。若MySQL无可靠答案，则调用RAG系统检索。为加快查询效率，优先使用Redis查询相同问题的答案，因为Redis中缓存了高可靠性结果（相似度&gt;0.85且有答案）。</p>
<h3 id="1-1-系统流程【掌握】"><a href="#1-1-系统流程【掌握】" class="headerlink" title="1.1 系统流程【掌握】"></a>1.1 系统流程【掌握】</h3><ol>
<li><strong>数据存储</strong>：MySQL存储FQA高频问答对数据。</li>
<li><strong>缓存管理</strong>：先基于Redis缓存，返回相同问题的答案，如果没有命中则进行MySQL问题检索；Redis中仅缓存相似度&gt;0.85且有答案的数据。</li>
<li><strong>问题检索</strong>：如果Redis中没有命中相同问题，则使用BM25计算与所有问题的相似度，将相似分数Softmax归一化。获取最相似文档的分数，并判断是否大于阈值0.85，如果是则认为是同一问题，去MySQL中查询该问题的答案；如果不是则调用RAG系统检索。</li>
<li><strong>答案返回</strong>：<ul>
<li>在MySQL中根据问题查询答案，若返回可靠答案，直接返回。</li>
<li>否则，调用RAG系统检索。</li>
</ul>
</li>
</ol>
<p>流程图如下：</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251013015326624.png" alt="image-20251013015326624" style="zoom:80%;" />



<hr>
<h3 id="1-2-项目结构【理解】"><a href="#1-2-项目结构【理解】" class="headerlink" title="1.2 项目结构【理解】"></a>1.2 项目结构【理解】</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">integrated_qa_system/</span><br><span class="line">├── config.ini                 # 配置文件，包含所有模块的配置</span><br><span class="line">├── base/</span><br><span class="line">│   ├── config.py              # 配置管理，加载 config.ini</span><br><span class="line">│   ├── create_logger.py       # 日志设置</span><br><span class="line">├── mysql_qa/</span><br><span class="line">│   ├── data/</span><br><span class="line">│   │   ├── JP学科知识问答.csv   # FQA数据集</span><br><span class="line">│   ├── db/</span><br><span class="line">│   │   ├── mysql_client.py    # MySQL 数据库操作</span><br><span class="line">│   ├── cache/</span><br><span class="line">│   │   ├── redis_client.py    # Redis 缓存操作</span><br><span class="line">│   ├── retrieval/</span><br><span class="line">│   │   ├── bm25_search.py     # BM25 搜索</span><br><span class="line">│   ├── utils/</span><br><span class="line">│   │   ├── preprocess.py      # 文本预处理</span><br><span class="line">│   ├── main.py                # MySQL 系统独立入口，支持查询</span><br><span class="line">└── logs/</span><br><span class="line">    └── app.log                # 日志文件</span><br></pre></td></tr></table></figure>

<h2 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2 代码实现"></a>2 代码实现</h2><h3 id="2-1-配置文件【理解】"><a href="#2-1-配置文件【理解】" class="headerlink" title="2.1 配置文件【理解】"></a>2.1 配置文件【理解】</h3><p>位置：integrated_qa_system&#x2F;config.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MySQL 配置</span></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">host</span> = localhost</span><br><span class="line"><span class="attr">user</span> = root</span><br><span class="line"><span class="attr">password</span> = root</span><br><span class="line"><span class="attr">database</span> = subjects_kg</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis 配置</span></span><br><span class="line"><span class="section">[redis]</span></span><br><span class="line"><span class="attr">host</span> = localhost</span><br><span class="line"><span class="attr">port</span> = <span class="number">6379</span></span><br><span class="line"><span class="attr">password</span> = <span class="number">1234</span></span><br><span class="line"><span class="attr">db</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="section">[logger]</span></span><br><span class="line"><span class="attr">log_file</span> = logs/app.log</span><br></pre></td></tr></table></figure>

<p><strong>注意：mysql的账号密码需要根据个人情况来设置。</strong></p>
<h3 id="2-2-配置管理【理解】"><a href="#2-2-配置管理【理解】" class="headerlink" title="2.2 配置管理【理解】"></a>2.2 配置管理【理解】</h3><h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><p><code>config.py</code>文件定义了<code>Config</code>类，用于集中管理系统中的所有配置参数。这些参数包括数据库连接信息、模型选择、分块策略、API设置等。通过集中管理配置，系统可以方便地调整参数、适配不同环境，并支持通过环境变量进行灵活配置。</p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>位置：integrated_qa_system&#x2F;base&#x2F;config.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入配置解析库</span></span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="comment"># 导入路径操作库</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目根目录</span></span><br><span class="line">project_root = os.path.join(os.path.dirname(os.path.abspath(__file__)), <span class="string">&#x27;..&#x27;</span>)</span><br><span class="line"><span class="comment"># print(f&#x27;project_root--&gt;&#123;project_root&#125;&#x27;)</span></span><br><span class="line"><span class="comment"># 配置文件路径</span></span><br><span class="line">config_path = os.path.join(project_root, <span class="string">&#x27;config.ini&#x27;</span>)</span><br><span class="line"><span class="comment"># print(f&#x27;config_path--&gt;&#123;config_path&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_file=config_path</span>):</span><br><span class="line">        <span class="comment"># 创建配置解析对象</span></span><br><span class="line">        self.cf = configparser.ConfigParser()</span><br><span class="line">        <span class="comment"># 读取配置文件</span></span><br><span class="line">        self.cf.read(config_file, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="comment"># 获取配置文件中的参数</span></span><br><span class="line">        <span class="comment"># MySQL配置</span></span><br><span class="line">        <span class="comment"># MySQL 主机地址</span></span><br><span class="line">        self.MYSQL_HOST = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, fallback=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">        <span class="comment"># MySQL 用户名</span></span><br><span class="line">        self.MYSQL_USER = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;user&#x27;</span>, fallback=<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">        <span class="comment"># MySQL 密码</span></span><br><span class="line">        self.MYSQL_PASSWORD = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, fallback=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line">        <span class="comment"># MySQL 数据库名</span></span><br><span class="line">        self.MYSQL_DATABASE = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, fallback=<span class="string">&#x27;subjects_kg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Redis 配置</span></span><br><span class="line">        <span class="comment"># Redis 主机地址</span></span><br><span class="line">        self.REDIS_HOST = self.cf.get(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, fallback=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">        <span class="comment"># Redis 端口</span></span><br><span class="line">        self.REDIS_PORT = self.cf.getint(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, fallback=<span class="number">6379</span>)</span><br><span class="line">        <span class="comment"># Redis 密码</span></span><br><span class="line">        self.REDIS_PASSWORD = self.cf.get(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, fallback=<span class="string">&#x27;1234&#x27;</span>)</span><br><span class="line">        <span class="comment"># Redis 数据库编号</span></span><br><span class="line">        self.REDIS_DB = self.cf.getint(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;db&#x27;</span>, fallback=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 日志文件路径</span></span><br><span class="line">        self.LOG_FILE = os.path.join(project_root, self.cf.get(<span class="string">&#x27;logger&#x27;</span>, <span class="string">&#x27;log_file&#x27;</span>, fallback=<span class="string">&#x27;logs/app.log&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    config = Config()</span><br><span class="line">    <span class="built_in">print</span>(config.LOG_FILE)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ul>
<li><strong>默认值</strong>：每个参数设有默认值，确保未配置环境变量时系统仍可运行。</li>
<li><strong>参数分类</strong>：按功能分类（如数据库、日志、模型等），便于管理和维护。</li>
</ul>
<h3 id="2-3-日志记录【实现】"><a href="#2-3-日志记录【实现】" class="headerlink" title="2.3 日志记录【实现】"></a>2.3 日志记录【实现】</h3><h4 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h4><p><code>create_logger.py</code>文件定义了<code>setup_logger</code>函数，用于配置系统的日志记录器。日志记录器将运行信息、警告和错误输出到文件和控制台，便于开发、调试和运维人员监控系统状态。</p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><p>位置：integrated_qa_system&#x2F;base&#x2F;create_logger.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logger</span>(<span class="params">name, log_file=<span class="string">&#x27;logs/app.log&#x27;</span></span>):</span><br><span class="line">    <span class="comment"># 创建日志文件夹</span></span><br><span class="line">    os.makedirs(os.path.dirname(log_file), exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取日志记录器</span></span><br><span class="line">    logger = logging.getLogger(name)</span><br><span class="line">    logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义日志格式</span></span><br><span class="line">    formatter = logging.Formatter(<span class="string">&#x27;%(name)s - %(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建控制台处理器</span></span><br><span class="line">    console_handler = logging.StreamHandler()</span><br><span class="line">    console_handler.setFormatter(formatter)</span><br><span class="line">    console_handler.setLevel(logging.INFO)  <span class="comment"># 每个日志处理器可以单独设置日志级别，但是这个日志级别必须高于或等于处理器级别</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建文件处理器</span></span><br><span class="line">    file_handler = logging.FileHandler(filename=log_file, encoding=<span class="string">&quot;utf-8&quot;</span>, mode=<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    file_handler.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将处理器添加到日志记录器中</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logger.handlers:  <span class="comment"># 先进行判断，再进行添加。避免重复添加处理器</span></span><br><span class="line">        logger.addHandler(console_handler)</span><br><span class="line">        logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line">logger = setup_logger(<span class="string">&#x27;EduRAG&#x27;</span>, Config().LOG_FILE)</span><br></pre></td></tr></table></figure>

<h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><ul>
<li><strong>日志级别</strong>：默认设为<code>INFO</code>，记录关键运行信息。</li>
<li><strong>双重输出</strong>：同时输出到文件和控制台，便于实时监控和后续分析。</li>
<li><strong>格式化</strong>：日志包含时间戳、名称、级别和内容，便于问题定位。</li>
</ul>
<hr>
<h3 id="2-4-MySQL操作模块【理解】"><a href="#2-4-MySQL操作模块【理解】" class="headerlink" title="2.4 MySQL操作模块【理解】"></a>2.4 MySQL操作模块【理解】</h3><h4 id="功能-2"><a href="#功能-2" class="headerlink" title="功能"></a>功能</h4><p><code>mysql_client.py</code>是一个用于与 MySQL 交互的模块。模块通过读取配置文件连接数据库，支持创建表、从 CSV 文件插入数据、查询问题和答案，以及安全关闭连接。所有操作均通过日志记录，便于调试和监控系统状态。</p>
<h4 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h4><p>需提前创建数据库：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> subjects_kg;</span><br></pre></td></tr></table></figure>

<p>在pycharm中配置方式如下：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251013155012224.png" alt="image-20251013155012224"></p>
<p>位置：integrated_qa_system&#x2F;mysql_qa&#x2F;db&#x2F;mysql_client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySQLClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 获取logger对象</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 获取日志对象</span></span><br><span class="line">        self.conf = Config()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 连接数据库</span></span><br><span class="line">            self.connection = pymysql.connect(host=self.conf.MYSQL_HOST,</span><br><span class="line">                                              user=self.conf.MYSQL_USER,</span><br><span class="line">                                              password=self.conf.MYSQL_PASSWORD,</span><br><span class="line">                                              database=self.conf.MYSQL_DATABASE)</span><br><span class="line">            <span class="comment"># 创建游标对象</span></span><br><span class="line">            self.cursor = self.connection.cursor()</span><br><span class="line">            self.logger.info(<span class="string">f&#x27;连接MySQL数据库成功&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&#x27;连接MySQL数据库失败，错误信息为：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建表</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_table</span>(<span class="params">self</span>):</span><br><span class="line">        create_table_sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        CREATE TABLE IF NOT EXISTS jpkb (</span></span><br><span class="line"><span class="string">            id INT AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="string">            subject_name VARCHAR(20),</span></span><br><span class="line"><span class="string">            question VARCHAR(1000),</span></span><br><span class="line"><span class="string">            answer VARCHAR(1000)</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cursor.execute(create_table_sql)</span><br><span class="line">            self.logger.info(<span class="string">f&#x27;创建表成功&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&#x27;创建表失败，错误信息为：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 插入数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_data</span>(<span class="params">self, csv_path</span>):</span><br><span class="line">        data = pd.read_csv(csv_path)</span><br><span class="line">        <span class="comment"># print(f&#x27;data--&gt;&#123;data&#125;&#x27;)</span></span><br><span class="line">        <span class="keyword">for</span> index, row <span class="keyword">in</span> data.iterrows():</span><br><span class="line">            insert_sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            INSERT INTO subjects_kg.jpkb (subject_name, question, answer) VALUES (%s, %s, %s)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.cursor.execute(insert_sql, (row[<span class="string">&#x27;学科名称&#x27;</span>], row[<span class="string">&#x27;问题&#x27;</span>], row[<span class="string">&#x27;答案&#x27;</span>]))</span><br><span class="line">                self.connection.commit()</span><br><span class="line">                self.logger.info(<span class="string">f&#x27;插入数据成功&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.connection.rollback()  <span class="comment"># 回滚</span></span><br><span class="line">                self.logger.error(<span class="string">f&#x27;插入数据失败，错误信息为：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取所有问题</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fecth_questions</span>(<span class="params">self</span>):</span><br><span class="line">        select_sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        SELECT question FROM subjects_kg.jpkb</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cursor.execute(select_sql)</span><br><span class="line">            questions = self.cursor.fetchall()</span><br><span class="line">            self.logger.info(<span class="string">f&#x27;获取所有问题成功&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> questions</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&#x27;获取所有问题失败，错误信息为：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据问题获取答案</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch_answer</span>(<span class="params">self, question</span>):</span><br><span class="line">        select_sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        SELECT answer FROM subjects_kg.jpkb WHERE question = %s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cursor.execute(select_sql, (question,))</span><br><span class="line">            answer = self.cursor.fetchone()</span><br><span class="line">            <span class="comment"># print(f&#x27;原始answer--&gt;&#123;answer&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">if</span> answer:</span><br><span class="line">                answer = answer[<span class="number">0</span>]</span><br><span class="line">                self.logger.info(<span class="string">f&#x27;根据问题获取答案成功&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> answer</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.logger.warning(<span class="string">f&#x27;根据问题获取到一个空答案&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&#x27;根据问题获取答案失败，错误信息为：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 关闭数据库连接</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 关闭连接</span></span><br><span class="line">            self.connection.close()</span><br><span class="line">            <span class="comment"># 记录关闭成功</span></span><br><span class="line">            self.logger.info(<span class="string">&quot;MySQL 连接已关闭&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> pymysql.MySQLError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 记录关闭失败</span></span><br><span class="line">            self.logger.error(<span class="string">f&quot;关闭连接失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 创建MySQL客户端对象</span></span><br><span class="line">    mysql_client = MySQLClient()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建表</span></span><br><span class="line">    <span class="comment"># mysql_client.create_table()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 插入数据</span></span><br><span class="line">    <span class="comment"># mysql_client.insert_data(&#x27;../data/JP学科知识问答.csv&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取所有问题</span></span><br><span class="line">    <span class="comment"># questions = mysql_client.fecth_questions()</span></span><br><span class="line">    <span class="comment"># print(f&#x27;questions--&gt;&#123;questions&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据问题获取答案</span></span><br><span class="line">    <span class="comment"># answer = mysql_client.fetch_answer(&#x27;什么叫Java语言？&#x27;)</span></span><br><span class="line">    <span class="comment"># answer = mysql_client.fetch_answer(&#x27;PyCharm使用中文版本还是英文版本&#x27;)</span></span><br><span class="line">    <span class="comment"># print(f&#x27;answer--&gt;&#123;answer&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 关闭数据库连接</span></span><br><span class="line">    mysql_client.close()</span><br></pre></td></tr></table></figure>

<h4 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h4><ul>
<li><p><strong>数据库连接</strong>：通过 config.ini 配置文件读取 MySQL 参数，使用 pymysql 建立连接。</p>
</li>
<li><p><strong>表管理</strong>：创建 jpkb 表，包含字段 id（自增主键）、subject_name（学科名称）、question（问题）、answer（答案），使用 IF NOT EXISTS 避免重复创建。</p>
</li>
<li><p><strong>插入数据</strong>：读取CSV文件数据并输入表中。</p>
</li>
<li><p><strong>获取问题</strong>：获取所有问题，用于与查询问题计算相似度。</p>
</li>
<li><p><strong>获取答案</strong>：根据问题获取答案。</p>
</li>
<li><p><strong>关闭连接</strong>：关闭MySQL连接，节省资源。</p>
</li>
<li><p><strong>异常处理</strong>：每个方法均捕获异常，记录错误日志并根据需要回滚事务或抛出异常。</p>
</li>
</ul>
<hr>
<h3 id="2-5-Redis-缓存操作模块【理解】"><a href="#2-5-Redis-缓存操作模块【理解】" class="headerlink" title="2.5 Redis 缓存操作模块【理解】"></a>2.5 Redis 缓存操作模块【理解】</h3><h4 id="功能-3"><a href="#功能-3" class="headerlink" title="功能"></a>功能</h4><p><code>redis_client.py</code>该模块用于与 Redis 数据库交互。模块通过配置文件连接 Redis，支持键值对存储与查询（使用 JSON 序列化）、答案缓存查询，并记录操作日志，便于调试和监控。</p>
<h4 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h4><p>位置：integrated_qa_system&#x2F;mysql_qa&#x2F;cache&#x2F;redis_client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.logger = logger</span><br><span class="line">        self.conf = Config()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client = redis.StrictRedis(host=self.conf.REDIS_HOST,</span><br><span class="line">                                            port=self.conf.REDIS_PORT,</span><br><span class="line">                                            password=self.conf.REDIS_PASSWORD,</span><br><span class="line">                                            db=self.conf.REDIS_DB,</span><br><span class="line">                                            decode_responses=<span class="literal">True</span>)  <span class="comment"># 将响应解码为字符串</span></span><br><span class="line">            self.logger.info(<span class="string">&quot;RedisClient成功启动!&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;Redis 连接失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_data</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client.<span class="built_in">set</span>(key, json.dumps(value))</span><br><span class="line">            self.logger.info(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 存储成功&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 存储失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据key获取数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_data</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = self.client.get(key)</span><br><span class="line">            <span class="comment"># print(f&#x27;value--&gt;&#123;type(value), value&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">return</span> json.loads(value) <span class="keyword">if</span> value <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 获取失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据问题获取答案</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_answer</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = self.client.get(<span class="string">f&quot;answer:<span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># print(f&#x27;value--&gt;&#123;type(value), value&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                self.logger.info(<span class="string">f&quot;从 Redis 中获取 &#x27;<span class="subst">&#123;query&#125;</span>&#x27; 的答案成功&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> json.loads(value)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;问题 <span class="subst">&#123;query&#125;</span> 获取失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据key删除数据</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_data</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client.delete(key)</span><br><span class="line">            self.logger.info(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 删除成功&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;数据 <span class="subst">&#123;key&#125;</span> 删除失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    redis_client = RedisClient()</span><br></pre></td></tr></table></figure>

<h4 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h4><ul>
<li><strong>Redis 连接</strong>：通过 config.ini 读取 Redis 配置，使用 redis.StrictRedis 建立连接。</li>
<li><strong>数据操作</strong>： <ul>
<li>set_data：将键值对（值序列化为 JSON）存储到 Redis。</li>
<li>get_data：根据键获取值并反序列化 JSON。</li>
<li>get_answer：查询以 answer:{query} 格式存储的答案缓存。</li>
</ul>
</li>
</ul>
<h3 id="2-6-文本预处理模块【理解】"><a href="#2-6-文本预处理模块【理解】" class="headerlink" title="2.6 文本预处理模块【理解】"></a>2.6 文本预处理模块【理解】</h3><h4 id="功能-4"><a href="#功能-4" class="headerlink" title="功能"></a>功能</h4><p><code>preprocess.py</code>是一个基于 jieba 分词库实现文本预处理的模块。该模块将输入文本转换为小写并进行分词，返回分词结果，支持日志记录以监控处理状态。</p>
<h4 id="代码实现-4"><a href="#代码实现-4" class="headerlink" title="代码实现"></a>代码实现</h4><p>位置：integrated_qa_system&#x2F;mysql_qa&#x2F;utils&#x2F;preprocess.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess_text</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> jieba.lcut(text.lower())</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        logger.error(<span class="string">f&#x27;文本&quot;<span class="subst">&#123;text&#125;</span>&quot;分词处理出现错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(preprocess_text(<span class="string">&#x27;我今天在北京&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h4 id="说明-4"><a href="#说明-4" class="headerlink" title="说明"></a>说明</h4><ul>
<li><strong>文本处理</strong>：使用 jieba.lcut 对输入文本进行中文分词，并将文本转换为小写以规范化。</li>
</ul>
<h3 id="2-7-BM25-Softmax检索模块【掌握】"><a href="#2-7-BM25-Softmax检索模块【掌握】" class="headerlink" title="2.7 BM25+Softmax检索模块【掌握】"></a>2.7 BM25+Softmax检索模块【掌握】</h3><h4 id="功能-5"><a href="#功能-5" class="headerlink" title="功能"></a>功能</h4><p><code>bm25_search.py</code> 是一个基于 BM25 算法和 Softmax 归一化的文本检索模块，用于从问题库中检索与查询最匹配的答案。模块结合 Redis 缓存和 MySQL 数据库，支持问题加载、分词、BM25 评分、Softmax 归一化，并记录操作日志。</p>
<h4 id="代码实现-5"><a href="#代码实现-5" class="headerlink" title="代码实现"></a>代码实现</h4><p>位置：integrated_qa_system&#x2F;mysql_qa&#x2F;retrieval&#x2F;bm25_search.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> rank_bm25 <span class="keyword">import</span> BM25Okapi</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.cache.redis_client <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.db.mysql_client <span class="keyword">import</span> MySQLClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.utils.preprocess <span class="keyword">import</span> preprocess_text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BM25Search</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, mysql_client, redis_client</span>):</span><br><span class="line">        <span class="comment"># 初始化日志对象</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 初始化MySQL客户端</span></span><br><span class="line">        self.mysql_client = mysql_client</span><br><span class="line">        <span class="comment"># 初始化Redis客户端</span></span><br><span class="line">        self.redis_client = redis_client</span><br><span class="line">        <span class="comment"># 初始化原始问题，用于根据索引获取原始问题</span></span><br><span class="line">        self.original_questions = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 初始化分词后的问题，用于训练BM25模型</span></span><br><span class="line">        self.tokenized_questions = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 初始化BM25模型</span></span><br><span class="line">        self.bm25 = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 完成初始化的方法</span></span><br><span class="line">        self._load_data()</span><br><span class="line">        logger.info(<span class="string">f&#x27;BM25模型对象创建成功&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 加载数据</span></span><br><span class="line">        original_key = <span class="string">&quot;qa_original_questions&quot;</span></span><br><span class="line">        tokenized_key = <span class="string">&quot;qa_tokenized_questions&quot;</span></span><br><span class="line">        <span class="comment"># 从 redis 获取原始问题</span></span><br><span class="line">        self.original_questions = self.redis_client.get_data(original_key)</span><br><span class="line">        <span class="comment"># print(f&#x27;original_questions--&gt;&#123;self.original_questions&#125;&#x27;)</span></span><br><span class="line">        <span class="comment">#  从 redis 获取分词后的问题</span></span><br><span class="line">        self.tokenized_questions = self.redis_client.get_data(tokenized_key)</span><br><span class="line">        <span class="comment"># print(f&#x27;tokenized_questions--&gt;&#123;self.tokenized_questions&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果redis中没有数据，则从MySQL数据库中获取数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.original_questions <span class="keyword">or</span> <span class="keyword">not</span> self.tokenized_questions:</span><br><span class="line">            <span class="comment"># 从MySQL数据库中获取原始问题</span></span><br><span class="line">            self.original_questions = self.mysql_client.fecth_questions()</span><br><span class="line">            <span class="comment"># print(f&#x27;original_questions--&gt;&#123;self.original_questions&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.original_questions:  <span class="comment"># 如果返回为空，则发出警告</span></span><br><span class="line">                self.logger.error(<span class="string">&quot;没有获取到原始问题！&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="comment"># 对问题进行分词</span></span><br><span class="line">            self.tokenized_questions = [preprocess_text(question[<span class="number">0</span>]) <span class="keyword">for</span> question <span class="keyword">in</span> self.original_questions]</span><br><span class="line">            <span class="comment"># print(f&#x27;tokenized_questions--&gt;&#123;self.tokenized_questions&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将分词后的问题保存到redis中</span></span><br><span class="line">            self.redis_client.set_data(tokenized_key, self.tokenized_questions)</span><br><span class="line">            <span class="comment"># 将原始问题保存到redis中</span></span><br><span class="line">            self.redis_client.set_data(original_key, self.original_questions)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 训练BM25模型</span></span><br><span class="line">        self.bm25 = BM25Okapi(self.tokenized_questions)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, query, threshold=<span class="number">0.85</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        通过用户的问题去检索redis和mysql，获取缓存的答案</span></span><br><span class="line"><span class="string">        :param query: 用户的问题</span></span><br><span class="line"><span class="string">        :param threshold: 相似度阈值：在检索相似问题时，超过该阈值认为是同一个问题</span></span><br><span class="line"><span class="string">        :return: 缓存的答案，是否需要进行RAG</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># 检查问题，如果无效则返回 None 和 False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> query <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(query, <span class="built_in">str</span>):</span><br><span class="line">            self.logger.error(<span class="string">&quot;无效查询&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 首先去redis中检索有没有相同问题，如果有则返回其答案</span></span><br><span class="line">        cached_answer = self.redis_client.get_answer(query)</span><br><span class="line">        <span class="comment"># print(f&#x27;cached_answer--&gt;&#123;cached_answer&#125;&#x27;)</span></span><br><span class="line">        <span class="keyword">if</span> cached_answer:</span><br><span class="line">            self.logger.info(<span class="string">f&quot;从Redis缓存中获取答案：<span class="subst">&#123;cached_answer&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> cached_answer, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 否则，从MySQL数据库中检索</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 对问题进行分词</span></span><br><span class="line">            query_tokens = preprocess_text(query)</span><br><span class="line">            <span class="comment"># 计算BM25得分</span></span><br><span class="line">            scores = self.bm25.get_scores(query_tokens)</span><br><span class="line">            <span class="comment"># print(f&#x27;scores--&gt;&#123;scores&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 对得分进行归一化</span></span><br><span class="line">            softmax_scores = self._softmax(scores)</span><br><span class="line">            <span class="comment"># print(f&#x27;softmax_scores--&gt;&#123;softmax_scores&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 获取得分最高的索引</span></span><br><span class="line">            best_index = np.argmax(softmax_scores)</span><br><span class="line">            <span class="comment"># print(f&#x27;best_index--&gt;&#123;best_index&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 获取得分最高的分数</span></span><br><span class="line">            best_score = softmax_scores[best_index]</span><br><span class="line">            <span class="comment"># print(f&#x27;best_score--&gt;&#123;best_score&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 检查是否超过阈值</span></span><br><span class="line">            <span class="keyword">if</span> best_score &gt;= threshold:</span><br><span class="line">                <span class="comment"># 获取原始问题</span></span><br><span class="line">                original_question = self.original_questions[best_index][<span class="number">0</span>]</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;original_question--&gt;<span class="subst">&#123;original_question&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="comment"># 从MySQL数据库中获取答案</span></span><br><span class="line">                answer = self.mysql_client.fetch_answer(original_question)</span><br><span class="line">                <span class="keyword">if</span> answer:</span><br><span class="line">                    self.logger.info(<span class="string">f&quot;从MySQL数据库中获取答案：<span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="comment"># 将答案保存到Redis中</span></span><br><span class="line">                    self.redis_client.set_data(<span class="string">&quot;answer:&quot;</span> + query, answer)</span><br><span class="line">                    <span class="comment"># 返回答案</span></span><br><span class="line">                    <span class="keyword">return</span> answer, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果没有找到答案，则返回 None 和 True</span></span><br><span class="line">            self.logger.info(<span class="string">f&quot;best_score为<span class="subst">&#123;best_score&#125;</span>, 最终没有在MySQL找到答案，将进行RAG&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;搜索失败：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_softmax</span>(<span class="params">self, scores</span>):</span><br><span class="line">        <span class="comment"># 计算 softmax 分数</span></span><br><span class="line">        exp_scores = np.exp(scores - np.<span class="built_in">max</span>(scores))</span><br><span class="line">        <span class="comment"># 归一化</span></span><br><span class="line">        <span class="keyword">return</span> exp_scores / np.<span class="built_in">sum</span>(exp_scores)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 创建一个BM25Search对象</span></span><br><span class="line">    mysql_client = MySQLClient()  <span class="comment"># 需要启动MySQL服务</span></span><br><span class="line">    redis_client = RedisClient()  <span class="comment"># 需要启动 Docker</span></span><br><span class="line">    bm25_search = BM25Search(mysql_client, redis_client)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试搜索功能</span></span><br><span class="line">    <span class="comment"># query = &quot;关联子查询的执行顺序是怎样的&quot;</span></span><br><span class="line">    query = <span class="string">&quot;关联子查询的执行顺序是什么&quot;</span></span><br><span class="line">    bm25_search.search(query)</span><br></pre></td></tr></table></figure>

<h4 id="说明-5"><a href="#说明-5" class="headerlink" title="说明"></a>说明</h4><ul>
<li><strong>数据加载</strong>：优先从 Redis 获取问题和分词数据，若无则从 MySQL 加载并分词后缓存到 Redis。</li>
<li><strong>BM25 检索</strong>：使用 BM25Okapi 计算查询与问题库的相似度，结合 Softmax 归一化评分。</li>
<li><strong>答案查询</strong>：通过 Redis 缓存答案，若无缓存则从 MySQL 获取并缓存，阈值（默认 0.85）控制答案可靠性。</li>
</ul>
<p><code>**注意点1：**</code></p>
<p>因为后续需要将最高分数对应的值 和 阈值进行判断，所以需要将分数进行归一化</p>
<p>归一化的方式：</p>
<p>原始计算公式为</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251015103821021.png" alt="image-20251015103821021"></p>
<p>优化的方式为</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251015103900570.png" alt="image-20251015103900570"></p>
<p>对应最终的结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_softmax</span>(<span class="params">scores</span>):</span><br><span class="line">    <span class="comment"># 计算 softmax 分数</span></span><br><span class="line">    exp_scores = np.exp(scores - np.<span class="built_in">max</span>(scores))</span><br><span class="line">    <span class="comment"># 归一化</span></span><br><span class="line">    <span class="keyword">return</span> exp_scores / np.<span class="built_in">sum</span>(exp_scores)</span><br><span class="line"></span><br><span class="line">scores = np.array([<span class="number">3</span>, <span class="number">1</span>, -<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(_softmax(scores))</span><br></pre></td></tr></table></figure>



<p><code>**注意点2：**</code></p>
<p><strong>当MySQL的数据更新之后，如何更新Redis中的数据，进而更新BM25模型？</strong></p>
<p>我们可以对Redis中 用于记录所有历史问题和所有分词问题的key ，即 “qa_original_questions” 和”qa_tokenized_questions”设置一个有效期，有效期可以设置为3小时，这样redis中的这2个key的数据会定期进行删除。当redis中这2个key的数据进行删除之后，就可以按照代码从MySQL中重新进行加载，从而实现它的更新。</p>
<h2 id="3-主程序【理解】"><a href="#3-主程序【理解】" class="headerlink" title="3 主程序【理解】"></a>3 主程序【理解】</h2><h3 id="代码实现-6"><a href="#代码实现-6" class="headerlink" title="代码实现"></a>代码实现</h3><p>位置：integrated_qa_system&#x2F;mysql_qa&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.cache.redis_client <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.db.mysql_client <span class="keyword">import</span> MySQLClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.retrieval.bm25_search <span class="keyword">import</span> BM25Search</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySQLQASystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 初始化日志</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 初始化 Redis 客户端</span></span><br><span class="line">        self.redis_client = RedisClient()</span><br><span class="line">        <span class="comment"># 初始化 MySQL 客户端</span></span><br><span class="line">        self.mysql_client = MySQLClient()</span><br><span class="line">        <span class="comment"># 初始化 BM25 搜索</span></span><br><span class="line">        self.bm25_search = BM25Search(self.mysql_client, self.redis_client)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="comment"># 查询开始时间</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="comment"># 进行查询</span></span><br><span class="line">        answer, if_rag = self.bm25_search.search(query, threshold=<span class="number">0.85</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> answer:  <span class="comment"># 如果没有检索到答案</span></span><br><span class="line">            answer = <span class="string">&quot;在MySQL中没有检索到答案&quot;</span></span><br><span class="line">        <span class="comment"># 查询结束时间</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询结束，耗时：<span class="subst">&#123;time.time() - start_time&#125;</span>s&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> answer, if_rag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建系统</span></span><br><span class="line">    system = MySQLQASystem()</span><br><span class="line">    <span class="comment"># 打印欢迎信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n欢迎使用 MySQL 问答系统！&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;输入查询进行问答，输入 &#x27;exit&#x27; 退出。&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 获取用户输入</span></span><br><span class="line">            query = <span class="built_in">input</span>(<span class="string">&quot;\n请输入查询：&quot;</span>).strip()</span><br><span class="line">            <span class="comment"># 如果输入 &#x27;exit&#x27;，则退出</span></span><br><span class="line">            <span class="keyword">if</span> query.lower() ` <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;感谢使用 MySQL 问答系统！&quot;</span>)</span><br><span class="line">                logger.info(<span class="string">&quot;退出系统&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># 进行查询</span></span><br><span class="line">            answer, if_rag = system.query(query)</span><br><span class="line">            <span class="comment"># 打印答案</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n答案：<span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;是否使用rag：<span class="subst">&#123;if_rag&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;发生错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;发生错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 关闭数据库连接</span></span><br><span class="line">        system.mysql_client.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><p>假设MySQL中有数据：</p>
<ul>
<li>问题：”切割字符中，特殊符号的切割”，答案：”字符串切割特殊字符时，需要进行转义比如split(“#“),加上转义就可以了”</li>
</ul>
<p>查询：”特殊符号的切割”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2025-10-11 18:05:21,011 - INFO - EduRAG - Redis 连接成功</span><br><span class="line">2025-10-11 18:05:21,017 - INFO - EduRAG - MySQL 连接成功</span><br><span class="line">2025-10-11 18:05:21,024 - INFO - EduRAG - BM25 模型初始化完成</span><br><span class="line"></span><br><span class="line">欢迎使用 MySQL 问答系统！</span><br><span class="line">输入查询进行问答，输入 &#x27;exit&#x27; 退出。</span><br><span class="line"></span><br><span class="line">输入查询: 特殊符号的切割</span><br><span class="line"></span><br><span class="line">2025-10-11 18:05:26,376 - INFO - EduRAG - 处理查询: &#x27;特殊符号的切割&#x27;</span><br><span class="line">2025-10-11 18:05:26,377 - INFO - EduRAG - 从 Redis 获取答案: 特殊符号的切割</span><br><span class="line">2025-10-11 18:05:26,377 - INFO - EduRAG - MySQL 答案: 字符串切割特殊字符时，需要进行转义比如split(&quot;\#&quot;),加上转义就可以了</span><br><span class="line">2025-10-11 18:05:26,377 - INFO - EduRAG - 查询处理耗时 0.00秒</span><br><span class="line">答案: 字符串切割特殊字符时，需要进行转义比如split(&quot;\#&quot;),加上转义就可以了</span><br></pre></td></tr></table></figure>

<h1 id="P05-基于Milvus构建RAG问答系统"><a href="#P05-基于Milvus构建RAG问答系统" class="headerlink" title="P05-基于Milvus构建RAG问答系统"></a>P05-基于Milvus构建RAG问答系统</h1><h1 id="一、整体架构与工程流程"><a href="#一、整体架构与工程流程" class="headerlink" title="一、整体架构与工程流程"></a>一、整体架构与工程流程</h1><h2 id="1-RAG系统整体架构介绍【理解】"><a href="#1-RAG系统整体架构介绍【理解】" class="headerlink" title="1 RAG系统整体架构介绍【理解】"></a>1 RAG系统整体架构介绍【理解】</h2><h3 id="1-1-系统背景"><a href="#1-1-系统背景" class="headerlink" title="1.1 系统背景"></a>1.1 系统背景</h3><p>EduRAG智慧问答系统是一个基于 <strong>RAG</strong> 技术的智能问答平台，专为IT教育培训设计。它通过结合信息检索和生成式模型，从知识库中提取相关信息并生成准确、自然的回答。系统采用工程化的模块化设计，代码结构清晰，便于开发、维护和扩展。</p>
<h3 id="1-2-模块化架构"><a href="#1-2-模块化架构" class="headerlink" title="1.2 模块化架构"></a>1.2 模块化架构</h3><p>系统的代码组织分为以下几个核心模块：</p>
<ul>
<li><strong><code>base/</code></strong>：基础支持模块，负责配置、日志处理。</li>
<li><strong><code>core/</code></strong>：核心逻辑模块，实现RAG的关键功能。</li>
<li><strong><code>main.py</code></strong>：系统运行入口，支持数据处理和交互查询。</li>
</ul>
<h4 id="模块详情"><a href="#模块详情" class="headerlink" title="模块详情"></a>模块详情</h4><ul>
<li><strong>base模块</strong>：<ul>
<li><code>config.py</code>：管理系统配置，如API密钥、模型选择等。</li>
<li><code>create_logger.py</code>：记录系统运行日志，便于调试和监控。</li>
</ul>
</li>
<li><strong>core模块</strong>：<ul>
<li><code>document_processor.py</code>：处理输入文档，分块并准备向量存储。</li>
<li><code>prompts.py</code>：管理Prompt模板，支持不同任务。</li>
<li><code>query_classifier.py</code>：分类用户查询类型。</li>
<li><code>strategy_selector.py</code>：选择合适的检索策略。</li>
<li><code>vector_store.py</code>：管理向量数据库，进行文档存储和检索。</li>
<li><code>rag_system.py</code>：整合RAG流程，生成最终回答。</li>
</ul>
</li>
<li><strong>main.py</strong>：命令行交互入口，测试和运行系统。</li>
</ul>
<h3 id="1-3-代码目录结构"><a href="#1-3-代码目录结构" class="headerlink" title="1.3 代码目录结构"></a>1.3 代码目录结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">integrated_qa_system/</span><br><span class="line">├── config.ini                 # 配置文件，包含所有模块的配置</span><br><span class="line">├── base/</span><br><span class="line">│   ├── config.py              # 配置管理，加载 config.ini</span><br><span class="line">│   ├── create_logger.py       # 日志设置</span><br><span class="line">├── rag_qa/</span><br><span class="line">│   ├── data/</span><br><span class="line">│   │   ├── ai_data/               # ai学科数据</span><br><span class="line">│   ├── samples/                   # 示例数据</span><br><span class="line">│   ├── models/                    # 模型</span><br><span class="line">│   ├── nlp_bert_document-segmentation_chinese-base/      # 语义解析模型</span><br><span class="line">│   ├── edu_document_loaders/      # 文档加载器</span><br><span class="line">│   ├── edu_text_spliter/          # 文档分割器</span><br><span class="line">│   ├── core/</span><br><span class="line">│   │   ├── prompts.py              # RAG 提示模板</span><br><span class="line">│   │   ├── document_processor.py   # 处理输入文档，分块并准备向量存储。</span><br><span class="line">│   │   ├── query_classifier.py     # 查询分类器</span><br><span class="line">│   │   ├── strategy_selector.py    # 检索策略选择器</span><br><span class="line">│   │   ├── vector_store.py         # 向量存储与检索</span><br><span class="line">│   │   ├── rag_system.py           # RAG 系统核心逻辑</span><br><span class="line">│   ├── main.py                     # RAG 系统独立入口，支持存储和查询</span><br><span class="line">└── logs/</span><br><span class="line">    └── app.log                     # 日志文件</span><br></pre></td></tr></table></figure>



<h2 id="2-RAG系统基本工作流程【掌握】"><a href="#2-RAG系统基本工作流程【掌握】" class="headerlink" title="2 RAG系统基本工作流程【掌握】"></a>2 RAG系统基本工作流程【掌握】</h2><p>EduRAG系统的工作流程分为四个主要步骤，确保从用户查询到生成回答的高效性和准确性：</p>
<ol>
<li><strong>查询分类</strong>：<ul>
<li>系统首先判断查询类型（如“通用知识”或“专业咨询”）。</li>
<li>通用知识直接由大语言模型回答，专业咨询进入检索流程。</li>
</ul>
</li>
<li><strong>策略选择</strong>：<ul>
<li>根据查询特点选择检索策略：<ul>
<li><strong>直接检索</strong>：适用于明确查询。</li>
<li><strong>HyDE检索</strong>：适用于抽象问题，生成假设答案后检索。</li>
<li><strong>子查询检索</strong>：分解复杂查询。</li>
<li><strong>回溯检索</strong>：简化复杂问题后检索。</li>
</ul>
</li>
</ul>
</li>
<li><strong>文档检索</strong>：<ul>
<li>使用<code>vector_store.py</code>从向量数据库中检索相关文档。</li>
<li>支持稠密向量和稀疏向量的混合检索，结果经过重排序优化。</li>
</ul>
</li>
<li><strong>生成回答</strong>：<ul>
<li>将检索到的文档作为上下文，结合用户查询输入大语言模型，生成自然语言回答。</li>
<li>若大模型调用报错则联系人工。</li>
</ul>
</li>
</ol>
<hr>
<p><strong>流程图如下：</strong></p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251011204440032.png" alt="image-20251011204440032" style="zoom:75%;" />



<h1 id="二、基础模块（base）"><a href="#二、基础模块（base）" class="headerlink" title="二、基础模块（base）"></a>二、基础模块（base）</h1><p><code>base</code>模块是EduRAG智慧问答系统的基础，负责提供系统运行所需的核心功能，包括配置管理、日志记录。这些功能为系统的其他模块提供了稳定的支持，确保系统能够灵活配置、监控运行状态。</p>
<hr>
<h2 id="1-配置文件【实现】"><a href="#1-配置文件【实现】" class="headerlink" title="1 配置文件【实现】"></a>1 配置文件【实现】</h2><p>位置：integrated_qa_system&#x2F;config.ini</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MySQL 配置</span></span><br><span class="line"><span class="attr">[mysql]</span></span><br><span class="line"><span class="attr">host</span> = <span class="string">localhost</span></span><br><span class="line"><span class="attr">user</span> = <span class="string">root</span></span><br><span class="line"><span class="attr">password</span> = <span class="string">root</span></span><br><span class="line"><span class="attr">database</span> = <span class="string">subjects_kg</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Redis 配置</span></span><br><span class="line"><span class="attr">[redis]</span></span><br><span class="line"><span class="attr">host</span> = <span class="string">localhost</span></span><br><span class="line"><span class="attr">port</span> = <span class="string">6379</span></span><br><span class="line"><span class="attr">password</span> = <span class="string">1234</span></span><br><span class="line"><span class="attr">db</span> = <span class="string">0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">[logger]</span></span><br><span class="line"><span class="attr">log_file</span> = <span class="string">logs/app.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Milvus 配置</span></span><br><span class="line"><span class="attr">[milvus]</span></span><br><span class="line"><span class="attr">host</span> = <span class="string">localhost</span></span><br><span class="line"><span class="attr">port</span> = <span class="string">19530</span></span><br><span class="line"><span class="attr">database_name</span> = <span class="string">itcast</span></span><br><span class="line"><span class="attr">collection_name</span> = <span class="string">edurag_0421</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># LLM 配置</span></span><br><span class="line"><span class="attr">[llm]</span></span><br><span class="line"><span class="attr">model</span> = <span class="string">qwen-plus</span></span><br><span class="line"><span class="attr">dashscope_api_key</span> = <span class="string">sk-e69e1fb6754042ca9aa160834b3d17ff</span></span><br><span class="line"><span class="attr">dashscope_base_url</span> = <span class="string">https://dashscope.aliyuncs.com/compatible-mode/v1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 检索参数配置</span></span><br><span class="line"><span class="attr">[retrieval]</span></span><br><span class="line"><span class="attr">parent_chunk_size</span> = <span class="string">1200</span></span><br><span class="line"><span class="attr">child_chunk_size</span> = <span class="string">300</span></span><br><span class="line"><span class="attr">parent_overlap</span> = <span class="string">150</span></span><br><span class="line"><span class="attr">child_overlap</span> = <span class="string">50</span></span><br><span class="line"><span class="attr">retrieval_k</span> = <span class="string">3</span></span><br><span class="line"><span class="attr">candidate_m</span> = <span class="string">2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 应用配置</span></span><br><span class="line"><span class="attr">[app]</span></span><br><span class="line"><span class="attr">valid_sources</span> = <span class="string">[&quot;ai&quot;, &quot;java&quot;, &quot;test&quot;, &quot;ops&quot;, &quot;bigdata&quot;]</span></span><br><span class="line"><span class="attr">customer_service_phone</span> = <span class="string">12345678</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：mysql的账号密码和 dashscope_api_key 需要根据个人情况来设置。</strong></p>
<h2 id="2-配置管理【实现】"><a href="#2-配置管理【实现】" class="headerlink" title="2 配置管理【实现】"></a>2 配置管理【实现】</h2><p>位置：integrated_qa_system&#x2F;base&#x2F;config.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入配置解析库</span></span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="comment"># 导入路径操作库</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目根目录</span></span><br><span class="line">project_root = os.path.join(os.path.dirname(os.path.abspath(__file__)), <span class="string">&#x27;..&#x27;</span>)</span><br><span class="line"><span class="comment"># print(f&#x27;project_root--&gt;&#123;project_root&#125;&#x27;)</span></span><br><span class="line"><span class="comment"># 配置文件路径</span></span><br><span class="line">config_path = os.path.join(project_root, <span class="string">&#x27;config.ini&#x27;</span>)</span><br><span class="line"><span class="comment"># print(f&#x27;config_path--&gt;&#123;config_path&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_file=config_path</span>):</span><br><span class="line">        <span class="comment"># 创建配置解析对象</span></span><br><span class="line">        self.cf = configparser.ConfigParser()</span><br><span class="line">        <span class="comment"># 读取配置文件</span></span><br><span class="line">        self.cf.read(config_file, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="comment"># 获取配置文件中的参数</span></span><br><span class="line">        <span class="comment"># MySQL配置</span></span><br><span class="line">        <span class="comment"># MySQL 主机地址</span></span><br><span class="line">        self.MYSQL_HOST = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, fallback=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">        <span class="comment"># MySQL 用户名</span></span><br><span class="line">        self.MYSQL_USER = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;user&#x27;</span>, fallback=<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">        <span class="comment"># MySQL 密码</span></span><br><span class="line">        self.MYSQL_PASSWORD = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, fallback=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line">        <span class="comment"># MySQL 数据库名</span></span><br><span class="line">        self.MYSQL_DATABASE = self.cf.get(<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, fallback=<span class="string">&#x27;subjects_kg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Redis 配置</span></span><br><span class="line">        <span class="comment"># Redis 主机地址</span></span><br><span class="line">        self.REDIS_HOST = self.cf.get(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, fallback=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">        <span class="comment"># Redis 端口</span></span><br><span class="line">        self.REDIS_PORT = self.cf.getint(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, fallback=<span class="number">6379</span>)</span><br><span class="line">        <span class="comment"># Redis 密码</span></span><br><span class="line">        self.REDIS_PASSWORD = self.cf.get(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, fallback=<span class="string">&#x27;1234&#x27;</span>)</span><br><span class="line">        <span class="comment"># Redis 数据库编号</span></span><br><span class="line">        self.REDIS_DB = self.cf.getint(<span class="string">&#x27;redis&#x27;</span>, <span class="string">&#x27;db&#x27;</span>, fallback=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 日志文件路径</span></span><br><span class="line">        self.LOG_FILE = os.path.join(project_root, self.cf.get(<span class="string">&#x27;logger&#x27;</span>, <span class="string">&#x27;log_file&#x27;</span>, fallback=<span class="string">&#x27;logs/app.log&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Milvus 配置</span></span><br><span class="line">        <span class="comment"># Milvus 主机地址</span></span><br><span class="line">        self.MILVUS_HOST = self.cf.get(<span class="string">&#x27;milvus&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, fallback=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">        <span class="comment"># Milvus 端口</span></span><br><span class="line">        self.MILVUS_PORT = self.cf.get(<span class="string">&#x27;milvus&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, fallback=<span class="string">&#x27;19530&#x27;</span>)</span><br><span class="line">        <span class="comment"># Milvus 数据库名</span></span><br><span class="line">        self.MILVUS_DATABASE_NAME = self.cf.get(<span class="string">&#x27;milvus&#x27;</span>, <span class="string">&#x27;database_name&#x27;</span>, fallback=<span class="string">&#x27;itcast&#x27;</span>)</span><br><span class="line">        <span class="comment"># Milvus 集合名</span></span><br><span class="line">        self.MILVUS_COLLECTION_NAME = self.cf.get(<span class="string">&#x27;milvus&#x27;</span>, <span class="string">&#x27;collection_name&#x27;</span>, fallback=<span class="string">&#x27;edurag_final&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LLM 配置</span></span><br><span class="line">        <span class="comment"># LLM 模型名</span></span><br><span class="line">        self.LLM_MODEL = self.cf.get(<span class="string">&#x27;llm&#x27;</span>, <span class="string">&#x27;model&#x27;</span>, fallback=<span class="string">&#x27;qwen-plus&#x27;</span>)</span><br><span class="line">        <span class="comment"># DashScope API 密钥</span></span><br><span class="line">        self.DASHSCOPE_API_KEY = self.cf.get(<span class="string">&#x27;llm&#x27;</span>, <span class="string">&#x27;dashscope_api_key&#x27;</span>)</span><br><span class="line">        <span class="comment"># DashScope API 地址</span></span><br><span class="line">        self.DASHSCOPE_BASE_URL = self.cf.get(<span class="string">&#x27;llm&#x27;</span>, <span class="string">&#x27;dashscope_base_url&#x27;</span>,</span><br><span class="line">                                                  fallback=<span class="string">&#x27;https://dashscope.aliyuncs.com/compatible-mode/v1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检索参数</span></span><br><span class="line">        <span class="comment"># 父块大小</span></span><br><span class="line">        self.PARENT_CHUNK_SIZE = self.cf.getint(<span class="string">&#x27;retrieval&#x27;</span>, <span class="string">&#x27;parent_chunk_size&#x27;</span>, fallback=<span class="number">1200</span>)</span><br><span class="line">        <span class="comment"># 子块大小</span></span><br><span class="line">        self.CHILD_CHUNK_SIZE = self.cf.getint(<span class="string">&#x27;retrieval&#x27;</span>, <span class="string">&#x27;child_chunk_size&#x27;</span>, fallback=<span class="number">300</span>)</span><br><span class="line">        <span class="comment"># 父块重叠大小</span></span><br><span class="line">        self.PARENT_OVERLAP = self.cf.getint(<span class="string">&#x27;retrieval&#x27;</span>, <span class="string">&#x27;parent_overlap&#x27;</span>, fallback=<span class="number">150</span>)</span><br><span class="line">        <span class="comment"># 子块重叠大小</span></span><br><span class="line">        self.CHILD_OVERLAP = self.cf.getint(<span class="string">&#x27;retrieval&#x27;</span>, <span class="string">&#x27;child_overlap&#x27;</span>, fallback=<span class="number">50</span>)</span><br><span class="line">        <span class="comment"># 检索返回数量</span></span><br><span class="line">        self.RETRIEVAL_K = self.cf.getint(<span class="string">&#x27;retrieval&#x27;</span>, <span class="string">&#x27;retrieval_k&#x27;</span>, fallback=<span class="number">5</span>)</span><br><span class="line">        <span class="comment"># 最终候选数量</span></span><br><span class="line">        self.CANDIDATE_M = self.cf.getint(<span class="string">&#x27;retrieval&#x27;</span>, <span class="string">&#x27;candidate_m&#x27;</span>, fallback=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 应用配置</span></span><br><span class="line">        <span class="comment"># 有效来源列表</span></span><br><span class="line">        self.VALID_SOURCES = <span class="built_in">eval</span>(</span><br><span class="line">            self.cf.get(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;valid_sources&#x27;</span>, fallback=<span class="string">&#x27;[&quot;ai&quot;, &quot;java&quot;, &quot;test&quot;, &quot;ops&quot;, &quot;bigdata&quot;]&#x27;</span>))</span><br><span class="line">        <span class="comment"># 客服电话</span></span><br><span class="line">        self.CUSTOMER_SERVICE_PHONE = self.cf.get(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;customer_service_phone&#x27;</span>, fallback=<span class="string">&#x27;12345678&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    config = Config()</span><br><span class="line">    <span class="built_in">print</span>(config.LOG_FILE)</span><br><span class="line">    <span class="built_in">print</span>(config.CUSTOMER_SERVICE_PHONE)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-日志记录【实现】"><a href="#3-日志记录【实现】" class="headerlink" title="3 日志记录【实现】"></a>3 日志记录【实现】</h2><p>直接使用第三章的代码即可，无需修改。</p>
<h1 id="三、文档处理"><a href="#三、文档处理" class="headerlink" title="三、文档处理"></a>三、文档处理</h1><h2 id="1-文档解析【掌握】"><a href="#1-文档解析【掌握】" class="headerlink" title="1 文档解析【掌握】"></a>1 文档解析【掌握】</h2><p><code>document_processor.py</code>是EduRAG系统的核心模块之一，用于文档解析。主要负责加载多种格式的文档（如<code>.txt</code>、<code>.pdf</code>等），并对其进行分层切分，生成 父块和子块，为后续的向量存储和检索做好准备。</p>
<h3 id="说明-6"><a href="#说明-6" class="headerlink" title="说明"></a>说明</h3><ul>
<li><p><strong>文档加载</strong>：支持多种格式（如<code>.txt</code>、<code>.pdf</code>），使用专用加载器处理复杂文档。</p>
</li>
<li><p><strong>分层切分</strong>：采用<code>ChineseRecursiveTextSplitter</code>生成父块和子块，优化中文文本处理。</p>
</li>
<li><p><strong>元数据管理</strong>：为每个块添加唯一ID、来源和时间戳，便于检索和溯源。</p>
</li>
<li><p><code>文本切分方式</code></p>
<ul>
<li>文本切分器的选择：根据文档的类型进行选择——如果是markdown，则使用MarkdownTextSplitter进行切割；如果是一大段文本，没有明确的段落标识，比如从网上爬取到的信息，则使用AliTextSplitter；其他使用ChineseRecursiveTextSplitter进行切割。</li>
<li>文本切块的方式：先切分了父块，然后在每个父块里边切分了子块。在子块中保存了元数据信息，包括父块的id,路径，<code>父块的内容</code>！最后返回的是所有的子块，需要将子块进行embedding后，存入Milvus中。</li>
</ul>
</li>
<li><p><code>为什么要进行父块和子块的区分？</code></p>
<ul>
<li>如果块特别大，这个时候块中会包括大量跟问题无关的信息，在检索时，没有办法精准找到我们想要的数据。如果将文档切分成了一个一个的小块，可以提高检索时的精准性。但是有一个新的问题，因为块比较小，所以块的上下文信息是比较缺失的，在回答问题时，可能语义不完整。</li>
<li>所以解决方式是：大块切分和小块切分进行了融合，即使用父块和子块组合切分的方式。具体来说，先切分父块，然后在每个父块里边切分了子块，然后在子块中保存父块的内容。最终存储到向量数据时，是将子块进行embedding后进行存储。在检索的时候，就是用子块进行检索，此时可以实现精准检索。当检索到子块后，会将该子块元数据信息中的父块内容进行返回，用于问答，从而解决了上下文缺失问题！</li>
</ul>
</li>
</ul>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251016110923167.png" alt="image-20251016110923167"></p>
<h3 id="代码实现-7"><a href="#代码实现-7" class="headerlink" title="代码实现"></a>代码实现</h3><p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;core&#x2F;document_processor.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> TextLoader</span><br><span class="line"><span class="keyword">from</span> langchain_community.document_loaders.markdown <span class="keyword">import</span> UnstructuredMarkdownLoader</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> MarkdownTextSplitter</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.edu_text_spliter <span class="keyword">import</span> AliTextSplitter, ChineseRecursiveTextSplitter</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.edu_document_loaders <span class="keyword">import</span> OCRPDFLoader, OCRDOCLoader, OCRPPTLoader, OCRIMGLoader</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line">conf = Config()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义支持的文件类型及其对应的加载器字典</span></span><br><span class="line">document_loaders = &#123;</span><br><span class="line">    <span class="comment"># 文本文件使用 TextLoader</span></span><br><span class="line">    <span class="string">&quot;.txt&quot;</span>: TextLoader,</span><br><span class="line">    <span class="comment"># PDF 文件使用 OCRPDFLoader</span></span><br><span class="line">    <span class="string">&quot;.pdf&quot;</span>: OCRPDFLoader,</span><br><span class="line">    <span class="comment"># Word 文件使用 OCRDOCLoader</span></span><br><span class="line">    <span class="string">&quot;.docx&quot;</span>: OCRDOCLoader,</span><br><span class="line">    <span class="comment"># PPT 文件使用 OCRPPTLoader</span></span><br><span class="line">    <span class="string">&quot;.ppt&quot;</span>: OCRPPTLoader,</span><br><span class="line">    <span class="comment"># PPTX 文件使用 OCRPPTLoader</span></span><br><span class="line">    <span class="string">&quot;.pptx&quot;</span>: OCRPPTLoader,</span><br><span class="line">    <span class="comment"># JPG 文件使用 OCRIMGLoader</span></span><br><span class="line">    <span class="string">&quot;.jpg&quot;</span>: OCRIMGLoader,</span><br><span class="line">    <span class="comment"># PNG 文件使用 OCRIMGLoader</span></span><br><span class="line">    <span class="string">&quot;.png&quot;</span>: OCRIMGLoader,</span><br><span class="line">    <span class="comment"># Markdown 文件使用 UnstructuredMarkdownLoader</span></span><br><span class="line">    <span class="string">&quot;.md&quot;</span>: UnstructuredMarkdownLoader</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义函数，从指定文件夹加载多种类型文件并添加元数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_documents_from_directory</span>(<span class="params">directory_path</span>):</span><br><span class="line">    <span class="comment"># 初始化空列表，用于存储加载的文档</span></span><br><span class="line">    documents = []</span><br><span class="line">    <span class="comment"># 获取能够处理的文档类型</span></span><br><span class="line">    supported_file_type = document_loaders.keys()</span><br><span class="line">    <span class="comment"># print(f&#x27;supported_file_type--&gt;&#123;supported_file_type&#125;&#x27;)</span></span><br><span class="line">    <span class="comment"># 从文件夹名称中提取学科名称</span></span><br><span class="line">    source = os.path.basename(directory_path).replace(<span class="string">&quot;_data&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># print(f&#x27;source--&gt;&#123;source&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用递归方式遍历文件夹中的所有文件</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory_path):  <span class="comment"># 路径、文件夹、文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:  <span class="comment">#  遍历文件</span></span><br><span class="line">            file_path = os.path.join(root, file)  <span class="comment">#  获取文件路径</span></span><br><span class="line">            file_extension = os.path.splitext(file)[<span class="number">1</span>].lower()  <span class="comment">#  获取文件扩展名</span></span><br><span class="line">            <span class="comment"># print(f&#x27;file_extension--&gt;&#123;file_extension&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">if</span> file_extension <span class="keyword">in</span> supported_file_type:  <span class="comment">#  判断文件扩展名是否在支持的文档类型列表中</span></span><br><span class="line">                <span class="comment"># 创建加载器类</span></span><br><span class="line">                loader_class = document_loaders[file_extension]</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="comment"># 实例化加载器对象</span></span><br><span class="line">                    <span class="keyword">if</span> file_extension ` <span class="string">&#x27;.txt&#x27;</span>:</span><br><span class="line">                        loader = loader_class(file_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># 如果是txt文件，则指定编码为utf-8</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        loader = loader_class(file_path)</span><br><span class="line">                    <span class="comment"># 加载文档</span></span><br><span class="line">                    loaded_documents = loader.load()</span><br><span class="line">                    <span class="comment"># print(f&#x27;loaded_documents--&gt;&#123;loaded_documents&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 添加元数据</span></span><br><span class="line">                    <span class="keyword">for</span> document <span class="keyword">in</span> loaded_documents:</span><br><span class="line">                        <span class="comment"># 添加学科类型</span></span><br><span class="line">                        document.metadata[<span class="string">&#x27;source&#x27;</span>] = source</span><br><span class="line">                        <span class="comment"># 添加文件路径</span></span><br><span class="line">                        document.metadata[<span class="string">&#x27;file_path&#x27;</span>] = file_path</span><br><span class="line">                        <span class="comment"># 添加创建时间</span></span><br><span class="line">                        document.metadata[<span class="string">&#x27;timestamp&#x27;</span>] = datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">                    <span class="comment"># 将处理后的文档添加到列表中</span></span><br><span class="line">                    documents.extend(loaded_documents)</span><br><span class="line">                    logger.info(<span class="string">f&#x27;从 <span class="subst">&#123;file_path&#125;</span> 中加载了 <span class="subst">&#123;<span class="built_in">len</span>(loaded_documents)&#125;</span> 个documents&#x27;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f&#x27;从 <span class="subst">&#123;file_path&#125;</span> 中加载文档时出错：<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(<span class="string">f&#x27;不支持的文件类型：<span class="subst">&#123;file_path&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> documents</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义函数，处理文档并进行分层切分，返回子块结果</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_documents</span>(<span class="params">directory_path, parent_chunk_size=conf.PARENT_CHUNK_SIZE,</span></span><br><span class="line"><span class="params">                      child_chunk_size=conf.CHILD_CHUNK_SIZE,</span></span><br><span class="line"><span class="params">                      parent_overlap=conf.PARENT_OVERLAP,</span></span><br><span class="line"><span class="params">                      child_overlap=conf.CHILD_OVERLAP</span>):</span><br><span class="line">    <span class="comment"># 1）加载文档</span></span><br><span class="line">    documents = load_documents_from_directory(directory_path)</span><br><span class="line">    logger.info(<span class="string">f&quot;加载的文档数量: <span class="subst">&#123;<span class="built_in">len</span>(documents)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2）创建父块文本切分器【包括结构切割器、字符切割器、语义切割器】</span></span><br><span class="line">    markdown_splitter_parent = MarkdownTextSplitter(chunk_size=parent_chunk_size, chunk_overlap=parent_overlap)</span><br><span class="line">    text_splitter_parent = ChineseRecursiveTextSplitter(chunk_size=parent_chunk_size, chunk_overlap=parent_overlap)</span><br><span class="line">    <span class="comment"># 创建子块文本切分器</span></span><br><span class="line">    markdown_splitter_child = MarkdownTextSplitter(chunk_size=child_chunk_size, chunk_overlap=child_overlap)</span><br><span class="line">    text_splitter_child = ChineseRecursiveTextSplitter(chunk_size=child_chunk_size, chunk_overlap=child_overlap)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3）遍历文档，处理并添加元数据</span></span><br><span class="line">    processed_documents = []  <span class="comment"># 存储处理后的文档（子块）</span></span><br><span class="line">    <span class="keyword">for</span> i, document <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents):</span><br><span class="line">        <span class="comment"># print(f&#x27;document--&gt;&#123;document&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4）按照文档的类型选取切分器</span></span><br><span class="line">        file_extension = os.path.splitext(document.metadata.get(<span class="string">&#x27;file_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>))[<span class="number">1</span>].lower()  <span class="comment"># 获取文件扩展名</span></span><br><span class="line">        <span class="comment"># print(f&#x27;file_extension--&gt;&#123;file_extension&#125;&#x27;)</span></span><br><span class="line">        <span class="keyword">if</span> file_extension ` <span class="string">&#x27;.md&#x27;</span>:</span><br><span class="line">            parent_splitter = markdown_splitter_parent</span><br><span class="line">            child_splitter = markdown_splitter_child</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            parent_splitter = text_splitter_parent</span><br><span class="line">            child_splitter = text_splitter_child</span><br><span class="line">        logger.info(<span class="string">f&quot;处理文档: <span class="subst">&#123;document.metadata[<span class="string">&#x27;file_path&#x27;</span>]&#125;</span>, 使用切分器: <span class="subst">&#123;<span class="string">&#x27;Markdown&#x27;</span> <span class="keyword">if</span> (file_extension ` <span class="string">&#x27;.md&#x27;</span>) <span class="keyword">else</span> <span class="string">&#x27;ChineseRecursive&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5）先将文档切分成父块</span></span><br><span class="line">        parent_chunks = parent_splitter.split_documents([document])</span><br><span class="line">        <span class="comment"># 6）遍历父块，将父块切分成子块</span></span><br><span class="line">        <span class="keyword">for</span> j, parent_chunk <span class="keyword">in</span> <span class="built_in">enumerate</span>(parent_chunks):</span><br><span class="line">            <span class="comment"># 为父块生成一个id，用来标识父块</span></span><br><span class="line">            parent_id = <span class="string">f&quot;doc_<span class="subst">&#123;i&#125;</span>_parent_<span class="subst">&#123;j&#125;</span>&quot;</span></span><br><span class="line">            <span class="comment"># 将父块切分成子块</span></span><br><span class="line">            child_chunks = child_splitter.split_documents([parent_chunk])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 遍历子块，添加元数据【注意：子块会自动将父块的metadata带上】</span></span><br><span class="line">            <span class="keyword">for</span> k, child_chunk <span class="keyword">in</span> <span class="built_in">enumerate</span>(child_chunks):</span><br><span class="line">                <span class="comment"># 为子块生成一个id，用来标识子块</span></span><br><span class="line">                child_chunk.metadata[<span class="string">&#x27;id&#x27;</span>] = <span class="string">f&quot;<span class="subst">&#123;parent_id&#125;</span>_child_<span class="subst">&#123;k&#125;</span>&quot;</span></span><br><span class="line">                <span class="comment"># 添加父块id</span></span><br><span class="line">                child_chunk.metadata[<span class="string">&#x27;parent_id&#x27;</span>] = parent_id</span><br><span class="line">                <span class="comment"># 将父块的内容添加到子块的元数据中！！！</span></span><br><span class="line">                child_chunk.metadata[<span class="string">&#x27;parent_content&#x27;</span>] = parent_chunk.page_content</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 将子块添加到列表中</span></span><br><span class="line">                processed_documents.append(child_chunk)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># break</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;处理完成，共生成 <span class="subst">&#123;<span class="built_in">len</span>(processed_documents)&#125;</span> 个文档&quot;</span>)</span><br><span class="line">    <span class="comment"># 返回所有处理后的文档（子块）</span></span><br><span class="line">    <span class="keyword">return</span> processed_documents</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 测试加载文档</span></span><br><span class="line">    <span class="comment"># documents = load_documents_from_directory(r&#x27;..\data\ai_data&#x27;)</span></span><br><span class="line">    <span class="comment"># print(f&#x27;documents--&gt;&#123;len(documents)&#125;&#x27;)</span></span><br><span class="line">    <span class="comment"># print(f&#x27;documents[0]--&gt;&#123;documents[0]&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试切分文档</span></span><br><span class="line">    child_chunks = process_documents(<span class="string">r&#x27;..\data\ai_data&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;child_chunks[0]--&gt;<span class="subst">&#123;child_chunks[<span class="number">0</span>]&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;child_chunks--&gt;<span class="subst">&#123;<span class="built_in">len</span>(child_chunks)&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="2-自定义文档加载器【理解】"><a href="#2-自定义文档加载器【理解】" class="headerlink" title="2 自定义文档加载器【理解】"></a>2 自定义文档加载器【理解】</h2><h3 id="（1）pdf加载器"><a href="#（1）pdf加载器" class="headerlink" title="（1）pdf加载器"></a><strong>（1）pdf加载器</strong></h3><p>主要思路：</p>
<ul>
<li><p>继承LangChain中的BaseLoader类，实现init方法和lazy_load方法，将整个 pdf 的提取结果加上元数据信息作为一个 Document yield 出去。</p>
</li>
<li><p>内容提取的核心逻辑是：使用PyMuPDF模块中的fitz加载PDF，用来提取文字和图片元数据信息，对于图片信息使用PaddleORC（使用的rapidocr_paddle 模块下的 RapidOCR类）识别图片中的文字，最终将结果拼接到一起。</p>
</li>
</ul>
<p>主要流程：</p>
<ol>
<li>使用 <code>fitz.open()</code> 打开 PDF。</li>
<li>逐页 (<code>page</code>) 处理。</li>
<li>使用 <code>page.get_text()</code> 提取原生文本。</li>
<li>使用 <code>page.get_image_info(xrefs=True)</code> 获取页面上的图片信息。</li>
<li><strong>OCR 应用</strong>: 对获取到的图片，检查其尺寸是否超过预设阈值 <code>PDF_OCR_THRESHOLD</code>（默认为页面宽高的 60%）。仅对大于阈值的图片执行 OCR。</li>
<li>处理页面旋转 (<code>page.rotation</code>)，确保 OCR 时图像方向正确。</li>
<li>调用 <code>get_ocr()</code> 获取的 OCR 实例识别图片文字。</li>
<li>合并原生文本和 OCR 结果。</li>
</ol>
<h3 id="（2）doc加载器"><a href="#（2）doc加载器" class="headerlink" title="（2）doc加载器"></a><strong>（2）doc加载器</strong></h3><p>主要思路：</p>
<ul>
<li><p>继承LangChain中的BaseLoader类，实现init方法和lazy_load方法，将整个 word文档 的提取结果加上元数据信息作为一个 Document yield 出去。</p>
</li>
<li><p>内容提取的核心逻辑是：使用python-docx模块加载word文档，然后获取该文档的块信息（Paragraph或Table），接下来去处理每一个块。如果是段落，先把段落中的文字提取出来，然后段落中的图片使用PaddleORC（使用的rapidocr_paddle 模块下的 RapidOCR类）识别其中的文字；如果是表格，则直接遍历获取表格单元格中的信息。最终将结果拼接到一起。</p>
</li>
</ul>
<p>主要流程：</p>
<ol>
<li>使用 <code>docx.Document()</code> 打开 DOCX 文件。</li>
<li>定义 <code>iter_block_items</code> 辅助函数，用于统一遍历文档中的段落 (<code>Paragraph</code>) 和表格 (<code>Table</code>) 块。</li>
<li>遍历所有块：</li>
<li>如果是段落，提取 <code>block.text</code>。同时，使用 XPath (<code>.//pic:pic</code>, <code>.//a:blip/@r:embed</code>) 查找并提取段落内嵌入的图片。对提取的图片执行 OCR。</li>
<li>如果是表格，遍历所有单元格 (<code>cell</code>)，提取单元格内段落的文本。</li>
<li>合并所有提取的文本和 OCR 结果。</li>
</ol>
<h3 id="（3）ppt加载器"><a href="#（3）ppt加载器" class="headerlink" title="（3）ppt加载器"></a><strong>（3）ppt加载器</strong></h3><p>主要思路：</p>
<ul>
<li><p>继承LangChain中的BaseLoader类，实现init方法和lazy_load方法，将整个 ppt 的提取结果加上元数据信息作为一个 Document yield 出去。</p>
</li>
<li><p>内容提取的核心逻辑是：使用python-pptx模块加载ppt，然后逐张处理PPT。在处理PPT时，首先将PPT上的形状 (<code>shape</code>) 按视觉顺序（<code>top</code>, <code>left</code> 坐标）排序，排序完后依次去处理每个形状。在处理形状时，如果是文本框 ，则直接提取文本；如果是表格，则直接遍历获取表格单元格中的信息；如果是图片，则使用PaddleORC（使用的rapidocr_paddle 模块下的 RapidOCR类）识别其中的文字；如果是组合形状，则进行递归调用。最终将结果拼接到一起。</p>
</li>
</ul>
<p>主要流程：</p>
<ol>
<li>使用 <code>pptx.Presentation()</code> 打开演示文稿。</li>
<li>逐张幻灯片 (<code>slide</code>) 处理。</li>
<li><strong>顺序处理</strong>: 将幻灯片上的形状 (<code>shape</code>) 按视觉顺序（<code>top</code>, <code>left</code> 坐标）排序。</li>
<li>定义 extract_text 递归函数处理单个形状：<ul>
<li>提取文本框 (<code>shape.has_text_frame</code>) 的文本。</li>
<li>提取表格 (<code>shape.has_table</code>) 内所有单元格的文本。</li>
<li>如果形状是图片 (<code>shape.shape_type </code> 13<code>)，提取图片数据 (</code>shape.image.blob&#96;)，执行 OCR。</li>
<li>如果形状是组合 (<code>shape.shape_type </code> 6<code>)，递归调用 </code>extract_text&#96; 处理其包含的子形状。</li>
</ul>
</li>
<li>遍历排序后的形状，调用 <code>extract_text</code>。</li>
<li>合并所有提取的文本和 OCR 结果。</li>
</ol>
<h3 id="（4）图片加载器"><a href="#（4）图片加载器" class="headerlink" title="（4）图片加载器"></a><strong>（4）图片加载器</strong></h3><p>主要思路：</p>
<ul>
<li>继承LangChain中的BaseLoader类，实现init方法和lazy_load方法，将整个图片的提取结果加上元数据信息作为一个 Document yield 出去。</li>
<li>内容提取的核心逻辑是：使用PaddleORC（使用的rapidocr_paddle 模块下的 RapidOCR类）识别其中的文字。</li>
</ul>
<p>主要流程：</p>
<ol>
<li>接收图像文件路径 <code>img_path</code>。</li>
<li>调用 <code>get_ocr()</code> 获取 OCR 实例。</li>
<li>直接对图像文件执行 OCR。</li>
<li>将 OCR 结果（所有识别出的文本行）合并成一个字符串。</li>
</ol>
<h2 id="3-自定义文本切分器（文档分割器）【理解】"><a href="#3-自定义文本切分器（文档分割器）【理解】" class="headerlink" title="3 自定义文本切分器（文档分割器）【理解】"></a>3 自定义文本切分器（文档分割器）【理解】</h2><h3 id="（1）中文递归文本切分器"><a href="#（1）中文递归文本切分器" class="headerlink" title="（1）中文递归文本切分器"></a>（1）中文递归文本切分器</h3><p>主要实现逻辑：继承langchain.text_splitter.RecursiveCharacterTextSplitter，对分割符列表进行了修改，修改成包括常见的中文标点和换行符，如 <code>[&quot;\n\n&quot;, &quot;\n&quot;, &quot;。|！|？&quot;, &quot;\.\s|\!\s|\?\s&quot;, &quot;；|;\s&quot;, &quot;，|,\s&quot;]</code>。这有助于在切分时尽量保持中文句子的完整性。</p>
<p>最终效果（为什么自定义文本切分器）：将长文本按照预设的中文分隔符递归地切分成指定大小的块。</p>
<h3 id="（2）基于模型的语义切分器"><a href="#（2）基于模型的语义切分器" class="headerlink" title="（2）基于模型的语义切分器"></a>（2）基于模型的语义切分器</h3><p>主要实现逻辑：继承langchain.text_splitter.CharacterTextSplitter，对split_text方法进行了修改。修改的方式就是利用预训练的文档语义分割模型对文本进行切分。具体的切分方式调用 <code>modelscope.pipeline</code> 加载指定的文档分割模型（nlp_bert_document-segmentation_chinese-base，达摩院开源的文档语义分割模型）模型，将输入文本传递给模型 pipeline 进行处理，最后解析模型输出，得到分块的结果。</p>
<p>最终效果（为什么自定义文本切分器）：实现了基于文档语义分割模型对文本进行切分，<code>准确度高并且效率高</code>。</p>
<p><strong>为什么选用这个模型？</strong></p>
<p>因为 nlp_bert_document-segmentation_chinese-base 是 达摩院开源的文档语义分割模型，通过自适应滑动窗口的序列模型，对输入文本进行语义层面的段落分割。它先将整个文本作为序列输入，然后使用使用 BERT 基础模型预测每个 token 是否是段落边界，通过自适应滑动窗口动态调整处理窗口大小，提高准确性和效率。</p>
<h1 id="四、向量存储"><a href="#四、向量存储" class="headerlink" title="四、向量存储"></a>四、向量存储</h1><p><code>vector_store.py</code>是EduRAG系统的核心模块之一，封装了与Milvus向量数据库的交互逻辑。它负责将文档转化为向量存储到数据库中，并提供高效的混合检索功能。通过结合BGE-M3嵌入模型和重排序机制，该模块确保系统能够快速检索到与用户查询最相关的文档。</p>
<h2 id="1-模块功能概述【理解】"><a href="#1-模块功能概述【理解】" class="headerlink" title="1 模块功能概述【理解】"></a>1 模块功能概述【理解】</h2><p><code>VectorStore</code>类提供了以下主要功能：</p>
<ul>
<li><strong>初始化与集合管理</strong>：创建或加载Milvus向量数据库集合。</li>
<li><strong>文档向量化与存储</strong>：将分块后的文档转换为向量并存储。</li>
<li><strong>混合检索与重排序</strong>：结合稠密和稀疏向量进行检索，并通过重排序优化结果。</li>
</ul>
<p>以下将逐一讲解每个方法的实现细节。</p>
<h3 id="导入必备工具包"><a href="#导入必备工具包" class="headerlink" title="导入必备工具包"></a>导入必备工具包</h3><p>注意：BGE-M3 模型需要依赖peft和FlagEmbedding。所以运行下面的代码之前，需要提前安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install peft -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip install FlagEmbedding&gt;=1.2.2 -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>

<hr>
<p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;core&#x2F;vector_store.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 导入 BGE-M3 嵌入函数，用于生成文档和查询的向量表示</span></span><br><span class="line"><span class="keyword">from</span> milvus_model.hybrid <span class="keyword">import</span> BGEM3EmbeddingFunction</span><br><span class="line"><span class="comment"># 导入 Milvus 相关类，用于操作向量数据库</span></span><br><span class="line"><span class="keyword">from</span> pymilvus <span class="keyword">import</span> MilvusClient, DataType, AnnSearchRequest, WeightedRanker</span><br><span class="line"><span class="comment"># 导入 Document 类，用于创建文档对象</span></span><br><span class="line"><span class="keyword">from</span> langchain.docstore.document <span class="keyword">import</span> Document</span><br><span class="line"><span class="comment"># CrossEncoder 用于 句对打分 的模型，常用于判断两段文本之间的 语义关系、相似度或相关性。</span></span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> CrossEncoder</span><br><span class="line"><span class="comment"># 导入 hashlib 模块，用于生成唯一 ID 的哈希值</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line">conf = Config()</span><br><span class="line">base_dir = os.path.dirname(os.path.abspath(__file__))</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-初始化方法【实现】"><a href="#2-初始化方法【实现】" class="headerlink" title="2 初始化方法【实现】"></a>2 初始化方法【实现】</h2><h3 id="功能-6"><a href="#功能-6" class="headerlink" title="功能"></a>功能</h3><p><code>__init__</code>方法初始化<code>VectorStore</code>类的实例，设置基本参数并调用集合创建或加载方法。</p>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><p><strong>参数设置</strong>：</p>
<ul>
<li>使用<code>Config</code>中的默认值初始化集合名称、主机、端口和数据库名称。</li>
</ul>
</li>
<li><p><strong>模型初始化</strong>：</p>
<ul>
<li><code>reranker</code>：加载BGE-Reranker模型，用于后续重排序。</li>
<li><code>embedding_function</code>：初始化BGE-M3嵌入模型。</li>
</ul>
<p>注意：BGE-M3 模型需要依赖peft和FlagEmbedding。所以运行代码之前，<code>需要提前安装</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install peft -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip install FlagEmbedding&gt;=1.2.2 -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dense_dim</code>：获取稠密向量的维度。</li>
</ul>
</li>
<li><p><strong>客户端连接</strong>：</p>
<ul>
<li>创建<code>MilvusClient</code>实例，连接到指定主机和数据库。</li>
<li>注意：<code>连接数据库之前需要先手动进行创建数据库，名称为 itcast。</code></li>
</ul>
</li>
<li><p><strong>集合管理</strong>：</p>
<ul>
<li>调用<code>_create_or_load_collection</code>方法，确保集合可用。</li>
</ul>
</li>
</ol>
<h3 id="说明-7"><a href="#说明-7" class="headerlink" title="说明"></a>说明</h3><ul>
<li><strong>BGE-M3模型</strong>：提供稠密和稀疏向量生成能力。</li>
<li><strong>灵活性</strong>：通过参数支持自定义配置。</li>
</ul>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义 VectorStore 类，封装向量存储和检索功能</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VectorStore</span>:</span><br><span class="line">    <span class="comment"># 初始化方法，设置向量存储的基本参数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 collection_name=conf.MILVUS_COLLECTION_NAME,</span></span><br><span class="line"><span class="params">                 host=conf.MILVUS_HOST,</span></span><br><span class="line"><span class="params">                 port=conf.MILVUS_PORT,</span></span><br><span class="line"><span class="params">                 database=conf.MILVUS_DATABASE_NAME</span>):</span><br><span class="line">        <span class="comment"># 设置日志记录器</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 设置 Milvus 主机地址</span></span><br><span class="line">        self.host = host</span><br><span class="line">        <span class="comment"># 设置 Milvus 端口号</span></span><br><span class="line">        self.port = port</span><br><span class="line">        <span class="comment"># 设置 Milvus 数据库名称</span></span><br><span class="line">        self.database = database</span><br><span class="line">        <span class="comment"># 设置 Milvus 集合名称</span></span><br><span class="line">        self.collection_name = collection_name</span><br><span class="line">        <span class="comment"># 初始化 Milvus 客户端，连接到指定主机和数据库</span></span><br><span class="line">        self.client = MilvusClient(uri=<span class="string">f&quot;http://<span class="subst">&#123;self.host&#125;</span>:<span class="subst">&#123;self.port&#125;</span>&quot;</span>, db_name=self.database)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化 BGE-M3 嵌入函数，可以使用GPU或CPU。</span></span><br><span class="line">        self.embedding_function = BGEM3EmbeddingFunction(model_name_or_path=os.path.join(base_dir, <span class="string">&#x27;../models/bge-m3&#x27;</span>),</span><br><span class="line">                                                         device=<span class="string">&quot;cuda:0&quot;</span>)</span><br><span class="line">        <span class="comment"># 获取稠密向量的维度</span></span><br><span class="line">        self.dense_dim = self.embedding_function.dim[<span class="string">&#x27;dense&#x27;</span>]</span><br><span class="line">        <span class="comment"># print(f&#x27;self.dense_dim--&gt;&#123;self.dense_dim&#125;&#x27;)  # 1024</span></span><br><span class="line">        <span class="comment"># 初始化重排序的模型</span></span><br><span class="line">        self.reranker = CrossEncoder(os.path.join(base_dir, <span class="string">&#x27;../models/bge-reranker-large&#x27;</span>), device=<span class="string">&quot;cuda:0&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建或加载一个向量集合，用于存储文档向量</span></span><br><span class="line">        self._create_or_load_collection()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-创建或加载集合【掌握】"><a href="#3-创建或加载集合【掌握】" class="headerlink" title="3 创建或加载集合【掌握】"></a>3 创建或加载集合【掌握】</h2><h3 id="功能-7"><a href="#功能-7" class="headerlink" title="功能"></a>功能</h3><p><code>_create_or_load_collection</code>方法检查并创建或加载Milvus集合，定义字段结构和索引参数。</p>
<h3 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><strong>检查集合是否存在</strong>：<ul>
<li>使用<code>has_collection</code>判断是否需要创建新集合。</li>
</ul>
</li>
<li><strong>定义Schema</strong>：<ul>
<li>设置字段：包括<code>id</code>（主键）、<code>text</code>（原文）、向量字段和元数据字段。</li>
<li>禁用自动ID，启用动态字段。</li>
</ul>
</li>
<li><strong>创建索引</strong>：<ul>
<li>稠密向量使用<code>IVF_FLAT</code>索引，稀疏向量使用<code>SPARSE_INVERTED_INDEX</code>。</li>
</ul>
</li>
<li><strong>创建并加载集合</strong>：<ul>
<li>调用<code>create_collection</code>创建集合，并加载到内存。</li>
</ul>
</li>
</ol>
<h3 id="说明-8"><a href="#说明-8" class="headerlink" title="说明"></a>说明</h3><ul>
<li><strong>字段设计</strong>：支持多种数据类型和元数据管理。</li>
<li><strong>索引优化</strong>：平衡检索速度和精度。</li>
</ul>
<h3 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义类似私有方法，创建或加载 Milvus 集合</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_create_or_load_collection</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># 检查指定集合是否已存在</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.client.has_collection(self.collection_name):</span><br><span class="line">        <span class="comment"># 创建集合</span></span><br><span class="line">        <span class="comment"># 1）创建集合 schema</span></span><br><span class="line">        schema = self.client.create_schema(auto_id=<span class="literal">False</span>, enable_dynamic_field=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 添加 id 字段， 类型是 varchar 类型【需要基于文档内容进行hash得到一个唯一标识】，最大长度为 100</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;id&quot;</span>, datatype=DataType.VARCHAR, is_primary=<span class="literal">True</span>, max_length=<span class="number">100</span>)</span><br><span class="line">        <span class="comment"># 添加文本字段，VARCHAR 类型，最大长度 65535</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;text&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">65535</span>)</span><br><span class="line">        <span class="comment"># 添加稠密向量字段，FLOAT_VECTOR 类型，维度由嵌入函数指定</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;dense_vector&quot;</span>, datatype=DataType.FLOAT_VECTOR, dim=self.dense_dim)</span><br><span class="line">        <span class="comment"># 添加稀疏向量字段，SPARSE_FLOAT_VECTOR 类型，这个类型是专门用来用于存储稀疏向量数据的</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;sparse_vector&quot;</span>, datatype=DataType.SPARSE_FLOAT_VECTOR)</span><br><span class="line">        <span class="comment"># 添加父块 ID 字段，VARCHAR 类型，最大长度 100</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;parent_id&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">100</span>)</span><br><span class="line">        <span class="comment"># 添加父块内容字段，VARCHAR 类型，最大长度 65535</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;parent_content&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">65535</span>)</span><br><span class="line">        <span class="comment"># 添加学科类别字段，VARCHAR 类型，最大长度 50</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;source&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">50</span>)</span><br><span class="line">        <span class="comment"># 添加时间戳字段，VARCHAR 类型，最大长度 50</span></span><br><span class="line">        schema.add_field(field_name=<span class="string">&quot;timestamp&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2）创建集合索引</span></span><br><span class="line">        <span class="comment"># 创建索引参数对象</span></span><br><span class="line">        index_params = self.client.prepare_index_params()</span><br><span class="line">        <span class="comment"># 为稠密向量字段创建索引</span></span><br><span class="line">        index_params.add_index(field_name=<span class="string">&quot;dense_vector&quot;</span>,</span><br><span class="line">                               index_name=<span class="string">&quot;dense_index&quot;</span>,</span><br><span class="line">                               index_type=<span class="string">&quot;IVF_SQ8&quot;</span>,</span><br><span class="line">                               metric_type=<span class="string">&quot;IP&quot;</span>,</span><br><span class="line">                               <span class="comment"># 设置簇的个数：设置簇的个数越多，每个簇中向量数越少，查询的速度变化越快，但是查询的准确度越低</span></span><br><span class="line">                               <span class="comment"># 一般来说设的值是 根号下文档数</span></span><br><span class="line">                               params=&#123;<span class="string">&quot;nlist&quot;</span>: <span class="number">10</span>&#125;)</span><br><span class="line">        <span class="comment"># 为稀疏向量字段创建索引</span></span><br><span class="line">        index_params.add_index(field_name=<span class="string">&quot;sparse_vector&quot;</span>,</span><br><span class="line">                               index_name=<span class="string">&quot;sparse_index&quot;</span>,</span><br><span class="line">                               <span class="comment"># 设置索引类型为稀疏倒排索引</span></span><br><span class="line">                               index_type=<span class="string">&quot;SPARSE_INVERTED_INDEX&quot;</span>,</span><br><span class="line">                               metric_type=<span class="string">&quot;IP&quot;</span></span><br><span class="line">                               )</span><br><span class="line">        <span class="comment"># 3）创建集合</span></span><br><span class="line">        self.client.create_collection(collection_name=self.collection_name,</span><br><span class="line">                                      schema=schema,</span><br><span class="line">                                      index_params=index_params)</span><br><span class="line">        logger.info(<span class="string">f&quot;已创建集合 <span class="subst">&#123;self.collection_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 记录加载集合的日志</span></span><br><span class="line">        logger.info(<span class="string">f&quot;已加载集合 <span class="subst">&#123;self.collection_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载集合</span></span><br><span class="line">    self.client.load_collection(self.collection_name)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-添加文档【掌握】"><a href="#4-添加文档【掌握】" class="headerlink" title="4 添加文档【掌握】"></a>4 添加文档【掌握】</h2><h3 id="功能-8"><a href="#功能-8" class="headerlink" title="功能"></a>功能</h3><p><code>add_documents</code>方法将分块后的文档转换为向量并存储到Milvus集合中。</p>
<h3 id="实现步骤-2"><a href="#实现步骤-2" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><strong>提取文本</strong>：<ul>
<li>从文档对象中提取文本内容。</li>
</ul>
</li>
<li><strong>生成向量</strong>：<ul>
<li>使用BGE-M3模型生成稠密和稀疏向量。</li>
</ul>
</li>
<li><strong>构造数据</strong>：<ul>
<li>为每篇文档生成唯一ID（MD5哈希）。</li>
<li>将向量和元数据组织成字典。</li>
</ul>
</li>
<li><strong>存储数据</strong>：<ul>
<li>使用<code>upsert</code>操作插入或更新数据。</li>
</ul>
</li>
</ol>
<h3 id="说明-9"><a href="#说明-9" class="headerlink" title="说明"></a>说明</h3><ul>
<li><strong>唯一性</strong>：通过MD5哈希确保ID唯一。</li>
<li><strong>稀疏向量处理</strong>：将稀疏矩阵转换为字典格式。</li>
</ul>
<h3 id="代码示例-2"><a href="#代码示例-2" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义方法，向向量存储添加文档</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_documents</span>(<span class="params">self, documents</span>):</span><br><span class="line">    <span class="comment"># 提取所有文档中的内容</span></span><br><span class="line">    texts = [doc.page_content <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line">    <span class="comment"># 使用嵌入函数将内容转换为稠密向量和稀疏向量</span></span><br><span class="line">    embeddings = self.embedding_function(texts)</span><br><span class="line">    <span class="comment"># print(f&#x27;embeddings--&gt;&#123;embeddings&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化空列表，用于存储插入的数据</span></span><br><span class="line">    data = []</span><br><span class="line">    <span class="comment"># 遍历每个文档，带上索引 i</span></span><br><span class="line">    <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents):</span><br><span class="line">        <span class="comment"># 1)生成文档内容的MD5哈希值，用于作为文档的ID</span></span><br><span class="line">        doc_id = hashlib.md5(doc.page_content.encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2)整理稀疏向量数据</span></span><br><span class="line">        sparse_vector = &#123;&#125;  <span class="comment"># 创建一个空字典，用于存储稀疏向量数据</span></span><br><span class="line">        <span class="comment"># 获取第i个文档对应的稀疏向量数据</span></span><br><span class="line">        row_vector = embeddings[<span class="string">&#x27;sparse&#x27;</span>]._getrow(i)</span><br><span class="line">        <span class="comment"># print(f&#x27;row_vector--&gt;&#123;row_vector&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 获取稀疏向量的非零索引</span></span><br><span class="line">        indices = row_vector.indices</span><br><span class="line">        <span class="comment"># print(f&#x27;indices--&gt;&#123;indices&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 获取稀疏向量的非零值</span></span><br><span class="line">        values = row_vector.data</span><br><span class="line">        <span class="comment"># print(f&#x27;values--&gt;&#123;values&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 将索引和值组成键值对，并添加到字典中</span></span><br><span class="line">        <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">zip</span>(indices, values):</span><br><span class="line">            sparse_vector[index] = value</span><br><span class="line">        <span class="comment"># print(f&#x27;sparse_vector--&gt;&#123;sparse_vector&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3)创建数据字典，包含所有字段</span></span><br><span class="line">        data.append(&#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: doc_id,</span><br><span class="line">            <span class="string">&quot;text&quot;</span>: doc.page_content,</span><br><span class="line">            <span class="string">&quot;dense_vector&quot;</span>: embeddings[<span class="string">&quot;dense&quot;</span>][i],</span><br><span class="line">            <span class="string">&quot;sparse_vector&quot;</span>: sparse_vector,</span><br><span class="line">            <span class="string">&quot;parent_id&quot;</span>: doc.metadata.get(<span class="string">&quot;parent_id&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">            <span class="string">&quot;parent_content&quot;</span>: doc.metadata.get(<span class="string">&quot;parent_content&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">            <span class="string">&quot;source&quot;</span>: doc.metadata.get(<span class="string">&quot;source&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: doc.metadata.get(<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将数据插入向量存储</span></span><br><span class="line">    self.client.upsert(collection_name=self.collection_name, data=data)</span><br><span class="line">    logger.info(<span class="string">f&quot;Milvus中已成功添加 <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> 个文档&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-混合检索与重排序【掌握】"><a href="#5-混合检索与重排序【掌握】" class="headerlink" title="5 混合检索与重排序【掌握】"></a>5 混合检索与重排序【掌握】</h2><h3 id="功能-9"><a href="#功能-9" class="headerlink" title="功能"></a>功能</h3><p><code>hybrid_search_with_rerank</code>方法实现混合检索并重排序，返回最相关文档。</p>
<h3 id="实现步骤-3"><a href="#实现步骤-3" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><strong>生成查询向量</strong>：<ul>
<li>使用BGE-M3生成稠密和稀疏向量。</li>
</ul>
</li>
<li><strong>构造检索请求</strong>：<ul>
<li>为稠密和稀疏向量分别创建<code>AnnSearchRequest</code>。</li>
</ul>
</li>
<li><strong>混合检索</strong>：<ul>
<li>使用<code>WeightedRanker</code>融合结果。</li>
</ul>
</li>
<li><strong>重排序</strong>：<ul>
<li>使用<code>CrossEncoder</code>重新排序父文档。</li>
</ul>
</li>
</ol>
<h3 id="说明-10"><a href="#说明-10" class="headerlink" title="说明"></a>说明</h3><ul>
<li><strong>混合检索</strong>：提升覆盖率和准确性。</li>
<li><strong>重排序</strong>：确保最相关文档优先。</li>
</ul>
<h3 id="代码示例-3"><a href="#代码示例-3" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  定义方法，实现混合检索和重排序</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hybrid_search_with_rerank</span>(<span class="params">self, query, top_k=conf.RETRIEVAL_K, source_filter=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param query: 查询的问题</span></span><br><span class="line"><span class="string">    :param top_k: 检索返回的topk个文档</span></span><br><span class="line"><span class="string">    :param source_filter: 进行查询过滤的条件，这里指的是学科</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># todo: 1.对查询进行embedding</span></span><br><span class="line">    query_embeddings = self.embedding_function([query])</span><br><span class="line">    <span class="comment"># 获取稠密向量</span></span><br><span class="line">    dense_vector = query_embeddings[<span class="string">&quot;dense&quot;</span>][<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># print(f&#x27;dense_vector--&gt;&#123;dense_vector&#125;&#x27;)  # 维度是1024</span></span><br><span class="line">    <span class="comment"># 获取稀疏向量</span></span><br><span class="line">    sparse_vector = query_embeddings[<span class="string">&quot;sparse&quot;</span>]._getrow(<span class="number">0</span>)</span><br><span class="line">    sparse_dict = &#123;index: value <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">zip</span>(sparse_vector.indices, sparse_vector.data)&#125;</span><br><span class="line">    <span class="comment"># print(f&#x27;sparse_dict--&gt;&#123;sparse_dict&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 2.构建稠密向量和稀疏向量的检索请求</span></span><br><span class="line">    filter_expression = <span class="string">f&quot;source ` &#x27;<span class="subst">&#123;source_filter&#125;</span>&#x27;&quot;</span> <span class="keyword">if</span> source_filter <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 创建稠密向量的搜索请求</span></span><br><span class="line">    dense_search_params = &#123;</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: [dense_vector],</span><br><span class="line">        <span class="string">&quot;anns_field&quot;</span>: <span class="string">&quot;dense_vector&quot;</span>,  <span class="comment"># 要查询的字段</span></span><br><span class="line">        <span class="comment"># nprobe 控制搜索的簇数量，nprobe 值越小，搜索速度越快，但是搜索的准确度越低，通常是nlist的1%-10%</span></span><br><span class="line">        <span class="string">&quot;param&quot;</span>: &#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>, <span class="string">&quot;nprobe&quot;</span>: <span class="number">2</span>&#125;,</span><br><span class="line">        <span class="string">&quot;limit&quot;</span>: top_k,</span><br><span class="line">        <span class="string">&quot;expr&quot;</span>: filter_expression</span><br><span class="line">    &#125;</span><br><span class="line">    request_1 = AnnSearchRequest(**dense_search_params)</span><br><span class="line">    <span class="comment"># 创建稀疏向量的搜索请求</span></span><br><span class="line">    request_2 = AnnSearchRequest(</span><br><span class="line">        data=[sparse_dict],</span><br><span class="line">        anns_field=<span class="string">&quot;sparse_vector&quot;</span>,</span><br><span class="line">        param=&#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>&#125;,</span><br><span class="line">        limit=top_k,</span><br><span class="line">        expr=filter_expression</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 3.使用 WeightedRanker 融合结果</span></span><br><span class="line">    <span class="comment"># 创建 WeightedRanker 对象，设置权重为稠密向量1.0和稀疏向量0.7</span></span><br><span class="line">    ranker = WeightedRanker(<span class="number">1.0</span>, <span class="number">0.7</span>)</span><br><span class="line">    <span class="comment"># 进行混合检索。因为检索结果是一个列表，所以需要取第一个元素</span></span><br><span class="line">    results = self.client.hybrid_search(collection_name=self.collection_name,</span><br><span class="line">                                        reqs=[request_1, request_2],</span><br><span class="line">                                        ranker=ranker,</span><br><span class="line">                                        limit=top_k,</span><br><span class="line">                                        output_fields=[<span class="string">&quot;text&quot;</span>, <span class="string">&quot;parent_id&quot;</span>, <span class="string">&quot;parent_content&quot;</span>, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;timestamp&quot;</span>])[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># print(f&#x27;results--&gt;&#123;type(results), results&#125;&#x27;)</span></span><br><span class="line">    <span class="comment"># 对结果进行处理，封装成 Document 对象</span></span><br><span class="line">    sub_chunks = [self._doc_from_hit(hit[<span class="string">&#x27;entity&#x27;</span>]) <span class="keyword">for</span> hit <span class="keyword">in</span> results]</span><br><span class="line">    <span class="comment"># print(f&#x27;sub_chunks--&gt;&#123;len(sub_chunks), sub_chunks&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 4.对去重后的父块进行重排序</span></span><br><span class="line">    <span class="comment"># 从子块中去重父块内容，并进行去重</span></span><br><span class="line">    parent_docs = self._get_unique_parent_docs(sub_chunks)</span><br><span class="line">    <span class="comment"># print(f&#x27;parent_docs--&gt;&#123;len(parent_docs), parent_docs&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对父块进行重排序</span></span><br><span class="line">    <span class="keyword">if</span> parent_docs:</span><br><span class="line">        <span class="comment"># 数据对为 查询和文档</span></span><br><span class="line">        data_pairs = [(query, doc.page_content) <span class="keyword">for</span> doc <span class="keyword">in</span> parent_docs]</span><br><span class="line">        scores = self.reranker.predict(data_pairs)</span><br><span class="line">        <span class="comment"># print(f&#x27;scores--&gt;&#123;scores&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 根据得分，从高到低去排序文档</span></span><br><span class="line">        ranked_parent_docs = [doc <span class="keyword">for</span> score, doc <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="built_in">zip</span>(scores, parent_docs), reverse=<span class="literal">True</span>)]</span><br><span class="line">        <span class="comment"># print(f&#x27;ranked_parent_docs--&gt;&#123;ranked_parent_docs&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 最终返回排序后的父块文档，返回前 conf.CANDIDATE_M 个</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;Milvus中已找到 <span class="subst">&#123;<span class="built_in">len</span>(ranked_parent_docs)&#125;</span> 个去重父块，最终返回 <span class="subst">&#123;conf.CANDIDATE_M&#125;</span> 个父块&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ranked_parent_docs[:conf.CANDIDATE_M]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.logger.warning(<span class="string">f&quot;在Milvus中没有找到去重父块&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-从查询结果创建文档【实现】"><a href="#6-从查询结果创建文档【实现】" class="headerlink" title="6 从查询结果创建文档【实现】"></a>6 从查询结果创建文档【实现】</h2><h3 id="功能-10"><a href="#功能-10" class="headerlink" title="功能"></a>功能</h3><p><code>_doc_from_hit</code>方法将Milvus查询结果转换为<code>Document</code>对象。</p>
<h3 id="实现步骤-4"><a href="#实现步骤-4" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><strong>提取内容和元数据</strong>：<ul>
<li>从查询结果中获取字段。</li>
</ul>
</li>
<li><strong>创建对象</strong>：<ul>
<li>构造<code>Document</code>实例。</li>
</ul>
</li>
</ol>
<h3 id="说明-11"><a href="#说明-11" class="headerlink" title="说明"></a>说明</h3><ul>
<li><strong>简单转换</strong>：便于后续处理。</li>
</ul>
<h3 id="代码示例-4"><a href="#代码示例-4" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义类似私有方法，从 Milvus 查询结果创建 Document 对象</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_doc_from_hit</span>(<span class="params">self, hit</span>):</span><br><span class="line">    <span class="comment"># 创建并返回 Document 对象，填充内容和元数据</span></span><br><span class="line">    <span class="keyword">return</span> Document(</span><br><span class="line">        page_content=hit.get(<span class="string">&quot;text&quot;</span>),</span><br><span class="line">        metadata=&#123;</span><br><span class="line">            <span class="string">&quot;parent_id&quot;</span>: hit.get(<span class="string">&quot;parent_id&quot;</span>),</span><br><span class="line">            <span class="string">&quot;parent_content&quot;</span>: hit.get(<span class="string">&quot;parent_content&quot;</span>),</span><br><span class="line">            <span class="string">&quot;source&quot;</span>: hit.get(<span class="string">&quot;source&quot;</span>),</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: hit.get(<span class="string">&quot;timestamp&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-获取唯一父文档【理解】"><a href="#7-获取唯一父文档【理解】" class="headerlink" title="7 获取唯一父文档【理解】"></a>7 获取唯一父文档【理解】</h2><h3 id="功能-11"><a href="#功能-11" class="headerlink" title="功能"></a>功能</h3><p><code>_get_unique_parent_docs</code>方法从子块中提取去重的父文档。</p>
<h3 id="实现步骤-5"><a href="#实现步骤-5" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><strong>去重</strong>：<ul>
<li>使用集合记录已处理的父内容。</li>
</ul>
</li>
<li><strong>构造文档</strong>：<ul>
<li>创建包含父内容的<code>Document</code>对象。</li>
</ul>
</li>
</ol>
<h3 id="说明-12"><a href="#说明-12" class="headerlink" title="说明"></a>说明</h3><ul>
<li><strong>去重逻辑</strong>：避免重复父文档。</li>
<li><strong>元数据保留</strong>：保持完整性。</li>
</ul>
<h3 id="代码示例-5"><a href="#代码示例-5" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义父块去重方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_unique_parent_docs</span>(<span class="params">self, chunks</span>):</span><br><span class="line">    <span class="comment"># 定义一个集合，用于存储去重后的父块ID</span></span><br><span class="line">    unique_parent_ids = <span class="built_in">set</span>()</span><br><span class="line">    <span class="comment"># 创建一个空列表，用于存储去重后的父块内容和元数据</span></span><br><span class="line">    parent_docs = []</span><br><span class="line">    <span class="comment"># 遍历子块，根据父块ID进行去重，将父块内容添加到列表中</span></span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">        parent_id = chunk.metadata.get(<span class="string">&quot;parent_id&quot;</span>, <span class="string">&quot;1&quot;</span>)  <span class="comment"># 如果父块ID不存在，则默认为1</span></span><br><span class="line">        parent_content = chunk.metadata.get(<span class="string">&quot;parent_content&quot;</span>, chunk.page_content)  <span class="comment"># 如果父块内容不存在，则默认为子块内容</span></span><br><span class="line">        <span class="keyword">if</span> parent_id <span class="keyword">not</span> <span class="keyword">in</span> unique_parent_ids:</span><br><span class="line">            unique_parent_ids.add(parent_id)</span><br><span class="line">            <span class="comment"># 创建并添加 Document 对象，其中 page_content 为父块内容，metadata 为原来的元数据</span></span><br><span class="line">            parent_docs.append(Document(page_content=parent_content, metadata=chunk.metadata))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parent_docs</span><br></pre></td></tr></table></figure>

<h2 id="8-完整代码"><a href="#8-完整代码" class="headerlink" title="8 完整代码"></a>8 完整代码</h2><p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;core&#x2F;vector_store.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 导入 BGE-M3 嵌入函数，用于生成文档和查询的向量表示</span></span><br><span class="line"><span class="keyword">from</span> milvus_model.hybrid <span class="keyword">import</span> BGEM3EmbeddingFunction</span><br><span class="line"><span class="comment"># 导入 Milvus 相关类，用于操作向量数据库</span></span><br><span class="line"><span class="keyword">from</span> pymilvus <span class="keyword">import</span> MilvusClient, DataType, AnnSearchRequest, WeightedRanker</span><br><span class="line"><span class="comment"># 导入 Document 类，用于创建文档对象</span></span><br><span class="line"><span class="keyword">from</span> langchain.docstore.document <span class="keyword">import</span> Document</span><br><span class="line"><span class="comment"># CrossEncoder 用于 句对打分 的模型，常用于判断两段文本之间的 语义关系、相似度或相关性。</span></span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> CrossEncoder</span><br><span class="line"><span class="comment"># 导入 hashlib 模块，用于生成唯一 ID 的哈希值</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.document_processor <span class="keyword">import</span> process_documents</span><br><span class="line"></span><br><span class="line">conf = Config()</span><br><span class="line">base_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 VectorStore 类，封装向量存储和检索功能</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VectorStore</span>:</span><br><span class="line">    <span class="comment"># 初始化方法，设置向量存储的基本参数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 collection_name=conf.MILVUS_COLLECTION_NAME,</span></span><br><span class="line"><span class="params">                 host=conf.MILVUS_HOST,</span></span><br><span class="line"><span class="params">                 port=conf.MILVUS_PORT,</span></span><br><span class="line"><span class="params">                 database=conf.MILVUS_DATABASE_NAME</span>):</span><br><span class="line">        <span class="comment"># 设置日志记录器</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 设置 Milvus 主机地址</span></span><br><span class="line">        self.host = host</span><br><span class="line">        <span class="comment"># 设置 Milvus 端口号</span></span><br><span class="line">        self.port = port</span><br><span class="line">        <span class="comment"># 设置 Milvus 数据库名称</span></span><br><span class="line">        self.database = database</span><br><span class="line">        <span class="comment"># 设置 Milvus 集合名称</span></span><br><span class="line">        self.collection_name = collection_name</span><br><span class="line">        <span class="comment"># 初始化 Milvus 客户端，连接到指定主机和数据库</span></span><br><span class="line">        self.client = MilvusClient(uri=<span class="string">f&quot;http://<span class="subst">&#123;self.host&#125;</span>:<span class="subst">&#123;self.port&#125;</span>&quot;</span>, db_name=self.database)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化 BGE-M3 嵌入函数，可以使用GPU或CPU。</span></span><br><span class="line">        self.embedding_function = BGEM3EmbeddingFunction(model_name_or_path=os.path.join(base_dir, <span class="string">&#x27;../models/bge-m3&#x27;</span>),</span><br><span class="line">                                                         device=<span class="string">&quot;cuda:0&quot;</span>)</span><br><span class="line">        <span class="comment"># 获取稠密向量的维度</span></span><br><span class="line">        self.dense_dim = self.embedding_function.dim[<span class="string">&#x27;dense&#x27;</span>]</span><br><span class="line">        <span class="comment"># print(f&#x27;self.dense_dim--&gt;&#123;self.dense_dim&#125;&#x27;)  # 1024</span></span><br><span class="line">        <span class="comment"># 初始化重排序的模型</span></span><br><span class="line">        self.reranker = CrossEncoder(os.path.join(base_dir, <span class="string">&#x27;../models/bge-reranker-large&#x27;</span>), device=<span class="string">&quot;cuda:0&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建或加载一个向量集合，用于存储文档向量</span></span><br><span class="line">        self._create_or_load_collection()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义类似私有方法，创建或加载 Milvus 集合</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_or_load_collection</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 检查指定集合是否已存在</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.client.has_collection(self.collection_name):</span><br><span class="line">            <span class="comment"># 创建集合</span></span><br><span class="line">            <span class="comment"># 1）创建集合 schema</span></span><br><span class="line">            schema = self.client.create_schema(auto_id=<span class="literal">False</span>, enable_dynamic_field=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># 添加 id 字段， 类型是 varchar 类型【需要基于文档内容进行hash得到一个唯一标识】，最大长度为 100</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;id&quot;</span>, datatype=DataType.VARCHAR, is_primary=<span class="literal">True</span>, max_length=<span class="number">100</span>)</span><br><span class="line">            <span class="comment"># 添加文本字段，VARCHAR 类型，最大长度 65535</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;text&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">65535</span>)</span><br><span class="line">            <span class="comment"># 添加稠密向量字段，FLOAT_VECTOR 类型，维度由嵌入函数指定</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;dense_vector&quot;</span>, datatype=DataType.FLOAT_VECTOR, dim=self.dense_dim)</span><br><span class="line">            <span class="comment"># 添加稀疏向量字段，SPARSE_FLOAT_VECTOR 类型，这个类型是专门用来用于存储稀疏向量数据的</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;sparse_vector&quot;</span>, datatype=DataType.SPARSE_FLOAT_VECTOR)</span><br><span class="line">            <span class="comment"># 添加父块 ID 字段，VARCHAR 类型，最大长度 100</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;parent_id&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">100</span>)</span><br><span class="line">            <span class="comment"># 添加父块内容字段，VARCHAR 类型，最大长度 65535</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;parent_content&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">65535</span>)</span><br><span class="line">            <span class="comment"># 添加学科类别字段，VARCHAR 类型，最大长度 50</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;source&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">50</span>)</span><br><span class="line">            <span class="comment"># 添加时间戳字段，VARCHAR 类型，最大长度 50</span></span><br><span class="line">            schema.add_field(field_name=<span class="string">&quot;timestamp&quot;</span>, datatype=DataType.VARCHAR, max_length=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2）创建集合索引</span></span><br><span class="line">            <span class="comment"># 创建索引参数对象</span></span><br><span class="line">            index_params = self.client.prepare_index_params()</span><br><span class="line">            <span class="comment"># 为稠密向量字段创建索引</span></span><br><span class="line">            index_params.add_index(field_name=<span class="string">&quot;dense_vector&quot;</span>,</span><br><span class="line">                                   index_name=<span class="string">&quot;dense_index&quot;</span>,</span><br><span class="line">                                   index_type=<span class="string">&quot;IVF_SQ8&quot;</span>,</span><br><span class="line">                                   metric_type=<span class="string">&quot;IP&quot;</span>,</span><br><span class="line">                                   <span class="comment"># 设置簇的个数：设置簇的个数越多，每个簇中向量数越少，查询的速度变化越快，但是查询的准确度越低</span></span><br><span class="line">                                   <span class="comment"># 一般来说设的值是 根号下文档数</span></span><br><span class="line">                                   params=&#123;<span class="string">&quot;nlist&quot;</span>: <span class="number">10</span>&#125;)</span><br><span class="line">            <span class="comment"># 为稀疏向量字段创建索引</span></span><br><span class="line">            index_params.add_index(field_name=<span class="string">&quot;sparse_vector&quot;</span>,</span><br><span class="line">                                   index_name=<span class="string">&quot;sparse_index&quot;</span>,</span><br><span class="line">                                   <span class="comment"># 设置索引类型为稀疏倒排索引</span></span><br><span class="line">                                   index_type=<span class="string">&quot;SPARSE_INVERTED_INDEX&quot;</span>,</span><br><span class="line">                                   metric_type=<span class="string">&quot;IP&quot;</span></span><br><span class="line">                                   )</span><br><span class="line">            <span class="comment"># 3）创建集合</span></span><br><span class="line">            self.client.create_collection(collection_name=self.collection_name,</span><br><span class="line">                                          schema=schema,</span><br><span class="line">                                          index_params=index_params)</span><br><span class="line">            logger.info(<span class="string">f&quot;已创建集合 <span class="subst">&#123;self.collection_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 记录加载集合的日志</span></span><br><span class="line">            logger.info(<span class="string">f&quot;已加载集合 <span class="subst">&#123;self.collection_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 加载集合</span></span><br><span class="line">        self.client.load_collection(self.collection_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义方法，向向量存储添加文档</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_documents</span>(<span class="params">self, documents</span>):</span><br><span class="line">        <span class="comment"># 提取所有文档中的内容</span></span><br><span class="line">        texts = [doc.page_content <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line">        <span class="comment"># 使用嵌入函数将内容转换为稠密向量和稀疏向量</span></span><br><span class="line">        embeddings = self.embedding_function(texts)</span><br><span class="line">        <span class="comment"># print(f&#x27;embeddings--&gt;&#123;embeddings&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化空列表，用于存储插入的数据</span></span><br><span class="line">        data = []</span><br><span class="line">        <span class="comment"># 遍历每个文档，带上索引 i</span></span><br><span class="line">        <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents):</span><br><span class="line">            <span class="comment"># 1)生成文档内容的MD5哈希值，用于作为文档的ID</span></span><br><span class="line">            doc_id = hashlib.md5(doc.page_content.encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2)整理稀疏向量数据</span></span><br><span class="line">            sparse_vector = &#123;&#125;  <span class="comment"># 创建一个空字典，用于存储稀疏向量数据</span></span><br><span class="line">            <span class="comment"># 获取第i个文档对应的稀疏向量数据</span></span><br><span class="line">            row_vector = embeddings[<span class="string">&#x27;sparse&#x27;</span>]._getrow(i)</span><br><span class="line">            <span class="comment"># print(f&#x27;row_vector--&gt;&#123;row_vector&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 获取稀疏向量的非零索引</span></span><br><span class="line">            indices = row_vector.indices</span><br><span class="line">            <span class="comment"># print(f&#x27;indices--&gt;&#123;indices&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 获取稀疏向量的非零值</span></span><br><span class="line">            values = row_vector.data</span><br><span class="line">            <span class="comment"># print(f&#x27;values--&gt;&#123;values&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 将索引和值组成键值对，并添加到字典中</span></span><br><span class="line">            <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">zip</span>(indices, values):</span><br><span class="line">                sparse_vector[index] = value</span><br><span class="line">            <span class="comment"># print(f&#x27;sparse_vector--&gt;&#123;sparse_vector&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3)创建数据字典，包含所有字段</span></span><br><span class="line">            data.append(&#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: doc_id,</span><br><span class="line">                <span class="string">&quot;text&quot;</span>: doc.page_content,</span><br><span class="line">                <span class="string">&quot;dense_vector&quot;</span>: embeddings[<span class="string">&quot;dense&quot;</span>][i],</span><br><span class="line">                <span class="string">&quot;sparse_vector&quot;</span>: sparse_vector,</span><br><span class="line">                <span class="string">&quot;parent_id&quot;</span>: doc.metadata.get(<span class="string">&quot;parent_id&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">                <span class="string">&quot;parent_content&quot;</span>: doc.metadata.get(<span class="string">&quot;parent_content&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: doc.metadata.get(<span class="string">&quot;source&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: doc.metadata.get(<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将数据插入向量存储【使用 upsert 操作插入数据，覆盖重复 ID】</span></span><br><span class="line">        self.client.upsert(collection_name=self.collection_name, data=data)</span><br><span class="line">        logger.info(<span class="string">f&quot;Milvus中已成功添加 <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> 个文档&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#  定义方法，实现混合检索和重排序</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hybrid_search_with_rerank</span>(<span class="params">self, query, top_k=conf.RETRIEVAL_K, source_filter=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        :param query: 查询的问题</span></span><br><span class="line"><span class="string">        :param top_k: 检索返回的topk个文档</span></span><br><span class="line"><span class="string">        :param source_filter: 进行查询过滤的条件，这里指的是学科</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># todo: 1.对查询进行embedding</span></span><br><span class="line">        query_embeddings = self.embedding_function([query])</span><br><span class="line">        <span class="comment"># 获取稠密向量</span></span><br><span class="line">        dense_vector = query_embeddings[<span class="string">&quot;dense&quot;</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># print(f&#x27;dense_vector--&gt;&#123;dense_vector&#125;&#x27;)  # 维度是1024</span></span><br><span class="line">        <span class="comment"># 获取稀疏向量</span></span><br><span class="line">        sparse_vector = query_embeddings[<span class="string">&quot;sparse&quot;</span>]._getrow(<span class="number">0</span>)</span><br><span class="line">        sparse_dict = &#123;index: value <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">zip</span>(sparse_vector.indices, sparse_vector.data)&#125;</span><br><span class="line">        <span class="comment"># print(f&#x27;sparse_dict--&gt;&#123;sparse_dict&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo: 2.构建稠密向量和稀疏向量的检索请求</span></span><br><span class="line">        filter_expression = <span class="string">f&quot;source ` &#x27;<span class="subst">&#123;source_filter&#125;</span>&#x27;&quot;</span> <span class="keyword">if</span> source_filter <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 创建稠密向量的搜索请求</span></span><br><span class="line">        dense_search_params = &#123;</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: [dense_vector],</span><br><span class="line">            <span class="string">&quot;anns_field&quot;</span>: <span class="string">&quot;dense_vector&quot;</span>,  <span class="comment"># 要查询的字段</span></span><br><span class="line">            <span class="comment"># nprobe 控制搜索的簇数量，nprobe 值越小，搜索速度越快，但是搜索的准确度越低，通常是nlist的1%-10%</span></span><br><span class="line">            <span class="string">&quot;param&quot;</span>: &#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>, <span class="string">&quot;nprobe&quot;</span>: <span class="number">2</span>&#125;,</span><br><span class="line">            <span class="string">&quot;limit&quot;</span>: top_k,</span><br><span class="line">            <span class="string">&quot;expr&quot;</span>: filter_expression</span><br><span class="line">        &#125;</span><br><span class="line">        request_1 = AnnSearchRequest(**dense_search_params)</span><br><span class="line">        <span class="comment"># 创建稀疏向量的搜索请求</span></span><br><span class="line">        request_2 = AnnSearchRequest(</span><br><span class="line">            data=[sparse_dict],</span><br><span class="line">            anns_field=<span class="string">&quot;sparse_vector&quot;</span>,</span><br><span class="line">            param=&#123;<span class="string">&quot;metric_type&quot;</span>: <span class="string">&quot;IP&quot;</span>&#125;,</span><br><span class="line">            limit=top_k,</span><br><span class="line">            expr=filter_expression</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo: 3.使用 WeightedRanker 融合结果</span></span><br><span class="line">        <span class="comment"># 创建 WeightedRanker 对象，设置权重为稠密向量1.0和稀疏向量0.7</span></span><br><span class="line">        ranker = WeightedRanker(<span class="number">1.0</span>, <span class="number">0.7</span>)</span><br><span class="line">        <span class="comment"># 进行混合检索。因为检索结果是一个列表，所以需要取第一个元素</span></span><br><span class="line">        results = self.client.hybrid_search(collection_name=self.collection_name,</span><br><span class="line">                                            reqs=[request_1, request_2],</span><br><span class="line">                                            ranker=ranker,</span><br><span class="line">                                            limit=top_k,</span><br><span class="line">                                            output_fields=[<span class="string">&quot;text&quot;</span>, <span class="string">&quot;parent_id&quot;</span>, <span class="string">&quot;parent_content&quot;</span>, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;timestamp&quot;</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># print(f&#x27;results--&gt;&#123;type(results), results&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 对结果进行处理，封装成 Document 对象</span></span><br><span class="line">        sub_chunks = [self._doc_from_hit(hit[<span class="string">&#x27;entity&#x27;</span>]) <span class="keyword">for</span> hit <span class="keyword">in</span> results]</span><br><span class="line">        <span class="comment"># print(f&#x27;sub_chunks--&gt;&#123;len(sub_chunks), sub_chunks&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo: 4.对去重后的父块进行重排序</span></span><br><span class="line">        <span class="comment"># 从子块中去重父块内容，并进行去重</span></span><br><span class="line">        parent_docs = self._get_unique_parent_docs(sub_chunks)</span><br><span class="line">        <span class="comment"># print(f&#x27;parent_docs--&gt;&#123;len(parent_docs), parent_docs&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 对父块进行重排序</span></span><br><span class="line">        <span class="keyword">if</span> parent_docs:</span><br><span class="line">            <span class="comment"># 数据对为 查询和文档</span></span><br><span class="line">            data_pairs = [(query, doc.page_content) <span class="keyword">for</span> doc <span class="keyword">in</span> parent_docs]</span><br><span class="line">            scores = self.reranker.predict(data_pairs)</span><br><span class="line">            <span class="comment"># print(f&#x27;scores--&gt;&#123;scores&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 根据得分，从高到低去排序文档</span></span><br><span class="line">            ranked_parent_docs = [doc <span class="keyword">for</span> score, doc <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="built_in">zip</span>(scores, parent_docs), reverse=<span class="literal">True</span>)]</span><br><span class="line">            <span class="comment"># print(f&#x27;ranked_parent_docs--&gt;&#123;ranked_parent_docs&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 最终返回排序后的父块文档，返回前 conf.CANDIDATE_M 个</span></span><br><span class="line">            self.logger.info(<span class="string">f&quot;Milvus中已找到 <span class="subst">&#123;<span class="built_in">len</span>(ranked_parent_docs)&#125;</span> 个去重父块，最终返回 <span class="subst">&#123;conf.CANDIDATE_M&#125;</span> 个父块&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> ranked_parent_docs[:conf.CANDIDATE_M]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.logger.warning(<span class="string">f&quot;在Milvus中没有找到去重父块&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义类似私有方法，从 Milvus 查询结果创建 Document 对象</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_doc_from_hit</span>(<span class="params">self, hit</span>):</span><br><span class="line">        <span class="comment"># 创建并返回 Document 对象，填充内容和元数据</span></span><br><span class="line">        <span class="keyword">return</span> Document(</span><br><span class="line">            page_content=hit.get(<span class="string">&quot;text&quot;</span>),</span><br><span class="line">            metadata=&#123;</span><br><span class="line">                <span class="string">&quot;parent_id&quot;</span>: hit.get(<span class="string">&quot;parent_id&quot;</span>),</span><br><span class="line">                <span class="string">&quot;parent_content&quot;</span>: hit.get(<span class="string">&quot;parent_content&quot;</span>),</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: hit.get(<span class="string">&quot;source&quot;</span>),</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: hit.get(<span class="string">&quot;timestamp&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义父块去重方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_unique_parent_docs</span>(<span class="params">self, chunks</span>):</span><br><span class="line">        <span class="comment"># 定义一个集合，用于存储去重后的父块ID</span></span><br><span class="line">        unique_parent_ids = <span class="built_in">set</span>()</span><br><span class="line">        <span class="comment"># 创建一个空列表，用于存储去重后的父块内容和元数据</span></span><br><span class="line">        parent_docs = []</span><br><span class="line">        <span class="comment"># 遍历子块，根据父块ID进行去重，将父块内容添加到列表中</span></span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">            parent_id = chunk.metadata.get(<span class="string">&quot;parent_id&quot;</span>, <span class="string">&quot;1&quot;</span>)  <span class="comment"># 如果父块ID不存在，则默认为1</span></span><br><span class="line">            parent_content = chunk.metadata.get(<span class="string">&quot;parent_content&quot;</span>, chunk.page_content)  <span class="comment"># 如果父块内容不存在，则默认为子块内容</span></span><br><span class="line">            <span class="keyword">if</span> parent_id <span class="keyword">not</span> <span class="keyword">in</span> unique_parent_ids:</span><br><span class="line">                unique_parent_ids.add(parent_id)</span><br><span class="line">                <span class="comment"># 创建并添加 Document 对象，其中 page_content 为父块内容，metadata 为原来的元数据</span></span><br><span class="line">                parent_docs.append(Document(page_content=parent_content, metadata=chunk.metadata))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parent_docs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    vector_store = VectorStore()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 插入数据</span></span><br><span class="line">    <span class="comment"># vector_store.add_documents([Document(page_content=&quot;这是测试文档1&quot;), Document(page_content=&quot;这是测试文档2&quot;)])</span></span><br><span class="line">    <span class="comment"># child_chunks = process_documents(r&#x27;..\data\ai_data&#x27;)</span></span><br><span class="line">    <span class="comment"># vector_store.add_documents(child_chunks)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 混合检索和重排序</span></span><br><span class="line">    results = vector_store.hybrid_search_with_rerank(<span class="string">&quot;什么是大语言模型？&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;results--&gt;<span class="subst">&#123;results&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>





<h1 id="五、查询分类"><a href="#五、查询分类" class="headerlink" title="五、查询分类"></a>五、查询分类</h1><h2 id="1-查询分类【掌握】"><a href="#1-查询分类【掌握】" class="headerlink" title="1 查询分类【掌握】"></a>1 查询分类【掌握】</h2><p><code>QueryClassifier</code> 是 EduRAG 系统的核心组件，负责将用户查询分为“通用知识”和“专业咨询”两类，以决定查询路由到知识库还是咨询接口。本模块利用 5000 条混合数据集（假设“通用知识”和“专业咨询”各约 2500 条）进行训练，并解决评估中的标签处理问题。</p>
<h3 id="1-1-功能概述"><a href="#1-1-功能概述" class="headerlink" title="1.1 功能概述"></a>1.1 功能概述</h3><p><code>QueryClassifier</code> 提供以下功能：</p>
<ul>
<li><strong>数据加载与处理</strong>：读取 5000 条 JSON 数据集，包含查询和标签（“通用知识”或“专业咨询”）。对数据进行处理，处理成模型训练的格式。</li>
<li><strong>BERT 训练</strong>：使用 <code>bert-base-chinese</code> 模型，微调二分类任务，准确率达 90%+。</li>
<li><strong>评估优化</strong>：直接处理数字标签（0 或 1），生成分类报告和混淆矩阵。</li>
<li><strong>预测接口</strong>：支持实时分类，集成到 EduRAG 系统。</li>
</ul>
<h3 id="1-2-实现细节"><a href="#1-2-实现细节" class="headerlink" title="1.2 实现细节"></a>1.2 实现细节</h3><ol>
<li><strong><code>__init__</code> 方法</strong>：<ul>
<li><strong>作用</strong>：初始化 BERT 分词器（<code>bert-base-chinese</code>）和模型，支持二分类。</li>
<li><strong>优化</strong>：设备选择优先 CUDA，若不可用则回退到 CPU。</li>
<li><strong>标签映射</strong>：定义 <code>label_map = &#123;&quot;通用知识&quot;: 0, &quot;专业咨询&quot;: 1&#125;</code>，用于训练时字符串标签转换。</li>
</ul>
</li>
<li><strong><code>preprocess_data</code> 方法</strong>：<ul>
<li><strong>作用</strong>：将查询文本分词为 BERT 输入，将字符串标签转换为数字（0 或 1）。</li>
<li><strong>细节</strong>：设置 <code>max_length=128</code>，平衡效率和信息完整性。</li>
</ul>
</li>
<li><strong><code>create_dataset</code> 方法</strong>：<ul>
<li><strong>作用</strong>：构建 PyTorch 数据集，适配 <code>Trainer</code> 的输入格式。</li>
<li><strong>实现</strong>：将输出封装到一个字典中，方便后续使用。</li>
</ul>
</li>
<li><strong><code>train_model</code> 方法</strong>：<ul>
<li><strong>作用</strong>：加载 5000 条数据集，划分 80% 训练（4000 条）和 20% 验证（1000 条），微调 BERT 模型。</li>
<li><strong>参数</strong>：<ul>
<li><code>num_train_epochs=3</code>：训练 3 轮，适合中等规模数据集。</li>
<li><code>per_device_train_batch_size=8</code>：平衡内存和速度。</li>
<li><code>fp16=False</code>：禁用混合精度，兼容 PyTorch 2.5 和 CPU。</li>
</ul>
</li>
<li><strong>流程</strong>：<ul>
<li>加载 <code>training_dataset_hybrid_5000.json</code>。</li>
<li>预处理数据，将标签转换为数字。</li>
<li>使用 <code>Trainer</code> 训练，自动保存最佳模型。</li>
</ul>
</li>
</ul>
</li>
<li><strong><code>evaluate_model</code> 方法</strong>：<ul>
<li><strong>作用</strong>：在验证集上评估模型，生成分类报告和混淆矩阵。</li>
<li><strong>输出</strong>：精确率、召回率、F1 分数和混淆矩阵。</li>
</ul>
</li>
<li><strong><code>predict_category</code> 方法</strong>：<ul>
<li><strong>作用</strong>：对单条查询分类，返回“通用知识”或“专业咨询”。</li>
<li><strong>实现</strong>：分词后通过模型预测，返回人类可读标签。</li>
</ul>
</li>
</ol>
<h3 id="1-3-代码实现"><a href="#1-3-代码实现" class="headerlink" title="1.3 代码实现"></a>1.3 代码实现</h3><p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;core&#x2F;query_classifier.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入标准库</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 导入 PyTorch</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="comment"># 导入numpy</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># 导入 Transformers 库， BertForSequenceClassification BERT+任务头的分类模型</span></span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> BertTokenizer, BertForSequenceClassification</span><br><span class="line"><span class="comment"># 使用 Trainer 来完成模型的训练，其中 TrainingArguments 是用来配置训练参数的</span></span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> Trainer, TrainingArguments</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report, confusion_matrix</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">base_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueryClassifier</span>:</span><br><span class="line">    <span class="comment"># model_path 指的的训练好的模型的保存路径，直接传相对路径的名称即可</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_path=<span class="string">&quot;bert_query_classifier&quot;</span></span>):</span><br><span class="line">        <span class="comment"># 设置日志记录器</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 模型保存路径</span></span><br><span class="line">        self.model_path = os.path.join(base_dir, <span class="string">&#x27;../models&#x27;</span>, model_path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;self.model_path--&gt;<span class="subst">&#123;self.model_path&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="comment"># BERT模型路径</span></span><br><span class="line">        self.bert_path = os.path.join(base_dir, <span class="string">&#x27;../models&#x27;</span>, <span class="string">&#x27;bert-base-chinese&#x27;</span>)</span><br><span class="line">        <span class="comment"># print(f&#x27;self.bert_path--&gt;&#123;self.bert_path&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 加载BERT分词器</span></span><br><span class="line">        self.tokenizer = BertTokenizer.from_pretrained(self.bert_path)</span><br><span class="line">        <span class="comment"># 初始化模型</span></span><br><span class="line">        self.model = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 确定设备（GPU 或 CPU）</span></span><br><span class="line">        self.device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">        self.logger.info(<span class="string">f&quot;使用设备: <span class="subst">&#123;self.device&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 加载模型</span></span><br><span class="line">        self.load_model()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定义标签映射</span></span><br><span class="line">        self.label_map = &#123;<span class="string">&quot;通用知识&quot;</span>: <span class="number">0</span>, <span class="string">&quot;专业咨询&quot;</span>: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_model</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 检查模型文件是否存在</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(self.model_path):</span><br><span class="line">            <span class="comment"># 加载训练好的模型</span></span><br><span class="line">            self.model = BertForSequenceClassification.from_pretrained(self.model_path, num_labels=<span class="number">2</span>).to(self.device)</span><br><span class="line">            self.logger.info(<span class="string">f&quot;加载已训练好的模型成功：<span class="subst">&#123;self.model_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 加载BERT模型，用于模型训练  可以使用  num_labels=2 来显示指定分类的个数</span></span><br><span class="line">            self.model = BertForSequenceClassification.from_pretrained(self.bert_path, num_labels=<span class="number">2</span>).to(self.device)</span><br><span class="line">            <span class="comment"># print(f&#x27;model--&gt;&#123;self.model&#125;&#x27;)</span></span><br><span class="line">            self.logger.info(<span class="string">f&quot;加载BERT模型成功：<span class="subst">&#123;self.bert_path&#125;</span>，用于模型训练&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train_model</span>(<span class="params">self, data_file</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        训练模型</span></span><br><span class="line"><span class="string">        :param data_file: 训练数据文件路径</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 1）加载数据集</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(data_file):</span><br><span class="line">            self.logger.error(<span class="string">f&quot;数据集文件 <span class="subst">&#123;data_file&#125;</span> 不存在&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;数据集文件 <span class="subst">&#123;data_file&#125;</span> 不存在&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(data_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = [json.loads(line) <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines()]</span><br><span class="line">        <span class="comment"># print(f&#x27;data--&gt;&#123;data&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2）数据划分</span></span><br><span class="line">        querys = [item[<span class="string">&#x27;query&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> data]</span><br><span class="line">        labels = [item[<span class="string">&#x27;label&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> data]</span><br><span class="line">        train_querys, val_querys, train_labels, val_labels = train_test_split(querys, labels, test_size=<span class="number">0.2</span>, random_state=<span class="number">42</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3）数据处理，转成成模型训练需要的数据格式</span></span><br><span class="line">        train_encodings, train_labels = self.preprocess_data(train_querys, train_labels)</span><br><span class="line">        <span class="comment"># print(f&#x27;train_encodings[&quot;input_ids&quot;]--&gt;&#123;train_encodings[&quot;input_ids&quot;].shape&#125;&#x27;)</span></span><br><span class="line">        val_encodings, val_labels = self.preprocess_data(val_querys, val_labels)</span><br><span class="line">        <span class="comment"># print(f&#x27;val_encodings[&quot;input_ids&quot;]--&gt;&#123;val_encodings[&quot;input_ids&quot;].shape&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4）创建数据集</span></span><br><span class="line">        train_dataset = self.create_dataset(train_encodings, train_labels)</span><br><span class="line">        <span class="comment"># print(f&#x27;train_dataset--&gt;&#123;train_dataset[0]&#125;&#x27;)</span></span><br><span class="line">        val_dataset = self.create_dataset(val_encodings, val_labels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5）模型训练-设置训练参数</span></span><br><span class="line">        training_args = TrainingArguments(</span><br><span class="line">            output_dir=<span class="string">&quot;./bert_results&quot;</span>,  <span class="comment"># 检查点的保存路径</span></span><br><span class="line">            num_train_epochs=<span class="number">3</span>,  <span class="comment"># 训练轮数</span></span><br><span class="line">            per_device_train_batch_size=<span class="number">8</span>,  <span class="comment"># 训练批次大小</span></span><br><span class="line">            per_device_eval_batch_size=<span class="number">8</span>,  <span class="comment"># 评估批次大小</span></span><br><span class="line">            warmup_steps=<span class="number">50</span>,  <span class="comment"># 预热步数</span></span><br><span class="line">            weight_decay=<span class="number">0.01</span>,  <span class="comment"># 使用adamW的权重衰减系数</span></span><br><span class="line">            logging_dir=<span class="string">&quot;./bert_logs&quot;</span>,  <span class="comment"># 日志保存路径：如果想生成这个文件夹，需要安装tensorboard</span></span><br><span class="line">            logging_steps=<span class="number">10</span>,  <span class="comment"># 每10个批次打印一次日志</span></span><br><span class="line">            evaluation_strategy=<span class="string">&quot;epoch&quot;</span>,  <span class="comment"># 评估策略，这里选择每个epoch评估一次</span></span><br><span class="line">            save_strategy=<span class="string">&quot;epoch&quot;</span>,  <span class="comment"># 保存策略，这里选择每个epoch保存一次</span></span><br><span class="line">            load_best_model_at_end=<span class="literal">True</span>,  <span class="comment"># 在训练结束时加载最佳模型</span></span><br><span class="line">            save_total_limit=<span class="number">1</span>,  <span class="comment"># 只保存1个检查点，注意这个检查点不一定是最优的模型</span></span><br><span class="line">            metric_for_best_model=<span class="string">&quot;eval_loss&quot;</span>,  <span class="comment"># 评估最优模型的指标 eval_loss是自带的，如果使用自定义的指标，需要在compute_metrics方法中进行定义</span></span><br><span class="line">            greater_is_better=<span class="literal">False</span>,  <span class="comment"># 明确指定loss指标越小越好</span></span><br><span class="line">            fp16=<span class="literal">False</span>,  <span class="comment"># 使用混合精度训练（GPU 支持时）</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 模型训练-创建Trainer对象</span></span><br><span class="line">        trainer = Trainer(</span><br><span class="line">            model=self.model,  <span class="comment"># 模型</span></span><br><span class="line">            args=training_args,  <span class="comment"># 训练参数</span></span><br><span class="line">            train_dataset=train_dataset,  <span class="comment"># 训练数据集</span></span><br><span class="line">            eval_dataset=val_dataset,  <span class="comment"># 验证数据集</span></span><br><span class="line">            compute_metrics=self.compute_metrics,  <span class="comment"># 自定义的评估指标</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 模型训练-开始训练</span></span><br><span class="line">        self.logger.info(<span class="string">&quot;开始训练模型...&quot;</span>)</span><br><span class="line">        trainer.train()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6）保存模型</span></span><br><span class="line">        self.save_model()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 7）评估模型【实际工作中，需要使用测试数据集，我们这里简化了，使用验证数据集】</span></span><br><span class="line">        <span class="comment"># trainer.evaluate()</span></span><br><span class="line">        <span class="comment"># 如果说你已经训练好了模型，可以将上边代码的train()和save_model()注释掉再运行。</span></span><br><span class="line">        self.evaluate_model(self.model, val_dataset, val_labels)  <span class="comment"># 传入模型、数据集和真实标签</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">preprocess_data</span>(<span class="params">self, querys, labels</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        数据处理，将数据转换成模型训练需要的数据格式</span></span><br><span class="line"><span class="string">        :param querys: 查询数据列表</span></span><br><span class="line"><span class="string">        :param labels: 数据标签列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        encodings = self.tokenizer.batch_encode_plus(querys,</span><br><span class="line">                                                     truncation=<span class="literal">True</span>,</span><br><span class="line">                                                     padding=<span class="literal">True</span>, <span class="comment"># 使用 padding=True, 此时会按批次中的最长长度进行填充</span></span><br><span class="line">                                                     max_length=<span class="number">128</span>,</span><br><span class="line">                                                     return_tensors=<span class="string">&#x27;pt&#x27;</span>)</span><br><span class="line">        <span class="comment"># print(f&#x27;encodings--&gt;&#123;encodings&#125;&#x27;)</span></span><br><span class="line">        label_ids = [self.label_map[label] <span class="keyword">for</span> label <span class="keyword">in</span> labels]</span><br><span class="line">        <span class="keyword">return</span> encodings, label_ids</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_dataset</span>(<span class="params">self, encodings, label_ids</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        创建数据集</span></span><br><span class="line"><span class="string">        :param encodings: 模型训练需要的编码数据</span></span><br><span class="line"><span class="string">        :param label_ids: 数据标签列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">MyDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, encodings, label_ids</span>):</span><br><span class="line">                self.encodings = encodings</span><br><span class="line">                self.label_ids = label_ids</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">len</span>(self.label_ids)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">                item = &#123;key: val[idx] <span class="keyword">for</span> key, val <span class="keyword">in</span> self.encodings.items()&#125;</span><br><span class="line">                item[<span class="string">&#x27;labels&#x27;</span>] = torch.tensor(self.label_ids[idx])</span><br><span class="line">                <span class="keyword">return</span> item</span><br><span class="line">        <span class="keyword">return</span> MyDataset(encodings, label_ids)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 评估指标</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_metrics</span>(<span class="params">self, eval_pred</span>):</span><br><span class="line">        logits, labels = eval_pred  <span class="comment"># 预测结果的logits和真实标签</span></span><br><span class="line">        predictions = np.argmax(logits, axis=-<span class="number">1</span>)</span><br><span class="line">        accuracy = np.mean(predictions ` labels)  <span class="comment"># 计算平均准确率</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;accuracy&quot;</span>: accuracy&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_model</span>(<span class="params">self</span>):</span><br><span class="line">        self.logger.info(<span class="string">&quot;保存模型...&quot;</span>)</span><br><span class="line">        self.model.save_pretrained(self.model_path)</span><br><span class="line">        self.tokenizer.save_pretrained(self.model_path)</span><br><span class="line">        self.logger.info(<span class="string">f&quot;模型保存成功！保存路径为<span class="subst">&#123;self.model_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_model</span>(<span class="params">self, model, dataset, labels</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        评估模型</span></span><br><span class="line"><span class="string">        :param model: 模型</span></span><br><span class="line"><span class="string">        :param dataset: 测试数据集</span></span><br><span class="line"><span class="string">        :param labels: 真实标签</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.logger.info(<span class="string">&quot;开始评估模型...&quot;</span>)</span><br><span class="line">        <span class="comment"># 获取trainer对象</span></span><br><span class="line">        trainer = Trainer(model=model)</span><br><span class="line">        <span class="comment"># 拿到预测结果</span></span><br><span class="line">        predict = trainer.predict(dataset)</span><br><span class="line">        predict_labels = np.argmax(predict.predictions, axis=-<span class="number">1</span>)</span><br><span class="line">        real_labels = labels</span><br><span class="line">        <span class="comment"># 打印分类报告</span></span><br><span class="line">        self.logger.info(<span class="string">&quot;打印分类报告...&quot;</span>)</span><br><span class="line">        self.logger.info(classification_report(real_labels, predict_labels, target_names=[<span class="string">&quot;通用知识&quot;</span>, <span class="string">&quot;专业咨询&quot;</span>]))</span><br><span class="line">        <span class="comment"># 打印混淆矩阵</span></span><br><span class="line">        self.logger.info(<span class="string">&quot;打印混淆矩阵...&quot;</span>)</span><br><span class="line">        self.logger.info(confusion_matrix(real_labels, predict_labels))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_category</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="comment"># 1)检查模型是否加载</span></span><br><span class="line">        <span class="keyword">if</span> self.model <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.logger.error(<span class="string">&quot;模型未加载，请先加载模型！&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;通用知识&#x27;</span></span><br><span class="line">        <span class="comment"># 2)对查询进行预处理</span></span><br><span class="line">        encoding = self.tokenizer(query,</span><br><span class="line">                                   truncation=<span class="literal">True</span>,</span><br><span class="line">                                   padding=<span class="literal">True</span>,  <span class="comment"># 使用 padding=True, 此时会按批次中的最长长度进行填充</span></span><br><span class="line">                                   max_length=<span class="number">128</span>,</span><br><span class="line">                                   return_tensors=<span class="string">&#x27;pt&#x27;</span>)</span><br><span class="line">        <span class="comment"># 将数据放到指定设备上</span></span><br><span class="line">        encoding = &#123;key: val.to(self.device) <span class="keyword">for</span> key, val <span class="keyword">in</span> encoding.items()&#125;</span><br><span class="line">        <span class="comment"># 3)将数据送入模型</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            output = self.model(**encoding)</span><br><span class="line">            <span class="comment"># print(f&#x27;output--&gt;&#123;output&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># 4)获取预测结果</span></span><br><span class="line">            predict_label = torch.argmax(output[<span class="string">&#x27;logits&#x27;</span>], dim=-<span class="number">1</span>).item()</span><br><span class="line">            <span class="comment"># print(f&#x27;predict_label--&gt;&#123;predict_label&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;通用知识&#x27;</span> <span class="keyword">if</span> predict_label ` <span class="number">0</span> <span class="keyword">else</span> <span class="string">&#x27;专业咨询&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    query_classifier = QueryClassifier()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模型训练</span></span><br><span class="line">    <span class="comment"># query_classifier.train_model(&#x27;../data/classify_data/model_generic_5000.json&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 示例预测</span></span><br><span class="line">    test_queries = [</span><br><span class="line">        <span class="string">&quot;AI学科的课程大纲是什么&quot;</span>,</span><br><span class="line">        <span class="string">&quot;JAVA课程费用多少？&quot;</span>,</span><br><span class="line">        <span class="string">&quot;5*9等于多少？&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AI培训有哪些老师？&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> query <span class="keyword">in</span> test_queries:</span><br><span class="line">        category = query_classifier.predict_category(query)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;查询: <span class="subst">&#123;query&#125;</span> -&gt; 分类: <span class="subst">&#123;category&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># break</span></span><br></pre></td></tr></table></figure>



<h1 id="六、RAG系统工作流程实现"><a href="#六、RAG系统工作流程实现" class="headerlink" title="六、RAG系统工作流程实现"></a>六、RAG系统工作流程实现</h1><h3 id="流程设计图"><a href="#流程设计图" class="headerlink" title="流程设计图"></a><strong>流程设计图</strong></h3><p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/%E5%9F%BA%E4%BA%8EMilvus%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%84%E5%BB%BARAG%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F.png" alt="RAG流程图"></p>
<h2 id="1-检索策略选择【掌握】"><a href="#1-检索策略选择【掌握】" class="headerlink" title="1 检索策略选择【掌握】"></a>1 检索策略选择【掌握】</h2><h3 id="1-1-功能概述-1"><a href="#1-1-功能概述-1" class="headerlink" title="1.1 功能概述"></a>1.1 功能概述</h3><p><code>strategy_selector.py</code>定义了<code>StrategySelector</code>类，通过调用大语言模型根据用户查询选择最合适的检索策略。支持的策略包括直接检索、HyDE（假设问题检索）、子查询检索和回溯问题检索，旨在优化检索阶段的输入处理。</p>
<h3 id="1-2-实现细节-1"><a href="#1-2-实现细节-1" class="headerlink" title="1.2 实现细节"></a>1.2 实现细节</h3><ol>
<li><strong><code>__init__</code></strong>：<ul>
<li><strong>作用</strong>：初始化DashScope客户端和策略选择Prompt。</li>
<li><strong>逻辑</strong>：连接大语言模型API，准备Prompt模板。</li>
</ul>
</li>
<li><strong><code>call_dashscope</code></strong>：<ul>
<li><strong>作用</strong>：封装DashScope API调用，处理异常并返回模型输出。</li>
<li><strong>逻辑</strong>：确保API调用的鲁棒性，记录错误日志。</li>
</ul>
</li>
<li><strong><code>_get_strategy_prompt</code></strong>：<ul>
<li><strong>作用</strong>：定义用于策略选择的Prompt模板。</li>
<li><strong>设计逻辑</strong>：简洁描述四种策略及其适用场景，要求模型直接返回策略名称。</li>
</ul>
</li>
<li><strong><code>select_strategy</code></strong>：<ul>
<li><strong>作用</strong>：根据查询调用模型选择策略并返回。</li>
<li><strong>逻辑</strong>：记录选择的策略，便于调试。</li>
</ul>
</li>
</ol>
<h3 id="1-3-代码示例"><a href="#1-3-代码示例" class="headerlink" title="1.3 代码示例"></a>1.3 代码示例</h3><p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;core&#x2F;strategy_selector.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 LangChain 提示模板</span></span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="comment"># 导入 OpenAI</span></span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line">conf = Config()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StrategySelector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 初始化 OpenAI 客户端</span></span><br><span class="line">        self.client = OpenAI(api_key=conf.DASHSCOPE_API_KEY,</span><br><span class="line">                             base_url=conf.DASHSCOPE_BASE_URL)</span><br><span class="line">        <span class="comment"># 获取策略选择的提示模板</span></span><br><span class="line">        self.strategy_prompt_template = self._get_strategy_prompt()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_strategy_prompt</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 定义类似私有方法，获取策略选择 Prompt 模板</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> PromptTemplate(</span><br><span class="line">            template=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            你是一个智能助手，负责分析用户查询 &#123;query&#125;，并从以下四种检索增强策略中选择一个最适合的策略，直接返回策略名称，不需要解释过程。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            以下是几种检索增强策略及其适用场景：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            1.  **直接检索：**</span></span><br><span class="line"><span class="string">                * 描述：对用户查询直接进行检索，不进行任何增强处理。</span></span><br><span class="line"><span class="string">                * 适用场景：适用于查询意图明确，需要从知识库中检索**特定信息**的问题，例如：</span></span><br><span class="line"><span class="string">                    * 示例：</span></span><br><span class="line"><span class="string">                        * 查询：AI 学科学费是多少？</span></span><br><span class="line"><span class="string">                        * 思考：这个问题比较简单，直接查询就行，所以使用直接检索。</span></span><br><span class="line"><span class="string">                        * 策略：直接检索</span></span><br><span class="line"><span class="string">            2.  **假设问题检索（HyDE）：**</span></span><br><span class="line"><span class="string">                * 描述：使用 LLM 生成一个假设的答案，然后基于假设答案进行检索。</span></span><br><span class="line"><span class="string">                * 适用场景：适用于查询较为抽象，直接检索效果不佳的问题，例如：</span></span><br><span class="line"><span class="string">                    * 示例：</span></span><br><span class="line"><span class="string">                        * 查询：人工智能在教育领域的应用有哪些？</span></span><br><span class="line"><span class="string">                        * 思考：这个问题比较抽象，可以先生成一个近似的答案，再去检索这个答案相似的文档，效果更好，所以使用假设问题检索。</span></span><br><span class="line"><span class="string">                        * 策略：假设问题检索</span></span><br><span class="line"><span class="string">            3.  **子查询检索：**</span></span><br><span class="line"><span class="string">                * 描述：将复杂的用户查询拆分为多个简单的子查询，分别检索并合并结果。</span></span><br><span class="line"><span class="string">                * 适用场景：适用于查询涉及多个实体或方面，需要分别检索不同信息的问题，例如：</span></span><br><span class="line"><span class="string">                    * 示例：</span></span><br><span class="line"><span class="string">                        * 查询：比较 Milvus 和 Zilliz Cloud 的优缺点。</span></span><br><span class="line"><span class="string">                        * 思考：要想知道Milvus 和 Zilliz Cloud 的优缺点，需要分别查询Milvus的优缺点和Zilliz Cloud的优缺点，所以使用子查询检索。</span></span><br><span class="line"><span class="string">                        * 策略：子查询检索</span></span><br><span class="line"><span class="string">            4.  **回溯问题检索：**</span></span><br><span class="line"><span class="string">                * 描述：将复杂的用户查询转化为更基础、更易于检索的问题，然后进行检索。</span></span><br><span class="line"><span class="string">                * 适用场景：适用于查询较为复杂，需要简化后才能有效检索的问题，例如：</span></span><br><span class="line"><span class="string">                    * 示例：</span></span><br><span class="line"><span class="string">                        * 查询：我是毕业于江西应用技术职业学院的大专生，专业是会计，可以报人工智能学科吗？</span></span><br><span class="line"><span class="string">                        * 思考：不论学生什么身份，只要查询报名要求就行了。可以对原问题进行简化，查询 &#x27;人工智能学科报名要求&#x27;，所以使用回溯问题检索。</span></span><br><span class="line"><span class="string">                        * 策略：回溯问题检索</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            根据用户查询 &#123;query&#125;，直接返回最适合的策略名称，例如 &quot;直接检索&quot;。不要输出任何分析过程或其他内容。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            ,</span><br><span class="line">            input_variables=[<span class="string">&quot;query&quot;</span>],</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call_dashscope</span>(<span class="params">self, prompt</span>):</span><br><span class="line">        <span class="comment"># 调用 DashScope API</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 创建聊天完成请求</span></span><br><span class="line">            completion = self.client.chat.completions.create(</span><br><span class="line">                model=conf.LLM_MODEL,</span><br><span class="line">                messages=[</span><br><span class="line">                    &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一个有用的助手。&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;,</span><br><span class="line">                ],</span><br><span class="line">                temperature=<span class="number">0.1</span></span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 返回完成结果</span></span><br><span class="line">            <span class="keyword">return</span> completion.choices[<span class="number">0</span>].message.content <span class="keyword">if</span> completion.choices <span class="keyword">else</span> <span class="string">&quot;直接检索&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 记录 API 调用失败</span></span><br><span class="line">            self.logger.error(<span class="string">f&quot;DashScope API 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 默认返回直接检索</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;直接检索&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_strategy</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="comment"># 获取策略选择提示</span></span><br><span class="line">        prompt = self.strategy_prompt_template.<span class="built_in">format</span>(query=query)</span><br><span class="line">        <span class="comment"># 调用 DashScope API</span></span><br><span class="line">        strategy = self.call_dashscope(prompt).strip()</span><br><span class="line">        self.logger.info(<span class="string">f&quot;问题：<span class="subst">&#123;query&#125;</span> 策略选择结果: <span class="subst">&#123;strategy&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回策略名称</span></span><br><span class="line">        <span class="keyword">return</span> strategy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    selector = StrategySelector()</span><br><span class="line">    <span class="built_in">print</span>(selector.select_strategy(<span class="string">&quot;LSTM和RNN有什么区别&quot;</span>))</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-Prompt管理【掌握】"><a href="#2-Prompt管理【掌握】" class="headerlink" title="2 Prompt管理【掌握】"></a>2 Prompt管理【掌握】</h2><h3 id="2-1-功能概述"><a href="#2-1-功能概述" class="headerlink" title="2.1 功能概述"></a>2.1 功能概述</h3><p><code>prompts.py</code>定义了<code>RAGPrompts</code>类，负责管理系统中使用的所有Prompt模板。这些模板用于指导大语言模型完成不同任务，例如生成最终答案、假设答案、子查询或简化问题。通过集中管理Prompt，系统能够确保输入的一致性和输出质量。</p>
<h3 id="2-2-实现细节"><a href="#2-2-实现细节" class="headerlink" title="2.2 实现细节"></a>2.2 实现细节</h3><ol>
<li><strong><code>rag_prompt</code></strong>：<ul>
<li><strong>作用</strong>：核心回答模板，结合检索到的上下文生成最终答案。</li>
<li><strong>输入变量</strong>：<code>context</code>（检索文档内容）、<code>question</code>（用户查询）、<code>phone</code>（客服电话）。</li>
<li><strong>设计逻辑</strong>：支持有无上下文的回答，并提供兜底回复，确保用户体验。</li>
</ul>
</li>
<li><strong><code>hyde_prompt</code></strong>：<ul>
<li><strong>作用</strong>：生成假设答案，用于HyDE（Hypothetical Document Embeddings）策略，优化抽象查询的检索。</li>
<li><strong>输入变量</strong>：<code>query</code>（用户查询）。</li>
<li><strong>设计逻辑</strong>：通过生成假设答案，间接增强查询与文档的语义匹配。</li>
</ul>
</li>
<li><strong><code>subquery_prompt</code></strong>：<ul>
<li><strong>作用</strong>：将复杂查询分解为多个子查询，适合涉及多方面的查询。</li>
<li><strong>输入变量</strong>：<code>query</code>（用户查询）。</li>
<li><strong>设计逻辑</strong>：分解复杂问题以提高检索覆盖率。</li>
</ul>
</li>
<li><strong><code>backtracking_prompt</code></strong>：<ul>
<li><strong>作用</strong>：将复杂查询简化为更基础的问题，便于检索。</li>
<li><strong>输入变量</strong>：<code>query</code>（用户查询）。</li>
<li><strong>设计逻辑</strong>：通过简化查询降低检索难度。</li>
</ul>
</li>
</ol>
<h3 id="2-3-代码实现"><a href="#2-3-代码实现" class="headerlink" title="2.3 代码实现"></a>2.3 代码实现</h3><p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;core&#x2F;prompts.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 PromptTemplate 类，用于创建 Prompt 模板</span></span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 RAGPrompts 类，用于管理所有 Prompt 模板</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RAGPrompts</span>:</span><br><span class="line">    <span class="comment"># 定义 RAG 提示模板。这里定义的是一个静态方便，可以直接使用类名.方法名()的方式进行调用，从而获取模板内容</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rag_prompt</span>():</span><br><span class="line">        <span class="comment"># 创建并返回 PromptTemplate 对象</span></span><br><span class="line">        <span class="keyword">return</span> PromptTemplate(</span><br><span class="line">            template=<span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">            你是一个智能助手，帮助用户回答问题。  </span></span><br><span class="line"><span class="string">            如果提供了上下文，请基于上下文回答；如果提供了上下文但上下文信息不足时，请回复：“信息不足，无法回答，请联系人工客服，电话：&#123;phone&#125;。”</span></span><br><span class="line"><span class="string">            如果没有上下文，请直接根据你的知识回答。 </span></span><br><span class="line"><span class="string">            如果答案来源于检索到的文档，请在回答中说明。</span></span><br><span class="line"><span class="string">            直接生成答案即可。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            上下文: &#x27;&#x27;&#x27;&#123;context&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            问题: &#x27;&#x27;&#x27;&#123;question&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            回答:  </span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>,</span><br><span class="line">            <span class="comment"># 定义输入变量</span></span><br><span class="line">            input_variables=[<span class="string">&quot;context&quot;</span>, <span class="string">&quot;question&quot;</span>, <span class="string">&quot;phone&quot;</span>],</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>



<h2 id="3-RAG核心逻辑【掌握】"><a href="#3-RAG核心逻辑【掌握】" class="headerlink" title="3 RAG核心逻辑【掌握】"></a>3 RAG核心逻辑【掌握】</h2><h3 id="3-1-功能概述"><a href="#3-1-功能概述" class="headerlink" title="3.1 功能概述"></a>3.1 功能概述</h3><p><code>rag_system.py</code>定义了<code>RAGSystem</code>类，整合系统的各个模块，完成从查询输入到答案生成的完整流程。它通过查询分类选择处理路径，利用检索策略优化文档检索，并结合上下文生成最终答案。</p>
<h3 id="3-2-实现细节"><a href="#3-2-实现细节" class="headerlink" title="3.2 实现细节"></a>3.2 实现细节</h3><ol>
<li><strong>init</strong>： <ul>
<li><strong>作用</strong>：初始化RAG系统，整合向量存储、大语言模型和其他核心组件。</li>
<li><strong>依赖</strong>：依赖VectorStore、RAGPrompts、QueryClassifier和StrategySelector。</li>
</ul>
</li>
<li><strong>_retrieve_with_hyde</strong>： <ul>
<li><strong>作用</strong>：生成假设答案并调用混合检索，适合抽象查询。</li>
<li><strong>逻辑</strong>：使用hyde_prompt生成假设答案，传递给hybrid_search_with_rerank。</li>
</ul>
</li>
<li><strong>_retrieve_with_subqueries</strong>： <ul>
<li><strong>作用</strong>：分解查询为子查询，分别检索并去重。</li>
<li><strong>逻辑</strong>：使用subquery_prompt分解查询，合并结果并限制数量。</li>
</ul>
</li>
<li><strong>_retrieve_with_backtracking</strong>： <ul>
<li><strong>作用</strong>：简化查询后检索，降低复杂度。</li>
<li><strong>逻辑</strong>：使用backtracking_prompt简化查询，调用混合检索。</li>
</ul>
</li>
<li><strong>retrieve_and_merge</strong>： <ul>
<li><strong>作用</strong>：根据策略选择执行检索，直接返回结果。</li>
<li><strong>优化</strong>：移除冗余的合并逻辑，直接使用hybrid_search_with_rerank的结果（去重的父文档）。</li>
</ul>
</li>
<li><strong>generate_answer</strong>： <ul>
<li><strong>作用</strong>：整合分类、检索和生成，输出最终答案。</li>
<li>流程： <ul>
<li>使用QueryClassifier判断查询类型。</li>
<li>“通用知识”直接生成答案，“专业咨询”触发检索。</li>
<li>结合上下文调用rag_prompt生成回答。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="3-3-代码示例"><a href="#3-3-代码示例" class="headerlink" title="3.3 代码示例"></a>3.3 代码示例</h3><p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;core&#x2F;rag_system.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.prompts <span class="keyword">import</span> RAGPrompts</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.query_classifier <span class="keyword">import</span> QueryClassifier</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.strategy_selector <span class="keyword">import</span> StrategySelector</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.vector_store <span class="keyword">import</span> VectorStore</span><br><span class="line"></span><br><span class="line">conf = Config()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RAGSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm</span>):</span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 大模型的对象</span></span><br><span class="line">        self.llm = llm</span><br><span class="line">        <span class="comment"># 初始化向量存储的对象, 用于调用它的 混合检索和重排序方法，拿到问题的相似文档</span></span><br><span class="line">        self.vector_store = VectorStore()</span><br><span class="line">        <span class="comment"># 初始化通用的提示词模版</span></span><br><span class="line">        self.rag_prompt = RAGPrompts.rag_prompt()</span><br><span class="line">        <span class="comment"># 初始化查询分类器</span></span><br><span class="line">        self.query_classifier = QueryClassifier(model_path=<span class="string">&quot;bert_query_classifier&quot;</span>)</span><br><span class="line">        <span class="comment"># 初始化策略选择器</span></span><br><span class="line">        self.strategy_selector = StrategySelector()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义方法，生成答案</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_answer</span>(<span class="params">self, query, source_filter=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># 记录查询开始时间</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        self.logger.info(<span class="string">f&quot;开始处理查询: &#x27;<span class="subst">&#123;query&#125;</span>&#x27;, 学科过滤: <span class="subst">&#123;source_filter&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1.调用查询分类器，得到查询类别</span></span><br><span class="line">        query_type = self.query_classifier.predict_category(query)</span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询：<span class="subst">&#123;query&#125;</span>, 查询类别: <span class="subst">&#123;query_type&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.如果是通用知识，则直接调用 LLM</span></span><br><span class="line">        <span class="keyword">if</span> query_type ` <span class="string">&quot;通用知识&quot;</span>:</span><br><span class="line">            self.logger.info(<span class="string">&quot;查询为通用知识，直接调用 LLM&quot;</span>)</span><br><span class="line">            <span class="comment"># 拼接提示词</span></span><br><span class="line">            prompt_input = self.rag_prompt.<span class="built_in">format</span>(question=query, context=<span class="string">&#x27;&#x27;</span>, phone=conf.CUSTOMER_SERVICE_PHONE)</span><br><span class="line">            <span class="comment"># 调用大模型</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                answer = self.llm(prompt_input)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.logger.error(<span class="string">f&quot;LLM 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                answer = <span class="string">f&quot;抱歉，处理您的通用知识问题时出错。请联系人工客服：<span class="subst">&#123;conf.CUSTOMER_SERVICE_PHONE&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 记录查询结束时间</span></span><br><span class="line">            end_time = time.time()</span><br><span class="line">            self.logger.info(<span class="string">f&quot;通用知识 查询结束，耗时: <span class="subst">&#123;end_time - start_time&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3.否则为专业咨询，进行RAG检索并生成答案</span></span><br><span class="line">        self.logger.info(<span class="string">&quot;查询为专业咨询，进行 RAG 检索&quot;</span>)</span><br><span class="line">        <span class="comment"># 3.1 进行策略选择</span></span><br><span class="line">        strategy = self.strategy_selector.select_strategy(query)</span><br><span class="line">        <span class="comment"># 3.2 基于不同的检索策略，进行不同的检索方式, 返回相似文档</span></span><br><span class="line">        ranked_chunks = self.retrieve_and_merge(query, source_filter, strategy)</span><br><span class="line">        <span class="comment"># 3.3 对文档进行拼接，然后构造提示词</span></span><br><span class="line">        <span class="comment"># 1）对文档进行拼接</span></span><br><span class="line">        <span class="keyword">if</span> ranked_chunks:</span><br><span class="line">            <span class="comment"># 对文档进行拼接</span></span><br><span class="line">            context = <span class="string">&#x27;\n\n&#x27;</span>.join([chunk.page_content <span class="keyword">for</span> chunk <span class="keyword">in</span> ranked_chunks])</span><br><span class="line">            self.logger.info(<span class="string">f&quot;文档拼接完成，共 <span class="subst">&#123;<span class="built_in">len</span>(ranked_chunks)&#125;</span> 个文档&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            context = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            self.logger.warning(<span class="string">f&quot;没有通过RAG检索到相似文档，context为空&quot;</span>)</span><br><span class="line">        <span class="comment"># 2）构造提示词</span></span><br><span class="line">        prompt_input = self.rag_prompt.<span class="built_in">format</span>(question=query, context=context, phone=conf.CUSTOMER_SERVICE_PHONE)</span><br><span class="line">        self.logger.debug(<span class="string">f&quot;最终生成的提示词: <span class="subst">&#123;prompt_input&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 3.4 调用大模型，生成答案</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            answer = self.llm(prompt_input)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;LLM 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            answer = <span class="string">f&quot;抱歉，处理您的专业咨询问题时出错。请联系人工客服：<span class="subst">&#123;conf.CUSTOMER_SERVICE_PHONE&#125;</span>&quot;</span></span><br><span class="line">        <span class="comment"># 3.5 记录查询结束时间，并返回答案</span></span><br><span class="line">        end_time = time.time()</span><br><span class="line">        self.logger.info(<span class="string">f&quot;专业咨询 查询结束，耗时: <span class="subst">&#123;end_time - start_time&#125;</span>s&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 基于不同的检索策略，进行不同的检索方式</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_and_merge</span>(<span class="params">self, query, source_filter=<span class="literal">None</span>, strategy=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        :param query: 查询的问题</span></span><br><span class="line"><span class="string">        :param source_filter: 学科，用于做条件过滤的</span></span><br><span class="line"><span class="string">        :param strategy: 检索的策略</span></span><br><span class="line"><span class="string">        :return: 重排序后的去重的父块的文档信息</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># 如果没有获取检索策略，则使用默认的策略</span></span><br><span class="line">        <span class="keyword">if</span> strategy <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            strategy = <span class="string">&#x27;直接检索&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 根据不同检索策略，进行不同的检索方式</span></span><br><span class="line">        <span class="keyword">if</span> strategy ` <span class="string">&#x27;假设问题检索&#x27;</span>:</span><br><span class="line">            ranked_chunks = self._retrieve_with_hyde(query, source_filter)</span><br><span class="line">        <span class="keyword">elif</span> strategy ` <span class="string">&#x27;子查询检索&#x27;</span>:</span><br><span class="line">            ranked_chunks = self._retrieve_with_sub_queries(query, source_filter)</span><br><span class="line">        <span class="keyword">elif</span> strategy ` <span class="string">&#x27;回溯问题检索&#x27;</span>:</span><br><span class="line">            ranked_chunks = self._retrieve_with_backtracking(query, source_filter)</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># &#x27;直接检索&#x27; 或 其他</span></span><br><span class="line">            self.logger.info(<span class="string">&quot;使用 直接检索 &quot;</span>)</span><br><span class="line">            <span class="comment"># 对问题进行检索</span></span><br><span class="line">            ranked_chunks = self.vector_store.hybrid_search_with_rerank(query=query,</span><br><span class="line">                                                               top_k=conf.RETRIEVAL_K,</span><br><span class="line">                                                               source_filter=source_filter)</span><br><span class="line">        <span class="comment"># print(f&#x27;ranked_chunks--&gt;&#123;ranked_chunks&#125;&#x27;)</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;策略 &#x27;<span class="subst">&#123;strategy&#125;</span>&#x27; 检索到 <span class="subst">&#123;<span class="built_in">len</span>(ranked_chunks)&#125;</span> 个候选文档&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ranked_chunks</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 假设问题检索</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_retrieve_with_hyde</span>(<span class="params">self, query, source_filter=<span class="literal">None</span></span>):</span><br><span class="line">        self.logger.info(<span class="string">&quot;使用 假设问题检索 &quot;</span>)</span><br><span class="line">        <span class="comment"># todo: 处理方式：先生成一个提示词，再调用大模型，对这个问题生成一个假设的答案，然后对假设的答案进行检索</span></span><br><span class="line">        <span class="comment"># 生成一个假设答案的提示词模版，用于生成提示词</span></span><br><span class="line">        hyde_prompt_template = RAGPrompts.hyde_prompt()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 调用大模型，生成假设的答案</span></span><br><span class="line">            hyde_answer = self.llm(hyde_prompt_template.<span class="built_in">format</span>(query=query)).strip()</span><br><span class="line">            self.logger.info(<span class="string">f&quot;假设的答案: <span class="subst">&#123;hyde_answer&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 对假设的答案进行检索</span></span><br><span class="line">            <span class="keyword">return</span> self.vector_store.hybrid_search_with_rerank(query=hyde_answer,</span><br><span class="line">                                                               top_k=conf.RETRIEVAL_K,</span><br><span class="line">                                                               source_filter=source_filter)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;HyDE 策略执行失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 子查询检索</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_retrieve_with_sub_queries</span>(<span class="params">self, query, source_filter=<span class="literal">None</span></span>):</span><br><span class="line">        self.logger.info(<span class="string">&quot;使用 子查询检索 &quot;</span>)</span><br><span class="line">        <span class="comment"># todo: 处理方式：先生成一个提示词，再调用大模型，对这个问题生成多个子问题，然后对每个子问题进行检索，最后将检索到的结果进行合并</span></span><br><span class="line">        <span class="comment"># 创建一个子查询提示词模版</span></span><br><span class="line">        sub_query_prompt_template = RAGPrompts.subquery_prompt()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 调用大模型，生成子问题</span></span><br><span class="line">            sub_queries = self.llm(sub_query_prompt_template.<span class="built_in">format</span>(query=query)).strip()</span><br><span class="line">            <span class="comment"># print(f&#x27;sub_queries--&gt;&#123;sub_queries&#125;&#x27;)</span></span><br><span class="line">            sub_queries_list =  [q.strip() <span class="keyword">for</span> q <span class="keyword">in</span> sub_queries.split(<span class="string">&#x27;\n&#x27;</span>) <span class="keyword">if</span> q.strip()]</span><br><span class="line">            self.logger.info(<span class="string">f&quot;子问题: <span class="subst">&#123;sub_queries_list&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 对每个子问题进行检索</span></span><br><span class="line">            all_docs = []  <span class="comment"># 用于存储所有检索到的文档</span></span><br><span class="line">            <span class="keyword">for</span> sub_query <span class="keyword">in</span> sub_queries_list:</span><br><span class="line">                <span class="comment"># 为防止子查询果断，这里每个子查询只取一个最相似的文档</span></span><br><span class="line">                docs = self.vector_store.hybrid_search_with_rerank(query=sub_query,</span><br><span class="line">                                                                   top_k=<span class="number">1</span>,</span><br><span class="line">                                                                   source_filter=source_filter)</span><br><span class="line">                all_docs.extend(docs)</span><br><span class="line">                self.logger.info(<span class="string">f&quot;子查询: <span class="subst">&#123;sub_query&#125;</span>, 检索到的文档个数: <span class="subst">&#123;<span class="built_in">len</span>(docs)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># print(f&#x27;all_docs--&gt;&#123;all_docs&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将检索到的结果进行合并</span></span><br><span class="line">            <span class="comment"># 基于parent_id 去重</span></span><br><span class="line">            unique_docs = &#123;doc.metadata[<span class="string">&#x27;parent_id&#x27;</span>]: doc <span class="keyword">for</span> doc <span class="keyword">in</span> all_docs&#125;</span><br><span class="line">            unique_docs_list = <span class="built_in">list</span>(unique_docs.values())</span><br><span class="line">            self.logger.info(<span class="string">f&quot;去重前的文档个数: <span class="subst">&#123;<span class="built_in">len</span>(all_docs)&#125;</span>  去重后的文档个数: <span class="subst">&#123;<span class="built_in">len</span>(unique_docs_list)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> unique_docs_list</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;子查询策略执行失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 回溯问题检索</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_retrieve_with_backtracking</span>(<span class="params">self, query, source_filter=<span class="literal">None</span></span>):</span><br><span class="line">        self.logger.info(<span class="string">&quot;使用 回溯问题检索 &quot;</span>)</span><br><span class="line">        <span class="comment"># todo: 处理方式：先生成一个提示词，再调用大模型，对这个问题生成一个简化的问题，然后对简化问题进行检索</span></span><br><span class="line">        <span class="comment"># 生成一个回溯问题的提示词模版，用于生成提示词</span></span><br><span class="line">        backtracking_prompt_template = RAGPrompts.backtracking_prompt()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 调用大模型，生成简化的问题</span></span><br><span class="line">            simple_query = self.llm(backtracking_prompt_template.<span class="built_in">format</span>(query=query)).strip()</span><br><span class="line">            self.logger.info(<span class="string">f&quot;简化的问题: <span class="subst">&#123;simple_query&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 对简化的问题进行检索</span></span><br><span class="line">            <span class="keyword">return</span> self.vector_store.hybrid_search_with_rerank(query=simple_query,</span><br><span class="line">                                                               top_k=conf.RETRIEVAL_K,</span><br><span class="line">                                                               source_filter=source_filter)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;回溯问题策略执行失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 初始化大模型对象，这个对象后续的使用方式是 llm(prompt)，所以需要找一个能执行提示词的对象</span></span><br><span class="line">    llm = StrategySelector().call_dashscope</span><br><span class="line">    rag_system = RAGSystem(llm)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># query = &quot;什么是机器学习？&quot;  # 通用知识</span></span><br><span class="line">    <span class="comment"># query = &quot;AI课程都学什么？&quot;  # 假设问题检索</span></span><br><span class="line">    <span class="comment"># query = &quot;AI就业课中自然语言处理项目1和自然语言处理项目2有什么区别？&quot;  # 子查询检索</span></span><br><span class="line">    query = <span class="string">&quot;我是学文科的，我叫张三，大专毕业，可以报名AI课程吗&quot;</span>  <span class="comment"># 回溯问题检索</span></span><br><span class="line">    <span class="comment"># query = &quot;AI课程中有大模型语言基础知识吗？&quot;  # 直接检索</span></span><br><span class="line">    answer = rag_system.generate_answer(query, source_filter=<span class="string">&quot;ai&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;answer--&gt;<span class="subst">&#123;answer&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="4-完整流程的整合【实现】"><a href="#4-完整流程的整合【实现】" class="headerlink" title="4 完整流程的整合【实现】"></a>4 完整流程的整合【实现】</h2><h3 id="4-1-从查询到回答的流程"><a href="#4-1-从查询到回答的流程" class="headerlink" title="4.1 从查询到回答的流程"></a>4.1 从查询到回答的流程</h3><ol>
<li><p><strong>查询分类</strong>：</p>
<ul>
<li><code>QueryClassifier</code>分类查询，决定是否需要检索。</li>
</ul>
</li>
<li><p><strong>策略选择</strong>：</p>
<ul>
<li><code>StrategySelector</code>根据查询选择最佳检索策略。</li>
</ul>
</li>
<li><p><strong>文档检索</strong>：</p>
<ul>
<li>根据策略调用<code>VectorStore</code>的混合检索，获取相关文档。</li>
</ul>
</li>
<li><p><strong>生成回答</strong>：</p>
<ul>
<li><p>使用<code>RAGPrompts</code>的模板，结合上下文调用大语言模型生成答案。</p>
</li>
<li><p>返回最终答案，并记录日志。</p>
</li>
</ul>
</li>
</ol>
<h3 id="4-2-代码示例"><a href="#4-2-代码示例" class="headerlink" title="4.2 代码示例"></a>4.2 代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 初始化大模型对象，这个对象后续的使用方式是 llm(prompt)，所以需要找一个能执行提示词的对象</span></span><br><span class="line">    llm = StrategySelector().call_dashscope</span><br><span class="line">    rag_system = RAGSystem(llm)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># query = &quot;什么是机器学习？&quot;  # 通用知识</span></span><br><span class="line">    <span class="comment"># query = &quot;AI课程都学什么？&quot;  # 假设问题检索</span></span><br><span class="line">    <span class="comment"># query = &quot;AI就业课中自然语言处理项目1和自然语言处理项目2有什么区别？&quot;  # 子查询检索</span></span><br><span class="line">    query = <span class="string">&quot;我是学文科的，我叫张三，大专毕业，可以报名AI课程吗&quot;</span>  <span class="comment"># 回溯问题检索</span></span><br><span class="line">    <span class="comment"># query = &quot;AI课程中有大模型语言基础知识吗？&quot;  # 直接检索</span></span><br><span class="line">    answer = rag_system.generate_answer(query, source_filter=<span class="string">&quot;ai&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;answer--&gt;<span class="subst">&#123;answer&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h1 id="七、RAG系统运行"><a href="#七、RAG系统运行" class="headerlink" title="七、RAG系统运行"></a>七、RAG系统运行</h1><h2 id="1-系统运行入口【实现】"><a href="#1-系统运行入口【实现】" class="headerlink" title="1 系统运行入口【实现】"></a>1 系统运行入口【实现】</h2><h3 id="1-1-功能概述-2"><a href="#1-1-功能概述-2" class="headerlink" title="1.1 功能概述"></a>1.1 功能概述</h3><p>main.py是EduRAG系统的运行入口，提供三种运行模式：</p>
<ul>
<li><strong>数据处理模式</strong>：加载并向量化文档，构建向量数据库，支持多学科目录处理。</li>
<li><strong>查询模式</strong>：通过命令行交互式回答用户查询，支持学科过滤。</li>
<li><strong>命令行模式</strong>：增加了环境变量加载、详细的错误处理、命令行参数支持和用户友好的提示。</li>
</ul>
<h3 id="1-2-实现细节-2"><a href="#1-2-实现细节-2" class="headerlink" title="1.2 实现细节"></a>1.2 实现细节</h3><ol>
<li><strong>环境变量加载</strong>：<ul>
<li>使用<code>Config</code>文件，确保API密钥等配置从环境变量读取。</li>
</ul>
</li>
<li><strong>LLM客户端初始化</strong>：<ul>
<li>增强错误处理，若初始化失败，在查询模式下退出，数据处理模式可继续。</li>
<li>定义<code>call_dashscope</code>函数，封装DashScope API调用，包含详细异常处理。</li>
</ul>
</li>
<li><strong>VectorStore初始化</strong>：<ul>
<li>使用显式参数初始化，确保配置可控，若失败则终止程序。</li>
</ul>
</li>
<li><strong>数据处理模式</strong>：<ul>
<li>遍历<code>VALID_SOURCES</code>，处理每个学科目录，记录处理的文档块数量。</li>
<li>支持自定义分块参数（如<code>PARENT_CHUNK_SIZE</code>）。</li>
</ul>
</li>
<li><strong>交互查询模式</strong>：<ul>
<li>显示支持的学科类别，提供输入提示。</li>
<li>校验<code>source_filter</code>，若无效则提示并忽略。</li>
<li>输出格式化答案，增强用户体验。</li>
</ul>
</li>
<li><strong>命令行参数</strong>：<ul>
<li>使用<code>argparse</code>支持<code>--data-processing</code>和<code>--data-dir</code>，提高灵活性。</li>
</ul>
</li>
</ol>
<h3 id="1-3-完整代码"><a href="#1-3-完整代码" class="headerlink" title="1.3 完整代码"></a>1.3 完整代码</h3><p>代码位置：integrated_qa_system&#x2F;rag_qa&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">base_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(base_dir, <span class="string">&#x27;../..&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI <span class="comment"># 使用 OpenAI 接口</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.document_processor <span class="keyword">import</span> process_documents</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.rag_system <span class="keyword">import</span> RAGSystem</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.vector_store <span class="keyword">import</span> VectorStore</span><br><span class="line"></span><br><span class="line"><span class="comment"># todo: 1.环境变量加载</span></span><br><span class="line">conf = Config()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">query_mode=<span class="literal">True</span>, directory_path=<span class="string">&quot;data&quot;</span></span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param query_mode: True代表是交互式查询模型，False代表数据处理模式</span></span><br><span class="line"><span class="string">    :param directory_path: 数据文件夹的路径</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># todo: 2.1 LLM客户端初始化</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client = OpenAI(api_key=conf.DASHSCOPE_API_KEY,</span><br><span class="line">                        base_url=conf.DASHSCOPE_BASE_URL)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;初始化 OpenAI 客户端失败 (请检查 API Key 和 Base URL): <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 如果客户端初始化失败，可能无法继续，取决于模式</span></span><br><span class="line">        <span class="keyword">if</span> query_mode:  <span class="comment"># 查询模式下必须要有 LLM</span></span><br><span class="line">            logger.error(<span class="string">&quot;错误：无法初始化语言模型客户端，无法进入查询模式。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 数据处理模式可能不需要 LLM，可以继续，但最好记录错误</span></span><br><span class="line">        client = <span class="literal">None</span>  <span class="comment"># 标记客户端不可用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># todo: 2.2 定义LLM调用函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call_dashscope</span>(<span class="params">prompt</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> client:  <span class="comment"># 检查客户端是否可用</span></span><br><span class="line">            logger.error(<span class="string">&quot;LLM 客户端未初始化，无法调用 call_dashscope&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;错误: LLM客户端不可用&quot;</span></span><br><span class="line">        <span class="comment"># 调用 DashScope API</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 创建聊天完成请求</span></span><br><span class="line">            completion = client.chat.completions.create(</span><br><span class="line">                model=conf.LLM_MODEL,</span><br><span class="line">                messages=[</span><br><span class="line">                    &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一个有用的助手。&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;,</span><br><span class="line">                ],</span><br><span class="line">                temperature=<span class="number">0.1</span></span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 返回完成结果</span></span><br><span class="line">            <span class="keyword">if</span> completion.choices <span class="keyword">and</span> completion.choices[<span class="number">0</span>].message:</span><br><span class="line">                <span class="keyword">return</span> completion.choices[<span class="number">0</span>].message.content</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.error(<span class="string">&quot;LLM API 调用返回无效响应或空消息&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;错误: LLM返回无效响应&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 记录 API 调用失败</span></span><br><span class="line">            logger.error(<span class="string">f&quot;DashScope API 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 默认返回直接检索</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;错误: 调用LLM失败 - <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据不同模式执行不同的操作</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> query_mode:</span><br><span class="line">        <span class="comment"># todo: 3.初始化 VectorStore</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            vector_store = VectorStore(</span><br><span class="line">                collection_name=conf.MILVUS_COLLECTION_NAME,</span><br><span class="line">                host=conf.MILVUS_HOST,</span><br><span class="line">                port=conf.MILVUS_PORT,</span><br><span class="line">                database=conf.MILVUS_DATABASE_NAME,</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;初始化 VectorStore 失败 (请检查 Milvus 连接配置): <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># todo: 4.数据处理模式</span></span><br><span class="line">        logger.info(<span class="string">&quot;进入数据处理模式...&quot;</span>)</span><br><span class="line">        total_chunks_added = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> source_dir <span class="keyword">in</span> conf.VALID_SOURCES:</span><br><span class="line">            dir_path = os.path.join(os.path.join(base_dir, directory_path), <span class="string">f&quot;<span class="subst">&#123;source_dir&#125;</span>_data&quot;</span>)</span><br><span class="line">            <span class="comment"># print(f&quot;处理目录：&#123;dir_path&#125;&quot;)</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(dir_path):</span><br><span class="line">                logger.info(<span class="string">f&quot;开始处理目录: <span class="subst">&#123;dir_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    chunks = process_documents(</span><br><span class="line">                        dir_path,</span><br><span class="line">                        conf.PARENT_CHUNK_SIZE,</span><br><span class="line">                        conf.CHILD_CHUNK_SIZE,</span><br><span class="line">                        conf.PARENT_OVERLAP,</span><br><span class="line">                        conf.CHILD_OVERLAP</span><br><span class="line">                    )</span><br><span class="line">                    <span class="keyword">if</span> chunks:</span><br><span class="line">                        vector_store.add_documents(chunks)</span><br><span class="line">                        total_chunks_added += <span class="built_in">len</span>(chunks)</span><br><span class="line">                        logger.info(<span class="string">f&quot;成功处理目录 <span class="subst">&#123;dir_path&#125;</span>，添加了 <span class="subst">&#123;<span class="built_in">len</span>(chunks)&#125;</span> 个文档块&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logger.info(<span class="string">f&quot;目录 <span class="subst">&#123;dir_path&#125;</span> 未发现有效文档或处理结果为空&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f&quot;处理目录 <span class="subst">&#123;dir_path&#125;</span> 时出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(<span class="string">f&quot;目录 <span class="subst">&#123;dir_path&#125;</span> 不存在，跳过处理&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># todo: 5.交互式查询模式</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> client:  <span class="comment"># 再次检查 LLM 客户端是否必须且可用</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;错误：查询模式需要语言模型客户端，但初始化失败。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        logger.info(<span class="string">&quot;进入交互式查询模式...&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            rag_system = RAGSystem(llm=call_dashscope)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;初始化 RAGSystem 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;错误：无法初始化 RAG 系统，无法进入查询模式。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        valid_sources = conf.VALID_SOURCES</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n欢迎使用 EduRAG 交互式查询系统！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;支持的学科类别：<span class="subst">&#123;valid_sources&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;输入您的问题，或输入 &#x27;exit&#x27; 退出。&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            query = <span class="built_in">input</span>(<span class="string">&quot;\n请输入您的问题：&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> query.lower() ` <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">                logger.info(<span class="string">&quot;用户退出查询模式&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;再见！&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            source_filter_input = <span class="built_in">input</span>(<span class="string">f&quot;请输入学科类别 (<span class="subst">&#123;<span class="string">&#x27;/&#x27;</span>.join(valid_sources)&#125;</span>) (直接回车默认不过滤)：&quot;</span>).strip()</span><br><span class="line">            source_filter = <span class="literal">None</span> <span class="comment"># 默认不过滤</span></span><br><span class="line">            <span class="keyword">if</span> source_filter_input:</span><br><span class="line">                <span class="keyword">if</span> source_filter_input <span class="keyword">in</span> valid_sources:</span><br><span class="line">                    source_filter = source_filter_input</span><br><span class="line">                    logger.info(<span class="string">f&quot;用户选择了学科过滤: <span class="subst">&#123;source_filter&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logger.warning(<span class="string">f&quot;无效的学科类别 &#x27;<span class="subst">&#123;source_filter_input&#125;</span>&#x27;，将不过滤&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;提示：输入的学科 &#x27;<span class="subst">&#123;source_filter_input&#125;</span>&#x27; 无效，将不过滤。&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;正在生成答案，请稍候...&quot;</span>)</span><br><span class="line">                answer = rag_system.generate_answer(query, source_filter=source_filter)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;问题: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;回答: <span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;处理查询 &#x27;<span class="subst">&#123;query&#125;</span>&#x27; 时失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;抱歉，处理您的问题时遇到了错误，请稍后重试或联系管理员。\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 数据处理模式</span></span><br><span class="line">    <span class="comment"># main(query_mode=False)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 交互式查询模式</span></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-RAG系统运行【实现】"><a href="#2-RAG系统运行【实现】" class="headerlink" title="2 RAG系统运行【实现】"></a>2 RAG系统运行【实现】</h2><p><strong>命令行运行（main.py）</strong>：</p>
<ul>
<li><strong>python代码</strong>：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 或者通过命令行参数控制</span></span><br><span class="line">    <span class="keyword">import</span> argparse</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;EduRAG 系统主入口&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--data-processing&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;运行模式：默认为查询模式，设置后为数据处理模式。&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--data-dir&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;data&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;数据文件夹路径，传相对路径即可，默认为 data&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    main(query_mode=(<span class="keyword">not</span> args.data_processing), directory_path=args.data_dir)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>数据处理</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python main.py --data-processing --data-dir data</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>查询模式</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python main.py</span><br></pre></td></tr></table></figure>

<h1 id="P06-RAG系统评估"><a href="#P06-RAG系统评估" class="headerlink" title="P06-RAG系统评估"></a>P06-RAG系统评估</h1><h2 id="1-评估数据集构造【掌握】"><a href="#1-评估数据集构造【掌握】" class="headerlink" title="1 评估数据集构造【掌握】"></a>1 评估数据集构造【掌握】</h2><p>流程如下：</p>
<ul>
<li>使用大模型生成测试样本，具体来说是<strong>使用Milvus中存储好的分块文档（子块内容），基于这些文档逆向生成问题和答案</strong> ，这些数据构成了评估系统的基础。</li>
<li>使用大模型对测试样本进行质量审核，确保数据具备清晰性和可检索性。</li>
<li>使用RAG系统对测试样本进行处理，记录检索文档和最终答案，连同问题和真实答案，构造评估数据集，用于评估系统。</li>
<li>使用大模型或评估框架对RAG系统性能进行量化评估。</li>
</ul>
<p>评估数据集格式：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[</span></span><br><span class="line">  <span class="attr">&#123;</span></span><br><span class="line">    <span class="attr">&quot;question&quot;</span>: <span class="string">&quot;人工智能就业课的课程版本是什么？&quot;,</span></span><br><span class="line">    <span class="attr">&quot;context&quot;</span>: <span class="string">[&quot;人工智能学科全新升级——人工智能开发V6.0课程。&quot;],</span></span><br><span class="line">    <span class="attr">&quot;answer&quot;</span>: <span class="string">&quot;人工智能就业课的课程版本是V6.0。&quot;,</span></span><br><span class="line">    <span class="attr">&quot;ground_truth&quot;</span>: <span class="string">&quot;V6.0&quot;</span></span><br><span class="line">  <span class="attr">&#125;,</span></span><br><span class="line">  <span class="attr">&#123;</span></span><br><span class="line">    <span class="attr">&quot;question&quot;</span>: <span class="string">&quot;课程的一句话概括是什么？&quot;,</span></span><br><span class="line">    <span class="attr">&quot;context&quot;</span>: <span class="string">[&quot;解锁「大模型」 新技能成就「高薪AI」人才&quot;],</span></span><br><span class="line">    <span class="attr">&quot;answer&quot;</span>: <span class="string">&quot;课程的一句话概括是：解锁「大模型」新技能成就「高薪AI」人才。&quot;,</span></span><br><span class="line">    <span class="attr">&quot;ground_truth&quot;</span>: <span class="string">&quot;解锁「大模型」新技能成就「高薪AI」人才。&quot;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">]</span></span><br></pre></td></tr></table></figure>



<h2 id="2-RAGAS评估框架【理解】"><a href="#2-RAGAS评估框架【理解】" class="headerlink" title="2 RAGAS评估框架【理解】"></a>2 RAGAS评估框架【理解】</h2><p>RAGAS (Retrieval Augmented Generation Assessment) 我们一般称为 Automated Evaluation of Retrieval Augmented Generation，即检索增强生成的自动评估。Ragas是一个大模型评测框架，可以评估检索增强生成（RAG）的效果，帮助分析模型的输出，了解模型在给定任务上的表现。Github地址:  <a target="_blank" rel="noopener" href="https://github.com/explodinggradients/ragas">https://github.com/explodinggradients/ragas</a></p>
<h2 id="3-评估指标【理解】"><a href="#3-评估指标【理解】" class="headerlink" title="3 评估指标【理解】"></a>3 评估指标【理解】</h2><h3 id="3-1-上下文相关性-context-precision"><a href="#3-1-上下文相关性-context-precision" class="headerlink" title="3.1 上下文相关性 (context precision)"></a>3.1 上下文相关性 (context precision)</h3><ul>
<li><p>作用：指的是检索到的上下文应该只包含回答问题所需的信息，这个指标旨在惩罚包含冗余信息的情况。</p>
</li>
<li><p>比率越高，表示检索到的上下文与问题的相关性越强。</p>
</li>
<li><p>实现方式：</p>
<ul>
<li><p>为了估算上下文的相关性，我们用 LLM 从上下文 C(q) 中抽取对回答问题 q 至关重要的句子 S。提取的prompt如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">请从提供的&#123;上下文&#125;中提取可能有助于回答以下&#123;问题&#125;的相关句子。</span></span><br><span class="line"><span class="attr">如果没有找到相关句子，或者你认为问题无法从给定上下文中得到回答，</span></span><br><span class="line"><span class="attr">则返回短语“信息不足”。</span></span><br><span class="line"><span class="attr">在提取候选句子时，你不得更改给定上下文中的句子。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，在RAGAS中，通过下面的公式计算相关性：</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251019134634503.png" alt="image-20251019134634503"></p>
<hr>
<h3 id="3-2-上下文召回率-context-recall"><a href="#3-2-上下文召回率-context-recall" class="headerlink" title="3.2 上下文召回率 (context recall)"></a>3.2 上下文召回率 (context recall)</h3><ul>
<li><p>作用：衡量检索到的上下文(contexts)是否足够覆盖真实答案（ground_truths）。</p>
</li>
<li><p>该指标通过问题、标注答案和检索到的上下文计算，分数范围在0到1之间，得分越高表示性能更好。</p>
</li>
<li><p>要从真实答案中估计上下文召回率，需要分析真实答案中的每个事实（claim），以确定它是否可以从检索到的上下文中推理出来。理想情况下，真实答案中的所有事实都应该能从检索到的上下文中推出。</p>
</li>
<li><p>实现方式：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">假设真实答案（Reference</span> <span class="string">Answer）为：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">真实答案：</span></span><br><span class="line"><span class="attr">“2010年世界杯的冠军是西班牙。”</span></span><br><span class="line"><span class="attr">“西班牙在决赛中以1-0击败了荷兰。”</span></span><br><span class="line"></span><br><span class="line"><span class="attr">RAG检索到的上下文（Retrieved</span> <span class="string">Context）为：</span></span><br><span class="line"><span class="attr">“西班牙在2010年世界杯的决赛中击败了荷兰。”</span></span><br><span class="line"><span class="attr">“2010年世界杯的冠军是西班牙，西班牙队首次赢得世界杯。”</span></span><br><span class="line"></span><br><span class="line"><span class="attr">步骤具体实施：</span></span><br><span class="line"><span class="attr">事实1：</span> <span class="string">&quot;2010年世界杯的冠军是西班牙。&quot;</span></span><br><span class="line"><span class="attr">输入给GPT-3.5：检索到的上下文</span> <span class="string">+ 事实1。</span></span><br><span class="line"><span class="attr">GPT-3.5检查上下文是否包含“2010年世界杯的冠军是西班牙”。</span></span><br><span class="line"><span class="attr">结果：GPT-3.5发现上下文包含该信息，因此该事实“召回”。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">事实2：</span> <span class="string">&quot;西班牙在决赛中以1-0击败了荷兰。&quot;</span></span><br><span class="line"><span class="attr">输入给GPT-3.5：检索到的上下文</span> <span class="string">+ 事实2。</span></span><br><span class="line"><span class="attr">GPT-3.5检查上下文是否包含“西班牙在决赛中以1-0击败了荷兰”。</span></span><br><span class="line"><span class="attr">结果：GPT-3.5确认上下文中提到西班牙击败了荷兰，但未提到具体的比分1-0，因此该事实“未召回”。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">计算召回率：</span></span><br><span class="line"><span class="attr">总事实数：2（事实1和事实2）。</span></span><br><span class="line"><span class="attr">被召回的事实数：1（事实1被召回，事实2未召回）。</span></span><br><span class="line"><span class="attr">Context Recall</span> =<span class="string">0.5</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>公式：</p>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/9-7-4.png" alt="image-20250106163757095"></p>
<ul>
<li>分子：GT claims that can be attributed to context，表示在真实答案（GT）中的事实中，有多少是可以归因于检索到的上下文的。换句话说，这些事实在检索到的上下文中找到了支持或依据。</li>
<li>分母：Number of claims in GT 表示真实答案中事实的总数量。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-3-忠实度（faithfulness）"><a href="#3-3-忠实度（faithfulness）" class="headerlink" title="3.3 忠实度（faithfulness）"></a>3.3 忠实度（faithfulness）</h3><ul>
<li><p>作用：判断生成的回答是否与检索到的证据一致，是否“编造”了信息。</p>
</li>
<li><p>如果分数低，它表明 LLM 的回应没有遵循检索到的知识，提供幻觉性答案的可能性增加。</p>
</li>
<li><p>实现方式：</p>
<ul>
<li><p>为了估计忠实度，我们首先使用 LLM 提取一组陈述，S(a(q))。方法是使用以下提示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">给定一个问题和答案，从给定答案的每个句子中创建一个或多个陈述。</span></span><br><span class="line"><span class="attr">问题：[问题]</span></span><br><span class="line"><span class="attr">答案：[生成的答案]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成 S(a(q)) 后，LLM 判断每个陈述 si 是否可以从 c(q) 中推断出来。这个验证步骤使用以下提示进行：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">考虑给定的上下文和以下陈述，然后确定它们是否由上下文中的信息支持。在得出结论（是/否）之前，为每个陈述提供简要解释。在最后以给定格式为每个陈述提供最终结论。不要偏离指定的格式。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">陈述：[陈述</span> <span class="string">1]</span></span><br><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="attr">陈述：[陈述</span> <span class="string">n]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最终的忠实度分数，F，计算为 F&#x3D;|V|&#x2F;|S|，其中 |V| 表示 LLM 支持的陈述数量，|S| 表示陈述的总数。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-4-答案相关性（answer-relevancy）"><a href="#3-4-答案相关性（answer-relevancy）" class="headerlink" title="3.4 答案相关性（answer relevancy）"></a>3.4 答案相关性（answer relevancy）</h3><ul>
<li><p>作用：衡量生成的回答是否真正回答了用户问题，是否切题。分数越高，相关性越好。</p>
</li>
<li><p>实现方式：</p>
<ul>
<li><p>为了估计答案的相关性，我们提示 LLM 根据给定的答案生成 n 个潜在问题 qi，如下所示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">为给定答案生成n个问题。</span></span><br><span class="line"><span class="attr">答案：[生成的答案]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>具体步骤：</p>
</li>
</ul>
<blockquote>
<ol>
<li>对给定答案，提示大型语言模型（LLM）生成基于该答案可能的 n个问题 qi。</li>
<li>使用embedding模型获取所有问题的嵌入表示。</li>
<li>对于每个生成的问题 <em>qi</em>，计算它与原始问题 q 之间的相似度 sim(q,qi)。这里的相似度是通过计算对应嵌入之间的余弦相似度来得到的。</li>
<li>答案相关性得分（平均相似度） A<em>R</em> 通过以下公式计算：</li>
</ol>
</blockquote>
</li>
</ul>
<p><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251019134650527.png" alt="image-20251019134650527"></p>
<p><strong>简单总结如下：</strong></p>
<table>
<thead>
<tr>
<th>指标</th>
<th>阶段</th>
<th>作用</th>
<th>谁和谁</th>
<th>通俗理解</th>
</tr>
</thead>
<tbody><tr>
<td>上下文相关性</td>
<td>检索</td>
<td>衡量检索到的文档是否全和原始问题有关系</td>
<td>文档与问题</td>
<td>开卷资料带没带对</td>
</tr>
<tr>
<td>上下文召回率</td>
<td>检索</td>
<td>衡量真实答案能否全从检索到的文档中推出来</td>
<td>真实答案与文档</td>
<td>开卷资料带没带全</td>
</tr>
<tr>
<td>忠实度</td>
<td>生成</td>
<td>衡量模型生成的答案能否全从检索到的文档中推出来</td>
<td>模型答案与文档</td>
<td>是不是根据开卷资料里回答的</td>
</tr>
<tr>
<td>答案相关性</td>
<td>生成</td>
<td>衡量模型生成的答案是否和原始问题有关系</td>
<td>模型答案与问题</td>
<td>有没有跑题（是否抄对资料）</td>
</tr>
</tbody></table>
<h2 id="4-RAGAS-评估脚本【实现】"><a href="#4-RAGAS-评估脚本【实现】" class="headerlink" title="4 RAGAS 评估脚本【实现】"></a>4 RAGAS 评估脚本【实现】</h2><h3 id="1-1-功能描述"><a href="#1-1-功能描述" class="headerlink" title="1.1 功能描述"></a>1.1 功能描述</h3><p><code>ragas_evaluate.py</code>脚本用于评估RAG系统的性能，具体功能包括：</p>
<ol>
<li><strong>数据集加载</strong>：从JSON文件加载包含问题、答案、上下文和真实答案的评估数据集。</li>
<li><strong>数据格式转换</strong>：将JSON数据转换为RAGAS要求的<code>Dataset</code>格式。</li>
<li><strong>环境配置</strong>：使用LangChain的OpenAI模型和嵌入模型初始化RAGAS评估环境。</li>
<li><strong>评估执行</strong>：计算四个核心指标：<ul>
<li><strong>Context Precision（上下文相关性）</strong>：上下文是否与问题相关。</li>
<li><strong>Context Recall（上下文召回率）</strong>：上下文是否包含所有必要信息。</li>
<li><strong>Faithfulness（忠实度）</strong>：答案是否忠于上下文。</li>
<li><strong>Answer Relevancy（答案相关性）</strong>：答案与问题的匹配程度。</li>
</ul>
</li>
<li><strong>结果输出与保存</strong>：打印评估结果并保存为CSV文件，便于后续分析。</li>
</ol>
<hr>
<h3 id="1-2-代码实现"><a href="#1-2-代码实现" class="headerlink" title="1.2 代码实现"></a>1.2 代码实现</h3><p>位置：integrated_qa_system&#x2F;rag_qa&#x2F;rag_evaluate&#x2F;ragas_evaluate.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="comment"># 导入datasets库的Dataset类，用于构建RAGAS所需的数据格式</span></span><br><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="comment"># 导入langchain_openai的聊天模型，用于评估时的推理</span></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="comment"># 导入langchain_community的嵌入模型，用于评估时的语义计算</span></span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> DashScopeEmbeddings</span><br><span class="line"><span class="comment"># 导入ragas库的evaluate函数，用于执行RAG评估</span></span><br><span class="line"><span class="keyword">from</span> ragas <span class="keyword">import</span> evaluate</span><br><span class="line"><span class="comment"># 导入ragas的评估指标，包括忠实度、答案相关性、上下文相关性和上下文召回率</span></span><br><span class="line"><span class="keyword">from</span> ragas.metrics <span class="keyword">import</span> (</span><br><span class="line">    faithfulness,</span><br><span class="line">    answer_relevancy,</span><br><span class="line">    context_precision,</span><br><span class="line">    context_recall</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line">conf = Config()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.加载评估数据集</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../data/rag_evaluate_data.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = json.load(f)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;data--&gt;<span class="subst">&#123;<span class="built_in">len</span>(data), data[:<span class="number">1</span>]&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.转换成RAGAS所需数据格式</span></span><br><span class="line"><span class="comment"># 创建字典eval_data，将JSON数据转换为RAGAS要求的字段格式</span></span><br><span class="line">eval_data = &#123;</span><br><span class="line">    <span class="comment"># 提取每个数据条目的question字段，组成问题列表</span></span><br><span class="line">    <span class="string">&quot;question&quot;</span>: [item[<span class="string">&quot;question&quot;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> data],</span><br><span class="line">    <span class="comment"># 提取每个数据条目的answer字段，组成答案列表</span></span><br><span class="line">    <span class="string">&quot;answer&quot;</span>: [item[<span class="string">&quot;answer&quot;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> data],</span><br><span class="line">    <span class="comment"># 提取每个数据条目的context字段，组成上下文列表（每个context为列表）</span></span><br><span class="line">    <span class="string">&quot;contexts&quot;</span>: [item[<span class="string">&quot;context&quot;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> data],</span><br><span class="line">    <span class="comment"># 提取每个数据条目的ground_truth字段，组成真实答案列表</span></span><br><span class="line">    <span class="string">&quot;ground_truth&quot;</span>: [item[<span class="string">&quot;ground_truth&quot;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> data]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用Dataset.from_dict将字典转换为RAGAS所需的Dataset对象</span></span><br><span class="line">dataset = Dataset.from_dict(eval_data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;dataset--&gt;<span class="subst">&#123;<span class="built_in">len</span>(dataset), dataset[:<span class="number">1</span>]&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.配置大模型和嵌入模型</span></span><br><span class="line"><span class="comment"># 创建一个ChatOpenAI对象</span></span><br><span class="line">llm = ChatOpenAI(base_url=conf.DASHSCOPE_BASE_URL,</span><br><span class="line">                 model=conf.LLM_MODEL,</span><br><span class="line">                 api_key=conf.DASHSCOPE_API_KEY,</span><br><span class="line">                 temperature=<span class="number">0.1</span>)</span><br><span class="line"><span class="comment"># 创建一个 Embeddings对象</span></span><br><span class="line">embed = DashScopeEmbeddings(dashscope_api_key=conf.DASHSCOPE_API_KEY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.执行评估</span></span><br><span class="line"><span class="comment"># 调用evaluate函数，传入数据集、评估指标、LLM模型和嵌入模型</span></span><br><span class="line">result = evaluate(</span><br><span class="line">    <span class="comment"># 传入转换好的Dataset对象</span></span><br><span class="line">    dataset=dataset,</span><br><span class="line">    <span class="comment"># 指定使用的评估指标列表</span></span><br><span class="line">    metrics=[</span><br><span class="line">        faithfulness,  <span class="comment"># 忠实度：答案是否基于上下文</span></span><br><span class="line">        answer_relevancy,  <span class="comment"># 答案相关性：答案与问题的匹配度</span></span><br><span class="line">        context_precision,  <span class="comment"># 上下文相关性：上下文是否仅包含相关信息</span></span><br><span class="line">        context_recall  <span class="comment"># 上下文召回率：上下文是否包含所有必要信息</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="comment"># 传入配置好的LLM模型</span></span><br><span class="line">    llm=llm,</span><br><span class="line">    <span class="comment"># 传入配置好的嵌入模型</span></span><br><span class="line">    embeddings=embed</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.输出并保存结果</span></span><br><span class="line"><span class="comment"># 打印评估结果</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;RAGAS评估结果：\n<span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># 将评估结果转换为pandas DataFrame，便于保存</span></span><br><span class="line">result_df = pd.DataFrame([result])</span><br><span class="line"><span class="comment"># 将DataFrame保存为CSV文件，文件名为ragas_evaluation_results.csv，不保存索引</span></span><br><span class="line">result_df.to_csv(<span class="string">&quot;ragas_evaluation_results.csv&quot;</span>, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<h3 id="1-3-指标范围"><a href="#1-3-指标范围" class="headerlink" title="1.3 指标范围"></a>1.3 指标范围</h3><p><strong>一般企业中这几个指标的范围</strong>：</p>
<p>context_recall：84%左右</p>
<p>context_precision：79%左右</p>
<p>faithfulness：92%左右</p>
<p>answer_relevancy：90%左右</p>
<p>注意：</p>
<ul>
<li>context_precision和context_recall是负相关的。一般会牺牲context_precision来换取高的context_recall。</li>
<li>answer_relevancy是答案相关性，不等同于答案正确率，答案正确率由context_recall、faithfulness、answer_relevancy共同决定。答案正确率大概在75%。</li>
<li>faithfulness和answer_relevancy也是有负相关性的，只是没有那么强烈。在选择时，如果上下文检索的特别好，就可以提高faithfulness；如果上下文检索的不好，就提高answer_relevancy。</li>
</ul>
<h1 id="P07-融合MySQL的RAG系统"><a href="#P07-融合MySQL的RAG系统" class="headerlink" title="P07-融合MySQL的RAG系统"></a>P07-融合MySQL的RAG系统</h1><h1 id="一、融合-FAQ-和知识库查询"><a href="#一、融合-FAQ-和知识库查询" class="headerlink" title="一、融合 FAQ 和知识库查询"></a>一、融合 FAQ 和知识库查询</h1><h2 id="1-查询流程图【掌握】"><a href="#1-查询流程图【掌握】" class="headerlink" title="1 查询流程图【掌握】"></a>1 查询流程图【掌握】</h2><p>以下是智能问答系统的查询流程图，展示从用户输入到答案输出的完整逻辑。</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251020234126722.png" alt="image-20251020234126722" style="zoom:70%;" />

<h2 id="2-流程说明【掌握】"><a href="#2-流程说明【掌握】" class="headerlink" title="2 流程说明【掌握】"></a>2 流程说明【掌握】</h2><ol>
<li><strong>输入处理</strong>：用户提供查询 (<code>query</code>) 和可选的学科过滤 (<code>source_filter</code>)。</li>
<li><strong>BM25 搜索</strong>：使用 BM25 算法在 MySQL 知识库中搜索，设置相似度阈值 0.85。</li>
<li><strong>答案判断</strong>：<ul>
<li>若找到可靠答案（相似度 &gt; 0.85），直接返回。</li>
<li>若无可靠答案且需要 RAG，调用 RAG 系统生成答案。</li>
<li>若无可靠答案且不需要 RAG，则返回默认答案。</li>
</ul>
</li>
<li><strong>日志记录</strong>：记录查询内容、答案和处理时间，便于调试和性能分析。</li>
<li><strong>输出</strong>：将答案返回给用户。</li>
</ol>
<h2 id="3-代码介绍【理解】"><a href="#3-代码介绍【理解】" class="headerlink" title="3 代码介绍【理解】"></a>3 代码介绍【理解】</h2><p>以下是 <code>old_main.py</code> 的完整代码，包含详细注释，逐行解析功能与实现逻辑。</p>
<h3 id="3-1-导入必备的工具包"><a href="#3-1-导入必备的工具包" class="headerlink" title="3.1 导入必备的工具包"></a>3.1 导入必备的工具包</h3><p>位置：integrated_qa_system&#x2F;old_main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.cache.redis_client <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.db.mysql_client <span class="keyword">import</span> MySQLClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.retrieval.bm25_search <span class="keyword">import</span> BM25Search</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.rag_system <span class="keyword">import</span> RAGSystem</span><br><span class="line"></span><br><span class="line">conf = Config()</span><br></pre></td></tr></table></figure>

<h3 id="3-2-系统初始化"><a href="#3-2-系统初始化" class="headerlink" title="3.2 系统初始化"></a>3.2 系统初始化</h3><ul>
<li>(<code>__init__</code>) 初始化方法</li>
<li><strong>功能</strong>：初始化日志、配置、数据库客户端、搜索模块、向量存储和 RAG 系统。</li>
<li><strong>关键点</strong>：通过 Config 管理 API 密钥和模型参数，异常处理确保 OpenAI 客户端初始化成功。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IntegratedQASystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 1)日志对象</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 2)创建 BM25搜索模块 对象</span></span><br><span class="line">        self.mysql_client = MySQLClient()</span><br><span class="line">        self.redis_client = RedisClient()</span><br><span class="line">        self.bm25_search = BM25Search(self.mysql_client, self.redis_client)</span><br><span class="line">        <span class="comment"># 3)创建RAG System对象</span></span><br><span class="line">        <span class="comment"># 创建openai客户端</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client = OpenAI(api_key=conf.DASHSCOPE_API_KEY,</span><br><span class="line">                                 base_url=conf.DASHSCOPE_BASE_URL)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&#x27;创建OpenAI客户端失败！<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="comment"># 创建RAG System对象</span></span><br><span class="line">        self.rag_system = RAGSystem(llm=self.call_dashscope)</span><br></pre></td></tr></table></figure>



<h3 id="3-3-调用-DashScope-API"><a href="#3-3-调用-DashScope-API" class="headerlink" title="3.3 调用 DashScope API"></a>3.3 调用 DashScope API</h3><ul>
<li>(<code>call_dashscope</code>) 方法</li>
<li><strong>功能</strong>：通过 OpenAI 客户端调用 DashScope API，基于用户提示生成答案。</li>
<li><strong>关键点</strong>：设置系统提示为“你是一个有用的助手”，异常处理捕获 API 调用失败，返回错误信息。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">call_dashscope</span>(<span class="params">self, prompt</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.client:  <span class="comment"># 检查客户端是否可用</span></span><br><span class="line">        logger.error(<span class="string">&quot;LLM 客户端未初始化，无法调用 call_dashscope&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;错误: LLM客户端不可用&quot;</span></span><br><span class="line">    <span class="comment"># 调用 DashScope API</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建聊天完成请求</span></span><br><span class="line">        completion = self.client.chat.completions.create(</span><br><span class="line">            model=conf.LLM_MODEL,</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一个有用的助手。&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;,</span><br><span class="line">            ],</span><br><span class="line">            temperature=<span class="number">0.1</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 返回完成结果</span></span><br><span class="line">        <span class="keyword">if</span> completion.choices <span class="keyword">and</span> completion.choices[<span class="number">0</span>].message:</span><br><span class="line">            <span class="keyword">return</span> completion.choices[<span class="number">0</span>].message.content</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.logger.error(<span class="string">&quot;DashScope API 调用返回无效响应或空消息&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;错误：LLM返回无效响应或空消息&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录 API 调用失败</span></span><br><span class="line">        self.logger.error(<span class="string">f&quot;DashScope API 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;错误：LLM API 调用失败 <span class="subst">&#123;e&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-查询处理"><a href="#3-4-查询处理" class="headerlink" title="3.4 查询处理"></a>3.4 查询处理</h3><ul>
<li>(<code>query</code>) 方法</li>
<li><strong>功能</strong>：处理用户查询，优先通过 BM25 搜索 MySQL，若无可靠答案则使用 RAG 系统。</li>
<li><strong>关键点</strong>：设置 BM25 相似度阈值 0.85，记录查询和处理时间，支持学科过滤。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self, query, source_filter=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 定义查询方法，处理用户输入的查询</span></span><br><span class="line">    start_time = time.time()  <span class="comment"># 记录查询开始时间</span></span><br><span class="line">    <span class="comment"># 记录查询信息到日志</span></span><br><span class="line">    self.logger.info(<span class="string">f&quot;处理查询: &#x27;<span class="subst">&#123;query&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    <span class="comment"># 执行 BM25 搜索，获取答案和是否需要 RAG 的标志</span></span><br><span class="line">    answer, need_rag = self.bm25_search.search(query, threshold=<span class="number">0.85</span>)</span><br><span class="line">    <span class="keyword">if</span> answer:</span><br><span class="line">        <span class="comment"># 如果找到可靠答案，记录答案到日志</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;找到缓存的可靠答案: <span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 计算处理时间</span></span><br><span class="line">        processing_time = time.time() - start_time</span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询处理耗时 <span class="subst">&#123;processing_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回 MySQL 答案</span></span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line">    <span class="keyword">elif</span> need_rag:</span><br><span class="line">        self.logger.info(<span class="string">&quot;未找到缓存的可靠答案，需要 RAG 搜索&quot;</span>)</span><br><span class="line">        <span class="comment"># 执行 RAG 搜索，获取答案</span></span><br><span class="line">        answer = self.rag_system.generate_answer(query, source_filter)</span><br><span class="line">        <span class="comment"># 记录 RAG 答案到日志</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;RAG 答案: <span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 计算处理时间</span></span><br><span class="line">        processing_time = time.time() - start_time</span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询处理耗时 <span class="subst">&#123;processing_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回 RAG 答案</span></span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.logger.info(<span class="string">&quot;未找到缓存的答案，且不需要 RAG 搜索&quot;</span>)</span><br><span class="line">        <span class="comment"># 创建一个默认答案</span></span><br><span class="line">        answer = <span class="string">f&quot;抱歉，处理您的问题时出错。请联系人工客服：<span class="subst">&#123;conf.CUSTOMER_SERVICE_PHONE&#125;</span>&quot;</span></span><br><span class="line">        <span class="comment"># 计算处理时间</span></span><br><span class="line">        processing_time = time.time() - start_time</span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询处理耗时 <span class="subst">&#123;processing_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回默认答案</span></span><br><span class="line">        <span class="keyword">return</span> answer</span><br></pre></td></tr></table></figure>



<h3 id="3-5-命令行交互"><a href="#3-5-命令行交互" class="headerlink" title="3.5 命令行交互"></a>3.5 命令行交互</h3><ul>
<li>(<code>main</code>) 函数</li>
<li><strong>功能</strong>：提供交互式命令行界面，接受用户查询和学科过滤，显示答案。</li>
<li><strong>关键点</strong>：验证学科过滤的有效性，异常处理和资源清理确保系统健壮。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 定义主函数，提供命令行交互界面</span></span><br><span class="line">    qa_system = IntegratedQASystem()  <span class="comment"># 初始化问答系统</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 打印欢迎信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n欢迎使用集成问答系统！&quot;</span>)</span><br><span class="line">        <span class="comment"># 打印支持的学科类别</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;支持的来源: <span class="subst">&#123;conf.VALID_SOURCES&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 提示用户输入查询或退出</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;输入查询进行问答，输入 &#x27;exit&#x27; 退出。&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 获取用户输入的查询</span></span><br><span class="line">            query = <span class="built_in">input</span>(<span class="string">&quot;\n输入查询: &quot;</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> query.lower() ` <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">                <span class="comment"># 如果用户输入 exit，记录退出日志</span></span><br><span class="line">                logger.info(<span class="string">&quot;退出系统&quot;</span>)</span><br><span class="line">                <span class="comment"># 打印退出信息</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;再见！&quot;</span>)</span><br><span class="line">                <span class="comment"># 退出循环</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># 获取用户输入的学科过滤</span></span><br><span class="line">            source_filter = <span class="built_in">input</span>(<span class="string">f&quot;输入来源过滤 (<span class="subst">&#123;<span class="string">&#x27;/&#x27;</span>.join(conf.VALID_SOURCES)&#125;</span>) (按 Enter 跳过): &quot;</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> source_filter <span class="keyword">and</span> source_filter <span class="keyword">not</span> <span class="keyword">in</span> conf.VALID_SOURCES:</span><br><span class="line">                <span class="comment"># 如果学科过滤无效，记录警告日志</span></span><br><span class="line">                logger.warning(<span class="string">f&quot;无效来源 &#x27;<span class="subst">&#123;source_filter&#125;</span>&#x27;，忽略过滤&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;无效来源 &#x27;<span class="subst">&#123;source_filter&#125;</span>&#x27;，继续无过滤。&quot;</span>)</span><br><span class="line">                source_filter = <span class="literal">None</span></span><br><span class="line">            <span class="comment"># 执行查询，获取答案</span></span><br><span class="line">            answer = qa_system.query(query, source_filter)</span><br><span class="line">            <span class="comment"># 打印答案</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n答案: <span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录系统错误日志</span></span><br><span class="line">        logger.error(<span class="string">f&quot;系统错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 打印错误信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 无论是否发生错误，关闭 MySQL 连接</span></span><br><span class="line">        qa_system.mysql_client.close()</span><br></pre></td></tr></table></figure>



<h1 id="二、融合-FAQ-和知识库查询-优化版"><a href="#二、融合-FAQ-和知识库查询-优化版" class="headerlink" title="二、融合 FAQ 和知识库查询-优化版"></a>二、融合 FAQ 和知识库查询-优化版</h1><p><code>new_main.py</code> 是对 <code>old_main.py</code> 的优化版本，新增了对话历史管理和流式输出功能，增强了交互性和实时性。</p>
<h2 id="1-查询流程图【掌握】-1"><a href="#1-查询流程图【掌握】-1" class="headerlink" title="1 查询流程图【掌握】"></a>1 查询流程图【掌握】</h2><p>以下是优化后的智能问答系统查询流程图，展示用户输入到答案输出的处理逻辑，包括对话历史和流式输出。</p>
<img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20251021005323672.png" alt="image-20251021005323672" style="zoom:80%;" />



<h2 id="2-流程说明【掌握】-1"><a href="#2-流程说明【掌握】-1" class="headerlink" title="2 流程说明【掌握】"></a>2 流程说明【掌握】</h2><ol>
<li><strong>输入处理</strong>：用户提供查询 (<code>query</code>)、会话 ID (<code>session_id</code>) 和可选的学科过滤 (<code>source_filter</code>)。</li>
<li><strong>会话管理</strong>：若提供 <code>session_id</code>，从 MySQL 获取最近 5 轮对话历史；否则生成新的 UUID。</li>
<li><strong>BM25 搜索</strong>：使用 BM25 算法搜索 MySQL 知识库，设置相似度阈值 0.85。</li>
<li><strong>答案判断</strong>：<ul>
<li>若找到可靠答案（相似度 &gt; 0.85），一次性返回。</li>
<li>若无可靠答案且需要 RAG，调用 RAG 系统以流式方式生成答案。</li>
<li>若无可靠答案且不需要 RAG，则一次性返回默认答案。</li>
</ul>
</li>
<li><strong>历史更新</strong>：将查询和答案存入 MySQL 的 <code>conversations</code> 表。</li>
<li><strong>输出</strong>：通过流式输出（RAG）或一次性输出（MySQL）返回答案，并展示对话历史。</li>
</ol>
<h2 id="3-代码介绍"><a href="#3-代码介绍" class="headerlink" title="3 代码介绍"></a>3 代码介绍</h2><p>以下是 <code>new_main.py</code> 的完整代码，包含逐行注释，详细解析功能与实现逻辑。</p>
<h3 id="3-1-导入必备的工具包【实现】"><a href="#3-1-导入必备的工具包【实现】" class="headerlink" title="3.1 导入必备的工具包【实现】"></a>3.1 导入必备的工具包【实现】</h3><p>位置：integrated_qa_system&#x2F;new_main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">import</span> uuid  <span class="comment"># 用于生成seesion id</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.config <span class="keyword">import</span> Config</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.base.create_logger <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.cache.redis_client <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.db.mysql_client <span class="keyword">import</span> MySQLClient</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.mysql_qa.retrieval.bm25_search <span class="keyword">import</span> BM25Search</span><br><span class="line"><span class="keyword">from</span> integrated_qa_system.rag_qa.core.rag_system <span class="keyword">import</span> RAGSystem</span><br><span class="line"></span><br><span class="line">conf = Config()</span><br></pre></td></tr></table></figure>



<h3 id="3-2-系统初始化【实现】"><a href="#3-2-系统初始化【实现】" class="headerlink" title="3.2 系统初始化【实现】"></a>3.2 系统初始化【实现】</h3><ul>
<li>(<code>__init__</code>) 初始化方法</li>
<li><strong>功能</strong>：初始化日志、配置、数据库客户端、搜索模块、向量存储、RAG 系统和对话历史表。</li>
<li><strong>关键点</strong>：通过 Config 管理 API 密钥和模型参数，异常处理确保 OpenAI 客户端初始化成功。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IntegratedQASystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 1)日志对象</span></span><br><span class="line">        self.logger = logger</span><br><span class="line">        <span class="comment"># 2)创建 BM25搜索模块 对象</span></span><br><span class="line">        self.mysql_client = MySQLClient()</span><br><span class="line">        self.redis_client = RedisClient()</span><br><span class="line">        self.bm25_search = BM25Search(self.mysql_client, self.redis_client)</span><br><span class="line">        <span class="comment"># 3)创建RAG System对象</span></span><br><span class="line">        <span class="comment"># 创建openai客户端</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client = OpenAI(api_key=conf.DASHSCOPE_API_KEY,</span><br><span class="line">                                 base_url=conf.DASHSCOPE_BASE_URL)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&#x27;创建OpenAI客户端失败！<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="comment"># 创建 RAG System 对象</span></span><br><span class="line">        self.rag_system = RAGSystem(llm=self.call_dashscope)</span><br></pre></td></tr></table></figure>



<h3 id="3-3-调用-DashScope-API【实现】"><a href="#3-3-调用-DashScope-API【实现】" class="headerlink" title="3.3 调用 DashScope API【实现】"></a>3.3 调用 DashScope API【实现】</h3><p>除了原有的call_dashscope外，还需要有call_dashscope_stream方法。</p>
<ul>
<li>(<code>call_dashscope_stream</code>) 方法</li>
<li><strong>功能</strong>：通过 OpenAI 客户端调用 DashScope API，支持流式输出，逐 token 返回答案。</li>
<li><strong>关键点</strong>：启用 <code>stream=True</code> 实现流式输出，异常处理捕获 API 调用失败，支持前端实时显示。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">call_dashscope</span>(<span class="params">self, prompt</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.client:  <span class="comment"># 检查客户端是否可用</span></span><br><span class="line">        logger.error(<span class="string">&quot;LLM 客户端未初始化，无法调用 call_dashscope&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;错误: LLM客户端不可用&quot;</span></span><br><span class="line">    <span class="comment"># 调用 DashScope API</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建聊天完成请求</span></span><br><span class="line">        completion = self.client.chat.completions.create(</span><br><span class="line">            model=conf.LLM_MODEL,</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一个有用的助手。&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;,</span><br><span class="line">            ],</span><br><span class="line">            temperature=<span class="number">0.1</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 返回完成结果</span></span><br><span class="line">        <span class="keyword">if</span> completion.choices <span class="keyword">and</span> completion.choices[<span class="number">0</span>].message:</span><br><span class="line">            <span class="keyword">return</span> completion.choices[<span class="number">0</span>].message.content</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.logger.error(<span class="string">&quot;DashScope API 调用返回无效响应或空消息&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;错误：LLM返回无效响应或空消息&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录 API 调用失败</span></span><br><span class="line">        self.logger.error(<span class="string">f&quot;DashScope API 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;错误：LLM API 调用失败 <span class="subst">&#123;e&#125;</span>&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_dashscope_stream</span>(<span class="params">self, prompt</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.client:  <span class="comment"># 检查客户端是否可用</span></span><br><span class="line">        logger.error(<span class="string">&quot;LLM 客户端未初始化，无法调用 call_dashscope&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;错误: LLM客户端不可用&quot;</span></span><br><span class="line">    <span class="comment"># 调用 DashScope API</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建聊天完成请求</span></span><br><span class="line">        completion = self.client.chat.completions.create(</span><br><span class="line">            model=conf.LLM_MODEL,</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一个有用的助手。&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;,</span><br><span class="line">            ],</span><br><span class="line">            temperature=<span class="number">0.1</span>,</span><br><span class="line">            stream=<span class="literal">True</span>,  <span class="comment"># 启用流式输出</span></span><br><span class="line">            timeout=<span class="number">30</span>  <span class="comment"># 设置超时时间为30秒</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 遍历流式输出的每个chunk</span></span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> completion:</span><br><span class="line">            <span class="keyword">if</span> chunk.choices <span class="keyword">and</span> chunk.choices[<span class="number">0</span>].delta.content:</span><br><span class="line">                <span class="comment"># 使用yield语句返回每个chunk的content部分</span></span><br><span class="line">                <span class="keyword">yield</span> chunk.choices[<span class="number">0</span>].delta.content</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录 API 调用失败</span></span><br><span class="line">        self.logger.error(<span class="string">f&quot;DashScope API 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">f&#x27;错误：LLM API 调用失败 <span class="subst">&#123;e&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-4-对话历史表初始化【实现】"><a href="#3-4-对话历史表初始化【实现】" class="headerlink" title="3.4 对话历史表初始化【实现】"></a>3.4 对话历史表初始化【实现】</h3><ul>
<li><strong>功能</strong>：在 MySQL 中创建 <code>conversations</code> 表，存储会话 ID、问题、答案和时间戳，添加索引优化查询。然后向MySQL中插入一些测试数据，方便代码开发。</li>
</ul>
<p>以下代码在MySQL中运行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 初始化MySQL中的conversations表，用于存储对话历史</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> subjects_kg.conversations </span><br><span class="line">(</span><br><span class="line">	id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">	session_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	question TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	answer TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="type">timestamp</span> DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	INDEX idx_session_id (session_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 准备测试数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> subjects_kg.conversations <span class="keyword">values</span> </span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;什么是AI&#x27;</span>, <span class="string">&#x27;人工智能&#x27;</span>, now()), </span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;什么是java&#x27;</span>, <span class="string">&#x27;编程语言&#x27;</span>, now()<span class="operator">+</span><span class="number">1</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;什么是ops&#x27;</span>, <span class="string">&#x27;运维&#x27;</span>, now()<span class="operator">+</span><span class="number">2</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;什么是test&#x27;</span>, <span class="string">&#x27;测试&#x27;</span>, now()<span class="operator">+</span><span class="number">3</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;什么是bigdata&#x27;</span>, <span class="string">&#x27;大数据&#x27;</span>, now()<span class="operator">+</span><span class="number">4</span>),</span><br><span class="line">(<span class="number">6</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;什么是fe&#x27;</span>, <span class="string">&#x27;前端&#x27;</span>, now()<span class="operator">+</span><span class="number">5</span>);</span><br></pre></td></tr></table></figure>



<h3 id="3-5-获取最近对话历史【实现】"><a href="#3-5-获取最近对话历史【实现】" class="headerlink" title="3.5 获取最近对话历史【实现】"></a>3.5 获取最近对话历史【实现】</h3><ul>
<li>(<code>get_session_history</code>) 方法</li>
<li><strong>功能</strong>：从 MySQL 的 <code>conversations</code> 表获取指定 <code>session_id</code> 的最近 5 轮对话历史。</li>
<li><strong>关键点</strong>：使用参数化查询防止 SQL 注入，返回结果按时间正序，异常处理确保健壮性。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_session_history</span>(<span class="params">self, session_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取最近5轮对话历史&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 执行 SQL 查询，获取最近 5 轮对话</span></span><br><span class="line">        self.mysql_client.cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            SELECT question, answer</span></span><br><span class="line"><span class="string">            FROM subjects_kg.conversations</span></span><br><span class="line"><span class="string">            WHERE session_id = %s</span></span><br><span class="line"><span class="string">            ORDER BY timestamp DESC</span></span><br><span class="line"><span class="string">            LIMIT %s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>, (session_id, <span class="number">5</span>))</span><br><span class="line">        <span class="comment"># 获取查询结果</span></span><br><span class="line">        history = self.mysql_client.cursor.fetchall()</span><br><span class="line">        <span class="comment"># print(f&#x27;history--&gt;&#123;history&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># 将结果处理成字典的列表</span></span><br><span class="line">        history_list = [&#123;<span class="string">&quot;question&quot;</span>: q, <span class="string">&quot;answer&quot;</span>: a&#125; <span class="keyword">for</span> q, a <span class="keyword">in</span> history]</span><br><span class="line">        <span class="comment"># 将结果进行反转，按照时间正序排序</span></span><br><span class="line">        <span class="keyword">return</span> history_list[::-<span class="number">1</span>]</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录查询失败的错误日志</span></span><br><span class="line">        self.logger.error(<span class="string">f&quot;获取对话历史失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回空列表</span></span><br><span class="line">        <span class="keyword">return</span> []</span><br></pre></td></tr></table></figure>



<h3 id="3-6-更新会话历史【实现】"><a href="#3-6-更新会话历史【实现】" class="headerlink" title="3.6 更新会话历史【实现】"></a>3.6 更新会话历史【实现】</h3><ul>
<li>(<code>update_session_history</code>) 方法</li>
<li><strong>功能</strong>：将新问题和答案插入 <code>conversations</code> 表。</li>
<li><strong>关键点</strong>：使用事务确保数据一致性，日志记录操作结果。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_session_history</span>(<span class="params">self, session_id: <span class="built_in">str</span>, question: <span class="built_in">str</span>, answer: <span class="built_in">str</span></span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;更新会话历史到MySQL&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 插入新的对话记录</span></span><br><span class="line">        self.mysql_client.cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            INSERT INTO subjects_kg.conversations (session_id, question, answer, timestamp)</span></span><br><span class="line"><span class="string">            VALUES (%s, %s, %s, NOW())</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>, (session_id, question, answer))</span><br><span class="line">        <span class="comment"># 提交事务</span></span><br><span class="line">        self.mysql_client.connection.commit()</span><br><span class="line">        <span class="comment"># 记录更新成功的日志</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;会话 <span class="subst">&#123;session_id&#125;</span> 历史更新成功&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录意外错误的日志</span></span><br><span class="line">        self.logger.error(<span class="string">f&quot;更新会话历史意外错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 回滚事务</span></span><br><span class="line">        self.mysql_client.connection.rollback()</span><br><span class="line">        <span class="comment"># 抛出异常</span></span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>



<h3 id="3-7-清除会话历史【实现】"><a href="#3-7-清除会话历史【实现】" class="headerlink" title="3.7 清除会话历史【实现】"></a>3.7 清除会话历史【实现】</h3><ul>
<li>(<code>clear_session_history</code>) 方法</li>
<li><strong>功能</strong>：删除指定 <code>session_id</code> 的所有对话历史记录。</li>
<li><strong>关键点</strong>：使用参数化查询防止 SQL 注入，事务管理确保操作原子性，返回布尔值表示成功或失败。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">clear_session_history</span>(<span class="params">self, session_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;清除指定会话历史&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 删除指定 session_id 的所有对话记录</span></span><br><span class="line">        self.mysql_client.cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            DELETE FROM subjects_kg.conversations</span></span><br><span class="line"><span class="string">            WHERE session_id = %s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>, (session_id,))</span><br><span class="line">        <span class="comment"># 提交事务</span></span><br><span class="line">        self.mysql_client.connection.commit()</span><br><span class="line">        <span class="comment"># 记录清除成功的日志</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;会话 <span class="subst">&#123;session_id&#125;</span> 历史已清除&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回 True 表示成功</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录清除失败的错误日志</span></span><br><span class="line">        self.logger.error(<span class="string">f&quot;清除会话历史失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 回滚事务</span></span><br><span class="line">        self.mysql_client.connection.rollback()</span><br><span class="line">        <span class="comment"># 返回 False 表示失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h3 id="3-8-查询处理【掌握】"><a href="#3-8-查询处理【掌握】" class="headerlink" title="3.8 查询处理【掌握】"></a>3.8 查询处理【掌握】</h3><ul>
<li>(<code>query</code>) 方法</li>
<li><strong>功能</strong>：处理用户查询，优先使用 BM25 搜索 MySQL，若无可靠答案则回退到 RAG，支持流式输出和对话历史。</li>
<li><strong>关键点</strong>：通过生成器逐 token 返回 RAG 答案，记录处理时间，支持学科过滤。</li>
<li><strong>注意</strong>：1.需要RAGPrompts中添加rag_prompt_with_history方法；2.需要RAGSystem中添加generate_answer_stream方法。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self, query, source_filter=<span class="literal">None</span>, session_id=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 定义查询方法，处理用户输入的查询</span></span><br><span class="line">    start_time = time.time()  <span class="comment"># 记录查询开始时间</span></span><br><span class="line">    <span class="comment"># 记录查询信息到日志</span></span><br><span class="line">    self.logger.info(<span class="string">f&quot;处理查询: &#x27;<span class="subst">&#123;query&#125;</span>&#x27;, 会话ID: <span class="subst">&#123;session_id&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 执行 BM25 搜索，获取答案和是否需要 RAG 的标志</span></span><br><span class="line">    answer, need_rag = self.bm25_search.search(query, threshold=<span class="number">0.85</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 获取历史对话信息，用于大模型生成</span></span><br><span class="line">    history_list = self.get_session_history(session_id) <span class="keyword">if</span> session_id <span class="keyword">else</span> []</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> answer:</span><br><span class="line">        <span class="comment"># 如果找到可靠答案，记录答案到日志</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;找到缓存的可靠答案: <span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 将问答对保存到 MySQL 中</span></span><br><span class="line">        <span class="keyword">if</span> session_id:</span><br><span class="line">            self.update_session_history(session_id, query, answer)</span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 计算处理时间</span></span><br><span class="line">        processing_time = time.time() - start_time</span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询处理耗时 <span class="subst">&#123;processing_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回 MySQL 答案, 返回True表示为完整答案</span></span><br><span class="line">        <span class="keyword">yield</span> answer, <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> need_rag:</span><br><span class="line">        self.logger.info(<span class="string">&quot;未找到缓存的可靠答案，需要 RAG 搜索&quot;</span>)</span><br><span class="line">  </span><br><span class="line">        llm_answer = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># 执行 RAG 搜索，获取答案</span></span><br><span class="line">        <span class="keyword">for</span> token <span class="keyword">in</span> self.rag_system.generate_answer_stream(query, llm_stream=self.call_dashscope_stream, source_filter=source_filter, history=history_list):</span><br><span class="line">            <span class="comment"># 答案累积</span></span><br><span class="line">            llm_answer += token</span><br><span class="line">            <span class="comment"># 逐 token进行返回， 返回False表示为非完整答案</span></span><br><span class="line">            <span class="keyword">yield</span> token, <span class="literal">False</span></span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 记录 RAG 答案到日志</span></span><br><span class="line">        self.logger.info(<span class="string">f&quot;RAG 答案: <span class="subst">&#123;llm_answer&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 将问答对保存到 MySQL 中</span></span><br><span class="line">        <span class="keyword">if</span> session_id:</span><br><span class="line">            self.update_session_history(session_id, query, llm_answer)</span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 计算处理时间</span></span><br><span class="line">        processing_time = time.time() - start_time</span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询处理耗时 <span class="subst">&#123;processing_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回 RAG 答案</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&#x27;&#x27;</span>, <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.logger.info(<span class="string">&quot;未找到缓存的答案，且不需要 RAG 搜索&quot;</span>)</span><br><span class="line">        <span class="comment"># 创建一个默认答案</span></span><br><span class="line">        answer = <span class="string">f&quot;抱歉，处理您的问题时出错。请联系人工客服：<span class="subst">&#123;conf.CUSTOMER_SERVICE_PHONE&#125;</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 将问答对保存到 MySQL 中</span></span><br><span class="line">        <span class="keyword">if</span> session_id:</span><br><span class="line">            self.update_session_history(session_id, query, answer)</span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 计算处理时间</span></span><br><span class="line">        processing_time = time.time() - start_time</span><br><span class="line">        self.logger.info(<span class="string">f&quot;查询处理耗时 <span class="subst">&#123;processing_time:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回默认答案</span></span><br><span class="line">        <span class="keyword">yield</span> answer, <span class="literal">True</span></span><br></pre></td></tr></table></figure>



<ul>
<li>需要RAGPrompts中添加rag_prompt_with_history方法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义带有对话历史的 RAG 提示模板</span></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rag_prompt_with_history</span>():</span><br><span class="line">    <span class="keyword">return</span> PromptTemplate(</span><br><span class="line">        template=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    你是一个智能助手，负责帮助用户回答问题。请按照以下步骤处理：</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    1. **分析问题和上下文**：</span></span><br><span class="line"><span class="string">       - 如果提供了上下文，请基于上下文回答。</span></span><br><span class="line"><span class="string">       - 如果没有上下文，请直接根据你的知识回答和对话历史来回答。</span></span><br><span class="line"><span class="string">       - 如果答案来源于检索到的文档，请在回答中明确说明，例如：“根据提供的文档，……”。</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    2. **评估对话历史**：</span></span><br><span class="line"><span class="string">       - 检查对话历史是否与当前问题相关（例如，是否涉及相同的话题、实体或问题背景）。</span></span><br><span class="line"><span class="string">       - 如果对话历史与问题相关，请结合历史信息生成更准确的回答。</span></span><br><span class="line"><span class="string">       - 如果对话历史无关（例如，仅包含问候或不相关的内容），忽略历史，仅基于上下文和问题回答。</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    3. **生成回答**：</span></span><br><span class="line"><span class="string">       - 如果没有提供上下文，也没有提供对话历史，则调用自身知识来回答。</span></span><br><span class="line"><span class="string">       - 如果没有提供上下文，只提供了对话历史，但是对话历史又和当前问题无关，则调用自身知识来回答。</span></span><br><span class="line"><span class="string">       - 如果提供了上下文，但仍然不足以回答问题，并且对话历史中也没有答案，则回复：“信息不足，无法回答，请联系人工客服，电话：&#123;phone&#125;。”</span></span><br><span class="line"><span class="string">       - 提供清晰、准确的回答，避免无关信息。</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    **上下文**: &#x27;&#x27;&#x27;&#123;context&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    **对话历史**: &#x27;&#x27;&#x27;&#123;history&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    **问题**: &#x27;&#x27;&#x27;&#123;question&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    **回答**:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>,</span><br><span class="line">        input_variables=[<span class="string">&quot;context&quot;</span>, <span class="string">&quot;history&quot;</span>, <span class="string">&quot;question&quot;</span>, <span class="string">&quot;phone&quot;</span>],</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>



<ul>
<li>需要RAGSystem中添加generate_answer_stream方法：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义方法，流式生成答案，并且考虑历史对话</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_answer_stream</span>(<span class="params">self, query, llm_stream, source_filter=<span class="literal">None</span>, history=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 记录查询开始时间</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    self.logger.info(<span class="string">f&quot;开始处理查询: &#x27;<span class="subst">&#123;query&#125;</span>&#x27;, 学科过滤: <span class="subst">&#123;source_filter&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># todo: 处理历史对话</span></span><br><span class="line">    <span class="keyword">if</span> history <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(history, <span class="built_in">list</span>):</span><br><span class="line">        self.logger.warning(<span class="string">f&quot;历史对话为空，将使用空历史对话&quot;</span>)</span><br><span class="line">        history_context = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        history_context = <span class="string">&#x27;\n&#x27;</span>.join([<span class="string">f&quot;Question:<span class="subst">&#123;qa[<span class="string">&#x27;question&#x27;</span>]&#125;</span>\nAnswer:<span class="subst">&#123;qa[<span class="string">&#x27;answer&#x27;</span>]&#125;</span>&quot;</span> <span class="keyword">for</span> qa <span class="keyword">in</span> history])</span><br><span class="line">        self.logger.info(<span class="string">f&quot;历史对话拼接完成，示例：<span class="subst">&#123;history_context[:<span class="number">50</span>]&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 1.调用查询分类器，得到查询类别</span></span><br><span class="line">    query_type = self.query_classifier.predict_category(query)</span><br><span class="line">    self.logger.info(<span class="string">f&quot;查询：<span class="subst">&#123;query&#125;</span>, 查询类别: <span class="subst">&#123;query_type&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 2.如果是通用知识，则直接调用 LLM</span></span><br><span class="line">    <span class="keyword">if</span> query_type ` <span class="string">&quot;通用知识&quot;</span>:</span><br><span class="line">        self.logger.info(<span class="string">&quot;查询为通用知识，直接调用 LLM&quot;</span>)</span><br><span class="line">        <span class="comment"># todo: 拼接提示词【带有历史对话的提示词模版】</span></span><br><span class="line">        prompt_input = RAGPrompts.rag_prompt_with_history().<span class="built_in">format</span>(question=query, context=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                                                                   phone=conf.CUSTOMER_SERVICE_PHONE,</span><br><span class="line">                                                                   history=history_context)</span><br><span class="line">        <span class="comment"># todo: 调用大模型</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> token <span class="keyword">in</span> llm_stream(prompt_input):</span><br><span class="line">               <span class="keyword">yield</span>  token</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;LLM 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">yield</span> <span class="string">f&quot;抱歉，处理您的通用知识问题时出错。请联系人工客服：<span class="subst">&#123;conf.CUSTOMER_SERVICE_PHONE&#125;</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 记录查询结束时间</span></span><br><span class="line">        end_time = time.time()</span><br><span class="line">        self.logger.info(<span class="string">f&quot;通用知识 查询结束，耗时: <span class="subst">&#123;end_time - start_time&#125;</span>s&quot;</span>)</span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 分支结束</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 3.否则为专业咨询，进行RAG检索并生成答案</span></span><br><span class="line">    self.logger.info(<span class="string">&quot;查询为专业咨询，进行 RAG 检索&quot;</span>)</span><br><span class="line">    <span class="comment"># 3.1 进行策略选择</span></span><br><span class="line">    strategy = self.strategy_selector.select_strategy(query)</span><br><span class="line">    <span class="comment"># 3.2 基于不同的检索策略，进行不同的检索方式, 返回相似文档</span></span><br><span class="line">    ranked_chunks = self.retrieve_and_merge(query, source_filter, strategy)</span><br><span class="line">    <span class="comment"># 3.3 对文档进行拼接，然后构造提示词</span></span><br><span class="line">    <span class="comment"># 1）对文档进行拼接</span></span><br><span class="line">    <span class="keyword">if</span> ranked_chunks:</span><br><span class="line">        <span class="comment"># 对文档进行拼接</span></span><br><span class="line">        context = <span class="string">&#x27;\n\n&#x27;</span>.join([chunk.page_content <span class="keyword">for</span> chunk <span class="keyword">in</span> ranked_chunks])</span><br><span class="line">        self.logger.info(<span class="string">f&quot;文档拼接完成，共 <span class="subst">&#123;<span class="built_in">len</span>(ranked_chunks)&#125;</span> 个文档&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        context = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.logger.warning(<span class="string">f&quot;没有通过RAG检索到相似文档，context为空&quot;</span>)</span><br><span class="line">    <span class="comment"># todo: 2）构造提示词</span></span><br><span class="line">    prompt_input = RAGPrompts.rag_prompt_with_history().<span class="built_in">format</span>(question=query,</span><br><span class="line">                                                               context=context,</span><br><span class="line">                                                               phone=conf.CUSTOMER_SERVICE_PHONE,</span><br><span class="line">                                                               history=history_context)</span><br><span class="line">    self.logger.debug(<span class="string">f&quot;最终生成的提示词: <span class="subst">&#123;prompt_input&#125;</span>&quot;</span>)</span><br><span class="line">    self.logger.info(<span class="string">f&quot;检索耗时: <span class="subst">&#123;time.time() - start_time&#125;</span>s&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># todo: 3.4 调用大模型，生成答案</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> token <span class="keyword">in</span> llm_stream(prompt_input):</span><br><span class="line">            <span class="keyword">yield</span> token</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        self.logger.error(<span class="string">f&quot;LLM 调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">f&quot;抱歉，处理您的专业咨询问题时出错。请联系人工客服：<span class="subst">&#123;conf.CUSTOMER_SERVICE_PHONE&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># 3.5 记录查询结束时间，并返回答案</span></span><br><span class="line">    end_time = time.time()</span><br><span class="line">    self.logger.info(<span class="string">f&quot;专业咨询 查询结束，耗时: <span class="subst">&#123;end_time - start_time&#125;</span>s&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ ` <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    qa_system = IntegratedQASystem()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # 如果使用了流式输出，则需要使用for循环来迭代输出</span></span><br><span class="line">    <span class="comment"># for chunk in qa_system.call_dashscope_stream(&quot;什么是机器学习？&quot;):</span></span><br><span class="line">    <span class="comment">#     print(chunk, end=&quot;&quot;, flush=True)  # flush=True的效果就是输出立即显示，而不是等待缓冲区满再输出。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># # 测试 get_session_history</span></span><br><span class="line">    <span class="comment"># history_list  = qa_system.get_session_history(&#x27;a&#x27;)</span></span><br><span class="line">    <span class="comment"># print(f&#x27;history_list--&gt;&#123;history_list&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试 query方法</span></span><br><span class="line">    <span class="comment"># query = &#x27;lxml的tree报错怎么办&#x27;  # 有缓存的答案</span></span><br><span class="line">    <span class="comment"># query = &#x27;什么是机器学习？&#x27;  # 通用知识</span></span><br><span class="line">    query = <span class="string">&#x27;AI课程都学什么？&#x27;</span>  <span class="comment"># 专业咨询</span></span><br><span class="line">    <span class="keyword">for</span> anwer, is_complete <span class="keyword">in</span> qa_system.query(query, session_id=<span class="string">&#x27;a&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> anwer:</span><br><span class="line">            <span class="built_in">print</span>(anwer, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> is_complete:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>



<h3 id="3-9-命令行交互【实现】"><a href="#3-9-命令行交互【实现】" class="headerlink" title="3.9 命令行交互【实现】"></a>3.9 命令行交互【实现】</h3><ul>
<li>(<code>main</code>) 函数</li>
<li><strong>功能</strong>：提供交互式命令行界面，生成唯一会话 ID，接受用户查询和学科过滤，流式显示答案并展示对话历史。</li>
<li><strong>关键点</strong>：支持流式输出，验证学科过滤有效性，异常处理和资源清理确保系统健壮。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 定义主函数，提供命令行交互界面</span></span><br><span class="line">    qa_system = IntegratedQASystem()  <span class="comment"># 初始化问答系统</span></span><br><span class="line">    <span class="comment"># 生成唯一会话 ID</span></span><br><span class="line">    session_id = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 打印欢迎信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n欢迎使用集成问答系统！&quot;</span>)</span><br><span class="line">        <span class="comment"># 打印支持的学科类别</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;支持的来源: <span class="subst">&#123;conf.VALID_SOURCES&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 提示用户输入查询或退出</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;输入查询进行问答，输入 &#x27;exit&#x27; 退出。&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 获取用户输入的查询</span></span><br><span class="line">            query = <span class="built_in">input</span>(<span class="string">&quot;\n输入查询: &quot;</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> query.lower() ` <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">                <span class="comment"># 如果用户输入 exit，记录退出日志</span></span><br><span class="line">                logger.info(<span class="string">&quot;退出系统&quot;</span>)</span><br><span class="line">                <span class="comment"># 打印退出信息</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;再见！&quot;</span>)</span><br><span class="line">                <span class="comment"># 退出循环</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取用户输入的学科过滤</span></span><br><span class="line">            source_filter = <span class="built_in">input</span>(<span class="string">f&quot;输入来源过滤 (<span class="subst">&#123;<span class="string">&#x27;/&#x27;</span>.join(conf.VALID_SOURCES)&#125;</span>) (按 Enter 跳过): &quot;</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> source_filter <span class="keyword">and</span> source_filter <span class="keyword">not</span> <span class="keyword">in</span> conf.VALID_SOURCES:</span><br><span class="line">                <span class="comment"># 如果学科过滤无效，记录警告日志</span></span><br><span class="line">                logger.warning(<span class="string">f&quot;无效来源 &#x27;<span class="subst">&#123;source_filter&#125;</span>&#x27;，忽略过滤&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;无效来源 &#x27;<span class="subst">&#123;source_filter&#125;</span>&#x27;，继续无过滤。&quot;</span>)</span><br><span class="line">                source_filter = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 打印答案提示</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n答案: &quot;</span>, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># 初始化累积答案的字符串</span></span><br><span class="line">            answer = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="comment"># 迭代 query 方法的生成器</span></span><br><span class="line">            <span class="keyword">for</span> token, is_complete <span class="keyword">in</span> qa_system.query(query, source_filter=source_filter, session_id=session_id):</span><br><span class="line">                <span class="keyword">if</span> token:  <span class="comment"># 仅当 token 非空时</span></span><br><span class="line">                    <span class="comment"># 累积答案</span></span><br><span class="line">                    answer += token</span><br><span class="line">                    <span class="comment"># 打印</span></span><br><span class="line">                    <span class="built_in">print</span>(token, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> is_complete:</span><br><span class="line">                    <span class="comment"># 如果是完整答案或流结束，换行并退出循环</span></span><br><span class="line">                    <span class="built_in">print</span>()</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># 打印对话历史</span></span><br><span class="line">            history = qa_system.get_session_history(session_id)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n最近对话历史:&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> idx, entry <span class="keyword">in</span> <span class="built_in">enumerate</span>(history, <span class="number">1</span>):</span><br><span class="line">                <span class="comment"># 按顺序打印历史记录</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;idx&#125;</span>. 问: <span class="subst">&#123;entry[<span class="string">&#x27;question&#x27;</span>]&#125;</span>\n   答: <span class="subst">&#123;entry[<span class="string">&#x27;answer&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 记录系统错误日志</span></span><br><span class="line">        logger.error(<span class="string">f&quot;系统错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 打印错误信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># 无论是否发生错误，关闭 MySQL 连接</span></span><br><span class="line">        qa_system.mysql_client.close()</span><br></pre></td></tr></table></figure></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://liamjohnson-w.github.io">李俊泽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://liamjohnson-w.github.io/2025/10/21/RAG/">https://liamjohnson-w.github.io/2025/10/21/RAG/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/doc/">doc</a><a class="post-meta__tags" href="/tags/AI/">AI</a></div><div class="post_share"><div class="social-share" data-image="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen3.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/10/25/Agent/" title="Agent-Note"><img class="cover" src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/Pusheen1121.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Agent-Note</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/28/LLM_Base/" title="LLM大模型基础"><img class="cover" src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen112.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">LLM大模型基础</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2025/06/29/InterviewQuestions/" title="Jason Interview Note"><img class="cover" src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen121.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-29</div><div class="title">Jason Interview Note</div></div></a></div><div><a href="/2025/07/18/Project/" title="Jason Project Demo"><img class="cover" src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-18</div><div class="title">Jason Project Demo</div></div></a></div><div><a href="/2025/09/14/TrafficDefenceDetection/" title="TQ System"><img class="cover" src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen132.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-14</div><div class="title">TQ System</div></div></a></div><div><a href="/2024/05/01/2024.05.01/" title="Document"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-01</div><div class="title">Document</div></div></a></div><div><a href="/2025/10/25/Agent/" title="Agent-Note"><img class="cover" src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/Pusheen1121.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-25</div><div class="title">Agent-Note</div></div></a></div><div><a href="/2025/06/03/2025.06.03/" title="OLLAMA"><img class="cover" src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/image-20250603132906789.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-03</div><div class="title">OLLAMA</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/tx.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">李俊泽</div><div class="author-info__description">机器都在学习,你有什么理由不学习?</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">239</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">58</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/weiswift/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/weiswift" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1265019024@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">博客为本人搭建 Github托管 仅记录学习过程 不做引流 不做排名 不打广告！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#P01-RAG%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">P01_RAG系统项目介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D%E3%80%90%E4%BA%86%E8%A7%A3%E3%80%91"><span class="toc-number">1.1.</span> <span class="toc-text">1 背景介绍【了解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-RAG%E7%9B%B8%E5%85%B3%E4%BB%8B%E7%BB%8D%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">1.2.</span> <span class="toc-text">2 RAG相关介绍【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-RAG%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 RAG概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-RAG%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 RAG作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-RAG-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 RAG 的工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE%E8%A7%A3"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">2.3.1 工作流程图解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-RAG%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.3.2 RAG标准流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%A1%B9%E7%9B%AE%E6%B5%81%E7%A8%8B%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">1.3.</span> <span class="toc-text">3 项目流程【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">1.4.</span> <span class="toc-text">4 项目结构【实现】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">1.5.</span> <span class="toc-text">5 环境配置【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-python%E7%8E%AF%E5%A2%83"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 python环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 相关工具介绍</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LangChain"><span class="toc-number">2.</span> <span class="toc-text">LangChain</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%AE%80%E8%BF%B0%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">2.1.</span> <span class="toc-text">1 简述【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AFLangChain"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1 什么是LangChain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%B8%BB%E8%A6%81%E7%BB%84%E4%BB%B6"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 主要组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-LangChain%E6%A0%B8%E5%BF%83%E5%8C%85"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 LangChain核心包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Models%E3%80%90%E7%86%9F%E6%82%89%E3%80%91"><span class="toc-number">2.2.</span> <span class="toc-text">2 Models【熟悉】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-LLMs-%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1 LLMs (大语言模型)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Chat-Models-%E8%81%8A%E5%A4%A9%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2 Chat Models (聊天模型)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Embeddings-Models-%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B%EF%BC%89"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3 Embeddings Models(嵌入模型）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Prompts%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">2.3.</span> <span class="toc-text">3 Prompts【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%80%9A%E7%94%A8prompt"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 通用prompt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-chatprompts"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 chatprompts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Chains%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">2.4.</span> <span class="toc-text">4 Chains【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-chain"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1 chain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-LCEL"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2 LCEL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Output-parsers%E3%80%90%E4%BA%86%E8%A7%A3%E3%80%91"><span class="toc-number">2.5.</span> <span class="toc-text">5 Output parsers【了解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Memory%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">2.6.</span> <span class="toc-text">6 Memory【理解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Indexes%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">2.7.</span> <span class="toc-text">7 Indexes【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.7.1.</span> <span class="toc-text">7.1 文档加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E6%96%87%E6%A1%A3%E5%88%86%E5%89%B2%E5%99%A8"><span class="toc-number">2.7.2.</span> <span class="toc-text">7.2 文档分割器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-VectorStores"><span class="toc-number">2.7.3.</span> <span class="toc-text">7.3 VectorStores</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E6%A3%80%E7%B4%A2%E5%99%A8"><span class="toc-number">2.7.4.</span> <span class="toc-text">7.4 检索器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-1-LangChain%E4%B8%AD%E7%9A%84%E6%A3%80%E7%B4%A2%E5%99%A8%E5%AE%9A%E4%B9%89"><span class="toc-number">2.7.4.1.</span> <span class="toc-text">7.4.1 LangChain中的检索器定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-2-%E6%A3%80%E7%B4%A2%E5%99%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.7.4.2.</span> <span class="toc-text">7.4.2 检索器的工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-3-%E6%A3%80%E7%B4%A2%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.7.4.3.</span> <span class="toc-text">7.4.3 检索器类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-4-%E6%8B%93%E5%B1%95"><span class="toc-number">2.7.4.4.</span> <span class="toc-text">7.4.4 拓展</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Agents%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">2.8.</span> <span class="toc-text">8 Agents【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-Agent-%E6%A6%82%E5%BF%B5"><span class="toc-number">2.8.1.</span> <span class="toc-text">8.1 Agent 概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-Agent%E5%85%B3%E9%94%AE%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86"><span class="toc-number">2.8.2.</span> <span class="toc-text">8.2 Agent关键组成部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-langchain%E5%AE%9E%E7%8E%B0Agent"><span class="toc-number">2.8.3.</span> <span class="toc-text">8.3 langchain实现Agent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-langchain%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7"><span class="toc-number">2.8.4.</span> <span class="toc-text">8.4 langchain自定义工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-LangChain%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">2.9.</span> <span class="toc-text">9 LangChain使用场景【理解】</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Milvus%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.</span> <span class="toc-text">Milvus向量数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-Milvus-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9F%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">3.1.</span> <span class="toc-text">1 什么是 Milvus 向量数据库？【理解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">3.2.</span> <span class="toc-text">2 关键概念【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E9%9D%9E%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1 非结构化数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%B5%8C%E5%85%A5%E5%90%91%E9%87%8F"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2 嵌入向量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%90%91%E9%87%8F%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.3 向量相似度搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Collection-%E5%92%8C-Field"><span class="toc-number">3.2.4.</span> <span class="toc-text">2.4 Collection 和 Field</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-Milvus%EF%BC%9F%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">3.3.</span> <span class="toc-text">3 为什么选择 Milvus？【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E7%B4%A2%E5%BC%95%E5%92%8C%E5%BA%A6%E9%87%8F%EF%BC%9F%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">3.4.</span> <span class="toc-text">4 支持哪些索引和度量？【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.4.1.</span> <span class="toc-text">4.1 索引类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%9B%B8%E4%BC%BC%E5%BA%A6%E5%BA%A6%E9%87%8F"><span class="toc-number">3.4.2.</span> <span class="toc-text">4.2 相似度度量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Milvus%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E3%80%90%E7%86%9F%E6%82%89%E3%80%91"><span class="toc-number">3.5.</span> <span class="toc-text">5 Milvus数据库操作【熟悉】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E8%AE%BE%E7%BD%AE%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.5.1.</span> <span class="toc-text">5.1 设置向量数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Collections%E6%93%8D%E4%BD%9C"><span class="toc-number">3.5.2.</span> <span class="toc-text">5.2 Collections操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Entity%E5%AE%9E%E4%BD%93%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">3.5.3.</span> <span class="toc-text">5.3 Entity实体数据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A2%9E%E3%80%81%E5%88%A0%E3%80%81%E6%94%B9"><span class="toc-number">3.5.3.1.</span> <span class="toc-text">5.3.1 数据的增、删、改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-%E6%95%B0%E6%8D%AE%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.5.3.2.</span> <span class="toc-text">5.3.2 数据的查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%88%A0%E9%99%A4-Collections"><span class="toc-number">3.5.4.</span> <span class="toc-text">5.4 删除 Collections</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Python%E6%97%A5%E5%BF%97%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%BA%94%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">一、Python日志介绍与应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E6%A6%82%E8%BF%B0%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">4.1.</span> <span class="toc-text">1 日志记录概述【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%A4%BA%E4%BE%8B1%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">4.2.</span> <span class="toc-text">2 示例1：基础日志记录【实现】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%A4%BA%E4%BE%8B2%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">4.3.</span> <span class="toc-text">3 示例2：自定义日志格式【实现】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%A4%BA%E4%BE%8B3%EF%BC%9A%E5%B0%86%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%B0%E6%96%87%E4%BB%B6%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">4.4.</span> <span class="toc-text">4 示例3：将日志存储到文件【实现】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%A4%BA%E4%BE%8B4%EF%BC%9A%E5%90%8C%E6%97%B6%E8%BE%93%E5%87%BA%E5%88%B0%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%92%8C%E6%96%87%E4%BB%B6%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">4.5.</span> <span class="toc-text">5 示例4：同时输出到控制台和文件【实现】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">4.6.</span> <span class="toc-text">6 代码实现【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-number">4.6.1.</span> <span class="toc-text">6.1 整体结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">4.6.2.</span> <span class="toc-text">6.2 日志配置模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.6.3.</span> <span class="toc-text">6.2 主程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81BM25%E7%AE%97%E6%B3%95%E7%AE%80%E4%BB%8B%E4%B8%8E%E5%BA%94%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">二、BM25算法简介与应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-BM25%E7%AE%97%E6%B3%95%E6%A6%82%E8%BF%B0%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">5.1.</span> <span class="toc-text">1 BM25算法概述【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">5.2.</span> <span class="toc-text">2 简单示例【理解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">5.3.</span> <span class="toc-text">3 代码实现【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.1 整体结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%A3%80%E7%B4%A2%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.2.</span> <span class="toc-text">3.2 检索模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.3.3.</span> <span class="toc-text">3.3 主程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81Redis%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">三、Redis数据库简介与使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Redis-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E8%BF%B0%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">6.1.</span> <span class="toc-text">1 Redis 数据库概述【理解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">6.2.</span> <span class="toc-text">2 代码实现【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-number">6.2.1.</span> <span class="toc-text">2.1 整体结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.2.</span> <span class="toc-text">2.2 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Redis-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%9D%97"><span class="toc-number">6.2.3.</span> <span class="toc-text">2.3 Redis 客户端模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">6.2.4.</span> <span class="toc-text">2.4 主程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%9F%BA%E4%BA%8EMySQL%E7%9A%84FQA%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.</span> <span class="toc-text">四、基于MySQL的FQA问答系统实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-FQA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="toc-number">7.1.</span> <span class="toc-text">1 FQA系统概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%B3%BB%E7%BB%9F%E6%B5%81%E7%A8%8B%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.1 系统流程【掌握】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.1.2.</span> <span class="toc-text">1.2 项目结构【理解】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.</span> <span class="toc-text">2 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.2.1.</span> <span class="toc-text">2.1 配置文件【理解】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.2.2.</span> <span class="toc-text">2.2 配置管理【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">7.2.2.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.2.2.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">7.2.2.3.</span> <span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">7.2.3.</span> <span class="toc-text">2.3 日志记录【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-1"><span class="toc-number">7.2.3.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">7.2.3.2.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-1"><span class="toc-number">7.2.3.3.</span> <span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-MySQL%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%9D%97%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.2.4.</span> <span class="toc-text">2.4 MySQL操作模块【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-2"><span class="toc-number">7.2.4.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">7.2.4.2.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-2"><span class="toc-number">7.2.4.3.</span> <span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Redis-%E7%BC%93%E5%AD%98%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%9D%97%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.2.5.</span> <span class="toc-text">2.5 Redis 缓存操作模块【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-3"><span class="toc-number">7.2.5.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">7.2.5.2.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-3"><span class="toc-number">7.2.5.3.</span> <span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E6%96%87%E6%9C%AC%E9%A2%84%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.2.6.</span> <span class="toc-text">2.6 文本预处理模块【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-4"><span class="toc-number">7.2.6.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-number">7.2.6.2.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-4"><span class="toc-number">7.2.6.3.</span> <span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-BM25-Softmax%E6%A3%80%E7%B4%A2%E6%A8%A1%E5%9D%97%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">7.2.7.</span> <span class="toc-text">2.7 BM25+Softmax检索模块【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-5"><span class="toc-number">7.2.7.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-5"><span class="toc-number">7.2.7.2.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-5"><span class="toc-number">7.2.7.3.</span> <span class="toc-text">说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%BB%E7%A8%8B%E5%BA%8F%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.3.</span> <span class="toc-text">3 主程序【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-6"><span class="toc-number">7.3.1.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">7.3.2.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#P05-%E5%9F%BA%E4%BA%8EMilvus%E6%9E%84%E5%BB%BARAG%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F"><span class="toc-number">8.</span> <span class="toc-text">P05-基于Milvus构建RAG问答系统</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%B7%A5%E7%A8%8B%E6%B5%81%E7%A8%8B"><span class="toc-number">9.</span> <span class="toc-text">一、整体架构与工程流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-RAG%E7%B3%BB%E7%BB%9F%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">9.1.</span> <span class="toc-text">1 RAG系统整体架构介绍【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%B3%BB%E7%BB%9F%E8%83%8C%E6%99%AF"><span class="toc-number">9.1.1.</span> <span class="toc-text">1.1 系统背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%A8%A1%E5%9D%97%E5%8C%96%E6%9E%B6%E6%9E%84"><span class="toc-number">9.1.2.</span> <span class="toc-text">1.2 模块化架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E8%AF%A6%E6%83%85"><span class="toc-number">9.1.2.1.</span> <span class="toc-text">模块详情</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%BB%A3%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">9.1.3.</span> <span class="toc-text">1.3 代码目录结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-RAG%E7%B3%BB%E7%BB%9F%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">9.2.</span> <span class="toc-text">2 RAG系统基本工作流程【掌握】</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%88base%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">二、基础模块（base）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">10.1.</span> <span class="toc-text">1 配置文件【实现】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">10.2.</span> <span class="toc-text">2 配置管理【实现】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">10.3.</span> <span class="toc-text">3 日志记录【实现】</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86"><span class="toc-number">11.</span> <span class="toc-text">三、文档处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%96%87%E6%A1%A3%E8%A7%A3%E6%9E%90%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">11.1.</span> <span class="toc-text">1 文档解析【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-6"><span class="toc-number">11.1.1.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-7"><span class="toc-number">11.1.2.</span> <span class="toc-text">代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD%E5%99%A8%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">11.2.</span> <span class="toc-text">2 自定义文档加载器【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89pdf%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">11.2.1.</span> <span class="toc-text">（1）pdf加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89doc%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">11.2.2.</span> <span class="toc-text">（2）doc加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89ppt%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">11.2.3.</span> <span class="toc-text">（3）ppt加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">11.2.4.</span> <span class="toc-text">（4）图片加载器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E6%9C%AC%E5%88%87%E5%88%86%E5%99%A8%EF%BC%88%E6%96%87%E6%A1%A3%E5%88%86%E5%89%B2%E5%99%A8%EF%BC%89%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">11.3.</span> <span class="toc-text">3 自定义文本切分器（文档分割器）【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E4%B8%AD%E6%96%87%E9%80%92%E5%BD%92%E6%96%87%E6%9C%AC%E5%88%87%E5%88%86%E5%99%A8"><span class="toc-number">11.3.1.</span> <span class="toc-text">（1）中文递归文本切分器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E5%9F%BA%E4%BA%8E%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%AF%AD%E4%B9%89%E5%88%87%E5%88%86%E5%99%A8"><span class="toc-number">11.3.2.</span> <span class="toc-text">（2）基于模型的语义切分器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8"><span class="toc-number">12.</span> <span class="toc-text">四、向量存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">12.1.</span> <span class="toc-text">1 模块功能概述【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%BF%85%E5%A4%87%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">12.1.1.</span> <span class="toc-text">导入必备工具包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">12.2.</span> <span class="toc-text">2 初始化方法【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-6"><span class="toc-number">12.2.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">12.2.2.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-7"><span class="toc-number">12.2.3.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">12.2.4.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E6%88%96%E5%8A%A0%E8%BD%BD%E9%9B%86%E5%90%88%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">12.3.</span> <span class="toc-text">3 创建或加载集合【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-7"><span class="toc-number">12.3.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">12.3.2.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-8"><span class="toc-number">12.3.3.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">12.3.4.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">12.4.</span> <span class="toc-text">4 添加文档【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-8"><span class="toc-number">12.4.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-2"><span class="toc-number">12.4.2.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-9"><span class="toc-number">12.4.3.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">12.4.4.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%B7%B7%E5%90%88%E6%A3%80%E7%B4%A2%E4%B8%8E%E9%87%8D%E6%8E%92%E5%BA%8F%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">12.5.</span> <span class="toc-text">5 混合检索与重排序【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-9"><span class="toc-number">12.5.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-3"><span class="toc-number">12.5.2.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-10"><span class="toc-number">12.5.3.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-3"><span class="toc-number">12.5.4.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BB%8E%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">12.6.</span> <span class="toc-text">6 从查询结果创建文档【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-10"><span class="toc-number">12.6.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-4"><span class="toc-number">12.6.2.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-11"><span class="toc-number">12.6.3.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-4"><span class="toc-number">12.6.4.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E8%8E%B7%E5%8F%96%E5%94%AF%E4%B8%80%E7%88%B6%E6%96%87%E6%A1%A3%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">12.7.</span> <span class="toc-text">7 获取唯一父文档【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-11"><span class="toc-number">12.7.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-5"><span class="toc-number">12.7.2.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-12"><span class="toc-number">12.7.3.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-5"><span class="toc-number">12.7.4.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">12.8.</span> <span class="toc-text">8 完整代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB"><span class="toc-number">13.</span> <span class="toc-text">五、查询分类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">13.1.</span> <span class="toc-text">1 查询分类【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0"><span class="toc-number">13.1.1.</span> <span class="toc-text">1.1 功能概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">13.1.2.</span> <span class="toc-text">1.2 实现细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">13.1.3.</span> <span class="toc-text">1.3 代码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81RAG%E7%B3%BB%E7%BB%9F%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">14.</span> <span class="toc-text">六、RAG系统工作流程实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1%E5%9B%BE"><span class="toc-number">14.0.1.</span> <span class="toc-text">流程设计图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A3%80%E7%B4%A2%E7%AD%96%E7%95%A5%E9%80%89%E6%8B%A9%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">14.1.</span> <span class="toc-text">1 检索策略选择【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0-1"><span class="toc-number">14.1.1.</span> <span class="toc-text">1.1 功能概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82-1"><span class="toc-number">14.1.2.</span> <span class="toc-text">1.2 实现细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">14.1.3.</span> <span class="toc-text">1.3 代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Prompt%E7%AE%A1%E7%90%86%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">14.2.</span> <span class="toc-text">2 Prompt管理【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0"><span class="toc-number">14.2.1.</span> <span class="toc-text">2.1 功能概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">14.2.2.</span> <span class="toc-text">2.2 实现细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">14.2.3.</span> <span class="toc-text">2.3 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-RAG%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">14.3.</span> <span class="toc-text">3 RAG核心逻辑【掌握】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0"><span class="toc-number">14.3.1.</span> <span class="toc-text">3.1 功能概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">14.3.2.</span> <span class="toc-text">3.2 实现细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">14.3.3.</span> <span class="toc-text">3.3 代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E7%9A%84%E6%95%B4%E5%90%88%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">14.4.</span> <span class="toc-text">4 完整流程的整合【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%BB%8E%E6%9F%A5%E8%AF%A2%E5%88%B0%E5%9B%9E%E7%AD%94%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">14.4.1.</span> <span class="toc-text">4.1 从查询到回答的流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">14.4.2.</span> <span class="toc-text">4.2 代码示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81RAG%E7%B3%BB%E7%BB%9F%E8%BF%90%E8%A1%8C"><span class="toc-number">15.</span> <span class="toc-text">七、RAG系统运行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%B3%BB%E7%BB%9F%E8%BF%90%E8%A1%8C%E5%85%A5%E5%8F%A3%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">15.1.</span> <span class="toc-text">1 系统运行入口【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0-2"><span class="toc-number">15.1.1.</span> <span class="toc-text">1.1 功能概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82-2"><span class="toc-number">15.1.2.</span> <span class="toc-text">1.2 实现细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">15.1.3.</span> <span class="toc-text">1.3 完整代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-RAG%E7%B3%BB%E7%BB%9F%E8%BF%90%E8%A1%8C%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">15.2.</span> <span class="toc-text">2 RAG系统运行【实现】</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#P06-RAG%E7%B3%BB%E7%BB%9F%E8%AF%84%E4%BC%B0"><span class="toc-number">16.</span> <span class="toc-text">P06-RAG系统评估</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%AF%84%E4%BC%B0%E6%95%B0%E6%8D%AE%E9%9B%86%E6%9E%84%E9%80%A0%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">16.1.</span> <span class="toc-text">1 评估数据集构造【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-RAGAS%E8%AF%84%E4%BC%B0%E6%A1%86%E6%9E%B6%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">16.2.</span> <span class="toc-text">2 RAGAS评估框架【理解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%AF%84%E4%BC%B0%E6%8C%87%E6%A0%87%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">16.3.</span> <span class="toc-text">3 评估指标【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9B%B8%E5%85%B3%E6%80%A7-context-precision"><span class="toc-number">16.3.1.</span> <span class="toc-text">3.1 上下文相关性 (context precision)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8F%AC%E5%9B%9E%E7%8E%87-context-recall"><span class="toc-number">16.3.2.</span> <span class="toc-text">3.2 上下文召回率 (context recall)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%BF%A0%E5%AE%9E%E5%BA%A6%EF%BC%88faithfulness%EF%BC%89"><span class="toc-number">16.3.3.</span> <span class="toc-text">3.3 忠实度（faithfulness）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E7%AD%94%E6%A1%88%E7%9B%B8%E5%85%B3%E6%80%A7%EF%BC%88answer-relevancy%EF%BC%89"><span class="toc-number">16.3.4.</span> <span class="toc-text">3.4 答案相关性（answer relevancy）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-RAGAS-%E8%AF%84%E4%BC%B0%E8%84%9A%E6%9C%AC%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">16.4.</span> <span class="toc-text">4 RAGAS 评估脚本【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0"><span class="toc-number">16.4.1.</span> <span class="toc-text">1.1 功能描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">16.4.2.</span> <span class="toc-text">1.2 代码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%8C%87%E6%A0%87%E8%8C%83%E5%9B%B4"><span class="toc-number">16.4.3.</span> <span class="toc-text">1.3 指标范围</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#P07-%E8%9E%8D%E5%90%88MySQL%E7%9A%84RAG%E7%B3%BB%E7%BB%9F"><span class="toc-number">17.</span> <span class="toc-text">P07-融合MySQL的RAG系统</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%9E%8D%E5%90%88-FAQ-%E5%92%8C%E7%9F%A5%E8%AF%86%E5%BA%93%E6%9F%A5%E8%AF%A2"><span class="toc-number">18.</span> <span class="toc-text">一、融合 FAQ 和知识库查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B%E5%9B%BE%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">18.1.</span> <span class="toc-text">1 查询流程图【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B5%81%E7%A8%8B%E8%AF%B4%E6%98%8E%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">18.2.</span> <span class="toc-text">2 流程说明【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BB%A3%E7%A0%81%E4%BB%8B%E7%BB%8D%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">18.3.</span> <span class="toc-text">3 代码介绍【理解】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AF%BC%E5%85%A5%E5%BF%85%E5%A4%87%E7%9A%84%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">18.3.1.</span> <span class="toc-text">3.1 导入必备的工具包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">18.3.2.</span> <span class="toc-text">3.2 系统初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%B0%83%E7%94%A8-DashScope-API"><span class="toc-number">18.3.3.</span> <span class="toc-text">3.3 调用 DashScope API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86"><span class="toc-number">18.3.4.</span> <span class="toc-text">3.4 查询处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BA%A4%E4%BA%92"><span class="toc-number">18.3.5.</span> <span class="toc-text">3.5 命令行交互</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%9E%8D%E5%90%88-FAQ-%E5%92%8C%E7%9F%A5%E8%AF%86%E5%BA%93%E6%9F%A5%E8%AF%A2-%E4%BC%98%E5%8C%96%E7%89%88"><span class="toc-number">19.</span> <span class="toc-text">二、融合 FAQ 和知识库查询-优化版</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B%E5%9B%BE%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91-1"><span class="toc-number">19.1.</span> <span class="toc-text">1 查询流程图【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B5%81%E7%A8%8B%E8%AF%B4%E6%98%8E%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91-1"><span class="toc-number">19.2.</span> <span class="toc-text">2 流程说明【掌握】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BB%A3%E7%A0%81%E4%BB%8B%E7%BB%8D"><span class="toc-number">19.3.</span> <span class="toc-text">3 代码介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AF%BC%E5%85%A5%E5%BF%85%E5%A4%87%E7%9A%84%E5%B7%A5%E5%85%B7%E5%8C%85%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.1.</span> <span class="toc-text">3.1 导入必备的工具包【实现】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.2.</span> <span class="toc-text">3.2 系统初始化【实现】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%B0%83%E7%94%A8-DashScope-API%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.3.</span> <span class="toc-text">3.3 调用 DashScope API【实现】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%E8%A1%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.4.</span> <span class="toc-text">3.4 对话历史表初始化【实现】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E8%8E%B7%E5%8F%96%E6%9C%80%E8%BF%91%E5%AF%B9%E8%AF%9D%E5%8E%86%E5%8F%B2%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.5.</span> <span class="toc-text">3.5 获取最近对话历史【实现】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E6%9B%B4%E6%96%B0%E4%BC%9A%E8%AF%9D%E5%8E%86%E5%8F%B2%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.6.</span> <span class="toc-text">3.6 更新会话历史【实现】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E6%B8%85%E9%99%A4%E4%BC%9A%E8%AF%9D%E5%8E%86%E5%8F%B2%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.7.</span> <span class="toc-text">3.7 清除会话历史【实现】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">19.3.8.</span> <span class="toc-text">3.8 查询处理【掌握】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BA%A4%E4%BA%92%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-number">19.3.9.</span> <span class="toc-text">3.9 命令行交互【实现】</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/30/Agent_all/" title="Agent"><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/Pusheen12222.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Agent"/></a><div class="content"><a class="title" href="/2025/10/30/Agent_all/" title="Agent">Agent</a><time datetime="2025-10-29T16:00:00.000Z" title="Created 2025-10-30 00:00:00">2025-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/25/Agent/" title="Agent-Note"><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/Pusheen1121.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Agent-Note"/></a><div class="content"><a class="title" href="/2025/10/25/Agent/" title="Agent-Note">Agent-Note</a><time datetime="2025-10-24T16:00:00.000Z" title="Created 2025-10-25 00:00:00">2025-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/21/RAG/" title="RAG"><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen3.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RAG"/></a><div class="content"><a class="title" href="/2025/10/21/RAG/" title="RAG">RAG</a><time datetime="2025-10-20T16:00:00.000Z" title="Created 2025-10-21 00:00:00">2025-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/28/LLM_Base/" title="LLM大模型基础"><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen112.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLM大模型基础"/></a><div class="content"><a class="title" href="/2025/09/28/LLM_Base/" title="LLM大模型基础">LLM大模型基础</a><time datetime="2025-09-27T16:00:00.000Z" title="Created 2025-09-28 00:00:00">2025-09-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/14/TrafficDefenceDetection/" title="TQ System"><img src="https://wei-blog.oss-cn-beijing.aliyuncs.com/24-07/pusheen132.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TQ System"/></a><div class="content"><a class="title" href="/2025/09/14/TrafficDefenceDetection/" title="TQ System">TQ System</a><time datetime="2025-09-13T16:00:00.000Z" title="Created 2025-09-14 00:00:00">2025-09-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 李俊泽</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Welcome to 李俊泽 の <a target="_blank" rel="noopener" href="https://www.cnblogs.com/liam-sliversucks/">Blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : ''

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>